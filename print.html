<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Ethrex</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Ethrex</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/lambdaclass/ethrex" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="getting-started"><a class="header" href="#getting-started">Getting started</a></h1>
<p>Ethrex is a minimalist, stable, modular and fast implementation of the Ethereum protocol in <a href="https://www.rust-lang.org/">Rust</a>.
The client supports running in two different modes:</p>
<ul>
<li><strong>ethrex L1</strong> - As a regular Ethereum execution client</li>
<li><strong>ethrex L2</strong> - As a multi-prover ZK-Rollup (supporting SP1, RISC Zero and TEEs), where block execution is proven and the proof sent to an L1 network for verification, thus inheriting the L1's security. Support for based sequencing is currently in the works.</li>
</ul>
<h2 id="quickstart-l1"><a class="header" href="#quickstart-l1">Quickstart L1</a></h2>
<div class="mdbook-alerts mdbook-alerts-caution">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  caution
</p>
<p>Before starting, ensure your hardware meets the <a href="getting-started/../getting-started/hardware_requirements.html">hardware requirements</a>.</p>
</div>
<p>Follow these steps to sync an ethrex node on the Hoodi testnet.</p>
<h3 id="macos"><a class="header" href="#macos">MacOS</a></h3>
<p>Install ethrex and lighthouse:</p>
<pre><code class="language-sh"># create secrets directory and jwt secret
mkdir -p ethereum/secrets/
cd ethereum/
openssl rand -hex 32 | tr -d "\n" | tee ./secrets/jwt.hex

# install lightouse and ethrex
brew install lambdaclass/tap/ethrex
brew install lighthouse
</code></pre>
<p>On one terminal:</p>
<pre><code class="language-sh">ethrex --authrpc.jwtsecret ./secrets/jwt.hex --network hoodi
</code></pre>
<p>and on another one:</p>
<pre><code class="language-sh">lighthouse bn --network hoodi --execution-endpoint http://localhost:8551 --execution-jwt ./secrets/jwt.hex --checkpoint-sync-url https://hoodi.checkpoint.sigp.io --http
</code></pre>
<h3 id="linux-x86"><a class="header" href="#linux-x86">Linux x86</a></h3>
<p>Install ethrex and lighthouse:</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Go to https://github.com/sigp/lighthouse/releases/ and use the latest package there and replace that in the below commands</p>
</div>
<pre><code class="language-sh"># create secrets directory and jwt secret
mkdir -p ethereum/secrets/
cd ethereum/
openssl rand -hex 32 | tr -d "\n" | tee ./secrets/jwt.hex

# install lightouse and ethrex
curl -L https://github.com/lambdaclass/ethrex/releases/latest/download/ethrex-linux-x86_64 -o ethrex
chmod +x ethrex
curl -LO https://github.com/sigp/lighthouse/releases/download/v8.0.0/lighthouse-v8.0.0-x86_64-unknown-linux-gnu.tar.gz
tar -xvf lighthouse-v8.0.0-x86_64-unknown-linux-gnu.tar.gz
</code></pre>
<p>On one terminal:</p>
<pre><code class="language-sh">./ethrex --authrpc.jwtsecret ./secrets/jwt.hex --network hoodi
</code></pre>
<p>and on another one:</p>
<pre><code class="language-sh">./lighthouse bn --network hoodi --execution-endpoint http://localhost:8551 --execution-jwt ./secrets/jwt.hex --checkpoint-sync-url https://hoodi.checkpoint.sigp.io --http
</code></pre>
<p>For other CPU architectures, see the <a href="https://github.com/lambdaclass/ethrex/releases/">releases page</a>.</p>
<h2 id="quickstart-l2"><a class="header" href="#quickstart-l2">Quickstart L2</a></h2>
<p>Follow these steps to quickly launch a local L2 node. For advanced options and real deployments, see the links at the end.</p>
<h3 id="macos-1"><a class="header" href="#macos-1">MacOS</a></h3>
<pre><code class="language-sh"># install ethrex
brew install lambdaclass/tap/ethrex
ethrex l2 --dev
</code></pre>
<h3 id="linux-x86-1"><a class="header" href="#linux-x86-1">Linux x86</a></h3>
<pre><code class="language-sh"># install ethrex
curl -L https://github.com/lambdaclass/ethrex/releases/latest/download/ethrex-linux-x86_64 -o ethrex
chmod +x ethrex
./ethrex l2 --dev
</code></pre>
<p>For other CPU architectures, see the <a href="https://github.com/lambdaclass/ethrex/releases/">releases page</a>.</p>
<h2 id="where-to-start"><a class="header" href="#where-to-start">Where to Start</a></h2>
<ul>
<li>
<p><strong>Want to run ethrex in production as an execution client?</strong></p>
<p>See <a href="getting-started/../l1/running">Node operation</a> for setup, configuration, monitoring, and best practices.</p>
</li>
<li>
<p><strong>Interested in deploying your own L2?</strong></p>
<p>See <a href="getting-started/../l2/deployment/overview.html">L2 rollup deployment</a> for launching your own rollup, deploying contracts, and interacting with your L2.</p>
</li>
<li>
<p><strong>Looking to contribute or develop?</strong></p>
<p>Visit the <a href="getting-started/../developers">Developer resources</a> for local dev mode, testing, debugging, advanced CLI usage, and the <a href="getting-started/../CLI.html">CLI reference</a>.</p>
</li>
<li>
<p><strong>Want to understand how ethrex works?</strong></p>
<p>Explore <a href="getting-started/../l1/fundamentals">L1 fundamentals</a> and <a href="getting-started/../l2/architecture">L2 Architecture</a> for deep dives into ethrex's design, sync modes, networking, and more.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="hardware-requirements"><a class="header" href="#hardware-requirements">Hardware Requirements</a></h1>
<blockquote>
<p>NOTE: The guidance in this document applies to running an L1 (Ethereum) node. L2 deployments (sequencers, provers and related infra) have different hardware profiles and operational requirements — see the "L2" section below for details.</p>
</blockquote>
<p>Hardware requirements depend primarily on the <strong>network</strong> you're running — for example, <strong>Hoodi</strong>, <strong>Sepolia</strong>, or <strong>Mainnet</strong>.</p>
<h2 id="general-recommendations"><a class="header" href="#general-recommendations">General Recommendations</a></h2>
<p>Across all networks, the following apply:</p>
<ul>
<li><strong>Disk Type:</strong> Use <strong>high-performance NVMe SSDs</strong>. For multi-disk setups, <strong>software RAID 0</strong> is recommended to maximize speed and capacity. <strong>Avoid hardware RAID</strong>, which can limit NVMe performance.</li>
<li><strong>RAM:</strong> Sufficient memory minimizes sync bottlenecks and improves stability under load.</li>
<li><strong>CPU:</strong> 4-8 Cores.
<ul>
<li>x86-64 bit Processors must be compatible with the instruction set AVX2.</li>
</ul>
</li>
</ul>
<hr />
<h2 id="disk-and-memory-requirements-by-network"><a class="header" href="#disk-and-memory-requirements-by-network">Disk and Memory Requirements by Network</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Network</th><th>Disk (Minimum)</th><th>Disk (Recommended)</th><th>RAM (Minimum)</th><th>RAM (Recommended)</th></tr></thead><tbody>
<tr><td><strong>Ethereum Mainnet</strong></td><td>500 GB</td><td>1 TB</td><td>32 GB</td><td>64 GB</td></tr>
<tr><td><strong>Ethereum Sepolia</strong></td><td>250 GB</td><td>400 GB</td><td>32 GB</td><td>64 GB</td></tr>
<tr><td><strong>Ethereum Hoodi</strong></td><td>60 GB</td><td>100 GB</td><td>32 GB</td><td>64 GB</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="l2"><a class="header" href="#l2">L2</a></h2>
<p>TBD</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>Ethrex is designed to run on Linux and macOS.</p>
<p>There are 4 supported methods to install ethrex:</p>
<ul>
<li><a href="getting-started/installation/./binary_distribution.html">Binary distribution</a></li>
<li><a href="getting-started/installation/./package_manager.html">Package manager</a></li>
<li><a href="getting-started/installation/./docker_images.html">Docker image</a></li>
<li><a href="getting-started/installation/./building_from_source.html">Building from source</a></li>
</ul>
<p>After following the installation steps you should have a binary that can <a href="getting-started/installation/../../l1/running/README.html">run an L1 client</a> or a <a href="getting-started/installation/../../l2/introduction.html">multi-prover ZK-rollup</a> with support for SP1, RISC Zero and TEEs.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="install-ethrex-binary-distribution"><a class="header" href="#install-ethrex-binary-distribution">Install ethrex (binary distribution)</a></h1>
<p>This guide explains how to quickly install the latest pre-built ethrex binary for your operating system.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<ul>
<li><a href="https://curl.se/download.html">curl</a> (for downloading the binary)</li>
</ul>
<h2 id="download-the-latest-release"><a class="header" href="#download-the-latest-release">Download the latest release</a></h2>
<p>Download the latest ethrex release for your OS from the <a href="https://github.com/lambdaclass/ethrex/releases/latest" target="_blank">GitHub Releases page</a>.</p>
<h3 id="linux-x86_64"><a class="header" href="#linux-x86_64">Linux x86_64</a></h3>
<pre><code class="language-sh">curl -L https://github.com/lambdaclass/ethrex/releases/latest/download/ethrex-linux-x86_64 -o ethrex
</code></pre>
<h4 id="linux-x86_64-with-gpu-support-for-l2-prover"><a class="header" href="#linux-x86_64-with-gpu-support-for-l2-prover">Linux x86_64 with GPU support (for L2 prover)</a></h4>
<p>If you want to run an L2 prover with GPU acceleration, download the GPU-enabled binary:</p>
<pre><code class="language-sh">curl -L https://github.com/lambdaclass/ethrex/releases/latest/download/ethrex-linux-x86_64-gpu -o ethrex
</code></pre>
<h3 id="linux-arm-aarch64"><a class="header" href="#linux-arm-aarch64">Linux ARM (aarch64)</a></h3>
<pre><code class="language-sh">curl -L https://github.com/lambdaclass/ethrex/releases/latest/download/ethrex-linux-aarch64 -o ethrex
</code></pre>
<h4 id="linux-arm-aarch64-with-gpu-support-for-l2-prover"><a class="header" href="#linux-arm-aarch64-with-gpu-support-for-l2-prover">Linux ARM (aarch64) with GPU support (for L2 prover)</a></h4>
<p>If you want to run an L2 prover with GPU acceleration, download the GPU-enabled binary:</p>
<pre><code class="language-sh">curl -L https://github.com/lambdaclass/ethrex/releases/latest/download/ethrex-linux-aarch64-gpu -o ethrex
</code></pre>
<h3 id="macos-apple-silicon-aarch64"><a class="header" href="#macos-apple-silicon-aarch64">macOS (Apple Silicon, aarch64)</a></h3>
<pre><code class="language-sh">curl -L https://github.com/lambdaclass/ethrex/releases/latest/download/ethrex-macos-aarch64 -o ethrex
</code></pre>
<h2 id="set-execution-permissions"><a class="header" href="#set-execution-permissions">Set execution permissions</a></h2>
<p>Make the binary executable:</p>
<pre><code class="language-sh">chmod +x ethrex
</code></pre>
<h2 id="optional-move-to-a-directory-in-your-path"><a class="header" href="#optional-move-to-a-directory-in-your-path">(Optional) Move to a directory in your <code>$PATH</code></a></h2>
<p>To run <code>ethrex</code> from anywhere, move it to a directory in your <code>$PATH</code> (e.g., <code>/usr/local/bin</code>):</p>
<pre><code class="language-sh">sudo mv ethrex /usr/local/bin/
</code></pre>
<h2 id="verify-the-installation"><a class="header" href="#verify-the-installation">Verify the installation</a></h2>
<p>Check that Ethrex is installed and working:</p>
<pre><code class="language-sh">ethrex --version
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="install-ethrex-package-manager"><a class="header" href="#install-ethrex-package-manager">Install ethrex (package manager)</a></h1>
<p>Coming soon.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="installing-ethrex-docker"><a class="header" href="#installing-ethrex-docker">Installing ethrex (docker)</a></h1>
<p>Run Ethrex easily using Docker containers. This guide covers pulling and running official images.</p>
<h2 id="prerequisites-1"><a class="header" href="#prerequisites-1">Prerequisites</a></h2>
<ul>
<li><a href="https://www.docker.com/get-started/">Docker</a> installed and running</li>
</ul>
<h2 id="pulling-the-docker-image"><a class="header" href="#pulling-the-docker-image">Pulling the Docker Image</a></h2>
<p><strong>Latest stable release:</strong></p>
<pre><code class="language-sh">docker pull ghcr.io/lambdaclass/ethrex:latest
</code></pre>
<p><strong>Latest development build:</strong></p>
<pre><code class="language-sh">docker pull ghcr.io/lambdaclass/ethrex:main
</code></pre>
<p><strong>Specific version:</strong></p>
<pre><code class="language-sh">docker pull ghcr.io/lambdaclass/ethrex:&lt;version-tag&gt;
</code></pre>
<p>Find available tags in the <a href="https://github.com/lambdaclass/ethrex/tags" target="_blank">GitHub repo</a>.</p>
<hr />
<h2 id="running-the-docker-image"><a class="header" href="#running-the-docker-image">Running the Docker Image</a></h2>
<h3 id="check-the-image"><a class="header" href="#check-the-image">Check the Image</a></h3>
<p>Verify the image is working:</p>
<pre><code class="language-sh">docker run --rm ghcr.io/lambdaclass/ethrex --version
</code></pre>
<h3 id="start-an-ethrex-node"><a class="header" href="#start-an-ethrex-node">Start an ethrex Node</a></h3>
<p>Run the following command to start a node in the background:</p>
<pre><code class="language-sh">docker run \
    --rm \
    -d \
    -v ethrex:/root/.local/share/ethrex \
    -p 8545:8545 \
    -p 8551:8551 \
    -p 30303:30303 \
    -p 30303:30303/udp \
    -p 9090:9090 \
    --name ethrex \
    ghcr.io/lambdaclass/ethrex \
    --authrpc.addr 0.0.0.0
</code></pre>
<p><strong>What this does:</strong></p>
<ul>
<li>Starts a container named <code>ethrex</code></li>
<li>Publishes ports:
<ul>
<li><code>8545</code>: JSON-RPC server (TCP)</li>
<li><code>8551</code>: Auth JSON-RPC server (TCP)</li>
<li><code>30303</code>: P2P networking (TCP/UDP)</li>
<li><code>9090</code>: Metrics (TCP)</li>
</ul>
</li>
<li>Mounts the Docker volume <code>ethrex</code> to persist blockchain data</li>
</ul>
<p><strong>Tip:</strong> You can add more Ethrex CLI arguments at the end of the command as needed.</p>
<hr />
<h2 id="managing-the-container"><a class="header" href="#managing-the-container">Managing the Container</a></h2>
<p><strong>View logs:</strong></p>
<pre><code class="language-sh">docker logs -f ethrex
</code></pre>
<p><strong>Stop the node:</strong></p>
<pre><code class="language-sh">docker stop ethrex
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="building-ethrex-from-source"><a class="header" href="#building-ethrex-from-source">Building ethrex from source</a></h1>
<p>Build ethrex yourself for maximum flexibility and experimental features.</p>
<h2 id="prerequisites-2"><a class="header" href="#prerequisites-2">Prerequisites</a></h2>
<ul>
<li><a href="https://www.rust-lang.org/tools/install">Rust toolchain</a> (use <code>rustup</code> for easiest setup)</li>
<li><a href="https://clang.llvm.org/docs/index.html">libclang</a> (for RocksDB)</li>
<li><a href="https://git-scm.com/downloads">Git</a></li>
<li><a href="https://docs.soliditylang.org/en/v0.8.31/installing-solidity.html">solc (v0.8.31)</a> (for L2 development)</li>
</ul>
<h3 id="l2-contracts"><a class="header" href="#l2-contracts">L2 contracts</a></h3>
<p>If you want to install ethrex for L2 development, you may set the <code>COMPILE_CONTRACTS</code> env var, so the binary have the necessary contract code.</p>
<pre><code class="language-sh">export COMPILE_CONTRACTS=true
</code></pre>
<h2 id="install-via-cargo-install"><a class="header" href="#install-via-cargo-install">Install via <code>cargo install</code></a></h2>
<p>The fastest way to install ethrex from source:</p>
<pre><code class="language-sh">cargo install --locked ethrex --git https://github.com/lambdaclass/ethrex.git
</code></pre>
<p><strong>Optional features:</strong></p>
<ul>
<li>Add <code>--features sp1,risc0</code> to enable SP1 and/or RISC0 provers</li>
<li>Add <code>--features gpu</code> for CUDA GPU support</li>
</ul>
<p><strong>Install a specific version:</strong></p>
<pre><code class="language-sh">cargo install --locked ethrex --git https://github.com/lambdaclass/ethrex.git --tag &lt;version-tag&gt;
</code></pre>
<p>Find available tags in the <a href="https://github.com/lambdaclass/ethrex/tags" target="_blank">GitHub repo</a>.</p>
<p><strong>Verify installation:</strong></p>
<pre><code class="language-sh">ethrex --version
</code></pre>
<hr />
<h2 id="build-manually-with-cargo-build"><a class="header" href="#build-manually-with-cargo-build">Build manually with <code>cargo build</code></a></h2>
<p>Clone the repository (replace <code>&lt;version-tag&gt;</code> with the desired version):</p>
<pre><code class="language-sh">git clone --branch &lt;version-tag&gt; --depth 1 https://github.com/lambdaclass/ethrex.git
cd ethrex
</code></pre>
<p>Build the binary:</p>
<pre><code class="language-sh">cargo build --bin ethrex --release
</code></pre>
<p><strong>Optional features:</strong></p>
<ul>
<li>Add <code>--features sp1,risc0</code> to enable SP1 and/or RISC0 provers</li>
<li>Add <code>--features gpu</code> for CUDA GPU support</li>
</ul>
<p>The built binary will be in <code>target/release/ethrex</code>.</p>
<p><strong>Verify the build:</strong></p>
<pre><code class="language-sh">./target/release/ethrex --version
</code></pre>
<p><strong>(Optional) Move the binary to your <code>$PATH</code>:</strong></p>
<pre><code class="language-sh">sudo mv ./target/release/ethrex /usr/local/bin/
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="running-an-ethereum-node-with-ethrex"><a class="header" href="#running-an-ethereum-node-with-ethrex">Running an Ethereum Node with ethrex</a></h1>
<p>This section explains how to run an Ethereum L1 node using ethrex. Here you'll find:</p>
<ul>
<li>Requirements for running a node (including the need for a consensus client)</li>
<li>Step-by-step instructions for setup and configuration</li>
<li>Guidance for both new and experienced users</li>
</ul>
<p>If you already have a consensus client running, you can skip directly to the <a href="l1/running/./startup.html">node startup instructions</a>. Otherwise, continue to the next section for help <a href="l1/running/./consensus_client.html">setting up a consensus client</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="connecting-to-a-consensus-client"><a class="header" href="#connecting-to-a-consensus-client">Connecting to a consensus client</a></h1>
<p>Ethrex is an execution client built for Ethereum networks after the <a href="https://ethereum.org/en/roadmap/merge/">merge</a>. As a result, ethrex must operate together with a <a href="https://ethereum.org/en/developers/docs/nodes-and-clients/#consensus-clients">consensus client</a> to fully participate in the network.</p>
<h3 id="consensus-clients"><a class="header" href="#consensus-clients">Consensus clients</a></h3>
<p>There are several consensus clients and all of them work with ethrex. When choosing a consensus client we suggest you keep in mind <a href="https://ethereum.org/en/developers/docs/nodes-and-clients/client-diversity">client diversity</a>.</p>
<ul>
<li><a href="https://lighthouse.sigmaprime.io/">Lighthouse</a></li>
<li><a href="https://lodestar.chainsafe.io/">Lodestar</a></li>
<li><a href="https://nimbus.team/">Nimbus</a></li>
<li><a href="https://prysm.offchainlabs.com/">Prysm</a></li>
<li><a href="https://consensys.io/teku">Teku</a></li>
<li><a href="https://docs.grandine.io/">Grandine</a></li>
</ul>
<h2 id="configuring-ethrex"><a class="header" href="#configuring-ethrex">Configuring ethrex</a></h2>
<h3 id="jwt-secret"><a class="header" href="#jwt-secret">JWT secret</a></h3>
<p>Consensus clients and execution clients communicate through an authenticated JSON-RPC API. The authentication is done through a <a href="https://www.jwt.io/">jwt</a> secret. Ethrex automatically generates the jwt secret and saves it to the current working directory by default. You can also use your own previously generated jwt secret by using the <code>--authrpc.jwtsecret</code> flag or <code>JWTSECRET_PATH</code> environment variable. If the jwt secret at the specified path does not exist ethrex will create it.</p>
<h3 id="auth-rpc-server"><a class="header" href="#auth-rpc-server">Auth RPC server</a></h3>
<p>By default the server is exposed at <code>http://localhost:8551</code> but both the address and the port can be modified using the <code>--authrpc.addr</code> and <code>--authrpc.port</code> flags respectively.</p>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<pre><code>ethrex --authrpc.jwtsecret path/to/jwt.hex  --authrpc.addr localhost --authrpc.port 8551
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="node-startup"><a class="header" href="#node-startup">Node startup</a></h1>
<h2 id="supported-networks"><a class="header" href="#supported-networks">Supported networks</a></h2>
<p>Ethrex is designed to support Ethereum mainnet and its testnets</p>
<div class="table-wrapper"><table><thead><tr><th>Network</th><th>Chain id</th><th>Supported sync modes</th></tr></thead><tbody>
<tr><td>mainnet</td><td>1</td><td>snap</td></tr>
<tr><td>sepolia</td><td>11155111</td><td>snap</td></tr>
<tr><td>holesky</td><td>17000</td><td>full, snap</td></tr>
<tr><td>hoodi</td><td>560048</td><td>full, snap</td></tr>
</tbody></table>
</div>
<p>For more information about sync modes please read the <a href="l1/running/../fundamentals/sync_modes.html">sync modes document</a>. Full syncing is the default, to switch to snap sync use the flag <code>--syncmode snap</code></p>
<h2 id="run-an-ethereum-node"><a class="header" href="#run-an-ethereum-node">Run an Ethereum node</a></h2>
<p>This guide will assume that you already <a href="l1/running/../../getting-started/installation/">installed ethrex</a> and you know how to set up a <a href="l1/running/./consensus_client.html">consensus client</a> to communicate with ethrex.</p>
<p>To sync with mainnet</p>
<pre><code>ethrex --syncmode snap
</code></pre>
<p>To sync with sepolia</p>
<pre><code>ethrex --network sepolia --syncmode snap
</code></pre>
<p>To sync with holesky</p>
<pre><code>ethrex --network holesky
</code></pre>
<p>To sync with hoodi</p>
<pre><code>ethrex --network hoodi
</code></pre>
<p>Once started, you should be able to check the sync status with:</p>
<pre><code class="language-sh">curl http://localhost:8545 \
    -H 'content-type: application/json' \
    -d '{"jsonrpc":"2.0","method":"eth_syncing","params":[],"id":1}'
</code></pre>
<p>The answer should be:</p>
<pre><code>{"id":1,"jsonrpc":"2.0","result":{"startingBlock":"0x0","currentBlock":"0x0","highestBlock":"0x0"}}
</code></pre>
<h2 id="run-an-ethereum-node-with-docker"><a class="header" href="#run-an-ethereum-node-with-docker">Run an Ethereum node with Docker</a></h2>
<p>You can simply start a node with a Consensus client and ethrex as Execution client with Docker using the <a href="https://github.com/lambdaclass/ethrex/blob/main/docker-compose.yaml">docker-compose.yaml</a></p>
<pre><code class="language-sh">curl -L -o docker-compose.yaml https://raw.githubusercontent.com/lambdaclass/ethrex/refs/heads/main/docker-compose.yaml
docker compose up
</code></pre>
<p>Or you can set a different network:</p>
<pre><code class="language-sh">ETHREX_NETWORK=hoodi docker compose up
</code></pre>
<hr />
<p>For more details and configuration options:</p>
<ul>
<li><a href="l1/running/./configuration.html">Configuration</a></li>
<li><a href="l1/running/../../CLI.html">CLI reference</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p>This page covers the basic configuration options for running an L1 node with ethrex. Full list of options can be found at the <a href="l1/running/../../CLI.html">CLI reference</a></p>
<h2 id="sync-modes"><a class="header" href="#sync-modes">Sync Modes</a></h2>
<p>Ethrex supports different sync modes for node operation:</p>
<ul>
<li><strong>full</strong>: Downloads and verifies the entire chain.</li>
<li><strong>snap</strong>: Fast sync using state snapshots (recommended for most users).</li>
</ul>
<p>Set the sync mode with:</p>
<pre><code class="language-sh">ethrex --sync &lt;mode&gt;
</code></pre>
<h2 id="file-locations"><a class="header" href="#file-locations">File Locations</a></h2>
<p>By default, ethrex stores its data in:</p>
<ul>
<li>Linux: <code>~/.local/share/ethrex</code></li>
<li>macOS: <code>~/Library/Application Support/ethrex</code></li>
</ul>
<p>You can change the data directory with:</p>
<pre><code class="language-sh">ethrex --datadir &lt;path&gt;
</code></pre>
<h2 id="ports"><a class="header" href="#ports">Ports</a></h2>
<p>Default ports used by ethrex:</p>
<ul>
<li><code>8545</code>: JSON-RPC (HTTP)</li>
<li><code>8551</code>: Auth JSON-RPC</li>
<li><code>30303</code>: P2P networking (TCP/UDP)</li>
<li><code>9090</code>: Metrics</li>
</ul>
<p>You can change ports with the corresponding flags: <code>--http.port</code>, <code>--authrpc.port</code>, <code>--p2p.port</code>, <code>--discovery.port</code>, <code>--metrics.port</code>.</p>
<p>All services listen on <code>0.0.0.0</code> by default, except for the auth RPC, which listens on <code>127.0.0.1</code>. This can also be changed with flags (e.g., <code>--http.addr</code>).</p>
<h2 id="log-levels"><a class="header" href="#log-levels">Log Levels</a></h2>
<p>Control log verbosity with:</p>
<pre><code class="language-sh">ethrex --log.level &lt;level&gt;
</code></pre>
<p>Levels: <code>error</code>, <code>warn</code>, <code>info</code> (default), <code>debug</code>, <code>trace</code></p>
<h2 id="dev-mode-localnet"><a class="header" href="#dev-mode-localnet">Dev Mode (Localnet)</a></h2>
<p>For local development and testing, you can use dev mode:</p>
<pre><code class="language-sh">ethrex --dev
</code></pre>
<p>This runs a local network with block production and no external peers. This network has a list of <a href="https://github.com/lambdaclass/ethrex/blob/main/fixtures/keys/private_keys_l1.txt">predefined accounts</a> with funds for testing purposes.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="monitoring-and-metrics"><a class="header" href="#monitoring-and-metrics">Monitoring and Metrics</a></h1>
<p>Ethrex exposes metrics in Prometheus format on port <code>9090</code> by default. But the easiest way to monitor your node is to use the provided Docker Compose stack, which includes Prometheus and Grafana preconfigured. For that we are currently using port <code>3701</code>, this will match the default in the future but for now if running the containers we expected to have the ethrex metrics exposed on port <code>3701</code>.</p>
<h2 id="quickstart-monitoring-stack-with-docker-compose"><a class="header" href="#quickstart-monitoring-stack-with-docker-compose">Quickstart: Monitoring Stack with Docker Compose</a></h2>
<ol>
<li>
<p><strong>Clone the repository:</strong></p>
<pre><code class="language-sh">git clone https://github.com/lambdaclass/ethrex.git
cd ethrex/metrics
</code></pre>
</li>
<li>
<p><strong>Start the monitoring stack:</strong></p>
<pre><code class="language-sh"># Optional: if you have updated from a previous version, stop first the docker compose.
# docker compose -f docker-compose-metrics.yaml -f docker-compose-metrics-l1.overrides.yaml down
docker compose -f docker-compose-metrics.yaml -f docker-compose-metrics-l1.overrides.yaml up -d
</code></pre>
</li>
</ol>
<p><em><strong>Note:</strong> You might want to restart the docker containers in case of an update from a previous ethrex version to make sure the latest provisioned configurations are applied:</em></p>
<ol start="3">
<li>
<p><strong>Run ethrex with metrics enabled:</strong></p>
<p>Make sure to start ethrex with the <code>--metrics</code> flag and set the port to <code>3701</code>:</p>
<pre><code class="language-sh">ethrex --authrpc.jwtsecret ./secrets/jwt.hex --network hoodi --metrics --metrics.port 3701
</code></pre>
</li>
</ol>
<p>This will launch Prometheus and Grafana, already set up to scrape ethrex metrics.</p>
<p><strong>Note: We depend on <code>ethereum-metrics-exporter</code> for some key metrics to define variables on the Grafana dashboards. For it to work properly we need the consensus client to expose its RPC endpoints. For example if you are running lighthhouse you may need to add <code>--http</code> and <code>--http-address 0.0.0.0</code> flags to it before the dashboards pick up all metrics. This wont be needed in the near future</strong></p>
<h2 id="logs"><a class="header" href="#logs">Logs</a></h2>
<p>Ethrex logs are written to stdout by default. To enable file logging, you must specify the <code>--log.dir</code> argument, with this you'll be able to have Promtail collect the logs and send them to Grafana Loki for log visualization.</p>
<ul>
<li><strong>Promtail Configuration:</strong> <code>metrics/provisioning/promtail/promtail.yaml</code></li>
</ul>
<p>The promtail configuration expects by default that logs are stored in <code>./logs</code> (relative to the repo root). To correctly see the logs in Grafana, ensure that Promtail can access the logs directory:</p>
<ul>
<li>If running via <strong>Docker</strong>, ensure you map a volume to the log directory and pass <code>--log.dir</code> to the container.</li>
<li>If running <strong>standalone</strong>, use <code>--log.dir ./logs</code> when running ethrex.</li>
</ul>
<pre><code class="language-bash">ethrex --log.dir ./logs ...
</code></pre>
<p>If you choose to use a different directory, you must set the <code>ETHREX_LOGS_DIR</code> environment variable when running the metrics stack to point to your custom logs directory.</p>
<pre><code class="language-bash">ETHREX_LOGS_DIR=/path/to/your/logs docker compose -f docker-compose-metrics.yaml -f docker-compose-metrics-l1.overrides.yaml up
</code></pre>
<p>You can view the logs in Grafana by navigating to the <a href="l1/running/../../developers/l1/dashboards.html#logs">logs row</a> in our dashboard.</p>
<h3 id="running-docker-container-manually"><a class="header" href="#running-docker-container-manually">Running Docker Container Manually</a></h3>
<p>If you run the <code>ethrex</code> Docker container manually (e.g., <code>docker run ...</code>) or use a custom <code>docker-compose.yaml</code> outside of this repository, you must ensure the logs are accessible to the monitoring stack.</p>
<p>The <code>ethrex</code> container writes logs to the directory specified by <code>--log.dir</code>. You should mount this directory to a location on your host machine that Promtail can access.</p>
<p>Example:</p>
<pre><code class="language-bash">docker run -d \
  --name ethrex \
  -v $(pwd)/logs:/data/logs \
  ghcr.io/lambdaclass/ethrex:main \
  --datadir /data \
  --log.dir /data/logs
</code></pre>
<p>If you are using the provided monitoring stack in <code>metrics/</code>, it expects logs to be in the <code>logs</code> directory at the root of the repository (or <code>../logs</code> relative to the <code>metrics</code> folder). Ensure your volume mount matches this expectation or update the Promtail volume configuration.</p>
<h2 id="accessing-metrics-and-dashboards"><a class="header" href="#accessing-metrics-and-dashboards">Accessing Metrics and Dashboards</a></h2>
<ul>
<li><strong>Prometheus:</strong> <a href="http://localhost:9091">http://localhost:9091</a></li>
<li><strong>Grafana:</strong> <a href="http://localhost:3001">http://localhost:3001</a>
<ul>
<li>Default login: <code>admin</code> / <code>admin</code></li>
<li>Prometheus is preconfigured as a data source</li>
<li>Example dashboards are included in the repo</li>
</ul>
</li>
</ul>
<p>Metrics from ethrex will be available at <code>http://localhost:3701/metrics</code> in Prometheus format if you followed <a href="l1/running/monitoring.html#run-ethrex-with-metrics-enabled">step 3</a>.</p>
<p>For detailed information on the provided Grafana dashboards, see our <a href="l1/running/../../developers/l1/dashboards.html">L1 Dashboard document</a>.</p>
<h2 id="custom-configuration"><a class="header" href="#custom-configuration">Custom Configuration</a></h2>
<p>Your ethrex setup may differ from the default configuration. Check your endpoints at <code>provisioning/prometheus/prometheus_l1_sync_docker.yaml</code>.</p>
<p>Also if you have a centralized Prometheus or Grafana setup, you can adapt the provided configuration files to fit your environment. or even stop the docker containers that run Prometheus and/or Grafana leaving only the additional <code>ethereum-metrics-exporter</code> running alongside ethrex to export the metrics to your existing monitoring stack.</p>
<pre><code class="language-sh">docker compose -f docker-compose-metrics.yaml -f docker-compose-metrics-l1.overrides.yaml up -d ethereum-metrics-exporter 
</code></pre>
<hr />
<p>For manual setup or more details, see the <a href="https://prometheus.io/docs/introduction/overview/">Prometheus documentation</a> and <a href="https://grafana.com/docs/">Grafana documentation</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="l1-architecture"><a class="header" href="#l1-architecture">L1 Architecture</a></h1>
<p>This section covers the internal architecture of ethrex as an Ethereum L1 execution client. It explains how the different components interact, how blocks flow through the system, and the design decisions behind the implementation.</p>
<ul>
<li><a href="l1/architecture/./overview.html">System Overview</a> - High-level architecture and component interactions</li>
<li><a href="l1/architecture/./block_execution.html">Block Execution Pipeline</a> - How blocks are validated and executed</li>
<li><a href="l1/architecture/./sync_state_machine.html">Sync State Machine</a> - Full sync and snap sync algorithms</li>
<li><a href="l1/architecture/./crate_map.html">Crate Map</a> - Overview of all crates and their responsibilities</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="system-overview"><a class="header" href="#system-overview">System Overview</a></h1>
<p>This document provides a high-level overview of ethrex's L1 architecture as an Ethereum execution client.</p>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>ethrex is a Rust implementation of an Ethereum execution client. It implements the Ethereum protocol specification, including:</p>
<ul>
<li>Block validation and execution</li>
<li>State management via Merkle Patricia Tries</li>
<li>P2P networking (devp2p stack)</li>
<li>JSON-RPC API for external interaction</li>
<li>Engine API for consensus client communication</li>
</ul>
<h2 id="high-level-architecture"><a class="header" href="#high-level-architecture">High-Level Architecture</a></h2>
<pre><code>                                    ┌─────────────────────┐
                                    │   Consensus Client  │
                                    │  (Lighthouse, etc)  │
                                    └──────────┬──────────┘
                                               │ Engine API
                                               │ (JWT auth)
                                               ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                              ethrex Execution Client                          │
│                                                                               │
│  ┌─────────────┐     ┌──────────────┐     ┌────────────────────────────────┐ │
│  │   JSON-RPC  │     │  Engine API  │     │           P2P Network          │ │
│  │    Server   │     │   Handler    │     │  ┌────────┐  ┌──────────────┐  │ │
│  │             │     │              │     │  │DiscV4  │  │    RLPx      │  │ │
│  │ eth_*       │     │ engine_*     │     │  │        │  │  ┌────────┐  │  │ │
│  │ debug_*     │     │ forkchoice   │     │  │        │  │  │ eth/68 │  │  │ │
│  │ txpool_*    │     │ newPayload   │     │  │        │  │  │ snap/1 │  │  │ │
│  │ admin_*     │     │ getPayload   │     │  │        │  │  └────────┘  │  │ │
│  └──────┬──────┘     └──────┬───────┘     │  └────────┘  └──────────────┘  │ │
│         │                   │             └────────────────┬───────────────┘ │
│         │                   │                              │                 │
│         └───────────────────┼──────────────────────────────┘                 │
│                             │                                                 │
│                             ▼                                                 │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │                           Blockchain                                   │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│  │  │   Mempool   │  │  Payload    │  │ Fork Choice │  │   Block     │   │   │
│  │  │             │  │  Builder    │  │   Update    │  │  Pipeline   │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                             │                                                 │
│                             ▼                                                 │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │                              EVM (LEVM)                                │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│  │  │Transaction  │  │   Opcode    │  │  Precompiled│  │    State    │   │   │
│  │  │ Execution   │  │   Handler   │  │  Contracts  │  │ Transitions │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                             │                                                 │
│                             ▼                                                 │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │                             Storage                                    │   │
│  │  ┌───────────────────────────────────────────────────────────────┐    │   │
│  │  │                     Store (High-level API)                     │    │   │
│  │  └───────────────────────────────────────────────────────────────┘    │   │
│  │                    │                              │                    │   │
│  │         ┌──────────┴──────────┐        ┌─────────┴────────┐           │   │
│  │         ▼                     ▼        ▼                  ▼           │   │
│  │  ┌─────────────┐       ┌─────────────────┐       ┌───────────────┐    │   │
│  │  │  InMemory   │       │    RocksDB      │       │  State Trie   │    │   │
│  │  │  (Testing)  │       │  (Production)   │       │ (MPT + Flat)  │    │   │
│  │  └─────────────┘       └─────────────────┘       └───────────────┘    │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="core-components"><a class="header" href="#core-components">Core Components</a></h2>
<h3 id="1-network-layer"><a class="header" href="#1-network-layer">1. Network Layer</a></h3>
<p>The network layer handles all external communication:</p>
<p><strong>JSON-RPC Server</strong> (<code>crates/networking/rpc</code>)</p>
<ul>
<li>Implements the Ethereum JSON-RPC specification</li>
<li>Namespaces: <code>eth_*</code>, <code>debug_*</code>, <code>txpool_*</code>, <code>admin_*</code>, <code>web3_*</code></li>
<li>Validates and broadcasts incoming transactions</li>
</ul>
<p><strong>Engine API</strong> (<code>crates/networking/rpc/engine</code>)</p>
<ul>
<li>Communication channel with the consensus client</li>
<li>Handles <code>engine_forkchoiceUpdatedV{1,2,3}</code>, <code>engine_newPayloadV{1,2,3}</code>, <code>engine_getPayloadV{1,2,3}</code></li>
<li>JWT authentication for security</li>
<li>Triggers sync when receiving unknown block hashes</li>
</ul>
<p><strong>P2P Network</strong> (<code>crates/networking/p2p</code>)</p>
<ul>
<li><strong>DiscV4</strong>: Node discovery protocol for finding peers</li>
<li><strong>RLPx</strong>: Encrypted transport layer for peer communication</li>
<li><strong>eth/68</strong>: Block and transaction propagation protocol</li>
<li><strong>snap/1</strong>: Snap sync protocol for fast state download</li>
</ul>
<h3 id="2-blockchain-layer"><a class="header" href="#2-blockchain-layer">2. Blockchain Layer</a></h3>
<p>The blockchain layer manages chain state and block processing:</p>
<p><strong>Blockchain</strong> (<code>crates/blockchain</code>)</p>
<ul>
<li>Orchestrates block validation and execution</li>
<li>Manages the mempool for pending transactions</li>
<li>Handles fork choice updates from the consensus layer</li>
<li>Coordinates payload building for block production</li>
</ul>
<p><strong>Mempool</strong></p>
<ul>
<li>Stores pending transactions awaiting inclusion</li>
<li>Filters transactions by gas price, nonce, and validity</li>
<li>Supports transaction replacement (EIP-1559 and EIP-4844)</li>
<li>Broadcasts new transactions to peers</li>
</ul>
<p><strong>Fork Choice</strong></p>
<ul>
<li>Implements Ethereum's fork choice rule</li>
<li>Updates the canonical chain based on consensus client signals</li>
<li>Handles chain reorganizations</li>
</ul>
<h3 id="3-execution-layer"><a class="header" href="#3-execution-layer">3. Execution Layer</a></h3>
<p><strong>LEVM (Lambda EVM)</strong> (<code>crates/vm/levm</code>)</p>
<ul>
<li>Custom EVM implementation in Rust</li>
<li>Executes smart contract bytecode</li>
<li>Implements all EVM opcodes up to the latest hard fork</li>
<li>Handles precompiled contracts</li>
</ul>
<p><strong>Block Execution Pipeline</strong></p>
<ol>
<li>Validate block header</li>
<li>Apply system-level operations (beacon root, block hash storage)</li>
<li>Execute transactions in order</li>
<li>Process withdrawals (post-Merge)</li>
<li>Extract requests (post-Prague)</li>
<li>Compute state root and verify against header</li>
</ol>
<h3 id="4-storage-layer"><a class="header" href="#4-storage-layer">4. Storage Layer</a></h3>
<p><strong>Store</strong> (<code>crates/storage</code>)</p>
<ul>
<li>High-level API for all blockchain data</li>
<li>Supports multiple backends: InMemory (testing), RocksDB (production)</li>
<li>Manages block headers, bodies, receipts, and state</li>
</ul>
<p><strong>State Trie</strong> (<code>crates/common/trie</code>)</p>
<ul>
<li>Merkle Patricia Trie implementation</li>
<li>Stores account states and contract storage</li>
<li>Supports flat key-value storage for performance</li>
<li>Handles trie node caching and persistence</li>
</ul>
<h2 id="data-flow"><a class="header" href="#data-flow">Data Flow</a></h2>
<h3 id="block-import-from-p2p"><a class="header" href="#block-import-from-p2p">Block Import (from P2P)</a></h3>
<pre><code>P2P Peer → Block Headers/Bodies → Syncer → Blockchain.add_block() → EVM.execute() → Store
</code></pre>
<ol>
<li>Syncer requests headers from peers</li>
<li>Headers are validated (parent exists, timestamps, gas limits, etc.)</li>
<li>Bodies are requested and matched to headers</li>
<li>Blocks are executed in batches</li>
<li>State is committed to storage</li>
</ol>
<h3 id="block-import-from-consensus-client"><a class="header" href="#block-import-from-consensus-client">Block Import (from Consensus Client)</a></h3>
<pre><code>Consensus Client → engine_newPayloadV3 → Blockchain.add_block_pipeline() → EVM.execute() → Store
                 → engine_forkchoiceUpdated → Fork Choice Update → Canonical Chain Update
</code></pre>
<ol>
<li>Consensus client sends new payload via Engine API</li>
<li>Block is validated and executed</li>
<li>Fork choice update makes the block canonical</li>
<li>Sync is triggered if the block's parent is unknown</li>
</ol>
<h3 id="transaction-lifecycle"><a class="header" href="#transaction-lifecycle">Transaction Lifecycle</a></h3>
<pre><code>User → JSON-RPC (eth_sendRawTransaction) → Mempool → Broadcast to Peers
                                                   → Include in Block
</code></pre>
<ol>
<li>Transaction arrives via JSON-RPC or P2P</li>
<li>Validated for signature, nonce, balance, gas</li>
<li>Added to mempool if valid</li>
<li>Broadcast to connected peers</li>
<li>Eventually included in a block by the payload builder</li>
</ol>
<h2 id="sync-modes-1"><a class="header" href="#sync-modes-1">Sync Modes</a></h2>
<h3 id="full-sync"><a class="header" href="#full-sync">Full Sync</a></h3>
<p>Downloads and executes every block from genesis (or a known checkpoint):</p>
<ol>
<li>Request block headers from peers</li>
<li>Request block bodies for each header</li>
<li>Execute blocks in batches (1024 blocks per batch)</li>
<li>Commit state after each batch</li>
<li>Update fork choice when sync head is reached</li>
</ol>
<h3 id="snap-sync"><a class="header" href="#snap-sync">Snap Sync</a></h3>
<p>Downloads state directly instead of executing all historical blocks:</p>
<ol>
<li>Download block headers to find a recent "pivot" block</li>
<li>Download account state trie leaves via snap protocol</li>
<li>Download storage tries for accounts with storage</li>
<li>Heal any missing trie nodes (state may have changed during download)</li>
<li>Download bytecode for contract accounts</li>
<li>Execute recent blocks (post-pivot) to catch up</li>
</ol>
<p>See <a href="l1/architecture/./sync_state_machine.html">Sync State Machine</a> for detailed documentation.</p>
<h2 id="concurrency-model"><a class="header" href="#concurrency-model">Concurrency Model</a></h2>
<p>ethrex uses Tokio for async I/O with the following patterns:</p>
<ul>
<li><strong>Async tasks</strong> for network I/O (RPC, P2P)</li>
<li><strong>Blocking tasks</strong> for CPU-intensive work (block execution, trie operations)</li>
<li><strong>Channels</strong> for inter-component communication (sync signals, mempool updates)</li>
<li><strong>RwLock/Mutex</strong> for shared state (mempool, peer table)</li>
</ul>
<h2 id="configuration-1"><a class="header" href="#configuration-1">Configuration</a></h2>
<p>Key configuration options:</p>
<div class="table-wrapper"><table><thead><tr><th>Option</th><th>Description</th><th>Default</th></tr></thead><tbody>
<tr><td><code>--network</code></td><td>Network to connect to</td><td><code>mainnet</code></td></tr>
<tr><td><code>--datadir</code></td><td>Data directory for DB and keys</td><td><code>~/.ethrex</code></td></tr>
<tr><td><code>--syncmode</code></td><td>Sync mode (<code>full</code> or <code>snap</code>)</td><td><code>snap</code></td></tr>
<tr><td><code>--authrpc.port</code></td><td>Engine API port</td><td><code>8551</code></td></tr>
<tr><td><code>--http.port</code></td><td>JSON-RPC HTTP port</td><td><code>8545</code></td></tr>
<tr><td><code>--discovery.port</code></td><td>P2P discovery port</td><td><code>30303</code></td></tr>
</tbody></table>
</div>
<p>See <a href="l1/architecture/../running/configuration.html">Configuration</a> for the complete reference.</p>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<ul>
<li><a href="l1/architecture/./block_execution.html">Block Execution Pipeline</a> - Deep dive into block processing</li>
<li><a href="l1/architecture/./sync_state_machine.html">Sync State Machine</a> - Detailed sync algorithm documentation</li>
<li><a href="l1/architecture/./crate_map.html">Crate Map</a> - Overview of all crates and dependencies</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="block-execution-pipeline"><a class="header" href="#block-execution-pipeline">Block Execution Pipeline</a></h1>
<p>This document describes how ethrex validates and executes blocks, from receiving a block to committing state changes.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>Block execution in ethrex follows the Ethereum specification closely. The pipeline handles:</p>
<ol>
<li>Block header validation</li>
<li>System-level operations (beacon root contract, block hash storage)</li>
<li>Transaction execution</li>
<li>Withdrawal processing</li>
<li>Request extraction (post-Prague)</li>
<li>State root verification</li>
</ol>
<h2 id="entry-points"><a class="header" href="#entry-points">Entry Points</a></h2>
<p>Blocks enter the execution pipeline through two main paths:</p>
<h3 id="1-p2p-sync-syncer"><a class="header" href="#1-p2p-sync-syncer">1. P2P Sync (<code>Syncer</code>)</a></h3>
<p>During synchronization, blocks are fetched from peers and executed in batches:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/networking/p2p/sync.rs
Syncer::add_blocks() → Blockchain::add_blocks_in_batch() → execute each block
<span class="boring">}</span></code></pre></pre>
<h3 id="2-engine-api-engine_newpayloadv123"><a class="header" href="#2-engine-api-engine_newpayloadv123">2. Engine API (<code>engine_newPayloadV{1,2,3}</code>)</a></h3>
<p>Post-Merge, the consensus client sends new blocks via the Engine API:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/networking/rpc/engine/payload.rs
NewPayloadV3::handle() → Blockchain::add_block() → execute block
<span class="boring">}</span></code></pre></pre>
<h2 id="block-header-validation"><a class="header" href="#block-header-validation">Block Header Validation</a></h2>
<p>Before executing a block, its header is validated:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/blockchain/blockchain.rs
fn validate_header(header: &amp;BlockHeader, parent: &amp;BlockHeader) -&gt; Result&lt;()&gt;
<span class="boring">}</span></code></pre></pre>
<h3 id="validation-checks"><a class="header" href="#validation-checks">Validation Checks</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Check</th><th>Description</th></tr></thead><tbody>
<tr><td>Parent hash</td><td>Must match parent block's hash</td></tr>
<tr><td>Block number</td><td>Must be parent.number + 1</td></tr>
<tr><td>Timestamp</td><td>Must be &gt; parent.timestamp</td></tr>
<tr><td>Gas limit</td><td>Must be within bounds of parent (EIP-1559)</td></tr>
<tr><td>Base fee</td><td>Must match calculated value (EIP-1559)</td></tr>
<tr><td>Difficulty</td><td>Must be 0 (post-Merge)</td></tr>
<tr><td>Nonce</td><td>Must be 0 (post-Merge)</td></tr>
<tr><td>Ommers hash</td><td>Must be empty hash (post-Merge)</td></tr>
<tr><td>Withdrawals root</td><td>Must match if Shanghai activated</td></tr>
<tr><td>Blob gas fields</td><td>Must be present if Cancun activated</td></tr>
<tr><td>Requests hash</td><td>Must match if Prague activated</td></tr>
</tbody></table>
</div>
<h2 id="execution-flow"><a class="header" href="#execution-flow">Execution Flow</a></h2>
<pre><code>┌─────────────────────────────────────────────────────────────────────┐
│                        Block Execution                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  1. ┌────────────────────────────────────────────────────────────┐  │
│     │             System Operations (post-Cancun)                 │  │
│     │  • Store beacon block root (EIP-4788)                       │  │
│     │  • Store parent block hash (EIP-2935)                       │  │
│     └────────────────────────────────────────────────────────────┘  │
│                              │                                       │
│                              ▼                                       │
│  2. ┌────────────────────────────────────────────────────────────┐  │
│     │              Transaction Execution                          │  │
│     │  For each transaction:                                      │  │
│     │  • Validate signature and nonce                             │  │
│     │  • Check sender balance                                     │  │
│     │  • Execute in EVM                                           │  │
│     │  • Apply gas refunds                                        │  │
│     │  • Update account states                                    │  │
│     │  • Generate receipt                                         │  │
│     └────────────────────────────────────────────────────────────┘  │
│                              │                                       │
│                              ▼                                       │
│  3. ┌────────────────────────────────────────────────────────────┐  │
│     │              Withdrawal Processing (post-Shanghai)          │  │
│     │  For each withdrawal:                                       │  │
│     │  • Credit validator address with withdrawal amount          │  │
│     └────────────────────────────────────────────────────────────┘  │
│                              │                                       │
│                              ▼                                       │
│  4. ┌────────────────────────────────────────────────────────────┐  │
│     │              Request Extraction (post-Prague)               │  │
│     │  • Deposit requests from logs                               │  │
│     │  • Withdrawal requests from system contract                 │  │
│     │  • Consolidation requests from system contract              │  │
│     └────────────────────────────────────────────────────────────┘  │
│                              │                                       │
│                              ▼                                       │
│  5. ┌────────────────────────────────────────────────────────────┐  │
│     │                  State Finalization                         │  │
│     │  • Compute state root from account updates                  │  │
│     │  • Verify against header.state_root                         │  │
│     │  • Commit changes to storage                                │  │
│     └────────────────────────────────────────────────────────────┘  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="transaction-execution"><a class="header" href="#transaction-execution">Transaction Execution</a></h2>
<p>Each transaction goes through the following steps:</p>
<h3 id="1-pre-execution-validation"><a class="header" href="#1-pre-execution-validation">1. Pre-Execution Validation</a></h3>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/blockchain/validate.rs
fn validate_transaction(tx: &amp;Transaction, header: &amp;BlockHeader) -&gt; Result&lt;()&gt;
<span class="boring">}</span></code></pre></pre>
<ul>
<li>Signature recovery and validation</li>
<li>Nonce check (must match account nonce)</li>
<li>Gas limit check (must be &lt;= block gas remaining)</li>
<li>Balance check (must cover <code>gas_limit * gas_price + value</code>)</li>
<li>Intrinsic gas calculation</li>
<li>EIP-2930 access list validation</li>
<li>EIP-4844 blob validation (if applicable)</li>
</ul>
<h3 id="2-evm-execution"><a class="header" href="#2-evm-execution">2. EVM Execution</a></h3>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/vm/levm/src/vm.rs
VM::execute() → Result&lt;ExecutionReport&gt;
<span class="boring">}</span></code></pre></pre>
<p>The EVM executes the transaction bytecode:</p>
<ol>
<li><strong>Contract Call</strong>: Execute target contract code</li>
<li><strong>Contract Creation</strong>: Deploy new contract, execute constructor</li>
<li><strong>Transfer</strong>: Simple value transfer (no code execution)</li>
</ol>
<p>During execution:</p>
<ul>
<li>Opcodes are decoded and executed</li>
<li>Gas is consumed for each operation</li>
<li>State changes are tracked (but not committed)</li>
<li>Logs are collected</li>
<li>Errors revert all changes</li>
</ul>
<h3 id="3-post-execution"><a class="header" href="#3-post-execution">3. Post-Execution</a></h3>
<p>After EVM execution:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/vm/levm/src/vm.rs
fn finalize_transaction() -&gt; Receipt
<span class="boring">}</span></code></pre></pre>
<ul>
<li>Calculate gas refund (max 1/5 of gas used, post-London)</li>
<li>Credit coinbase with priority fee</li>
<li>Generate receipt with logs and status</li>
<li>Update cumulative gas used</li>
</ul>
<h2 id="state-management"><a class="header" href="#state-management">State Management</a></h2>
<h3 id="account-updates"><a class="header" href="#account-updates">Account Updates</a></h3>
<p>State changes are tracked as <code>AccountUpdate</code> structs:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct AccountUpdate {
    pub address: Address,
    pub removed: bool,
    pub info: Option&lt;AccountInfo&gt;,       // balance, nonce, code_hash
    pub code: Option&lt;Bytes&gt;,             // bytecode if changed
    pub added_storage: HashMap&lt;H256, U256&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="state-root-computation"><a class="header" href="#state-root-computation">State Root Computation</a></h3>
<p>After all transactions execute:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/storage/store.rs
Store::apply_account_updates_batch(parent_hash, updates) -&gt; StateTrieHash
<span class="boring">}</span></code></pre></pre>
<p>This is one of the two merkelization backends (the other is used by <code>add_block_pipeline</code>):</p>
<ol>
<li>Load parent state trie</li>
<li>Apply each account update to the trie</li>
<li>For accounts with storage changes, update storage tries</li>
<li>Compute new state root</li>
<li>Verify it matches <code>header.state_root</code></li>
</ol>
<h2 id="payload-building"><a class="header" href="#payload-building">Payload Building</a></h2>
<p>When ethrex acts as a block producer (validator), it builds payloads:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/blockchain/payload.rs
Blockchain::build_payload(template: Block) -&gt; PayloadBuildResult
<span class="boring">}</span></code></pre></pre>
<h3 id="building-process"><a class="header" href="#building-process">Building Process</a></h3>
<ol>
<li>
<p><strong>Fetch transactions</strong> from mempool, filtered by:</p>
<ul>
<li>Base fee (must afford current base fee)</li>
<li>Blob fee (for EIP-4844 transactions)</li>
<li>Nonce ordering (consecutive nonces per sender)</li>
</ul>
</li>
<li>
<p><strong>Order transactions</strong> by effective tip (highest first)</p>
</li>
<li>
<p><strong>Execute transactions</strong> until:</p>
<ul>
<li>Block gas limit reached</li>
<li>No more valid transactions</li>
<li>Blob limit reached (for blob transactions)</li>
</ul>
</li>
<li>
<p><strong>Finalize block</strong>:</p>
<ul>
<li>Apply withdrawals</li>
<li>Extract requests</li>
<li>Compute state root</li>
<li>Compute receipts root</li>
<li>Generate logs bloom</li>
</ul>
</li>
</ol>
<h3 id="payload-rebuilding"><a class="header" href="#payload-rebuilding">Payload Rebuilding</a></h3>
<p>Payloads are rebuilt continuously until requested:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/blockchain/payload.rs
Blockchain::build_payload_loop(payload, cancel_token)
<span class="boring">}</span></code></pre></pre>
<p>This maximizes MEV by including the most profitable transactions available.</p>
<h2 id="error-handling"><a class="header" href="#error-handling">Error Handling</a></h2>
<p>Block execution can fail for various reasons:</p>
<div class="table-wrapper"><table><thead><tr><th>Error</th><th>Cause</th><th>Recovery</th></tr></thead><tbody>
<tr><td><code>InvalidBlock::InvalidStateRoot</code></td><td>Computed state root doesn't match header</td><td>Reject block</td></tr>
<tr><td><code>InvalidBlock::InvalidGasUsed</code></td><td>Gas used doesn't match header</td><td>Reject block</td></tr>
<tr><td><code>InvalidBlock::InvalidTransaction</code></td><td>Transaction validation failed</td><td>Reject block</td></tr>
<tr><td><code>EvmError::OutOfGas</code></td><td>Transaction ran out of gas</td><td>Revert transaction, continue block</td></tr>
<tr><td><code>EvmError::InvalidOpcode</code></td><td>Unknown opcode encountered</td><td>Revert transaction, continue block</td></tr>
</tbody></table>
</div>
<h2 id="performance-considerations"><a class="header" href="#performance-considerations">Performance Considerations</a></h2>
<h3 id="batch-execution"><a class="header" href="#batch-execution">Batch Execution</a></h3>
<p>During sync, blocks are executed in batches (default 1024 blocks):</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/networking/p2p/sync.rs
const EXECUTE_BATCH_SIZE: usize = 1024;
<span class="boring">}</span></code></pre></pre>
<p>This reduces database commits and improves throughput.</p>
<h3 id="parallel-trie-operations"><a class="header" href="#parallel-trie-operations">Parallel Trie Operations</a></h3>
<p>Storage trie updates can be parallelized across accounts:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Uses rayon for parallel iteration
account_updates.par_iter().map(|update| update_storage_trie(update))
<span class="boring">}</span></code></pre></pre>
<h3 id="state-caching"><a class="header" href="#state-caching">State Caching</a></h3>
<p>The EVM maintains a cache of accessed accounts and storage slots to minimize database reads during execution.</p>
<h2 id="hard-fork-handling"><a class="header" href="#hard-fork-handling">Hard Fork Handling</a></h2>
<p>Block execution adapts based on the active hard fork:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/common/types/chain_config.rs
impl ChainConfig {
    pub fn fork(&amp;self, timestamp: u64) -&gt; Fork { ... }
    pub fn is_cancun_activated(&amp;self, timestamp: u64) -&gt; bool { ... }
    pub fn is_prague_activated(&amp;self, timestamp: u64) -&gt; bool { ... }
}
<span class="boring">}</span></code></pre></pre>
<p>Each fork may introduce:</p>
<ul>
<li>New opcodes (e.g., <code>PUSH0</code> in Shanghai)</li>
<li>New precompiles (e.g., point evaluation in Cancun)</li>
<li>New system contracts (e.g., beacon root contract in Cancun)</li>
<li>Changed gas costs</li>
<li>New transaction types</li>
</ul>
<h2 id="related-documentation"><a class="header" href="#related-documentation">Related Documentation</a></h2>
<ul>
<li><a href="l1/architecture/../../vm/levm/debug.html">LEVM Documentation</a> - EVM implementation details</li>
<li><a href="l1/architecture/./sync_state_machine.html">Sync State Machine</a> - How blocks flow during sync</li>
<li><a href="l1/architecture/./crate_map.html">Crate Map</a> - Overview of involved crates</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="sync-state-machine"><a class="header" href="#sync-state-machine">Sync State Machine</a></h1>
<p>This document describes the synchronization algorithms implemented in ethrex, including full sync and snap sync.</p>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<p>ethrex supports two synchronization modes:</p>
<div class="table-wrapper"><table><thead><tr><th>Mode</th><th>Description</th><th>Use Case</th></tr></thead><tbody>
<tr><td><strong>Full Sync</strong></td><td>Downloads and executes every block</td><td>Maximum security, slower</td></tr>
<tr><td><strong>Snap Sync</strong></td><td>Downloads state directly, executes recent blocks</td><td>Faster initial sync</td></tr>
</tbody></table>
</div>
<h2 id="sync-manager-architecture"><a class="header" href="#sync-manager-architecture">Sync Manager Architecture</a></h2>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                        SyncManager                               │
│  • Receives sync targets from Engine API / P2P                   │
│  • Tracks current sync mode (Full / Snap)                        │
│  • Coordinates Syncer for actual sync work                       │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                          Syncer                                  │
│  • Executes sync cycles                                          │
│  • Manages peer connections via PeerHandler                      │
│  • Handles both full and snap sync algorithms                    │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="sync-triggers"><a class="header" href="#sync-triggers">Sync Triggers</a></h2>
<p>Synchronization is triggered by:</p>
<ol>
<li><strong>Engine API</strong>: <code>engine_forkchoiceUpdated</code> with unknown head hash</li>
<li><strong>P2P</strong>: Receiving block announcements for unknown blocks</li>
<li><strong>Startup</strong>: When local chain is behind network</li>
</ol>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/networking/rpc/engine/fork_choice.rs
match apply_fork_choice(...) {
    Err(InvalidForkChoice::Syncing) =&gt; {
        syncer.sync_to_head(fork_choice_state.head_block_hash);
        // Return SYNCING status to consensus client
    }
}
<span class="boring">}</span></code></pre></pre>
<h2 id="full-sync-algorithm"><a class="header" href="#full-sync-algorithm">Full Sync Algorithm</a></h2>
<p>Full sync downloads blocks from the network and executes each one to reconstruct the state.</p>
<h3 id="state-machine"><a class="header" href="#state-machine">State Machine</a></h3>
<pre><code>                    ┌─────────────────┐
                    │   START SYNC    │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
         ┌─────────│  Request Headers │◄─────────────┐
         │         └────────┬────────┘              │
         │                  │                        │
         │                  ▼                        │
         │         ┌─────────────────┐              │
         │         │ Validate Headers│              │
         │         └────────┬────────┘              │
         │                  │                        │
         │                  ▼                        │
         │         ┌─────────────────┐              │
         │         │ Found Canonical │──No──────────┘
         │         │   Ancestor?     │
         │         └────────┬────────┘
         │                  │ Yes
         │                  ▼
         │         ┌─────────────────┐
         │         │  Request Bodies │◄─────────────┐
         │         └────────┬────────┘              │
         │                  │                        │
         │                  ▼                        │
         │         ┌─────────────────┐              │
         │         │ Execute Batch   │              │
         │         │ (1024 blocks)   │              │
         │         └────────┬────────┘              │
         │                  │                        │
         │                  ▼                        │
         │         ┌─────────────────┐              │
         │         │  More Blocks?   │──Yes─────────┘
         │         └────────┬────────┘
         │                  │ No
         │                  ▼
         │         ┌─────────────────┐
         └─Error───│   SYNC DONE     │
                   └─────────────────┘
</code></pre>
<h3 id="algorithm-details"><a class="header" href="#algorithm-details">Algorithm Details</a></h3>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/networking/p2p/sync.rs
async fn sync_cycle_full(sync_head: H256, store: Store) -&gt; Result&lt;()&gt;
<span class="boring">}</span></code></pre></pre>
<ol>
<li>
<p><strong>Find Chain Link</strong></p>
<ul>
<li>Request headers backwards from sync_head</li>
<li>Stop when reaching a canonical block (already known)</li>
<li>This identifies the fork point</li>
</ul>
</li>
<li>
<p><strong>Store Headers</strong></p>
<ul>
<li>Save all new headers to temporary storage</li>
<li>Headers are stored in batches during download</li>
</ul>
</li>
<li>
<p><strong>Download Bodies</strong></p>
<ul>
<li>Request bodies for stored headers</li>
<li>Match bodies to headers by hash</li>
<li>Maximum 64 bodies per request</li>
</ul>
</li>
<li>
<p><strong>Execute Blocks</strong></p>
<ul>
<li>Execute in batches of 1024 blocks</li>
<li>Each block is fully validated and executed</li>
<li>State is committed after each batch</li>
</ul>
</li>
<li>
<p><strong>Update Fork Choice</strong></p>
<ul>
<li>After all blocks executed, update canonical chain</li>
<li>Set new head, safe, and finalized blocks</li>
</ul>
</li>
</ol>
<h3 id="key-constants"><a class="header" href="#key-constants">Key Constants</a></h3>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>const EXECUTE_BATCH_SIZE: usize = 1024;      // Blocks per execution batch
const MAX_BLOCK_BODIES_TO_REQUEST: usize = 64; // Bodies per request
<span class="boring">}</span></code></pre></pre>
<h2 id="snap-sync-algorithm"><a class="header" href="#snap-sync-algorithm">Snap Sync Algorithm</a></h2>
<p>Snap sync downloads state directly from peers instead of executing all historical blocks.</p>
<h3 id="state-machine-1"><a class="header" href="#state-machine-1">State Machine</a></h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                           SNAP SYNC STATE MACHINE                            │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │  START SNAP  │
    │    SYNC      │
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐     ┌─────────────────────────────────────────────────────┐
    │   Download   │     │  Download headers to find sync head                  │
    │   Headers    │────▶│  Store hashes for later body download               │
    └──────┬───────┘     └─────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────┐     ┌─────────────────────────────────────────────────────┐
    │ Select Pivot │────▶│  Choose recent block as pivot (must not be stale)   │
    │    Block     │     │  Pivot block is target for state download           │
    └──────┬───────┘     └─────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────┐     ┌─────────────────────────────────────────────────────┐
    │  Download    │────▶│  Request account ranges via SNAP protocol           │
    │  Accounts    │     │  Store account states to disk as snapshots          │
    └──────┬───────┘     └─────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────┐     ┌─────────────────────────────────────────────────────┐
    │   Insert     │────▶│  Build account trie from downloaded leaves          │
    │  Accounts    │     │  Identify accounts with non-empty storage           │
    └──────┬───────┘     └─────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────┐     ┌─────────────────────────────────────────────────────┐
    │  Download    │────▶│  For each account with storage:                     │
    │  Storage     │     │  Request storage ranges and build storage tries.    │
    │              │     │  Includes a healing loop to fix state trie changes. │
    └──────┬───────┘     └─────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────┐     ┌─────────────────────────────────────────────────────┐
    │    Heal      │────▶│  Heal state trie (fill missing nodes)               │
    │    Tries     │     │  Heal storage tries for modified accounts           │
    └──────┬───────┘     └─────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────┐     ┌─────────────────────────────────────────────────────┐
    │  Download    │────▶│  Download bytecode for all contract accounts        │
    │  Bytecode    │     │  Match by code hash                                 │
    └──────┬───────┘     └─────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────┐
    │  SNAP SYNC   │
    │   COMPLETE   │
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐     ┌─────────────────────────────────────────────────────┐
    │   Switch to  │────▶│  Execute recent blocks from pivot to head           │
    │  Full Sync   │     │  Continue with full sync for new blocks             │
    └──────────────┘     └─────────────────────────────────────────────────────┘
</code></pre>
<h3 id="phase-1-header-download"><a class="header" href="#phase-1-header-download">Phase 1: Header Download</a></h3>
<p>Download all block headers from current head to sync target:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/networking/p2p/sync.rs
async fn sync_cycle_snap(sync_head: H256, store: Store) -&gt; Result&lt;()&gt;
<span class="boring">}</span></code></pre></pre>
<ul>
<li>Request headers in batches</li>
<li>Store header hashes for later use</li>
<li>Identify pivot block (recent block whose state we'll download)</li>
</ul>
<h3 id="phase-2-pivot-selection"><a class="header" href="#phase-2-pivot-selection">Phase 2: Pivot Selection</a></h3>
<p>The pivot block must be:</p>
<ul>
<li>Recent enough to have state available on peers</li>
<li>Not "stale" (older than SNAP_LIMIT * 12 seconds)</li>
</ul>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/networking/p2p/sync.rs
fn block_is_stale(header: &amp;BlockHeader) -&gt; bool {
    calculate_staleness_timestamp(header.timestamp) &lt; current_unix_time()
}

const SNAP_LIMIT: usize = 128; // Blocks before pivot is considered stale
<span class="boring">}</span></code></pre></pre>
<p>If the pivot becomes stale during sync, a new pivot is selected:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn update_pivot(block_number: u64, ...) -&gt; Result&lt;BlockHeader&gt;
<span class="boring">}</span></code></pre></pre>
<h3 id="phase-3-account-download"><a class="header" href="#phase-3-account-download">Phase 3: Account Download</a></h3>
<p>Download all account states at the pivot block:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Uses SNAP protocol GetAccountRange messages
peers.request_account_range(start_hash, end_hash, snapshot_dir, pivot_header)
<span class="boring">}</span></code></pre></pre>
<ul>
<li>Accounts are saved to disk as RLP-encoded snapshots</li>
<li>Each snapshot file contains a batch of (hash, account_state) pairs</li>
<li>Process tracks code hashes for later bytecode download</li>
</ul>
<h3 id="phase-4-account-trie-construction"><a class="header" href="#phase-4-account-trie-construction">Phase 4: Account Trie Construction</a></h3>
<p>Build the account state trie from downloaded leaves:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn insert_accounts(store, storage_accounts, snapshots_dir, ...) -&gt; (H256, accounts_with_storage)
<span class="boring">}</span></code></pre></pre>
<p>For RocksDB backend:</p>
<ul>
<li>Ingest snapshot files directly via SST ingestion</li>
<li>Build trie using sorted insertion algorithm</li>
<li>Track accounts with non-empty storage root</li>
</ul>
<h3 id="phase-5-storage-download"><a class="header" href="#phase-5-storage-download">Phase 5: Storage Download</a></h3>
<p>For each account with storage, download storage slots:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>peers.request_storage_ranges(storage_accounts, snapshots_dir, chunk_index, pivot_header)
<span class="boring">}</span></code></pre></pre>
<ul>
<li>Multiple accounts can be requested per message</li>
<li>Large accounts are downloaded in chunks</li>
<li>"Big accounts" (&gt;4096 slots) are marked for healing instead</li>
</ul>
<h3 id="phase-6-trie-healing"><a class="header" href="#phase-6-trie-healing">Phase 6: Trie Healing</a></h3>
<p>State may have changed while downloading. Healing fixes inconsistencies:</p>
<p><strong>State Trie Healing:</strong></p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn heal_state_trie_wrap(state_root, store, peers, deadline, ...) -&gt; bool
<span class="boring">}</span></code></pre></pre>
<ul>
<li>Walk trie from root</li>
<li>Request missing nodes from peers</li>
<li>Fill in gaps caused by state changes</li>
</ul>
<p><strong>Storage Trie Healing:</strong></p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn heal_storage_trie(state_root, accounts, peers, store, ...) -&gt; bool
<span class="boring">}</span></code></pre></pre>
<ul>
<li>For each account marked for healing</li>
<li>Request missing storage trie nodes</li>
<li>Verify storage roots match account state</li>
</ul>
<h3 id="phase-7-bytecode-download"><a class="header" href="#phase-7-bytecode-download">Phase 7: Bytecode Download</a></h3>
<p>Download contract bytecode:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>peers.request_bytecodes(&amp;code_hashes)
<span class="boring">}</span></code></pre></pre>
<ul>
<li>Code hashes collected during account download</li>
<li>Bytecode downloaded in chunks (50,000 per batch)</li>
<li>Verified by hashing and comparing to code_hash</li>
</ul>
<h3 id="phase-8-transition-to-full-sync"><a class="header" href="#phase-8-transition-to-full-sync">Phase 8: Transition to Full Sync</a></h3>
<p>After snap sync completes:</p>
<ol>
<li>Store pivot block body</li>
<li>Update fork choice to pivot</li>
<li>Switch sync mode to Full</li>
<li>Execute any remaining blocks normally</li>
</ol>
<h2 id="p2p-protocols-used"><a class="header" href="#p2p-protocols-used">P2P Protocols Used</a></h2>
<h3 id="eth68-protocol"><a class="header" href="#eth68-protocol">eth/68 Protocol</a></h3>
<p>Used for block header and body download:</p>
<div class="table-wrapper"><table><thead><tr><th>Message</th><th>Purpose</th></tr></thead><tbody>
<tr><td><code>GetBlockHeaders</code></td><td>Request headers by number or hash</td></tr>
<tr><td><code>BlockHeaders</code></td><td>Response with headers</td></tr>
<tr><td><code>GetBlockBodies</code></td><td>Request bodies by hash</td></tr>
<tr><td><code>BlockBodies</code></td><td>Response with bodies</td></tr>
</tbody></table>
</div>
<h3 id="snap1-protocol"><a class="header" href="#snap1-protocol">snap/1 Protocol</a></h3>
<p>Used for state download during snap sync:</p>
<div class="table-wrapper"><table><thead><tr><th>Message</th><th>Purpose</th></tr></thead><tbody>
<tr><td><code>GetAccountRange</code></td><td>Request accounts in hash range</td></tr>
<tr><td><code>AccountRange</code></td><td>Response with accounts and proof</td></tr>
<tr><td><code>GetStorageRanges</code></td><td>Request storage for accounts</td></tr>
<tr><td><code>StorageRanges</code></td><td>Response with storage and proofs</td></tr>
<tr><td><code>GetByteCodes</code></td><td>Request bytecode by hash</td></tr>
<tr><td><code>ByteCodes</code></td><td>Response with bytecode</td></tr>
<tr><td><code>GetTrieNodes</code></td><td>Request specific trie nodes</td></tr>
<tr><td><code>TrieNodes</code></td><td>Response with nodes</td></tr>
</tbody></table>
</div>
<h2 id="error-recovery"><a class="header" href="#error-recovery">Error Recovery</a></h2>
<h3 id="recoverable-errors"><a class="header" href="#recoverable-errors">Recoverable Errors</a></h3>
<p>These errors cause sync to retry:</p>
<ul>
<li>Peer disconnection</li>
<li>Invalid response from peer</li>
<li>Timeout waiting for response</li>
<li>Database errors (transient)</li>
</ul>
<h3 id="non-recoverable-errors"><a class="header" href="#non-recoverable-errors">Non-Recoverable Errors</a></h3>
<p>These errors cause sync to abort with warning:</p>
<ul>
<li>Snapshot file corruption</li>
<li>Database corruption</li>
<li>State root mismatch after healing</li>
</ul>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/networking/p2p/sync.rs
impl SyncError {
    pub fn is_recoverable(&amp;self) -&gt; bool {
        match self {
            SyncError::Chain(_) | SyncError::Store(_) | ... =&gt; true,
            SyncError::CorruptDB | SyncError::SnapshotDecodeError(_) | ... =&gt; false,
        }
    }
}
<span class="boring">}</span></code></pre></pre>
<h2 id="performance-optimizations"><a class="header" href="#performance-optimizations">Performance Optimizations</a></h2>
<h3 id="parallel-operations"><a class="header" href="#parallel-operations">Parallel Operations</a></h3>
<ul>
<li>Account trie insertion uses Rayon for parallelism</li>
<li>Storage tries built in parallel across accounts</li>
<li>Bytecode downloads are batched</li>
</ul>
<h3 id="disk-io"><a class="header" href="#disk-io">Disk I/O</a></h3>
<ul>
<li>Snapshot files written in batches to reduce writes</li>
<li>RocksDB SST ingestion for fast account loading</li>
<li>Temporary directories cleaned up after sync</li>
</ul>
<h3 id="network"><a class="header" href="#network">Network</a></h3>
<ul>
<li>Multiple peers used concurrently</li>
<li>Peer scoring based on response time and validity</li>
<li>Automatic peer rotation for failed requests</li>
</ul>
<h2 id="metrics"><a class="header" href="#metrics">Metrics</a></h2>
<p>Sync progress is tracked via metrics:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/networking/p2p/metrics.rs
METRICS.account_tries_inserted     // Accounts added to trie
METRICS.storage_leaves_inserted    // Storage slots added
METRICS.current_step               // Current sync phase
METRICS.sync_head_hash             // Current sync target
<span class="boring">}</span></code></pre></pre>
<h2 id="configuration-2"><a class="header" href="#configuration-2">Configuration</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Option</th><th>Description</th><th>Default</th></tr></thead><tbody>
<tr><td><code>--syncmode</code></td><td>Sync mode (<code>full</code> or <code>snap</code>)</td><td><code>snap</code></td></tr>
<tr><td><code>EXECUTE_BATCH_SIZE</code></td><td>Blocks per batch (env var)</td><td>1024</td></tr>
<tr><td><code>MIN_FULL_BLOCKS</code></td><td>Min blocks to full sync in snap mode</td><td>10,000</td></tr>
</tbody></table>
</div>
<h2 id="related-documentation-1"><a class="header" href="#related-documentation-1">Related Documentation</a></h2>
<ul>
<li><a href="l1/architecture/../fundamentals/snap_sync.html">Snap Sync Internals</a> - Detailed snap sync documentation</li>
<li><a href="l1/architecture/./block_execution.html">Block Execution Pipeline</a> - How blocks are executed</li>
<li><a href="l1/architecture/../fundamentals/networking.html">Networking</a> - P2P protocol details</li>
</ul>
<blockquote>
<p><strong>Note:</strong> For comprehensive snap sync documentation, see <a href="l1/architecture/../fundamentals/snap_sync.html">Snap Sync Internals</a>.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="crate-map"><a class="header" href="#crate-map">Crate Map</a></h1>
<p>This document provides an overview of all crates in the ethrex monorepo and their responsibilities.</p>
<h2 id="crate-dependency-graph"><a class="header" href="#crate-dependency-graph">Crate Dependency Graph</a></h2>
<pre><code>                              ┌─────────────────────────────────────┐
                              │           cmd/ethrex                │
                              │      (Main binary entry point)      │
                              └───────────────┬─────────────────────┘
                                              │
                    ┌─────────────────────────┼─────────────────────────┐
                    │                         │                         │
                    ▼                         ▼                         ▼
        ┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
        │  networking/rpc   │     │  networking/p2p   │     │    blockchain     │
        │   (JSON-RPC API)  │     │  (P2P networking) │     │ (Chain management)│
        └─────────┬─────────┘     └─────────┬─────────┘     └─────────┬─────────┘
                  │                         │                         │
                  │                         │                         │
                  └─────────────────────────┼─────────────────────────┘
                                            │
                                            ▼
                              ┌─────────────────────────────┐
                              │           vm/levm           │
                              │    (EVM implementation)     │
                              └─────────────┬───────────────┘
                                            │
                                            ▼
                              ┌─────────────────────────────┐
                              │          storage            │
                              │     (Data persistence)      │
                              └─────────────┬───────────────┘
                                            │
                    ┌───────────────────────┼───────────────────────┐
                    │                       │                       │
                    ▼                       ▼                       ▼
        ┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐
        │    common/trie    │   │    common/rlp     │   │   common/types    │
        │ (Merkle Patricia) │   │ (RLP encoding)    │   │ (Core data types) │
        └───────────────────┘   └───────────────────┘   └───────────────────┘
</code></pre>
<h2 id="core-crates"><a class="header" href="#core-crates">Core Crates</a></h2>
<h3 id="ethrex-common"><a class="header" href="#ethrex-common"><code>ethrex-common</code></a></h3>
<p><strong>Purpose:</strong> Core data types and utilities shared across all crates.</p>
<p><strong>Key Modules:</strong></p>
<ul>
<li><code>types/</code> - Block, Transaction, Receipt, Account types</li>
<li><code>trie/</code> - Merkle Patricia Trie implementation</li>
<li><code>rlp/</code> - RLP encoding/decoding</li>
<li><code>crypto/</code> - Keccak hashing, signature recovery</li>
</ul>
<p><strong>Notable Types:</strong></p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Block { header: BlockHeader, body: BlockBody }
pub struct Transaction { /* variants for Legacy, EIP-2930, EIP-1559, EIP-4844, EIP-7702 */ }
pub struct AccountState { nonce: u64, balance: U256, storage_root: H256, code_hash: H256 }
<span class="boring">}</span></code></pre></pre>
<hr />
<h3 id="ethrex-storage"><a class="header" href="#ethrex-storage"><code>ethrex-storage</code></a></h3>
<p><strong>Purpose:</strong> Persistent storage layer with multiple backend support.</p>
<p><strong>Key Components:</strong></p>
<ul>
<li><code>Store</code> - High-level API for all blockchain data</li>
<li><code>StoreEngine</code> trait - Backend abstraction</li>
<li><code>InMemoryStore</code> - Testing backend</li>
<li><code>RocksDBStore</code> - Production backend</li>
</ul>
<p><strong>Stored Data:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Table</th><th>Contents</th></tr></thead><tbody>
<tr><td><code>block_numbers</code></td><td>Block hash → block number</td></tr>
<tr><td><code>canonical_block_hashes</code></td><td>Block number → canonical hash</td></tr>
<tr><td><code>headers</code></td><td>Block hash → BlockHeader</td></tr>
<tr><td><code>bodies</code></td><td>Block hash → BlockBody</td></tr>
<tr><td><code>receipts</code></td><td>Block hash + index → Receipt</td></tr>
<tr><td><code>account_trie_nodes</code></td><td>Node hash → trie node data</td></tr>
<tr><td><code>storage_trie_nodes</code></td><td>Node hash → trie node data</td></tr>
<tr><td><code>account_codes</code></td><td>Code hash → bytecode</td></tr>
<tr><td><code>account_flatkeyvalue</code></td><td>Account flat key-value store</td></tr>
<tr><td><code>storage_flatkeyvalue</code></td><td>Storage flat key-value store</td></tr>
</tbody></table>
</div>
<hr />
<h3 id="ethrex-blockchain"><a class="header" href="#ethrex-blockchain"><code>ethrex-blockchain</code></a></h3>
<p><strong>Purpose:</strong> Chain management, block validation, and mempool.</p>
<p><strong>Key Components:</strong></p>
<ul>
<li><code>Blockchain</code> - Main orchestrator for chain operations</li>
<li><code>Mempool</code> - Pending transaction pool</li>
<li><code>fork_choice</code> - Fork choice rule implementation</li>
<li><code>payload</code> - Block building for validators</li>
<li><code>validate</code> - Block and transaction validation</li>
</ul>
<p><strong>Public API:</strong></p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Blockchain {
    pub fn add_block(&amp;self, block: Block) -&gt; Result&lt;(), ChainError&gt;
    pub fn add_block_pipeline(&amp;self, block: Block) -&gt; Result&lt;(), ChainError&gt;
    pub fn validate_transaction(&amp;self, tx: &amp;Transaction) -&gt; Result&lt;(), MempoolError&gt;
    pub fn build_payload(&amp;self, template: Block) -&gt; Result&lt;PayloadBuildResult, ChainError&gt;
    pub fn get_payload(&amp;self, id: u64) -&gt; Result&lt;PayloadBuildResult, ChainError&gt;
}
<span class="boring">}</span></code></pre></pre>
<hr />
<h3 id="ethrex-vm--levm"><a class="header" href="#ethrex-vm--levm"><code>ethrex-vm</code> / <code>levm</code></a></h3>
<p><strong>Purpose:</strong> Ethereum Virtual Machine implementation.</p>
<p><strong>Key Components:</strong></p>
<ul>
<li><code>VM</code> - Main EVM execution engine</li>
<li><code>Evm</code> trait - VM interface for different contexts</li>
<li>Opcode handlers (one per EVM opcode)</li>
<li>Precompiled contracts</li>
<li>Gas metering</li>
</ul>
<p><strong>Execution Flow:</strong></p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl VM {
    pub fn execute(&amp;mut self) -&gt; Result&lt;ExecutionReport, VMError&gt;
    fn execute_opcode(&amp;mut self, opcode: u8) -&gt; Result&lt;(), VMError&gt;
    fn call(&amp;mut self, ...) -&gt; Result&lt;CallOutcome, VMError&gt;
    fn create(&amp;mut self, ...) -&gt; Result&lt;CreateOutcome, VMError&gt;
}
<span class="boring">}</span></code></pre></pre>
<hr />
<h3 id="ethrex-networkingrpc"><a class="header" href="#ethrex-networkingrpc"><code>ethrex-networking/rpc</code></a></h3>
<p><strong>Purpose:</strong> JSON-RPC API server.</p>
<p><strong>Supported Namespaces:</strong></p>
<ul>
<li><code>eth_*</code> - Standard Ethereum methods</li>
<li><code>debug_*</code> - Debugging and tracing</li>
<li><code>txpool_*</code> - Mempool inspection</li>
<li><code>admin_*</code> - Node administration</li>
<li><code>engine_*</code> - Consensus client communication</li>
<li><code>web3_*</code> - Web3 utilities</li>
</ul>
<p><strong>Architecture:</strong></p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait RpcHandler: Send + Sync {
    fn parse(params: &amp;Option&lt;Vec&lt;Value&gt;&gt;) -&gt; Result&lt;Self, RpcErr&gt;;
    async fn handle(&amp;self, context: RpcApiContext) -&gt; Result&lt;Value, RpcErr&gt;;
}
<span class="boring">}</span></code></pre></pre>
<hr />
<h3 id="ethrex-networkingp2p"><a class="header" href="#ethrex-networkingp2p"><code>ethrex-networking/p2p</code></a></h3>
<p><strong>Purpose:</strong> Peer-to-peer networking stack.</p>
<p><strong>Protocol Layers:</strong></p>
<ol>
<li><strong>DiscV4</strong> - Node discovery</li>
<li><strong>RLPx</strong> - Encrypted transport</li>
<li><strong>eth/68</strong> - Ethereum wire protocol</li>
<li><strong>snap/1</strong> - Snap sync protocol</li>
</ol>
<p><strong>Key Components:</strong></p>
<ul>
<li><code>PeerHandler</code> - Manages peer connections</li>
<li><code>PeerTable</code> - Tracks known peers and their scores</li>
<li><code>Syncer</code> - Synchronization state machine</li>
<li><code>SyncManager</code> - Coordinates sync operations</li>
</ul>
<hr />
<h2 id="supporting-crates"><a class="header" href="#supporting-crates">Supporting Crates</a></h2>
<h3 id="ethrex-commontrie"><a class="header" href="#ethrex-commontrie"><code>ethrex-common/trie</code></a></h3>
<p><strong>Purpose:</strong> Merkle Patricia Trie implementation.</p>
<p><strong>Features:</strong></p>
<ul>
<li>Standard MPT operations (get, insert, delete)</li>
<li>Proof generation and verification</li>
<li>Sorted insertion for snap sync</li>
<li>Flat key-value store integration</li>
</ul>
<hr />
<h3 id="ethrex-commonrlp"><a class="header" href="#ethrex-commonrlp"><code>ethrex-common/rlp</code></a></h3>
<p><strong>Purpose:</strong> Recursive Length Prefix encoding.</p>
<p><strong>Traits:</strong></p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait RLPEncode {
    fn encode(&amp;self, buf: &amp;mut dyn BufMut);
    fn encode_to_vec(&amp;self) -&gt; Vec&lt;u8&gt;;
}

pub trait RLPDecode: Sized {
    fn decode(rlp: &amp;[u8]) -&gt; Result&lt;Self, RLPDecodeError&gt;;
    fn decode_unfinished(rlp: &amp;[u8]) -&gt; Result&lt;(Self, &amp;[u8]), RLPDecodeError&gt;;
}
<span class="boring">}</span></code></pre></pre>
<hr />
<h3 id="ethrex-metrics"><a class="header" href="#ethrex-metrics"><code>ethrex-metrics</code></a></h3>
<p><strong>Purpose:</strong> Prometheus metrics collection.</p>
<p><strong>Metric Categories:</strong></p>
<ul>
<li>Block metrics (height, gas, execution time)</li>
<li>Transaction metrics (types, counts, errors)</li>
<li>P2P metrics (peers, messages, sync progress)</li>
<li>RPC metrics (requests, latency)</li>
</ul>
<hr />
<h3 id="ethrex-crypto"><a class="header" href="#ethrex-crypto"><code>ethrex-crypto</code></a></h3>
<p><strong>Purpose:</strong> Cryptographic primitives.</p>
<p><strong>Features:</strong></p>
<ul>
<li>Keccak-256 hashing</li>
<li>ECDSA signature recovery</li>
<li>BLS signatures (for beacon chain)</li>
</ul>
<hr />
<h2 id="l2-specific-crates"><a class="header" href="#l2-specific-crates">L2-Specific Crates</a></h2>
<h3 id="ethrex-l2"><a class="header" href="#ethrex-l2"><code>ethrex-l2</code></a></h3>
<p><strong>Purpose:</strong> L2 sequencer and prover integration.</p>
<p><strong>Components:</strong></p>
<ul>
<li>Sequencer logic</li>
<li>State diff computation</li>
<li>Prover interface</li>
<li>L1 interaction (deposits, withdrawals)</li>
</ul>
<hr />
<h3 id="ethrex-prover"><a class="header" href="#ethrex-prover"><code>ethrex-prover</code></a></h3>
<p><strong>Purpose:</strong> Zero-knowledge proof generation.</p>
<p><strong>Supported Provers:</strong></p>
<ul>
<li>SP1 (Succinct)</li>
<li>RISC0</li>
<li>TDX (Trusted Execution)</li>
</ul>
<hr />
<h2 id="test-and-development-crates"><a class="header" href="#test-and-development-crates">Test and Development Crates</a></h2>
<h3 id="ef-tests"><a class="header" href="#ef-tests"><code>ef-tests</code></a></h3>
<p><strong>Purpose:</strong> Ethereum Foundation test runner.</p>
<p>Runs official Ethereum tests to verify protocol compliance.</p>
<hr />
<h3 id="ethrex-dev"><a class="header" href="#ethrex-dev"><code>ethrex-dev</code></a></h3>
<p><strong>Purpose:</strong> Development mode utilities.</p>
<p>Features:</p>
<ul>
<li>Local development network</li>
<li>Block import from files</li>
<li>Test fixtures</li>
</ul>
<hr />
<h2 id="crate-features"><a class="header" href="#crate-features">Crate Features</a></h2>
<p>Many crates support feature flags:</p>
<div class="table-wrapper"><table><thead><tr><th>Crate</th><th>Feature</th><th>Effect</th></tr></thead><tbody>
<tr><td><code>ethrex-storage</code></td><td><code>rocksdb</code></td><td>Enable RocksDB backend</td></tr>
<tr><td><code>ethrex-blockchain</code></td><td><code>metrics</code></td><td>Enable Prometheus metrics</td></tr>
<tr><td><code>ethrex-networking/p2p</code></td><td><code>sync-test</code></td><td>Testing utilities for sync</td></tr>
<tr><td><code>ethrex-networking/p2p</code></td><td><code>experimental-discv5</code></td><td>Enable discv5 node discovery (experimental)</td></tr>
</tbody></table>
</div>
<h2 id="adding-new-functionality"><a class="header" href="#adding-new-functionality">Adding New Functionality</a></h2>
<p>When adding new features, consider:</p>
<ol>
<li>
<p><strong>Where does it belong?</strong></p>
<ul>
<li>Pure data types → <code>ethrex-common</code></li>
<li>Database operations → <code>ethrex-storage</code></li>
<li>EVM changes → <code>ethrex-vm</code></li>
<li>Chain logic → <code>ethrex-blockchain</code></li>
<li>API endpoints → <code>ethrex-networking/rpc</code></li>
<li>P2P messages → <code>ethrex-networking/p2p</code></li>
</ul>
</li>
<li>
<p><strong>Dependency direction</strong></p>
<ul>
<li>Lower-level crates should not depend on higher-level ones</li>
<li>Common types flow down, behaviors flow up</li>
</ul>
</li>
<li>
<p><strong>Testing</strong></p>
<ul>
<li>Unit tests in the crate</li>
<li>Integration tests in <code>tests/</code> directory</li>
<li>EF tests for protocol compliance</li>
</ul>
</li>
</ol>
<h2 id="related-documentation-2"><a class="header" href="#related-documentation-2">Related Documentation</a></h2>
<ul>
<li><a href="l1/architecture/./overview.html">System Overview</a> - How crates work together</li>
<li><a href="l1/architecture/./block_execution.html">Block Execution</a> - Execution flow across crates</li>
<li><a href="l1/architecture/./sync_state_machine.html">Sync State Machine</a> - Sync implementation details</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="fundamentals"><a class="header" href="#fundamentals">Fundamentals</a></h1>
<p>This section covers the core concepts and technical details behind ethrex as an Ethereum execution client. Here you'll find explanations about sync modes, networking, databases, security, and more.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>This section is a work in progress and will be updated with more content and examples soon.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="databases"><a class="header" href="#databases">Databases</a></h1>
<p>Ethrex uses a versioning system to ensure we don't run on invalid data if we restart the node after a breaking change to the DB structure. This system consists of a <code>STORE_SCHEMA_VERSION</code> constant, defined in <code>crates/storage/lib.rs</code> that must be increased after any breaking change and that is checked every time we start the node.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="networking"><a class="header" href="#networking">Networking</a></h1>
<p>The network crate handles the ethereum networking protocols. This involves:</p>
<ul>
<li><a href="l1/fundamentals/networking.html#discovery-protocol">Discovery protocol</a>: built on top of udp and it is how we discover new nodes.</li>
<li>devP2P: sits on top of tcp and is where the actual blockchain information exchange happens.</li>
</ul>
<p>Implementation follows the official spec which can be found <a href="https://github.com/ethereum/devp2p/tree/master">here</a>. Also, we've inspired in some <a href="https://github.com/ethereum/go-ethereum/tree/master/p2p/discover">geth code</a>.</p>
<h2 id="discovery-protocol"><a class="header" href="#discovery-protocol">Discovery protocol</a></h2>
<p>In the next section, we'll be looking at the discovery protocol (discv4 to be more specific) and the way we have it set up. There are many points for improvement and here we discuss some possible solutions to them.</p>
<p>At startup, the discovery server launches three concurrent tokio tasks:</p>
<ul>
<li>The listen loop for incoming requests.</li>
<li>A revalidation loop to ensure peers remain responsive.</li>
<li>A recursive lookup loop to request new peers and keep our table filled.</li>
</ul>
<p>Before starting these tasks, we run a <a href="l1/fundamentals/networking.html#startup">startup</a> process to connect to an array of initial nodes.</p>
<p>Before diving into what each task does, first, we need to understand how we are storing our nodes. Nodes are stored in an in-memory matrix which we call a <a href="https://github.com/lambdaclass/ethrex/blob/main/crates/networking/p2p/kademlia.rs#L25-L28">Kademlia table</a>, though it isn't really a Kademlia table as we don't thoroughly follow the spec but we take it as a reference, you can read more <a href="https://en.wikipedia.org/wiki/Kademlia">here</a>. This table holds:</p>
<ul>
<li>Our <code>node_id</code>: The node's unique identifier computed by obtaining the keccak hash of the 64 bytes starting from index 1 of the encoded pub key.</li>
<li>A vector of 256 <code>bucket</code>s which holds:
<ul>
<li><code>peers</code>: a vector of 16 elements of type <code>PeersData</code> where we save the node record and other related data that we'll see later.</li>
<li><code>replacements</code>: a vector of 16 elements of <code>PeersData</code> that are not connected to us, but we consider them as potential replacements for those nodes that have disconnected from us.</li>
</ul>
</li>
</ul>
<p>Peers are not assigned to any bucket but they are assigned based on its <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.136em;"></span><span class="mord text"><span class="mord">distance</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">255</span></span></span></span> to our <code>node_id</code>. Distance is defined by:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn distance(node_id_1: H512, node_id_2: H512) -&gt; usize {
    let xor = node_id_1 ^ node_id_2;
    let distance = U256::from_big_endian(xor.as_bytes());
    distance.bits().saturating_sub(1)
}
<span class="boring">}</span></code></pre></pre>
<h3 id="startup"><a class="header" href="#startup">Startup</a></h3>
<p>Before starting the server, we do a startup where we connect to an array of seeders or bootnodes. This involves:</p>
<ul>
<li>Receiving bootnodes via CLI params</li>
<li>Inserting them into our table</li>
<li>Pinging them to notify our presence, so they acknowledge us.</li>
</ul>
<p>This startup is far from being completed. The current state allows us to do basic tests and connections. Later, we want to do a real startup by first trying to connect to those nodes we were previously connected. For that, we'd need to store nodes on the database. If those nodes aren't enough to fill our table, then we also ping some bootnodes, which could be hardcoded or received through the cli. Current issues are opened regarding <a href="https://github.com/lambdaclass/ethrex/issues/398">startup</a> and <a href="https://github.com/lambdaclass/ethrex/issues/454">nodes db</a>.</p>
<h3 id="listen-loop"><a class="header" href="#listen-loop">Listen loop</a></h3>
<p>The listen loop handles messages sent to our socket. The spec defines 6 types of messages:</p>
<ul>
<li><strong>Ping</strong>: Responds with a <code>pong</code> message. If the peer is not in our table we add it, if the corresponding bucket is already filled then we add it as a replacement for that bucket. If it was inserted we send a `ping from our end to get an endpoint proof.</li>
<li><strong>Pong</strong>: Verifies that the <code>pong</code> corresponds to a previously sent <code>ping</code>, if so we mark the peer as proven.</li>
<li><strong>FindNodes</strong>: Responds with a <code>neighbors</code> message that contains as many as the 16 closest nodes from the given target. A target is a pubkey provided by the peer in the message. The response can't be sent in one packet as it might exceed the discv4 max packet size. So we split it into different packets.</li>
<li><strong>Neighbors</strong>: First we verify that we have sent the corresponding <code>find_node</code> message. If so, we receive the peers, store them, and ping them. Also, every <a href="https://github.com/lambdaclass/ethrex/blob/229ca0b316a79403412a917d04e3b95f579c56c7/crates/net/discv4.rs#L305-L314"><code>find_node</code> request</a> may have a <a href="https://docs.rs/tokio/latest/tokio/sync/mpsc/struct.Sender.html">tokio <code>Sender</code></a> attached, if that is the case, we forward the nodes from the message through the channel. This becomes useful when waiting for a <code>find_node</code> response, <a href="https://github.com/lambdaclass/ethrex/blob/229ca0b316a79403412a917d04e3b95f579c56c7/crates/net/net.rs#L517-L570">something we do in the lookups</a>.</li>
<li><strong>ENRRequest</strong>: currently not implemented see <a href="https://github.com/lambdaclass/ethrex/issues/432">here</a>.</li>
<li><strong>ENRResponse</strong>: same as above.</li>
</ul>
<h3 id="re-validations"><a class="header" href="#re-validations">Re-validations</a></h3>
<p>Re-validations are tasks that are implemented as intervals, that is: they run an action every <code>x</code> wherever unit of time (currently configured to run every 30 seconds). The current flow of re-validation is as follows</p>
<ol>
<li>Every 30 seconds (by default) we ping the three least recently pinged peers: this may be fine now to keep simplicity, but we might prefer to choose three random peers instead to avoid the search which might become expensive as our buckets start to fill with more peers.</li>
<li>In the next iteration we check if they have answered
<ul>
<li>if they have: we increment the liveness field by one.</li>
<li>otherwise: we decrement the liveness by a third of its value.</li>
</ul>
</li>
<li>If the liveness field is 0, we delete it and insert a new one from the replacements table.</li>
</ol>
<p>Liveness checks are not part of the spec but are taken from geth, see <a href="https://github.com/ethereum/go-ethereum/blob/master/p2p/discover/table_reval.go">here</a>. This field is useful because it provides us with good criteria of which nodes are connected and we "trust" more. This trustiness is useful when deciding if we want to store this node in the database to use it as a future seeder or when establishing a connection in p2p.</p>
<p>Re-validations are another point of potential improvement. While it may be fine for now to keep simplicity at max, pinging the last recently pinged peers becomes quite expensive as the number of peers in the table increases. And it also isn't very "just" in selecting nodes so that they get their liveness increased so we trust them more and we might consider them as a seeder. A possible improvement could be:</p>
<ul>
<li>Keep two lists: one for nodes that have already been pinged, and another one for nodes that have not yet been revalidated. Let's call the former "a" and the second "b".</li>
<li>In the beginning, all nodes would belong to "a" and whenever we insert a new node, they would be pushed to "a".</li>
<li>We would have two intervals: one for pinging "a" and another for pinging to nodes in "b". The "b" would be quicker, as no initial validation has been done.</li>
<li>When picking a node to ping, we would do it randomly, which is the best form of justice for a node to become trusted by us.</li>
<li>When a node from <code>b</code> responds successfully, we move it to <code>a</code>, and when one from <code>a</code> does not respond, we move it to <code>b</code>.</li>
</ul>
<p>This improvement follows somewhat what geth does, see <a href="https://github.com/ethereum/go-ethereum/blob/master/p2p/discover/table_reval.go">here</a>.</p>
<h3 id="recursive-lookups"><a class="header" href="#recursive-lookups">Recursive Lookups</a></h3>
<p>Recursive lookups are as with re-validations implemented as intervals. Their current flow is as follows:</p>
<ol>
<li>Every 30min we spawn three concurrent lookups: one closest to our pubkey and three others closest to randomly generated pubkeys.</li>
<li>Every lookup starts with the closest nodes from our table. Each lookup keeps track of:
<ul>
<li>Peers that have already been asked for nodes</li>
<li>Peers that have been already seen</li>
<li>Potential peers to query for nodes: a vector of up to 16 entries holding the closest peers to the pubkey. This vector is initially filled with nodes from our table.</li>
</ul>
</li>
<li>We send a <code>find_node</code> to the closest 3 nodes (that we have not yet asked) from the pubkey.</li>
<li>We wait for the neighbors' response and push or replace those who are closer to the potential peers.</li>
<li>We select three other nodes from the potential peers vector and do the same until one lookup has no node to ask.</li>
</ol>
<p>The way to do lookups aren't part of the spec. Our implementation aligns with geth approach, see <a href="https://github.com/ethereum/go-ethereum/blob/master/p2p/discover/v4_udp.go#L282-L310">here</a>.</p>
<h3 id="an-example-of-how-you-might-build-a-network"><a class="header" href="#an-example-of-how-you-might-build-a-network">An example of how you might build a network</a></h3>
<p>Finally, here is an example of how you could build a network and see how they connect each other:</p>
<p>We'll have three nodes: <code>a</code>, <code>b</code>, and <code>c</code>, we'll start <code>a</code>, then <code>b</code> setting <code>a</code> as a bootnode, and finally we'll start <code>c</code> with <code>b</code> as bootnode we should see that <code>c</code> connects to both <code>a</code> and <code>b</code> and so all the network should be connected.</p>
<p><strong>node a</strong>:</p>
<pre><code class="language-bash">cargo run --release -- --network ./fixtures/genesis/kurtosis.json
</code></pre>
<p>We get the <code>enode</code> by querying the node_info and using jq:</p>
<pre><code class="language-bash">curl -s http://localhost:8545 \
-X POST \
-H "Content-Type: application/json" \
--data '{"jsonrpc":"2.0","method":"admin_nodeInfo","params":[],"id":1}' \
| jq '.result.enode'
</code></pre>
<p><strong>node b</strong>:</p>
<p>We start a new server passing the enode from node <code>a</code> as an argument. Also changing the database dir and the ports is needed to avoid conflicts.</p>
<pre><code class="language-bash">cargo run --release -- --network ./fixtures/genesis/kurtosis.json --bootnodes=`NODE_A_ENODE` \
--datadir=ethrex_b --authrpc.port=8552 --http.port=8546 --p2p.port=30305 --discovery.port=30306
</code></pre>
<p><strong>node c</strong>
Finally, with <code>node_c</code> we connect to <code>node_b</code>. When the lookup runs, <code>node_c</code> should end up connecting to <code>node_a</code>:</p>
<pre><code class="language-bash">cargo run --release -- --network ./fixtures/genesis/kurtosis.json --bootnodes=`NODE_B_ENODE` \
--datadir=ethrex_c --authrpc.port=8553 --http.port=8547 --p2p.port=30308 --discovery.port=30310
</code></pre>
<p>We get the <code>enode</code> by querying the node_info and using jq:</p>
<pre><code class="language-bash">curl -s http://localhost:8546 \
-X POST \
-H "Content-Type: application/json" \
--data '{"jsonrpc":"2.0","method":"admin_nodeInfo","params":[],"id":1}' \
| jq '.result.enode'
</code></pre>
<p>You could also spawn nodes from other clients and it should work as well.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="sync-modes-2"><a class="header" href="#sync-modes-2">Sync Modes</a></h1>
<h2 id="full-sync-1"><a class="header" href="#full-sync-1">Full sync</a></h2>
<p>Full syncing works by downloading and executing every block from genesis. This means that full syncing will only work for networks that started after <a href="https://ethereum.org/en/roadmap/merge/">The Merge</a>, as ethrex only supports post merge execution.</p>
<h2 id="snap-sync-1"><a class="header" href="#snap-sync-1">Snap sync</a></h2>
<p>For snap sync, you can view the <a href="l1/fundamentals/./snap_sync.html">main document here</a>.
`</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="snap-sync-2"><a class="header" href="#snap-sync-2">Snap Sync</a></h1>
<p>API reference: https://github.com/ethereum/devp2p/blob/master/caps/snap.md</p>
<p>Terminology:</p>
<ul>
<li>Peers: Other Ethereum execution clients we are connected to, and which can respond to snap requests.</li>
<li>Pivot: The block we have chosen to snap-sync to. The pivot block changes continually as it becomes too old, because nodes don't serve old data (i.e. more than 128 blocks in the past). Read below for more details on this.</li>
</ul>
<h2 id="concept"><a class="header" href="#concept">Concept</a></h2>
<h3 id="what"><a class="header" href="#what">What</a></h3>
<p>Executing all blocks to rebuild the state is slow. It is also not possible on ethrex, because we don’t support pre-merge execution. Therefore, we need to download the current state from our peers. The largest challenge in snap sync is downloading the state (the account state trie and storage state tries). Secondary concerns are downloading headers and bytecodes.</p>
<h3 id="first-solution-fast-sync"><a class="header" href="#first-solution-fast-sync">First solution: Fast-Sync</a></h3>
<p>Fast-sync is the original method used in Ethereum to download a Patricia Merkle trie. The idea is to download the trie top-down, starting from the root, then recursively downloading child nodes until the entire trie is obtained.</p>
<p><img src="l1/fundamentals/./snap_sync/FastSync-1.png" alt="Initial state of simple fast sync" />
<img src="l1/fundamentals/./snap_sync/FastSync-2.png" alt="Root download of simple fast sync" />
<img src="l1/fundamentals/./snap_sync/FastSync-3.png" alt="Branches download of simple fast sync" />
<img src="l1/fundamentals/./snap_sync/FastSync-4.png" alt="Leaves download of simple fast sync" /></p>
<p>There are two problems with this:</p>
<ul>
<li>Peers stop responding to node requests at some point. When requesting a trie node, you specify the state root for which you want the node. If the root is 128 or more blocks old, peers will not serve the request.</li>
<li>Scanning the entire trie to find missing nodes is slow.</li>
</ul>
<p>For the first problem: once peers stop serving nodes for a given root<sup class="footnote-reference" id="fr-1-1"><a href="#footnote-1">1</a></sup>, we stop fast-syncing, update the pivot, and restart the process. The naïve approach would be to download the new root and recursively fetch all its children, checking each time whether they already exist in the DB.</p>
<p>Example of a possible state after stopping fast sync due to staleness.</p>
<p><img src="l1/fundamentals/./snap_sync/FastSyncRetakingExample-1.png" alt="Fast Sync Retaking Example - 1" /></p>
<p>In the example, even if we find that node { hash: 0x317f, path: 0 } is correct, we still need to check all its children in the DB (in this case none are present).</p>
<p>To solve the second problem, we introduce an optimization, which is called the "Membatch"<sup class="footnote-reference" id="fr-2-1"><a href="#footnote-2">2</a></sup>. This allows us to maintain a new invariant:</p>
<blockquote>
<p>If a node is present in the DB, then that node and all its children must be present.</p>
</blockquote>
<p>This removes the need to explore entire subtrees: when walking down the trie, if a node is in the DB, the whole subtree can be skipped.</p>
<p>To maintain this invariant, we do the following:</p>
<ul>
<li>When we get a new node, we don't immediately store it in the database. We keep track of the amount of every node's children that are not yet in the database. As long as it's not zero, we keep it in a separate in-memory structure "Membatch" instead of on the db.</li>
<li>When a node has all of its children in the db, we commit it and recursively go up the tree to see if its parent needs to be commited, etc.</li>
<li>When the nodes are written to the database, all it's parents are deleted from the db, which preserves the subtree invariant. Because lower down nodes are always written first, we never delete a valid node.</li>
</ul>
<p>Example of a possible state after stopping fast sync due to staleness with membatch.</p>
<p><img src="l1/fundamentals/./snap_sync/FastSyncMembatchExample-1.png" alt="Fast Sync Membatch Example - 1" /></p>
<h3 id="speeding-up-snap-sync"><a class="header" href="#speeding-up-snap-sync">Speeding up: Snap-Sync</a></h3>
<p>Fast-sync is slow (ethrex fast-sync of a fresh “hoodi” state takes ~45 minutes—4.5× slower than snap-sync). To accelerate it, we use a key property of fast-sync:</p>
<blockquote>
<p>Fast-sync can “heal” any partial trie that obeys the invariant, even if that trie is not consistent with any real on-chain state.</p>
</blockquote>
<p>Snap sync exploits this by:</p>
<ul>
<li>downloading only the leaves (the accounts and storage slots) from any recent state</li>
<li>assembling a trie from these leaves</li>
<li>running fast-sync (“healing”) to repair it into a consistent trie.
In our code, we call the fast-sync step "healing".</li>
</ul>
<p>Example run:</p>
<p>- We download the 4 accounts in the state trie from two different blocks</p>
<p><img src="l1/fundamentals/./snap_sync/SnapSyncLeaves-1.png" alt="Snap Sync Leaves - 1" /></p>
<p>- We rebuild the trie</p>
<p><img src="l1/fundamentals/./snap_sync/SnapSyncHealing-1.png" alt="Snap Sync Healing - 1" /></p>
<p>- We run the healing algorithm and get a correct tree at the end of it</p>
<p>This method alone provides up to a 4-5 times boost in performance, as computing the trie is way faster than downloading it.</p>
<h2 id="implementation"><a class="header" href="#implementation">Implementation</a></h2>
<p>Generalized Flowchart of snapsync</p>
<p><img src="l1/fundamentals/./snap_sync/Flow-SnapSync.png" alt="Flow - Snap Sync" /></p>
<h3 id="flags"><a class="header" href="#flags">Flags</a></h3>
<p>When developing snap sync there are flags to take into account that are used only for testing:</p>
<ul>
<li>
<p>If the <code>SKIP_START_SNAP_SYNC</code> environment variable is set and isn't empty, it will skip the step of downloading the leaves and will immediately begin healing. This simulates the behaviour of fast-sync.</p>
</li>
<li>
<p>If debug assertions are on, the program will validate that the entire state and storage tries are valid by traversing the entire trie and recomputing the roots. If any is found to be wrong, it will print an error and exit the program. This is used for debugging purposes; a validation error here means that there is 100% a bug in snap sync.</p>
</li>
<li>
<p><code>--syncmode [full, default:snap]</code> which defines what kind of sync we use. Full is executing each block, and isn't possible on a fresh sync for mainnet and sepolia.</p>
</li>
</ul>
<h3 id="file-structure"><a class="header" href="#file-structure">File Structure</a></h3>
<p>The sync module is a component of the <code>ethrex-p2p</code> crate, found in <code>crates/networking/p2p</code> folder. The main sync functions are found in:</p>
<ul>
<li><code>crates/networking/p2p/sync.rs</code></li>
<li><code>crates/networking/p2p/peer_handler.rs</code></li>
<li><code>crates/networking/p2p/sync/state_healing.rs</code></li>
<li><code>crates/networking/p2p/sync/storage_healing.rs</code></li>
<li><code>crates/networking/p2p/sync/code_collector.rs</code></li>
</ul>
<h3 id="syncer-and-sync-modes"><a class="header" href="#syncer-and-sync-modes">Syncer and Sync Modes</a></h3>
<p>The struct that handles the needed handles for syncing is the <code>Syncer</code>, and it has a variable to indicate if the snap mode is enabled. The Sync Modes are defined in <code>sync.rs</code> as follows.</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>/// Manager in charge the sync process
#[derive(Debug)]
pub struct Syncer {
    /// This is also held by the SyncManager allowing it to track the latest syncmode, without modifying it
    /// No outside process should modify this value, only being modified by the sync cycle
    snap_enabled: Arc&lt;AtomicBool&gt;,
    peers: PeerHandler,
    // Used for cancelling long-living tasks upon shutdown
    cancel_token: CancellationToken,
    blockchain: Arc&lt;Blockchain&gt;,
    /// This string indicates a folder where the snap algorithm will store temporary files that are
    /// used during the syncing process
    datadir: PathBuf,
}

pub enum SyncMode {
    #[default]
    Full,
    Snap,
}
<span class="boring">}</span></code></pre></pre>
<p>The flow of the program in default mode is to start by doing snap sync, then we switch to fullsync at the end and continue catching up by executing blocks.</p>
<h3 id="downloading-headers"><a class="header" href="#downloading-headers">Downloading Headers</a></h3>
<p>The first step is downloading all the headers, through the <code>request_block_headers</code> function. This function does the following steps:</p>
<ul>
<li>Request from peers the number of the sync_head that we received from the consensus client</li>
<li>Divide the headers into discrete "chunks" to ask our peers
<ul>
<li>Currently, the headers are divided into 800 chunks<sup class="footnote-reference" id="fr-3-1"><a href="#footnote-3">3</a></sup></li>
</ul>
</li>
<li>Queue those chunks as tasks into a channel
<ul>
<li>These tasks ask the peers for their data, and respond through a channel</li>
</ul>
</li>
<li>Read from the channel to get a task</li>
<li>Finds the best free peers</li>
<li>Spawn a new async job to ask the peer for the task</li>
<li>If the channel for new is empty, check if everything is downloaded</li>
<li>Read from the channel of responses</li>
<li>Store the read result</li>
</ul>
<p><img src="l1/fundamentals/./snap_sync/Flow-DownloadHeaders.png" alt="request_block_header flowchart" /></p>
<h3 id="downloading-account-values"><a class="header" href="#downloading-account-values">Downloading Account Values</a></h3>
<h4 id="api"><a class="header" href="#api">API</a></h4>
<p>When downloading the account values, we use the snap function <a href="https://github.com/ethereum/devp2p/blob/master/caps/snap.md#getaccountrange-0x00"><code>GetAccountRange</code></a>. This requests receives:</p>
<ul>
<li>rootHash: state_root of the block we're trying to download</li>
<li>startingHash: Account hash<sup class="footnote-reference" id="fr-4-1"><a href="#footnote-4">4</a></sup> of the first to retrieve</li>
<li>limitHash: Account hash after which to stop serving data</li>
<li>responseBytes: Soft limit at which to stop returning data</li>
</ul>
<p>This method returns the following</p>
<ul>
<li>accounts: List of consecutive accounts from the trie
<ul>
<li>accHash: Hash of the account address (trie path)</li>
<li>accBody: Account body in slim format</li>
</ul>
</li>
<li>proof: List of trie nodes proving the account range</li>
</ul>
<p>The proof is a merkle proof of the accounts provided, and the root of that merkle must equal to the rootHash.
In ethrex this is checked by the <code>verify_range</code> function.</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Verifies that the key value range belongs to the trie with the given root given the edge proofs for the range
/// Also returns true if there is more state to be fetched (aka if there are more keys to the right of the given range)
pub fn verify_range(
    root: H256,
    left_bound: &amp;H256,
    keys: &amp;[H256],
    values: &amp;[ValueRLP],
    proof: &amp;[Vec&lt;u8&gt;],
) -&gt; Result&lt;bool, TrieError&gt;
<span class="boring">}</span></code></pre></pre>
<p>We know we have finished a range if the last of the accounts downloaded is to the right of the bound we have set to the request, or if the <code>verify_range</code> returns true.</p>
<h4 id="dump-to-file"><a class="header" href="#dump-to-file">Dump to file</a></h4>
<p>To avoid having all of the accounts in memory, when their size in memory exceeds 64MiB we dump them to a new file.
These files are a subfolder of the datadir folder called <code>"account_state_snapshots"</code>.
For an optimization for faster insertion, these are stored ordered in the RocksDB sst file format.</p>
<h4 id="flowchart"><a class="header" href="#flowchart">Flowchart</a></h4>
<p><img src="l1/fundamentals/./snap_sync/Flow-DownloadAccounts.png" alt="request_account_range flowchart" /></p>
<h3 id="insertion-of-accounts"><a class="header" href="#insertion-of-accounts">Insertion of Accounts</a></h3>
<p>The sst files in the <code>"account_state_snapshots"</code> subfolder are ingested into a RocksDB database. This provides an ordered array that is used for insertion.</p>
<p><a href="l1/fundamentals/../../internal/l1/sorted_trie_insert.html">More detailed documentation found in sorted_trie_insert.md</a>.
<a href="l1/fundamentals/../../internal/l1/sorted_trie_insert.html">More detailed documentation found in sorted_trie_insert.md</a>.</p>
<h3 id="downloading-storage-slots"><a class="header" href="#downloading-storage-slots">Downloading Storage Slots</a></h3>
<p>The download of the storage slots is conceptually similar to the download of accounts, but very different in implementation. The method uses the snap function <a href="https://github.com/ethereum/devp2p/blob/master/caps/snap.md#getstorageranges-0x02"><code>GetStorageRanges</code></a>. This requests has the following parameters:</p>
<ul>
<li>rootHash: state_root of the block we're trying to download</li>
<li>accountHashes: List of all the account address hashes of the storage tries to serve</li>
<li>startingHash: Storage slot hash of the first to retrieve</li>
<li>limitHash: Storage slot hash after which to stop serving</li>
<li>responseBytes: Soft limit at which to stop returning data</li>
</ul>
<p>The parameters <code>startingHash</code> and <code>limitHash</code> are only read when <code>accountHashes</code> is a single account.</p>
<p>The return is similar to the one from <code>GetAccountRange</code>, but with multiple results, one for each account provided, with the following parameters:</p>
<ul>
<li>slots: List of list of consecutive slots from the trie (one list per account)
<ul>
<li>slotHash: Hash of the storage slot key (trie path)</li>
<li>slotData: Data content of the slot</li>
</ul>
</li>
<li>proof: List of trie nodes proving the slot range</li>
</ul>
<p>From these parameters, there is a couple of difficulties that pop up.</p>
<ul>
<li>We need to know which accounts have storage that needs to be downloaded</li>
<li>We need to know what storage root each account has to be able to verify it</li>
</ul>
<p>To solve these issues we take two actions:</p>
<ul>
<li>Before we download the storage slots we ensure that the state trie is in a consistent complete state. This is accomplished by doing the insertion of accounts step first and then healing the trie. If during the storage slot download the pivot becomes stale, we heal the trie again with the new pivot, to keep the trie up to date.</li>
<li>When inserting the accounts, we grab a list of all the accounts with their storage root. If the account is healed, we marked the storage root as <code>None</code>, to indicate we should check in the DB what is the state of the storage root.</li>
</ul>
<h4 id="the-time-traveling-problem"><a class="header" href="#the-time-traveling-problem">The time traveling problem</a></h4>
<p>During snap sync development, we kept running into a problematic edge case: what we call "time traveling". This is when a certain account is in state A at a certain pivot, then changes to B in the next pivot, <strong>then goes back to A</strong> on a subsequent pivot change. This was a huge source of problems because it broke an invariant we assumed to be true, namely:</p>
<ul>
<li>If an account changes its state on pivot change, we will encounter it during state healing. This is NOT true if the trie is hash based.</li>
</ul>
<p>The reason for this is the time traveling scenario. When an account goes back to a state we already have on our database, we do not heal it (because we already have it), even though its state has changed. This means the code won't realize the account has changed its storage root and won't update it.</p>
<p>This should not be a problem in a path based trie (which we currently have), but it's important to keep it in mind and make sure that whatever code we write keeps this time traveling edge case in mind and solves it.</p>
<h4 id="repeated-storage-roots"><a class="header" href="#repeated-storage-roots">Repeated Storage Roots</a></h4>
<p>A large amount of the accounts with storage have exactly the same storage as other accounts.<sup class="footnote-reference" id="fr-5-1"><a href="#footnote-5">5</a></sup> As such, when we are creating tasks for download, it's important to group the tasks by storage root and not download them twice.</p>
<h4 id="big-accounts"><a class="header" href="#big-accounts">Big Accounts</a></h4>
<p>Storage trie sizes have a very uneven distribution. Around 70% of all ethereum mainnet contracts have only 1 or 2 storage slots. However, a few contracts have more storage slots than all account leaves in the entire state trie. As such, the code needs to take this pareto distribution into account to download storage tries fast.</p>
<p>At the beginning of the algorithm, we divide the accounts into chunks of 300 storage roots and their corresponding accounts. We start downloading the storage slots, until we find an account whose storage doesn't fit into a single requests. This will be indicated by the proof field having the data indicating that there are still more nodes to download in that account.</p>
<p><img src="l1/fundamentals/./snap_sync/SnapSyncDownloadingStorages-1.png" alt="proofs for missing slots" /></p>
<p>When we reach that situation, we chunk the big account based on the "density"<sup class="footnote-reference" id="fr-7-1"><a href="#footnote-7">6</a></sup> of storage slots we downloaded, following this code to get chunks of 10,000 slots<sup class="footnote-reference" id="fr-6-1"><a href="#footnote-6">7</a></sup>. We create the tasks to download those intervals, and store all of the intervals in a struct to check when everything for that account was properly download.</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    // start_hash_u256 is the hash of the address of the last slot
    // slot_count is the amount of slots we have downloaded
    // The division gives us the density (maximum possible slots/actual slots downloaded) 
    // we want chunks of 10.000 slots, so we multiply those two numbers
    let storage_density = start_hash_u256 / slot_count;
    let slots_per_chunk = U256::from(10000);
    let chunk_size = storage_density
        .checked_mul(slots_per_chunk)
        .unwrap_or(U256::MAX);
<span class="boring">}</span></code></pre></pre>
<h4 id="tasks-api"><a class="header" href="#tasks-api">Tasks API</a></h4>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct StorageTask {
    // Index of the first storage account we want to download
    start_index: usize,
    // Index of the last storage account we want to download (not inclusive)
    end_index: usize,
    // startingHash, used when the task is downloading a single account
    start_hash: H256,
    // end_hash is Some if the task is to download a big task
    end_hash: Option&lt;H256&gt;,
}

struct StorageTaskResult {
    // Index of the first storage account we want to download
    start_index: usize,
    // Slots we have successfully downloaded with the hash of the slot + value
    account_storages: Vec&lt;Vec&lt;(H256, U256)&gt;&gt;,
    // Which peer answered the task, used for scoring
    peer_id: H256,
    // Index of the first storage account we still need to download
    remaining_start: usize,
    // Index of the last storage account we still need to download
    remaining_end: usize,
    // remaining_hash_range[0] is the hash of the last slot we downloaded (so we need to download starting from there)
    // remaining_hash_range[1] is the end_hash from the original StorageTask
    remaining_hash_range: (H256, Option&lt;H256&gt;),
}
<span class="boring">}</span></code></pre></pre>
<h4 id="big-accounts-flow"><a class="header" href="#big-accounts-flow">Big Accounts Flow</a></h4>
<p><img src="l1/fundamentals/./snap_sync/Flow-BigAccountLogic.png" alt="Big Account logic" /></p>
<h4 id="retry-limit"><a class="header" href="#retry-limit">Retry Limit</a></h4>
<p>Currently, if ethrex has been downloading storages for more than 2 pivots, the node will stop trying to download storage, and fallback to heal (fast sync) all the storage accounts that were still missing downloads. This prevents snap sync from hanging due to an edge case we do not currently handle if an account time travels. See the "snap sync concerns" document for details on what this edge case is.</p>
<h3 id="downloading-bytecodes"><a class="header" href="#downloading-bytecodes">Downloading Bytecodes</a></h3>
<p>Whenever an account is download or healed we check if the code is not empty. If it isn't, we store it for future download. This is added to a list, and when the list grows beyond a certain size it is written to disk. After the healing is done and we have a complete state and storage tree, we start with the download of bytecodes, chunking them to avoid memory overflow.</p>
<h3 id="forkchoice-update"><a class="header" href="#forkchoice-update">Forkchoice update</a></h3>
<p>Once the entire state trie, all storage tries and contract bytecodes are downloaded, we switch the sync mode from <code>snap</code> to <code>full</code>, and we do an <code>apply_forkchoice</code> to mark that as the last pivot as the last block.</p>
<hr>
<ol class="footnote-definition"><li id="footnote-1">
<p>We update pivots based only on the timestamp, not on the peer response. According to the spec, stale roots return empty responses, but Byzantine peers may return empty responses at arbitrary times. Therefore, we rely on the rule that nodes must keep at least 128 blocks. Once <code>time &gt; timestamp + 128 * 12</code> we mark the pivot as stale. <a href="#fr-1-1">↩</a></p>
</li>
<li id="footnote-2">
<p>The membatch is an idea taken from geth, and the name comes from their code. The name should be updated to "pendingNodes" as it reflects it current use. <a href="#fr-2-1">↩</a></p>
</li>
<li id="footnote-3">
<p>This currently isn't a named constant, we should change that <a href="#fr-3-1">↩</a></p>
</li>
<li id="footnote-4">
<p>All accounts and storages are sent and found through the hash of their address. Example: the account with address 0xf003 would be found through the 0x26c2...38c1 hash, and would be found before the account with adress 0x0001 whose hash would be 0x49d0...49d5 <a href="#fr-4-1">↩</a></p>
</li>
<li id="footnote-5">
<p>This may be for a variety of reasons, but the most likely is ERC20 tokens that were deployed and never used. <a href="#fr-5-1">↩</a></p>
</li>
<li id="footnote-7">
<p>actually <a href="https://en.wikipedia.org/wiki/Specific_volume">specific volume</a> (maximum possible slots/actual slots downloaded) <a href="#fr-7-1">↩</a></p>
</li>
<li id="footnote-6">
<p>10_000 slots is a number chosen without hard data, we should review that number. <a href="#fr-6-1">↩</a></p>
</li>
</ol><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h2 id="can-you-delete-accounts-in-ethereum-yes"><a class="header" href="#can-you-delete-accounts-in-ethereum-yes">Can you delete accounts in Ethereum? Yes</a></h2>
<h3 id="how-it-happens"><a class="header" href="#how-it-happens">How it happens</a></h3>
<p>Ethereum accounts are broadly divided into two categories:</p>
<ul>
<li>Externally Owned Accounts (EOA): accounts for general users to transfer eth and call contracts.</li>
<li>Contracts: which execute code and store data.</li>
</ul>
<p>Creating EOA is done through sending ETH into a new address, at which point the account is created and added into the state trie.</p>
<p>Creating a contract can be done through the CREATE and <a href="https://eips.ethereum.org/EIPS/eip-1014">CREATE2</a> opcode. Notably, those opcodes check that the account is created at an address where the code is empty and the nonce is zero, but <strong>it doesn't check balance</strong>. As such, a contract can be created through taking over an existing account.</p>
<p>During the creating of a contract, the <code>init_code</code> is run which can include the <a href="https://eips.ethereum.org/EIPS/eip-6780">self destruct opcode</a> that deletes the contract in the same transaction it was created. Normally, this deletes an account that was created in the same transaction (because contracts are usually created over empty accounts) but in this case the account already existed because it already had some balance. This is the only edge case in which an account can go from existing to non-existing from one block to another after the Cancun fork.</p>
<h3 id="how-we-found-it"><a class="header" href="#how-we-found-it">How we found it</a></h3>
<p>Snap-sync is broadly divided into two stages:</p>
<ul>
<li>Downloading the leaves of the state (account states) and storage tries (storage slots)</li>
<li>Healing (reconciling the state).</li>
</ul>
<p>Healing is needed because the leaves can be downloaded from disparate blocks, and to "fix" only the nodes of the trie that changed between nodes. <a href="internal/l1/./healing.html">In depth explanation</a>.</p>
<p>We were working under the assumption that accounts were never deleted, so we adopted some specific optimizations. During the state healing stage every account that was "healed" was added into a list of accounts that needed to be checked for storage healing. When healing the storage of those accounts the algorithm requested their account states and expected them to be there to see if they had any storage that needed healing. This lead to the storage healing threads panicking when they failed to find the account that was deleted.</p>
<p>During the test of snapsync mainnet, we started seeing that storage healing was panicking, so we added some logs to see what account hashes were being accessed and when where they healed vs accessed. Exploring the database we saw that the offending account was present in a previous state and missing in the next one, with the corresponding merkle proof matching the block state root. Originally we suspected a reorg, but searching the blocks we saw they were finalized in the chain.</p>
<p>The account state present indicated an account with nonce 0, no code and no storage but with balance. We didn't have access to the account address, as the state trie only stores the hash of the account address so we turned to another strategy to find it. Using <a href="https://docs.etherscan.io/api-endpoints/accounts#get-internal-transactions-by-block-range">etherscan's API</a> allowing to search internal transactions from a block range, we explored the range where we knew the account existed in the state trie. Hashing all of the <code>to</code> and <code>from</code> of the transactions <a href="https://etherscan.io/tx/0xf23b2c233410141cda0c6d24f21f0074c494565bfd54ce008c5ce1b30b23b0da">we found the transaction</a> that deleted the account with a self destruct. Despite the account becoming a contract just during that transaction, we saw that 900 blocks before it was <a href="https://etherscan.io/tx/0xbc9f52ba45a6915878318be944cb20bd3bb1bbf36b2ce8ff5e6575ce1689f1b6">created with a transfer</a>. The result of the self destruct was the transfer of 0.044 ETH from one account to another.</p>
<p>The specific transaction that created the contract: https://etherscan.io/tx/0xf23b2c233410141cda0c6d24f21f0074c494565bfd54ce008c5ce1b30b23b0da</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="snap-sync-concerns"><a class="header" href="#snap-sync-concerns">Snap Sync Concerns</a></h1>
<h2 id="code-improvement-opportunities"><a class="header" href="#code-improvement-opportunities">Code Improvement opportunities</a></h2>
<h3 id="storage-downloads"><a class="header" href="#storage-downloads">Storage downloads</a></h3>
<p>When downloading storages, there's a possibility that storage leaves never finish downloading. This can happen if an account time travels (i.e. if it goes from state A to state B on a pivot change, then back to state A on a subsequent pivot). The reason for this is that we have an in-memory cache where we keep track of the storage root for every account that needs to be downloaded. On every state healing phase on a pivot change, we update the storage root of every account we encounter. However, if an account time travels, we will not encounter it during healing because we already had it, and thus our storage root for it will be wrong.</p>
<p>NOTE: this should no longer be a problem now that our trie is path based, because on every state healing phase we erase the account's previous state. However, it's important to keep this scenario in mind when developing snap sync; any change in how we handle our trie or our assumptions may run into a problem it does not properly handle time traveling accounts.</p>
<h3 id="handling-the-pivot-and-reorgs"><a class="header" href="#handling-the-pivot-and-reorgs">Handling the pivot and reorgs</a></h3>
<p>We are currently asking the pivot from our peers. We should have a system for handling the pivot from our consensus client. We should also be able to understand if the new pivot received is a reorg. In that case, we can't fullsync, but we can fast-sync between those pivots relatively easily.</p>
<h3 id="potential-bytecode-nonresponse"><a class="header" href="#potential-bytecode-nonresponse">Potential Bytecode Nonresponse</a></h3>
<p>We are currently asking for all the bytecodes that we have seen, never checking if those bytecodes are currently in the tree. This isn't a problem for most codes that are immutable, but EOA may change their code to be a delegated, and the old code may be deleted from other peers in that scenario. We should consider pruning the bytecode requests if one is downloaded during healing.</p>
<h2 id="performance"><a class="header" href="#performance">Performance</a></h2>
<p>For performance, having an efficient cache of accounts that need to have their storage downloaded in memory is key, and we should avoid going to the db as much as possible. In particular in storage healing we start by trying to get all of the storage healing roots, and this can be sped up considerably if we avoid going to the db.</p>
<h3 id="improving-debug"><a class="header" href="#improving-debug">Improving debug</a></h3>
<p>The functions <code>validate_state_root</code> and <code>validate_storage_roots</code> are very slow, as they rebuild the entire state trie in memory. This is</p>
<h2 id="code-quality"><a class="header" href="#code-quality">Code Quality</a></h2>
<p>In general, snap sync lacks explanation comments that detail the functioning on the algorithm. Variables and structs should be renamed to make it properly readable.</p>
<h3 id="storage-downloads-1"><a class="header" href="#storage-downloads-1">Storage downloads</a></h3>
<p>Request storages is a very hard function to read, as the data structures were constantly modified to introduce speed optimizations. As such, this function is critical to restructure and manage it taking into account memory concerns.</p>
<p>This function also has a lot of numeric constants inserted in the code directly, and should be handled better by having defined consts with explanations.</p>
<h3 id="healing"><a class="header" href="#healing">Healing</a></h3>
<p>There are two healing challenges. We should have a single main algorithm for healing, not have the code duplicated across two files. On top of that, the Membatch structure should be replaced with "PendingNodes" as it's a far more descriptive name.</p>
<h2 id="memory-concerns"><a class="header" href="#memory-concerns">Memory Concerns</a></h2>
<h3 id="storage-accounts"><a class="header" href="#storage-accounts">Storage accounts</a></h3>
<p>Currently, we use a struct <code>accounts_by_root_hash</code> that has an unbounded size in memory. When rewriting this algorithm we should make sure that we never use more than a certain amount of memory for it; the rest should be on disk.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="sorted-trie-insertion"><a class="header" href="#sorted-trie-insertion">Sorted Trie Insertion</a></h1>
<p>This document describes the algorithm implemented in <code>crates/common/trie/trie_sorted.rs</code>
which is used to speed up the insertion time in snap sync.
During that step we are inserting all of the accounts state and storage
slots downloaded into the Ethereum world state Merkle Patricia Trie.
To know how that trie works, it's recommended to <a href="https://epf.wiki/#/wiki/EL/data-structures?id=world-state-trie">read this primer first.</a></p>
<h2 id="concept-1"><a class="header" href="#concept-1">Concept</a></h2>
<p>Naive algorithm: we insert keys in arbitrary (unsorted) order.
This version requires O(n*log(n)) reads and writes to disk.
This is because each insertion creates a new leaf, which modifies
the hash of its parent branch recursively. We could avoid reads
to disk by having the trie in memory, but this is unviable
for large amounts of state data.</p>
<p>Example of the Naive implementation:
<img src="internal/l1/sorted_trie_insert/NaiveInsertionExample1.png" alt="Image showing the insertion of 3 elements 0x0EBB, 0x12E6, 0x172E. Each one requiring multiple new reads and writes" /></p>
<p>If the input data is sorted, the computation can be optimized to be O(n).
In the example, just by reading 0x0EBB and 0x172E, we know that there is
a branch node as root (because they start with different nibbles), and
that the leaf will have a partial path of 0xEBB (because no node exists
between 0x0EBB and 0x172E if it's sorted). The root branch node we know exists and will be modified, so we don't write until we have read all
input.</p>
<h2 id="implementation-1"><a class="header" href="#implementation-1">Implementation</a></h2>
<p>The implementation maintains three pointers:</p>
<ol>
<li>The current element being processed.</li>
<li>The next input value.</li>
<li>The parent of the current element.</li>
</ol>
<p>All parents that can still be modified are stored in a "parent stack".
Based on these, the algorithm can determine the next write operation to perform.</p>
<h3 id="scenarios"><a class="header" href="#scenarios">Scenarios</a></h3>
<p>Depending on the state of the three current pointers, one of 3 scenarios
can happen:</p>
<p>Scenario 1: Current and next value are siblings with the current
parent being the parent of both values.
This happens when the parent and both values share the same
number of nibbles at the beginning of their paths.
In our example, all node paths start with 0x1 and then diverge.</p>
<p>In this scenario, we can compute the leaf for the current value, write it,
update the parent to include a pointer to that leaf, and then continue.</p>
<p><img src="internal/l1/sorted_trie_insert/SortedInsertionScenario1.png" alt="Image showing the insertion of 1 element with a current parent branch 0x1, the current element 0x12E6 and next element 0x172E. 0x12E6 is inserted with a single write" /></p>
<p>Scenario 2: Current and next values are siblings of a new current parent.
This happens when the parent shares less nibbles from their paths than what the siblings share.
In our example, the current and next value share 0x17, while the parent only shares 0x1.</p>
<p>In this scenario, we know the leaf we need to compute from the current value
so we write that. Furthermore, we know that we need a new branch at 0x17,
so we create it and insert the leaf we just computed and insert into the branch.
The current parent is stored in the "parent stack", and the new branch becomes the
current parent.</p>
<p><img src="internal/l1/sorted_trie_insert/SortedInsertionScenario2.png" alt="Image showing the insertion of 1 element with a current parent branch 0x1, the current element 0x172E and next element 0x175B. 0x172E is inserted with a single write, while the current parent branch is put onto the stack, and a new current parent branch 0x17 is created" /></p>
<p>Scenario 3: The current parent is not the parent of the
next value. This happens when the parent doesn't have
all of the nibbles of its path.</p>
<p>In this scenario, we know the leaf we need to compute from the current value,
so we write that. We change the current value to be the current parent, and
the new current parent is popped from the "parent stack".</p>
<p><img src="internal/l1/sorted_trie_insert/SortedInsertionScenario3.png" alt="Image showing the insertion of 1 element with a current parent branch 0x17, the current element 0x175B and next element 0x1825. 0x175B is inserted with a single write, while the current parent branch becomes the current value, and the current parent branch is popped from the stack" /></p>
<p>These three scenarios keep repeating themselves until the trie is complete,
at which point the algorithm returns a hash to the root node branch.</p>
<h3 id="inserting-with-extensions"><a class="header" href="#inserting-with-extensions">Inserting with extensions</a></h3>
<p>In general, each write to disk is prepared to properly handle extensions
as the write function knows what it's writing and what was its parent
and full path. As such, it can check if the insertion is a branch and
if an extension is needed.</p>
<p>A specific edge case is the root node, which is assumed to always be a branch
node, but the code has a special case check to see if the root node has
a single child, in which case it changes to an extension or leaf as needed,
while modifying the other nodes in the trie.</p>
<h3 id="concurrency"><a class="header" href="#concurrency">Concurrency</a></h3>
<p>The slowest step in this process is flushing nodes to disk.
To avoid stalling during writes, the algorithm uses an internal buffer that holds a fixed number of nodes. Once the buffer is filled, it
creates a new task that writes it to disk in the background.</p>
<p>We want to limit the amount of buffers we can have, so we allocate a
fixed number of buffers at the beginning and we use a channel for the
algorithm to receive empty buffers and the writing task clears the
buffer and sends it back through the channels.</p>
<p>These tasks are executed using a custom thread pool defined in
<code>/crates/concurrency/concurrency.rs</code></p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="healing-algorithm-explanation-and-documentation-before-path-based"><a class="header" href="#healing-algorithm-explanation-and-documentation-before-path-based">Healing Algorithm Explanation and Documentation (Before Path Based)</a></h1>
<p>Healing is the last step of Snap Sync. Snap begins the downloading of the state and storage tries by downloading the leaves (account states and storage slots), and from those leaves we reconstruct the intermediate nodes (branches and extension). Afterwards we may be left with a malformed trie, as that step will resume the download of leaves with a new state root if the old one times out.</p>
<p>The purpose of the healing algorithm is “heal” that trie so that it ends up in a consistent state.</p>
<h1 id="healing-conceptually"><a class="header" href="#healing-conceptually">Healing Conceptually</a></h1>
<p>The malformed trie is going to have large sections of the trie which are in a correct state, as we had all of the leaves in that sections and those accounts haven’t been modified in the blocks that happened concurrently to the snapsync algorithm.</p>
<p><img src="internal/l1/healing/Example_1_Step_0.svg" alt="Image of a trie, where the root node is in red, indicating that it’s in an incorrect state. It points to two branches, one is correct and one was computed from faulty data, and such doesn’t exist in the latest block" /></p>
<p>Example of a trie where 3 leaves where downloaded in block 1 and 1 was downloaded in block 2. The trie root is different from the state root of block 2, as one of the leaf nodes was modified in block 2.</p>
<p>The algorithm attempts to rebuild the trie through downloading the missing nodes, starting from the top. If the node is present in the database that means that we have that and all of their child nodes present in the database. If not, we download the node and check if the children of the root are present, applying the algorithm recursively.</p>
<p><img src="internal/l1/healing/Example_1_Step_1.svg" alt="Iteration 1 of algorithm" /></p>
<p>Iteration 1 of algorithm</p>
<p><img src="internal/l1/healing/Example_1_Step_2.svg" alt="Iteration 2 of algorithm" /></p>
<p>Iteration 2 of algorithm</p>
<p><img src="internal/l1/healing/Example_1_Step_3.svg" alt="Iteration 3 of algorithm" /></p>
<p>Iteration 3 of algorithm</p>
<p><img src="internal/l1/healing/Example_1_Step_4.svg" alt="Final state of trie after healing" /></p>
<p>Final state of trie after healing</p>
<h1 id="implementation-2"><a class="header" href="#implementation-2">Implementation</a></h1>
<p>The algorithm is implemented in ethrex currently in <code>crates/networking/p2p/sync/state_healings.rs</code> and <code>crates/networking/p2p/sync/storage_healing.rs</code>. All of our code examples are from the account state trie.</p>
<h3 id="api-1"><a class="header" href="#api-1">API</a></h3>
<p>The API used is the ethereum capability snap/1, documented at https://github.com/ethereum/devp2p/blob/master/caps/snap.md and for healing the only method used is <code>GetTrieNodes</code>. This method allows us to ask our peers for nodes in a trie. We ask the nodes by <strong>path</strong> to the node, not by hash.</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct GetTrieNodes {    
    pub id: u64,    
    pub root_hash: H256,    
    // [[acc_path, slot_path_1, slot_path_2,...]...]    
    // The paths can be either full paths (hash) or 
    // only the partial path (compact-encoded nibbles)    
    pub paths: Vec&lt;Vec&lt;Bytes&gt;&gt;,    
    pub bytes: u64,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="staleness"><a class="header" href="#staleness">Staleness</a></h3>
<p>The spec allows the nodes to stop responding if the request is older than 128 blocks. In that case, the response to the <code>GetTrieNodes</code> will be empty. As such, our algorithm checks periodically if the block is stale, and stops executing. In that scenario, we must be sure that the we leave the storage in a consistent state at any given time and doesn’t break our invariants.</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Current Staleness logic code
// We check with a clock if we are stale        
if !is_stale &amp;&amp; current_unix_time() &gt; staleness_timestamp {
    info!("state healing is stale");            
    is_stale = true;       
}
// We make sure that we have stored everything that we need to the database
if is_stale &amp;&amp; nodes_to_heal.is_empty() &amp;&amp; inflight_tasks == 0 {
  info!("Finished inflight tasks");            
  db_joinset.join_all().await;            
  break;
}
<span class="boring">}</span></code></pre></pre>
<h3 id="membatch"><a class="header" href="#membatch">Membatch</a></h3>
<p>Currently, our algorithm has an invariant, which is that if we have a node in storage we have its and all of its children are present. Therefore, when we download for a node if some of it’s children are missing we can’t immediately store it on disk. Our implementation currently stores the nodes in temporary structure called membatch, which stores the node and how many of it’s children are missing. When a child gets stored, we reduce the counter of missing children of the parent. If that numbers reaches 0, we write the parent to the database.</p>
<p>In code, the membatch is current <code>HashMap&lt;Nibbles, MembatchEntryValue&gt;</code> with the value being the following struct</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct MembatchEntryValue {
    /// The node to be flushed into storage
    node: Node,
    /// How many of the nodes that are child of this are not in storage
    children_not_in_storage_count: u64,
    /// Which is the parent of this node
    parent_path: Nibbles,
}
<span class="boring">}</span></code></pre></pre>
<h2 id="known-optimization-issues"><a class="header" href="#known-optimization-issues">Known Optimization Issues</a></h2>
<ul>
<li>Membatch gets cleared between iterations, while it could be preserved and the hash checked.</li>
<li>When checking if a child is present in storage, we can also check if it’s in the membatch. If it is, we can skip that download and act like we have immediately downloaded that node.</li>
<li>Membatch is currently a <code>HashMap</code>, a <code>BTreeMap</code> or other structures may be faster in real use.</li>
<li>Storage healing receives as a parameter a list of accounts that need to be healed and it has get their state before it can run. Doing those reads could be more efficient.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="introduction-1"><a class="header" href="#introduction-1">Introduction</a></h1>
<p>Layer 2 (L2) solutions are protocols built on top of Ethereum to increase scalability and reduce transaction costs. L2s process transactions off-chain and, in the case of Rollups, they periodically post data or proofs back to Ethereum Layer 1, inheriting its security.</p>
<p><strong>Ethrex</strong> is a framework that lets you launch your own L2 rollup or blockchain. With ethrex, you can deploy, run, and experiment with custom L2 networks, taking advantage of Ethereum's security while enabling high throughput and low fees.</p>
<h2 id="get-started-with-your-l2"><a class="header" href="#get-started-with-your-l2">Get started with your L2</a></h2>
<p>Check out the <a href="l2/../getting-started/README.html#quickstart-l2">Quickstart L2 guide</a> to start your rollup in just a command, or jump right into the <a href="l2/../l2/deployment/overview.html">Deploy an L2</a> for more detailed instructions.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="deploy-an-l2"><a class="header" href="#deploy-an-l2">Deploy an L2</a></h1>
<p>This section provides step-by-step guides for deploying different types of ethrex L2 chains, including vanilla, validium, and based configurations, as well as a shared bridge enabled L2 and migrations bewteen versions. Each guide outlines the necessary commands and parameters to successfully deploy and start an L2 node.</p>
<p>Use this section to choose the deployment method that best fits your needs and follow the instructions accordingly.</p>
<ul>
<li><a href="l2/deployment/./overview.html">Overview</a></li>
<li><a href="l2/deployment/./vanilla.html">Deploying a vanilla ethrex L2</a></li>
<li><a href="l2/deployment/./validium.html">Deploying a validium ethrex L2</a></li>
<li><a href="l2/deployment/./based.html">Deploying a based ethrex L2</a></li>
<li><a href="l2/deployment/./aligned.html">Ethrex &lt;&gt; Aligned</a></li>
<li><a href="l2/deployment/./shared_bridge.html">Deploying a shared bridge enabled L2</a></li>
<li><a href="l2/deployment/./fee_token.html">Deploying a fee token</a></li>
<li><a href="l2/deployment/./upgrades.html">Upgrades</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="deploying-an-ethrex-l2"><a class="header" href="#deploying-an-ethrex-l2">Deploying an ethrex L2</a></h1>
<p>As outlined in the introduction, ethrex L2 offers a wide range of features to its users. The most common is a classic centralized L2 managed by an operator, which can be an individual or a DAO. ethrex L2 can also function as a Validium, which is similarly centralized and operator-managed, with the key difference that network data is not posted to L1 during settlement.</p>
<p>In addition to these classic functionalities, ethrex L2 provides a novel and continually evolving feature in the industry: ethrex L2 as a based rollup. Unlike the previous options, this is a permissionless and decentralized L2 sequencer—anyone can run a node and participate in the network.</p>
<p>In this section, we will cover how to deploy any of these options.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>This section focuses solely on the step-by-step process for deploying ethrex L2 in any of its forms. For a deeper understanding of how each mode works under the hood, refer to the <a href="l2/deployment/../fundamentals/README.html">Fundamentals</a> section. To learn more about the architecture of each mode, see the <a href="l2/deployment/../architecture/README.html">Architecture</a> section.</p>
</div>
<p>Before proceeding, note that this guide assumes you have ethrex installed. If you haven't installed it yet, follow one of the methods in the <a href="l2/deployment/../../getting-started/installation/README.html">Installation Guide</a>. If you're looking to build from source, don't skip this section—we'll cover that method here, as it is independent of the deployment approach you choose later.</p>
<h2 id="building-from-source-skip-if-ethrex-is-already-installed"><a class="header" href="#building-from-source-skip-if-ethrex-is-already-installed">Building from source (skip if ethrex is already installed)</a></h2>
<h3 id="prerequisites-3"><a class="header" href="#prerequisites-3">Prerequisites</a></h3>
<p>Ensure you have the following installed on your system:</p>
<ul>
<li>Rust and Cargo (install via <a href="https://rustup.rs/">rustup</a>)</li>
<li>Solidity compiler v0.8.31 (refer to <a href="https://docs.soliditylang.org/en/latest/installing-solidity.html">Solidity documentation</a>)</li>
<li>SP1 Toolchain (if you plan to use SP1 proving, refer to <a href="https://docs.succinct.xyz/docs/sp1/getting-started/install">SP1 documentation</a>)</li>
<li>RISC0 Toolchain (if you plan to use RISC0 proving, refer to <a href="https://dev.risczero.com/api/zkvm/install">RISC0 documentation</a>)</li>
<li>CUDA Toolkit 12.9 (if you plan to use GPU acceleration for SP1 or RISC0 proving)</li>
</ul>
<ol>
<li>
<p>Clone the official ethrex repository:</p>
<pre><code class="language-shell">git clone https://github.com/lambdaclass/ethrex
cd ethrex
</code></pre>
</li>
<li>
<p>Install the binary to your <code>$PATH</code>:</p>
<pre><code class="language-shell"># For dummy proving
COMPILE_CONTRACTS=true cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql

# For SP1 CPU proving (very slow, not recommended)
COMPILE_CONTRACTS=true cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql,sp1

# For RISC0 CPU proving (very slow, not recommended)
COMPILE_CONTRACTS=true cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql,risc0

# For SP1 and RISC0 CPU proving (very slow, not recommended)
COMPILE_CONTRACTS=true cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql,sp1,risc0

# For SP1 GPU proving
COMPILE_CONTRACTS=true cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql,sp1,gpu

# For RISC0 GPU proving
COMPILE_CONTRACTS=true cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql,risc0,gpu

# For SP1 and RISC0 GPU proving
COMPILE_CONTRACTS=true cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql,sp1,risc0,gpu
</code></pre>
<p>By default <code>cargo install</code> places the binary at <code>~/.cargo/bin/ethrex</code> (make sure that directory is on your <code>$PATH</code>). Add <code>--force</code> to the commands above if you need to overwrite a previous installation.</p>
</li>
</ol>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>If you want your verifying keys generation to be reproducible, prepend <code>PROVER_REPRODUCIBLE_BUILD=true</code> to the above command:</p>
<pre><code class="language-shell">PROVER_REPRODUCIBLE_BUILD=true COMPILE_CONTRACTS=true cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql,sp1,risc0,gpu
</code></pre>
</div>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>Compiling with both <code>sp1</code> and <code>risc0</code> features only makes the binary capable of both. Settlement requires every proof you mark as required at deploy time (e.g., passing both <code>--sp1 true</code> and <code>--risc0 true</code> in <code>ethrex l2 deploy</code> will require both proofs).</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="deploying-a-vanilla-ethrex-l2"><a class="header" href="#deploying-a-vanilla-ethrex-l2">Deploying a vanilla ethrex L2</a></h1>
<p>In this section, we'll cover how to deploy a vanilla ethrex L2 on a public network such as Holesky, Sepolia, or Mainnet.</p>
<h2 id="prerequisites-4"><a class="header" href="#prerequisites-4">Prerequisites</a></h2>
<p>This guide assumes that you have ethrex installed and available in your PATH. If you haven't installed it yet, follow one of the methods in the Installation Guide. If you want to build the binary from source, refer to the <a href="l2/deployment/./overview.html#building-from-source-skip-if-ethrex-is-already-installed">Building from source</a> section and select the appropriate build option.</p>
<h2 id="1-deploy-the-contracts"><a class="header" href="#1-deploy-the-contracts">1. Deploy the Contracts</a></h2>
<p>First, deploy and initialize the contracts on L1 using the ethrex l2 deploy command (for more details on the ethrex CLI, see the ethrex CLI Reference section):</p>
<pre><code class="language-shell">ethrex l2 deploy \
  --eth-rpc-url &lt;L1_RPC_URL&gt; \
  --private-key &lt;PRIVATE_KEY&gt; \
  --genesis-l2-path &lt;PATH_TO_L2_GENESIS_FILE&gt; \
  --bridge-owner &lt;COMMON_BRIDGE_OWNER_ADDRESS&gt; \
  --on-chain-proposer-owner &lt;ON_CHAIN_PROPOSER_OWNER_ADDRESS&gt; \
  --committer.l1-address &lt;L1_COMMITTER_ADDRESS&gt; \
  --proof-sender.l1-address &lt;L1_PROOF_SENDER_ADDRESS&gt; \
  --env-file-path &lt;PATH_TO_ENV_FILE&gt; \
  --randomize-contract-deployment
</code></pre>
<div class="mdbook-alerts mdbook-alerts-caution">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  caution
</p>
<p>Ensure you control the Committer and Proof Sender accounts, as they will be authorized as sequencers. These accounts will have control over the chain state.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>If you plan to prove your L2 using SP1, RISC0, or TDX, add the following extra arguments to the command above:</p>
<p><code>--sp1 true</code> to require SP1 proofs for validating batch execution and state settlement.</p>
<p><code>--sp1.verifier-address</code> to use an existing verifier instead of deploying one on the public network. Succinct Labs recommends their deployed canonical verifier gateways; see the list here.</p>
<p><code>--risc0 true</code> to require RISC0 proofs for validating batch execution and state settlement.</p>
<p><code>--risc0.verifier-address</code> to use an existing verifier instead of deploying one on the public network. RISC0 recommends their deployed canonical verifier gateways; see the list here.</p>
<p><code>--tdx true</code> to require TEE proofs for validating batch execution and state settlement.</p>
<p><code>--tdx.verifier-address</code> to use an existing verifier instead of deploying one on the public network. Do not pass this flag if you want to deploy a new verifier.</p>
<p>Enabling multiple proving backend will require running multiple provers, one for each backend. Refer to the <a href="l2/deployment/./prover/multi-prover.html">Run multiple provers</a> section for more details.</p>
<p>If you enable more than one proving system (e.g., both <code>--sp1 true</code> and <code>--risc0 true</code>), all selected proving systems will be required (i.e., every batch must include a proof from each enabled system to settle on L1).</p>
</div>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>Retrieve the deployed contract addresses from the console logs or the .env file generated during deployment (in the directory where you ran the command) for use in the next step.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<ul>
<li>Replace <code>L1_RPC_URL</code> with your preferred RPC provider endpoint.</li>
<li>Replace <code>PRIVATE_KEY</code> with the private key of an account funded on the target L1. This key will sign the transactions during deployment.</li>
<li>Replace <code>PATH_TO_L2_GENESIS_FILE</code> with the path to your L2 genesis file. A genesis example is available in the fixtures directory of the <a href="https://github.com/lambdaclass/ethrex/blob/main/fixtures/genesis/l2.json">official GitHub repository</a>. This file initializes the <code>OnChainProposer</code> contract with the genesis state root.</li>
<li>The <code>CommonBridge</code> and <code>OnChainProposer</code> contracts are upgradeable and ownable, with implementations behind proxies initialized during deployment. Replace <code>COMMON_BRIDGE_OWNER_ADDRESS</code> and <code>ON_CHAIN_PROPOSER_OWNER_ADDRESS</code> with the address of the account you want as the owner. The owner can upgrade implementations or perform administrative actions; for more details, see the Architecture section.</li>
<li>The sequencer components (<code>L1Committer</code> and <code>L1ProofSender</code>) require funded accounts on the target L1 to advance the network. Replace <code>L1_COMMITTER_ADDRESS</code> and <code>L1_PROOF_SENDER_ADDRESS</code> with the addresses of those accounts.</li>
<li>Replace <code>PATH_TO_ENV_FILE</code> with the path where you want to save the generated environment file. This file contains the deployed contract addresses and other configuration details needed to run the L2 node.</li>
<li>L1 contract deployment uses the <code>CREATE2</code> opcode for deterministic addresses. To deploy non-deterministically, include the <code>--randomize-contract-deployment</code> flag.</li>
</ul>
</div>
<h2 id="2-start-the-l2-node"><a class="header" href="#2-start-the-l2-node">2. Start the L2 node</a></h2>
<p>Once the contracts are deployed, start the L2 node:</p>
<pre><code class="language-shell">ethrex l2 \
  --l1.bridge-address &lt;COMMON_BRIDGE_ADDRESS&gt; \
  --l1.on-chain-proposer-address &lt;ON_CHAIN_PROPOSER_ADDRESS&gt; \
  --block-producer.coinbase-address &lt;L2_COINBASE_ADDRESS&gt; \
  --proof-coordinator.l1-private-key &lt;L1_PROOF_SENDER_PRIVATE_KEY&gt; \
  --committer.l1-private-key &lt;L1_COMMITTER_PRIVATE_KEY&gt; \
  --eth.rpc-url &lt;L1_RPC_URL&gt; \
  --network &lt;PATH_TO_L2_GENESIS_FILE&gt; \
  --no-monitor
</code></pre>
<div class="mdbook-alerts mdbook-alerts-caution">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  caution
</p>
<p>Replace <code>L1_COMMITTER_PRIVATE_KEY</code> and <code>L1_PROOF_SENDER_PRIVATE_KEY</code> with the private keys for the <code>L1_COMMITTER_ADDRESS</code> and <code>L1_PROOF_SENDER_ADDRESS</code> used in the deployment step, respectively.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>The L1 Committer and L1 Proof Sender accounts must be funded for the chain to advance.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<ul>
<li>
<p>Replace <code>COMMON_BRIDGE_ADDRESS</code> and <code>ON_CHAIN_PROPOSER_ADDRESS</code> with the proxy addresses for the CommonBridge and OnChainProposer contracts from the deployment step.</p>
</li>
<li>
<p>Replace <code>L2_COINBASE_ADDRESS</code> with the address that will collect L2 block fees. To access these funds on L1, you'll need to withdraw them (see the Withdrawals section for details).</p>
</li>
<li>
<p>Replace <code>L1_PROOF_SENDER_PRIVATE_KEY</code> and <code>L1_COMMITTER_PRIVATE_KEY</code> with the private keys for the <code>L1_PROOF_SENDER_ADDRESS</code> and <code>L1_COMMITTER_ADDRESS</code> from the deployment step.</p>
</li>
<li>
<p>Replace <code>L1_RPC_URL</code> and <code>PATH_TO_L2_GENESIS_FILE</code> with the same values used in the deployment step.</p>
</li>
<li>
<p>Tune throughput with the gas caps:</p>
<ul>
<li><code>--block-producer.block-gas-limit</code> (env: <code>ETHREX_BLOCK_PRODUCER_BLOCK_GAS_LIMIT</code>, default: <code>30000000</code>): Sets the gas limit per L2 block.</li>
<li><code>--committer.batch-gas-limit</code> (env: <code>ETHREX_COMMITTER_BATCH_GAS_LIMIT</code>): Sets the gas limit per batch sent to L1—should be at or above the block gas limit.</li>
</ul>
<p>You can use either the environment variables or the flags to configure these values.</p>
</li>
</ul>
</div>
<p>That's it! You now have a vanilla ethrex L2 up and running. However, one key component is still missing: state proving. The L2 state is considered final only after a batch execution ZK proof is successfully verified on-chain. Generating these proofs requires running a dedicated prover, which is covered in the Run an ethrex L2 Prover section.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="deploying-a-validium-ethrex-l2"><a class="header" href="#deploying-a-validium-ethrex-l2">Deploying a validium ethrex L2</a></h1>
<p>In this section, we'll cover how to deploy a validium ethrex L2 on a public network such as Holesky, Sepolia, or Mainnet.</p>
<h2 id="prerequisites-5"><a class="header" href="#prerequisites-5">Prerequisites</a></h2>
<p>This guide assumes that you have ethrex installed and available in your PATH. If you haven't installed it yet, follow one of the methods in the Installation Guide. If you want to build the binary from source, refer to the <a href="l2/deployment/./overview.html#building-from-source-skip-if-ethrex-is-already-installed">Building from source</a> section and select the appropriate build option.</p>
<h2 id="1-deploy-the-contracts-1"><a class="header" href="#1-deploy-the-contracts-1">1. Deploy the Contracts</a></h2>
<p>First, deploy and initialize the contracts on L1 using the ethrex l2 deploy command (for more details on the ethrex CLI, see the ethrex CLI Reference section):</p>
<pre><code class="language-shell">ethrex l2 deploy \
  --validium true \
  --eth-rpc-url &lt;L1_RPC_URL&gt; \
  --private-key &lt;PRIVATE_KEY&gt; \
  --genesis-l2-path &lt;PATH_TO_L2_GENESIS_FILE&gt; \
  --bridge-owner &lt;COMMON_BRIDGE_OWNER_ADDRESS&gt; \
  --on-chain-proposer-owner &lt;ON_CHAIN_PROPOSER_OWNER_ADDRESS&gt; \
  --committer.l1-address &lt;L1_COMMITTER_ADDRESS&gt; \
  --proof-sender.l1-address &lt;L1_PROOF_SENDER_ADDRESS&gt; \
  --env-file-path &lt;PATH_TO_ENV_FILE&gt; \
  --randomize-contract-deployment
</code></pre>
<div class="mdbook-alerts mdbook-alerts-caution">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  caution
</p>
<p>Ensure you control the Committer and Proof Sender accounts, as they will be authorized as sequencers. These accounts will have control over the chain state.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>If you plan to prove your L2 using SP1, RISC0, or TEE, add the following extra arguments to the command above:</p>
<p><code>--sp1 true</code> to require SP1 proofs for validating batch execution and state settlement.</p>
<p><code>--sp1.verifier-address</code> to use an existing verifier instead of deploying one on the public network. Succinct Labs recommends their deployed canonical verifier gateways; see the list here.</p>
<p><code>--risc0 true</code> to require RISC0 proofs for validating batch execution and state settlement.</p>
<p><code>--risc0.verifier-address</code> to use an existing verifier instead of deploying one on the public network. RISC0 recommends their deployed canonical verifier gateways; see the list here.</p>
<p><code>--tdx true</code> to require TEE proofs for validating batch execution and state settlement.</p>
<p><code>--tdx.verifier-address</code> to use an existing verifier instead of deploying one on the public network. Do not pass this flag if you want to deploy a new verifier.</p>
<p>Enabling multiple proving backend will require running multiple provers, one for each backend. Refer to the <a href="l2/deployment/./prover/multi-prover.html">Run multiple provers</a> section for more details.</p>
<p>If you enable more than one proving system (e.g., both <code>--sp1 true</code> and <code>--risc0 true</code>), all selected proving systems will be required (i.e., every batch must include a proof from each enabled system to settle on L1).</p>
</div>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>Retrieve the deployed contract addresses from the console logs or the .env file generated during deployment (in the directory where you ran the command) for use in the next step.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<ul>
<li>Replace <code>L1_RPC_URL</code> with your preferred RPC provider endpoint.</li>
<li>Replace <code>PRIVATE_KEY</code> with the private key of an account funded on the target L1. This key will sign the transactions during deployment.</li>
<li>Replace <code>PATH_TO_L2_GENESIS_FILE</code> with the path to your L2 genesis file.A genesis example is available in the fixtures directory of the <a href="https://github.com/lambdaclass/ethrex/blob/main/fixtures/genesis/l2.json">official GitHub repository</a>. This file initializes the <code>OnChainProposer</code> contract with the genesis state root.</li>
<li>The <code>CommonBridge</code> and <code>OnChainProposer</code> contracts are upgradeable and ownable, with implementations behind proxies initialized during deployment. Replace <code>COMMON_BRIDGE_OWNER_ADDRESS</code> and <code>ON_CHAIN_PROPOSER_OWNER_ADDRESS</code> with the address of the account you want as the owner. The owner can upgrade implementations or perform administrative actions; for more details, see the Architecture section.</li>
<li>The sequencer components (<code>L1Committer</code> and <code>L1ProofSender</code>) require funded accounts on the target L1 to advance the network. Replace <code>L1_COMMITTER_ADDRESS</code> and <code>L1_PROOF_SENDER_ADDRESS</code> with the addresses of those accounts.</li>
<li>Replace <code>PATH_TO_ENV_FILE</code> with the path where you want to save the generated environment file. This file contains the deployed contract addresses and other configuration details needed to run the L2 node.</li>
<li>L1 contract deployment uses the <code>CREATE2</code> opcode for deterministic addresses. To deploy non-deterministically, include the <code>--randomize-contract-deployment</code> flag.</li>
</ul>
</div>
<h2 id="2-start-the-l2-node-1"><a class="header" href="#2-start-the-l2-node-1">2. Start the L2 node</a></h2>
<p>Once the contracts are deployed, start the L2 node:</p>
<pre><code class="language-shell">ethrex l2 \
  --validium \
  --l1.bridge-address &lt;COMMON_BRIDGE_ADDRESS&gt; \
  --l1.on-chain-proposer-address &lt;ON_CHAIN_PROPOSER_ADDRESS&gt; \
  --block-producer.coinbase-address &lt;L2_COINBASE_ADDRESS&gt; \
  --proof-coordinator.l1-private-key &lt;L1_PROOF_SENDER_PRIVATE_KEY&gt; \
  --committer.l1-private-key &lt;L1_COMMITTER_PRIVATE_KEY&gt; \
  --eth.rpc-url &lt;L1_RPC_URL&gt; \
  --network &lt;PATH_TO_L2_GENESIS_FILE&gt; \
  --no-monitor
</code></pre>
<div class="mdbook-alerts mdbook-alerts-caution">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  caution
</p>
<p>Replace <code>L1_COMMITTER_PRIVATE_KEY</code> and <code>L1_PROOF_SENDER_PRIVATE_KEY</code> with the private keys for the <code>L1_COMMITTER_ADDRESS</code> and <code>L1_PROOF_SENDER_ADDRESS</code> used in the deployment step, respectively.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>The L1 Committer and L1 Proof Sender accounts must be funded for the chain to advance.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<ul>
<li>
<p>Replace <code>COMMON_BRIDGE_ADDRESS</code> and <code>ON_CHAIN_PROPOSER_ADDRESS</code> with the proxy addresses for the CommonBridge and OnChainProposer contracts from the deployment step.</p>
</li>
<li>
<p>Replace <code>L2_COINBASE_ADDRESS</code> with the address that will collect L2 block fees. To access these funds on L1, you'll need to withdraw them (see the Withdrawals section for details).</p>
</li>
<li>
<p>Replace <code>L1_PROOF_SENDER_PRIVATE_KEY</code> and <code>L1_COMMITTER_PRIVATE_KEY</code> with the private keys for the <code>L1_PROOF_SENDER_ADDRESS</code> and <code>L1_COMMITTER_ADDRESS</code> from the deployment step.</p>
</li>
<li>
<p>Replace <code>L1_RPC_URL</code> and <code>PATH_TO_L2_GENESIS_FILE</code> with the same values used in the deployment step.</p>
</li>
<li>
<p>Tune throughput with the gas caps:</p>
<ul>
<li><code>--block-producer.block-gas-limit</code> (env: <code>ETHREX_BLOCK_PRODUCER_BLOCK_GAS_LIMIT</code>, default: <code>30000000</code>): Sets the gas limit per L2 block.</li>
<li><code>--committer.batch-gas-limit</code> (env: <code>ETHREX_COMMITTER_BATCH_GAS_LIMIT</code>): Sets the gas limit per batch sent to L1—should be at or above the block gas limit.</li>
</ul>
<p>You can use either the environment variables or the flags to configure these values.</p>
</li>
</ul>
</div>
<p>That's it! You now have a validium ethrex L2 up and running. However, one key component is still missing: state proving. The L2 state is considered final only after a batch execution ZK proof is successfully verified on-chain. Generating these proofs requires running a dedicated prover, which is covered in the Run an ethrex L2 Prover section.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="deploying-a-based-ethrex-l2"><a class="header" href="#deploying-a-based-ethrex-l2">Deploying a based ethrex L2</a></h1>
<p>TBD</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="running-ethrex-in-aligned-mode"><a class="header" href="#running-ethrex-in-aligned-mode">Running Ethrex in Aligned Mode</a></h1>
<p>This guide extends the <a href="l2/deployment/./overview.html">Deploy an L2 overview</a> and shows how to run an ethrex L2 with <strong>Aligned mode</strong> enabled.</p>
<blockquote>
<p><strong>For a comprehensive technical deep-dive into the Aligned integration architecture, see <a href="l2/deployment/../fundamentals/ethrex_l2_aligned_integration.html">Aligned Layer Integration</a>.</strong></p>
</blockquote>
<p>It assumes:</p>
<ul>
<li>
<p>You already installed the <code>ethrex</code> binary to your <code>$PATH</code> (for example from the repo root with <code>cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql --force</code>).</p>
</li>
<li>
<p>You have the ethrex repository checked out locally for the <code>make</code> targets referenced below.</p>
</li>
<li>
<p>Check <a href="l2/deployment/aligned.html#how-to-run-local-devnet">How to Run (local devnet)</a> for development or testing.</p>
</li>
<li>
<p>Check <a href="l2/deployment/aligned.html#how-to-run-testnet">How to Run (testnet)</a> for a prod-like environment.</p>
</li>
</ul>
<h2 id="how-to-run-testnet"><a class="header" href="#how-to-run-testnet">How to run (testnet)</a></h2>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>This guide assumes there is an L1 running with all Aligned environment set.</p>
</div>
<h3 id="1-generate-the-prover-elfvk"><a class="header" href="#1-generate-the-prover-elfvk">1. Generate the prover ELF/VK</a></h3>
<p>From the ethrex repository root run:</p>
<pre><code class="language-bash">make -C crates/l2 build-prover-&lt;sp1/risc0&gt; # optional: GPU=true
</code></pre>
<p>This will generate the SP1 ELF program and verification key under:</p>
<ul>
<li><code>crates/l2/prover/src/guest_program/src/sp1/out/riscv32im-succinct-zkvm-elf</code></li>
<li><code>crates/l2/prover/src/guest_program/src/sp1/out/riscv32im-succinct-zkvm-vk-u32</code></li>
</ul>
<h3 id="2-deploying-l1-contracts"><a class="header" href="#2-deploying-l1-contracts">2. Deploying L1 Contracts</a></h3>
<p>Run the deployer with the Aligned settings:</p>
<pre><code class="language-bash">COMPILE_CONTRACTS=true \
ETHREX_L2_ALIGNED=true \
ETHREX_DEPLOYER_ALIGNED_AGGREGATOR_ADDRESS=&lt;ALIGNED_AGGREGATOR_ADDRESS&gt; \
ETHREX_L2_SP1=true \
ETHREX_DEPLOYER_RANDOMIZE_CONTRACT_DEPLOYMENT=true \
ethrex l2 deploy \
  --eth-rpc-url &lt;ETH_RPC_URL&gt; \
  --private-key &lt;YOUR_PRIVATE_KEY&gt; \
  --on-chain-proposer-owner &lt;ON_CHAIN_PROPOSER_OWNER&gt;  \
  --bridge-owner &lt;BRIDGE_OWNER_ADDRESS&gt;  \
  --genesis-l2-path fixtures/genesis/l2.json \
  --proof-sender.l1-address &lt;PROOF_SENDER_L1_ADDRESS&gt;
</code></pre>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>This command requires the <code>COMPILE_CONTRACTS</code> env variable to be set, as the deployer needs the SDK to embed the proxy bytecode.
In this step we are initializing the <code>OnChainProposer</code> contract with the <code>ALIGNED_PROOF_AGGREGATOR_SERVICE_ADDRESS</code> and skipping the rest of verifiers; you can find the address for the aligned aggregator service <a href="https://docs.alignedlayer.com/guides/7_contract_addresses">here</a>.
Save the addresses of the deployed proxy contracts, as you will need them to run the L2 node.
Accounts for the deployer, on-chain proposer owner, bridge owner, and proof sender must have funds. Add <code>--bridge-owner-pk &lt;PRIVATE_KEY&gt;</code> if you want the deployer to immediately call <code>acceptOwnership</code> on behalf of that owner; otherwise, they can accept later.
If you enable more than one proving system (e.g., both <code>--sp1 true</code> and <code>--risc0 true</code>), all selected proving systems will be required (i.e., every batch must include a proof from each enabled system to settle on L1).</p>
</div>
<h3 id="3-deposit-funds-to-the-alignedbatcherpaymentservice-contract-from-the-proof-sender"><a class="header" href="#3-deposit-funds-to-the-alignedbatcherpaymentservice-contract-from-the-proof-sender">3. Deposit funds to the <code>AlignedBatcherPaymentService</code> contract from the proof sender</a></h3>
<pre><code class="language-bash">aligned deposit-to-batcher \
  --network &lt;NETWORK&gt; \
  --private_key &lt;PROOF_SENDER_PRIVATE_KEY&gt; \
  --rpc_url &lt;RPC_URL&gt; \
  --amount &lt;DEPOSIT_AMOUNT&gt;
</code></pre>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>Using the <a href="https://docs.alignedlayer.com/guides/9_aligned_cli">Aligned CLI</a></p>
</div>
<h3 id="4-running-a-node"><a class="header" href="#4-running-a-node">4. Running a node</a></h3>
<p>Run the sequencer using the installed <code>ethrex</code> binary:</p>
<pre><code class="language-bash">ethrex l2 \
  --watcher.block-delay 0 \
  --network fixtures/genesis/l2.json \
  --l1.bridge-address &lt;BRIDGE_ADDRESS&gt; \
  --l1.on-chain-proposer-address &lt;ON_CHAIN_PROPOSER_ADDRESS&gt; \
  --eth.rpc-url &lt;ETH_RPC_URL&gt; \
  --aligned \
  --aligned-network &lt;ALIGNED_NETWORK&gt;  \
  --block-producer.coinbase-address &lt;COINBASE_ADDRESS&gt;  \
  --committer.l1-private-key &lt;COMMITTER_PRIVATE_KEY&gt;  \
  --proof-coordinator.l1-private-key &lt;PROOF_COORDINATOR_PRIVATE_KEY&gt;  \
  --aligned.beacon-url &lt;ALIGNED_BEACON_URL&gt; \
  --datadir ethrex_l2 \
  --no-monitor
</code></pre>
<p>Both committer and proof coordinator should have funds.</p>
<p>Aligned params explanation:</p>
<ul>
<li><code>--aligned</code>: Enables aligned mode, enforcing all required parameters.</li>
<li><code>--aligned.beacon-url</code>: URL of the beacon client used by the Aligned SDK to verify proof aggregations, it has to support <code>/eth/v1/beacon/blobs</code></li>
<li><code>--aligned-network</code>: Parameter used by the <a href="https://docs.alignedlayer.com/guides/1.2_sdk_api_reference">Aligned SDK</a>.</li>
</ul>
<p>If you can't find a beacon client URL which supports that endpoint, you can run your own with lighthouse and ethrex:</p>
<p>Create secrets directory and jwt secret</p>
<pre><code class="language-bash">mkdir -p ethereum/secrets/
openssl rand -hex 32 | tr -d "\n" | tee ./ethereum/secrets/jwt.hex
</code></pre>
<pre><code class="language-bash">lighthouse bn --network &lt;NETWORK&gt; --execution-endpoint http://localhost:8551 --execution-jwt ./ethereum/secrets/jwt.hex --checkpoint-sync-url &lt;CHECKPOINT_URL&gt; --http --purge-db-force --supernode
</code></pre>
<pre><code class="language-bash">ethrex --authrpc.jwtsecret ./ethereum/secrets/jwt.hex --network &lt;NETWORK&gt;
</code></pre>
<h3 id="5-running-the-prover"><a class="header" href="#5-running-the-prover">5. Running the Prover</a></h3>
<p>In another terminal start the prover(s):</p>
<pre><code class="language-bash">make -C crates/l2 init-prover-&lt;sp1/risc0&gt; GPU=true # The GPU parameter is optional
</code></pre>
<p>Then you should wait until Aligned aggregates your proof.</p>
<h2 id="how-to-run-local-devnet"><a class="header" href="#how-to-run-local-devnet">How to run (local devnet)</a></h2>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>This guide assumes you have already generated the prover ELF/VK. See: <a href="l2/deployment/aligned.html#1-generate-the-prover-elfvk">Generate the prover ELF/VK</a></p>
</div>
<h3 id="set-up-the-aligned-environment"><a class="header" href="#set-up-the-aligned-environment">Set Up the Aligned Environment</a></h3>
<ol>
<li>
<p>Clone the Aligned repository and checkout the currently supported release:</p>
<pre><code class="language-bash">git clone git@github.com:yetanotherco/aligned_layer.git
cd aligned_layer
git checkout tags/v0.19.1
</code></pre>
</li>
<li>
<p>Edit the <code>aligned_layer/network_params.rs</code> file to send some funds to the <code>committer</code> and <code>integration_test</code> addresses:</p>
<pre><code>prefunded_accounts: '{
    "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266": { "balance": "100000000000000ETH" },
    "0x70997970C51812dc3A010C7d01b50e0d17dc79C8": { "balance": "100000000000000ETH" },

    ...
    "0xa0Ee7A142d267C1f36714E4a8F75612F20a79720": { "balance": "100000000000000ETH" },
+   "0x4417092B70a3E5f10Dc504d0947DD256B965fc62": { "balance": "100000000000000ETH" },
+   "0x3d1e15a1a55578f7c920884a9943b3b35d0d885b": { "balance": "100000000000000ETH" },
     }'
</code></pre>
<p>You can also decrease the seconds per slot in <code>aligned_layer/network_params.rs</code>:</p>
<pre><code># Number of seconds per slot on the Beacon chain
  seconds_per_slot: 4
</code></pre>
<p>Change <code>ethereum-genesis-generator</code> to 5.0.8</p>
<pre><code>ethereum_genesis_generator_params:
  # The image to use for ethereum genesis generator
  image: ethpandaops/ethereum-genesis-generator:5.0.8
</code></pre>
</li>
<li>
<p>Make sure you have the latest version of <a href="https://github.com/kurtosis-tech/kurtosis">kurtosis</a> installed and start the ethereum-package:</p>
<pre><code>cd aligned_layer
make ethereum_package_start
</code></pre>
<p>If you need to stop it run <code>make ethereum_package_rm</code></p>
</li>
<li>
<p>Start the batcher:</p>
<p>First, increase the <code>max_proof_size</code> in <code>aligned_layer/config-files/config-batcher-ethereum-package.yaml</code> <code>max_proof_size: 104857600 # 100 MiB</code> for example.</p>
<pre><code>cd aligned_layer
make batcher_start_ethereum_package
</code></pre>
<p>This is the Aligned component that receives the proofs before sending them in a batch.</p>
</li>
</ol>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>If you see the following error in the batcher: <code>[ERROR aligned_batcher] Unexpected error: Space limit exceeded: Message too long: 16940713 &gt; 16777216</code> modify the file <code>aligned_layer/batcher/aligned-batcher/src/lib.rs</code> at line 433 with the following code:</p>
<pre><code class="language-Rust">use tokio_tungstenite::tungstenite::protocol::WebSocketConfig;

let mut stream_config = WebSocketConfig::default();
stream_config.max_frame_size = None;

let ws_stream_future =
    tokio_tungstenite::accept_async_with_config(raw_stream, Some(stream_config));
</code></pre>
</div>
<h3 id="initialize-l2-node"><a class="header" href="#initialize-l2-node">Initialize L2 node</a></h3>
<ol>
<li>
<p>Deploy the L1 contracts, specifying the <code>AlignedProofAggregatorService</code> contract address, and adding the required prover types (Risc0 or SP1):</p>
<pre><code class="language-bash">COMPILE_CONTRACTS=true \
ETHREX_L2_ALIGNED=true \
ETHREX_DEPLOYER_ALIGNED_AGGREGATOR_ADDRESS=0xcbEAF3BDe82155F56486Fb5a1072cb8baAf547cc \
ETHREX_L2_SP1=true \
ETHREX_L2_RISC0=true \
make -C crates/l2 deploy-l1
</code></pre>
<p>Both <code>ETHREX_L2_SP1</code> and <code>ETHREX_L2_RISC0</code> are optional.</p>
<blockquote>
<p>[!NOTE]
This command requires the COMPILE_CONTRACTS env variable to be set, as the deployer needs the SDK to embed the proxy bytecode.</p>
</blockquote>
<p>You will see that some deposits fail with the following error:</p>
<pre><code>2025-10-13T19:44:51.600047Z ERROR ethrex::l2::deployer: Failed to deposit address=0x0002869e27c6faee08cca6b765a726e7a076ee0f value_to_deposit=0
2025-10-13T19:44:51.600114Z  WARN ethrex::l2::deployer: Failed to make deposits: Deployer EthClient error: eth_sendRawTransaction request error: insufficient funds for gas * price + value: have 0 want 249957710190063
</code></pre>
<p>This is because not all the accounts are pre-funded from the genesis.</p>
</li>
<li>
<p>Send some funds to the Aligned batcher payment service contract from the proof sender:</p>
<pre><code class="language-bash">cargo run --manifest-path aligned_layer/crates/cli/Cargo.toml deposit-to-batcher \
  --network devnet \
  --private_key 0x39725efee3fb28614de3bacaffe4cc4bd8c436257e2c8bb887c4b5c4be45e76d \
  --amount 1ether
</code></pre>
</li>
<li>
<p>Start the L2 node:</p>
<pre><code class="language-bash">ETHREX_ALIGNED_MODE=true \
ETHREX_ALIGNED_BEACON_URL=http://127.0.0.1:58801 \
ETHREX_ALIGNED_NETWORK=devnet \
ETHREX_PROOF_COORDINATOR_DEV_MODE=false \
SP1=true \
RISC0=true \
make -C crates/l2 init-l2
</code></pre>
<p>Suggestion:
When running the integration test, consider increasing the <code>--committer.commit-time</code> to 2 minutes. This helps avoid having to aggregate the proofs twice. You can do this by adding the following flag to the <code>init-l2-no-metrics</code> target:</p>
<pre><code>--committer.commit-time 120000
</code></pre>
</li>
<li>
<p>Start prover(s) in different terminals:</p>
<pre><code class="language-bash">make -C crates/l2 init-prover-&lt;sp1/risc0&gt; GPU=true # The GPU flag is optional
</code></pre>
</li>
</ol>
<h3 id="aggregate-proofs"><a class="header" href="#aggregate-proofs">Aggregate proofs:</a></h3>
<p>After some time, you will see that the <code>l1_proof_verifier</code> is waiting for Aligned to aggregate the proofs. You can trigger an aggregation (for either sp1 or risc0 proofs) by running:</p>
<pre><code class="language-bash">make -C aligned_layer proof_aggregator_start AGGREGATOR=&lt;sp1/risc0&gt;

# or with gpu acceleration
make -C aligned_layer proof_aggregator_start_gpu AGGREGATOR=&lt;sp1/risc0&gt;
</code></pre>
<p>If successful, the <code>l1_proof_verifier</code> will print the following logs:</p>
<pre><code>INFO ethrex_l2::sequencer::l1_proof_verifier: Proof for batch 1 aggregated by Aligned with commitment 0xa9a0da5a70098b00f97d96cee43867c7aa8f5812ca5388da7378454580af2fb7 and Merkle root 0xa9a0da5a70098b00f97d96cee43867c7aa8f5812ca5388da7378454580af2fb7
INFO ethrex_l2::sequencer::l1_proof_verifier: Batches verified in OnChainProposer, with transaction hash 0x731d27d81b2e0f1bfc0f124fb2dd3f1a67110b7b69473cacb6a61dea95e63321
</code></pre>
<h2 id="behavioral-differences-in-aligned-mode"><a class="header" href="#behavioral-differences-in-aligned-mode">Behavioral Differences in Aligned Mode</a></h2>
<h3 id="prover"><a class="header" href="#prover">Prover</a></h3>
<ul>
<li>Generates <code>Compressed</code> proofs instead of <code>Groth16</code>.</li>
<li>Required because Aligned accepts compressed proofs (both SP1 and RISC0).</li>
</ul>
<h3 id="proof-sender"><a class="header" href="#proof-sender">Proof Sender</a></h3>
<ul>
<li>Sends proofs to the <strong>Aligned Batcher</strong> instead of the <code>OnChainProposer</code> contract.</li>
<li>Tracks the last proof sent using the rollup store.</li>
</ul>
<p><img src="l2/deployment/../img/aligned_mode_proof_sender.png" alt="Proof Sender Aligned Mode" /></p>
<h3 id="proof-verifier"><a class="header" href="#proof-verifier">Proof Verifier</a></h3>
<ul>
<li>Spawned only in Aligned mode.</li>
<li>Monitors whether the next proof has been aggregated by Aligned.</li>
<li>Once verified, collects all already aggregated proofs and triggers the advancement of the <code>OnChainProposer</code> contract by sending a single transaction.</li>
</ul>
<p><img src="l2/deployment/../img/aligned_mode_proof_verifier.png" alt="Aligned Mode Proof Verifier" /></p>
<h3 id="onchainproposer"><a class="header" href="#onchainproposer">OnChainProposer</a></h3>
<ul>
<li>Uses <code>verifyBatchesAligned()</code> instead of <code>verifyBatch()</code>.</li>
<li>Receives an array of proofs to verify.</li>
<li>Delegates proof verification to the <code>AlignedProofAggregatorService</code> contract.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="synchronous-composability-poc"><a class="header" href="#synchronous-composability-poc">Synchronous Composability (PoC)</a></h1>
<h2 id="status"><a class="header" href="#status">Status</a></h2>
<p><strong>Development branch:</strong> <code>sync_comp_poc</code></p>
<div class="table-wrapper"><table><thead><tr><th>Sync</th><th>Column 1</th><th>Status</th></tr></thead><tbody>
<tr><td>L1 -&gt; L2</td><td>Deposits</td><td>✅</td></tr>
<tr><td>L1 -&gt; L2</td><td>L2 contract calls from L1</td><td>✅</td></tr>
<tr><td>L2 -&gt; L1</td><td>Withdrawals</td><td>✅</td></tr>
<tr><td>L2 -&gt; L1</td><td>L1 contract calls from L2</td><td>❌</td></tr>
<tr><td>L2 -&gt; L2</td><td></td><td>🔜</td></tr>
</tbody></table>
</div>
<h2 id="commands"><a class="header" href="#commands">Commands</a></h2>
<h3 id="prerequisites-6"><a class="header" href="#prerequisites-6">Prerequisites</a></h3>
<ul>
<li>A fresh-cloned ethrex repository.</li>
<li><code>rex</code> installed and available in your PATH. If you haven't installed it yet, follow one of the methods in the <a href="https://github.com/lambdaclass/rex?tab=readme-ov-file#rex-cli">rex repository</a>.</li>
</ul>
<h3 id="run-a-supernode"><a class="header" href="#run-a-supernode">Run a supernode</a></h3>
<p>The following command will:</p>
<ol>
<li>Remove both L1 and L2 dev databases (to start from scratch).</li>
<li>Start an ethrex supernode, i.e. an L1 execution client embedded with an L2 sequencer node.</li>
</ol>
<pre><code class="language-shell">rm -rf dev_ethrex_l*; RUSTFLAGS="-Awarnings" COMPILE_CONTRACTS=true RUST_LOG=off cargo run -r -F l2,l2-sql -- l2 --supernode --block-producer.coinbase-address $(rex a -z) --committer.l1-private-key 0x850643a0224065ecce3882673c21f56bcf6eef86274cc21cadff15930b59fc8c --proof-coordinator.l1-private-key 0xf296c7802555da2a5a662be70e078cbd38b44f96f8615ae529da41122ce8db05 --eth.rpc-url http://localhost:8545 --validium --no-monitor --datadir dev_ethrex_l2 --network ./fixtures/genesis/l2.json --http.port 1729 --committer.commit-time 86400000

# Same but enabling logs

rm -rf dev_ethrex_l*; RUSTFLAGS="-Awarnings" COMPILE_CONTRACTS=true RUST_LOG=info,ethrex_p2p=error,ethrex_l2::sequencer::l1_committer=debug cargo run -r -F l2,l2-sql -- l2 --supernode --block-producer.coinbase-address $(rex a -z) --committer.l1-private-key 0x850643a0224065ecce3882673c21f56bcf6eef86274cc21cadff15930b59fc8c --proof-coordinator.l1-private-key 0xf296c7802555da2a5a662be70e078cbd38b44f96f8615ae529da41122ce8db05 --eth.rpc-url http://localhost:8545 --validium --no-monitor --datadir dev_ethrex_l2 --network ./fixtures/genesis/l2.json --http.port 1729 --committer.commit-time 86400000
</code></pre>
<h3 id="testing-l1---l2-synchronous-composability"><a class="header" href="#testing-l1---l2-synchronous-composability">Testing L1 -&gt; L2 synchronous composability</a></h3>
<h4 id="synchronous-deposits"><a class="header" href="#synchronous-deposits">Synchronous Deposits</a></h4>
<pre><code class="language-shell">rex transfer 999999999999999999 0x67cad0d689b799f385d2ebcf3a626254a9074e12 0x41443995d9eb6c6d6df51e55db2b188b12fe0f80d32817e57e11c64acff1feb8
</code></pre>
<h4 id="l1-contract-calling-into-an-l2-contract"><a class="header" href="#l1-contract-calling-into-an-l2-contract">L1 contract calling into an L2 contract</a></h4>
<pre><code class="language-shell"># Deploy a Counter.sol contract in the L1

rex deploy --contract-path crates/l2/contracts/src/example/Counter.sol 0 0x41443995d9eb6c6d6df51e55db2b188b12fe0f80d32817e57e11c64acff1feb8 --remappings ""

# Update that contract state by statically calling a contract in the L2

rex send 0x3fe21258005ca065695d205aac21168259e58155 "update(address)" 0x67cad0d689b799f385d2ebcf3a626254a9074e12 --private-key 0x41443995d9eb6c6d6df51e55db2b188b12fe0f80d32817e57e11c64acff1feb8
</code></pre>
<h3 id="testing-l2---l1-synchronous-composability"><a class="header" href="#testing-l2---l1-synchronous-composability">Testing L2 -&gt; L1 synchronous composability</a></h3>
<h4 id="synchronous-withdrawals"><a class="header" href="#synchronous-withdrawals">Synchronous Withdrawals</a></h4>
<pre><code class="language-shell"># Deposit
rex transfer 999999999999999999 0x67cad0d689b799f385d2ebcf3a626254a9074e12 0x41443995d9eb6c6d6df51e55db2b188b12fe0f80d32817e57e11c64acff1feb8

# Withdrawal
rex l2 withdraw 111111111111111111 0x41443995d9eb6c6d6df51e55db2b188b12fe0f80d32817e57e11c64acff1feb8
</code></pre>
<h2 id="introduction-2"><a class="header" href="#introduction-2">Introduction</a></h2>
<h3 id="l1---l2-synchronous-composability"><a class="header" href="#l1---l2-synchronous-composability">L1 -&gt; L2 Synchronous Composability</a></h3>
<h4 id="synchronous-deposits-1"><a class="header" href="#synchronous-deposits-1">Synchronous Deposits</a></h4>
<p>Deposits are the process by which L1 users can enter L2 in some form. This process begins and ends on L1 through a series of steps:</p>
<ol>
<li><strong>Initiate the deposit on L1</strong>:
<ul>
<li>A user sends a transaction to L1, either via an ETH transfer to the <code>CommonBridge</code> contract or by calling the <code>deposit</code> function on the same contract. Both actions execute the same logic, which, upon successful execution, emits a log containing the necessary information for the sequencer of the corresponding L2 to process it.</li>
<li>This transaction must be included in a block, and that block must be finalized for the sequencer on the corresponding L2 to detect the log on L1.</li>
</ul>
</li>
<li><strong>Process the deposit on L2</strong>:
<ul>
<li>When the sequencer processes this log, it includes a transaction in its mempool that mints the corresponding ETH to the recipient's address, thereby ensuring the recipient has funds on L2.</li>
</ul>
</li>
<li><strong>Commit the deposit process from L2 to L1</strong>:
<ul>
<li>Eventually, the L2 batch that includes this mint transaction is sealed and committed to L1. This commit transaction must be included in an L1 block and finalized.</li>
<li>The same batch is sent to a prover to generate a ZK proof validating the previously committed batch.</li>
</ul>
</li>
<li><strong>Verify the deposit process from L2 to L1 (deposit finalization)</strong>:
<ul>
<li>Eventually, the batch execution proof is generated and returned to the sequencer, which submits it for verification on L1 via a <code>verify</code> transaction.</li>
<li>The <code>verify</code> transaction, assuming it is valid, must be included in an L1 block and finalized.</li>
</ul>
</li>
</ol>
<p>This 4-step process requires, by definition, that it occur across different L1 slots. The number of slots needed can vary based on L1's configuration, but even assuming a sufficiently fast commit time, real-time proving to generate the proof quickly, and a sufficiently fast proof submission time, this process would still require at least 2 slots: the first is always mandatory to emit the log that the sequencer listens for, and with significant luck, finalization could occur in the next slot.</p>
<p>Synchronous Composability enables this entire process to happen within the same L1 slot. In other words, the transaction that initiates the deposit, the deposit processing on L2, the commit transaction for the batch that included the mint, the generation of the execution proof for that batch, and the verify transaction for the same batch all occur in the same L1 slot.</p>
<h4 id="l1-contract-calling-into-an-l2-contract-1"><a class="header" href="#l1-contract-calling-into-an-l2-contract-1">L1 Contract Calling into an L2 Contract</a></h4>
<p>Another capability enabled by synchronous composability is the ability to call L2 contracts from L1.</p>
<p>A simple example of this would be updating the state of a counter on L1 with the current state of another counter that resides on L2.</p>
<p>Unlike deposits, which do not require synchronous composability to function normally, calling an L2 contract from L1 and using the result as part of the L1 execution is not possible without this feature.</p>
<h3 id="l2---l1-synchronous-composability"><a class="header" href="#l2---l1-synchronous-composability">L2 -&gt; L1 Synchronous Composability</a></h3>
<p>TBD</p>
<h3 id="rollup-requirements-for-sc-and-how-we-addressed-them-in-the-poc"><a class="header" href="#rollup-requirements-for-sc-and-how-we-addressed-them-in-the-poc">Rollup Requirements for SC and How We Addressed Them in the PoC</a></h3>
<p>To achieve synchronous composability, our rollup needed to fulfill the following requirements:</p>
<ol>
<li><strong>Reorg with L1</strong>: The rollup consumes unconfirmed L1 data and therefore must reorganize (reorg) with L1.</li>
<li><strong>Instant Settlement</strong>: The rollup must be able to settle within one L1 slot, requiring real-time proving.</li>
<li><strong>Coordinated Sequencing</strong>: The L2 proposer is the L1 proposer or works closely together (e.g., issues L1 inclusion preconfs).</li>
</ol>
<p>We addressed these requirements in the following manner:</p>
<ol>
<li>For this PoC, we removed reorgs from the equation.</li>
<li>Our L2 block builder would force a commit batch transaction after building a block that includes a scoped call. Assuming real-time proving by skipping verification, the commit transaction now serves as a settlement transaction.</li>
<li>We extended the ethrex functionality with a supernode mode that operates essentially as an L1 and L2 node sharing both states. This allows the L1 to insert transactions into the L2 mempool and simulate the L2 state in real time, while the L2 can insert transactions into the L1 mempool and simulate the L1 state in real time.</li>
</ol>
<h2 id="future-work"><a class="header" href="#future-work">Future work</a></h2>
<p>TBD</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="deploying-an-ethrex-l2-with-shared-bridge-enabled"><a class="header" href="#deploying-an-ethrex-l2-with-shared-bridge-enabled">Deploying an ethrex L2 with shared bridge enabled</a></h1>
<p>In this section, we'll cover how to deploy two ethrex L2 with shared bridge enabled on a devnet.</p>
<h2 id="prerequisites-7"><a class="header" href="#prerequisites-7">Prerequisites</a></h2>
<p>This guide assumes that you have the ethrex repository cloned.</p>
<h2 id="steps"><a class="header" href="#steps">Steps</a></h2>
<h3 id="change-directory"><a class="header" href="#change-directory">Change directory</a></h3>
<p>Every command should be run under <code>crates/l2</code></p>
<pre><code class="language-bash">cd crates/l2
</code></pre>
<h3 id="start-an-l1"><a class="header" href="#start-an-l1">Start an L1</a></h3>
<pre><code class="language-bash">make init-l1
</code></pre>
<h3 id="deploy-the-first-l2"><a class="header" href="#deploy-the-first-l2">Deploy the first L2</a></h3>
<p>On another terminal</p>
<pre><code class="language-bash">ETHREX_SHARED_BRIDGE_DEPLOY_ROUTER=true make deploy-l1
</code></pre>
<h3 id="start-the-first-l2"><a class="header" href="#start-the-first-l2">Start the first L2</a></h3>
<p>Replace <code>L1_BRIDGE_ADDRESS</code>, <code>L1_ON_CHAIN_PROPOSER_ADDRESS</code> and <code>ROUTER_ADDRESS</code> with the outputs of the previous command, you can also check it under <code>cmd/.env</code>.</p>
<pre><code class="language-bash">../../target/release/ethrex \
	l2 \
	--watcher.block-delay 0 \
	--network ../../fixtures/genesis/l2.json \
	--http.port 1729 \
	--http.addr 0.0.0.0 \
	--metrics \
	--metrics.port 3702 \
	--datadir dev_ethrex_l2 \
	--l1.bridge-address &lt;L1_BRIDGE_ADDRESS&gt; \
	--l1.on-chain-proposer-address &lt;L1_ON_CHAIN_PROPOSER_ADDRESS&gt; \
	--eth.rpc-url http://localhost:8545 \
	--osaka-activation-time 1761677592 \
	--block-producer.coinbase-address 0x0007a881CD95B1484fca47615B64803dad620C8d \
	--block-producer.base-fee-vault-address 0x000c0d6b7c4516a5b274c51ea331a9410fe69127 \
	--block-producer.operator-fee-vault-address 0xd5d2a85751b6F158e5b9B8cD509206A865672362 \
	--block-producer.operator-fee-per-gas 1000000000 \
	--committer.l1-private-key 0x385c546456b6a603a1cfcaa9ec9494ba4832da08dd6bcf4de9a71e4a01b74924 \
	--proof-coordinator.l1-private-key 0x39725efee3fb28614de3bacaffe4cc4bd8c436257e2c8bb887c4b5c4be45e76d \
	--proof-coordinator.addr 127.0.0.1 \
    --l1.router-address &lt;ROUTER_ADDRESS&gt; \
    --watcher.l2-rpcs http://localhost:1730 \
    --watcher.l2-chain-ids 1730
</code></pre>
<h3 id="deploy-the-second-l2"><a class="header" href="#deploy-the-second-l2">Deploy the second L2</a></h3>
<p>On another terminal</p>
<p>Copy the <code>../../fixtures/genesis/l2.json</code> file to <code>../../fixtures/genesis/l2_2.json</code> and modify chain id to 1730</p>
<p>Replace <code>ROUTER_ADDRESS</code> with the outputs of the first deploy</p>
<pre><code class="language-bash">../../target/release/ethrex l2 deploy \
	--eth-rpc-url http://localhost:8545 \
	--private-key 0x385c546456b6a603a1cfcaa9ec9494ba4832da08dd6bcf4de9a71e4a01b74924 \
	--on-chain-proposer-owner 0x4417092b70a3e5f10dc504d0947dd256b965fc62 \
	--bridge-owner 0x4417092b70a3e5f10dc504d0947dd256b965fc62 \
	--deposit-rich \
	--private-keys-file-path ../../fixtures/keys/private_keys_l1.txt \
	--genesis-l1-path ../../fixtures/genesis/l1.json \
	--genesis-l2-path ../../fixtures/genesis/l2_2.json \
    --randomize-contract-deployment \
    --router.address &lt;ROUTER_ADDRESS&gt;
</code></pre>
<h3 id="start-the-second-l2"><a class="header" href="#start-the-second-l2">Start the second L2</a></h3>
<p>Replace <code>L1_BRIDGE_ADDRESS</code> and <code>L1_ON_CHAIN_PROPOSER_ADDRESS</code> with the outputs of the previous command, you can also check it under <code>cmd/.env</code>.
And <code>ROUTER_ADDRESS</code> with the outputs of the first deploy</p>
<pre><code class="language-bash">../../target/release/ethrex \
	l2 \
	--watcher.block-delay 0 \
	--network ../../fixtures/genesis/l2_2.json \
	--http.port 1730 \
	--http.addr 0.0.0.0 \
	--metrics \
	--metrics.port 3703 \
	--datadir dev_ethrex_l2_2 \
	--l1.bridge-address &lt;L1_BRIDGE_ADDRESS&gt; \
	--l1.on-chain-proposer-address &lt;L1_ON_CHAIN_PROPOSER_ADDRESS&gt; \
	--eth.rpc-url http://localhost:8545 \
	--osaka-activation-time 1761677592 \
	--block-producer.coinbase-address 0x0007a881CD95B1484fca47615B64803dad620C8d \
	--block-producer.base-fee-vault-address 0x000c0d6b7c4516a5b274c51ea331a9410fe69127 \
	--block-producer.operator-fee-vault-address 0xd5d2a85751b6F158e5b9B8cD509206A865672362 \
	--block-producer.operator-fee-per-gas 1000000000 \
	--committer.l1-private-key 0x385c546456b6a603a1cfcaa9ec9494ba4832da08dd6bcf4de9a71e4a01b74924 \
	--proof-coordinator.l1-private-key 0x39725efee3fb28614de3bacaffe4cc4bd8c436257e2c8bb887c4b5c4be45e76d \
	--proof-coordinator.addr 127.0.0.1 \
    --proof-coordinator.port 3901 \
    --l1.router-address &lt;ROUTER_ADDRESS&gt; \
    --watcher.l2-rpcs http://localhost:1729 \
    --watcher.l2-chain-ids 65536999
</code></pre>
<h3 id="start-the-prover"><a class="header" href="#start-the-prover">Start the prover</a></h3>
<p>On another terminal</p>
<pre><code class="language-bash">../../target/release/ethrex \
	l2 prover \
	--proof-coordinators tcp://127.0.0.1:3900 tcp://127.0.0.1:3901 \
	--backend exec
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="deploying-a-fee-token"><a class="header" href="#deploying-a-fee-token">Deploying a fee token</a></h1>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="upgrades"><a class="header" href="#upgrades">Upgrades</a></h1>
<h2 id="from-v7-to-v8"><a class="header" href="#from-v7-to-v8">From v7 to v8</a></h2>
<h3 id="database-migration-local-node"><a class="header" href="#database-migration-local-node">Database migration (local node)</a></h3>
<p>This migration applies to the L2 node database only (SQL-backed store). It does not change any on-chain contracts.</p>
<p>The <code>messages</code> table was renamed to <code>l1_messages</code>. Copy the data and then remove the old table:</p>
<pre><code class="language-sql">INSERT INTO l1_messages
SELECT *
FROM messages;
</code></pre>
<p>Then delete the <code>messages</code> table.</p>
<h2 id="from-v8-to-v9"><a class="header" href="#from-v8-to-v9">From v8 to v9</a></h2>
<h3 id="timelock-upgrade-l1-contracts"><a class="header" href="#timelock-upgrade-l1-contracts">Timelock upgrade (L1 contracts)</a></h3>
<p>From ethrex v9 onwards, the Timelock contract manages access to the OnChainProposer (OCP). The OCP owner becomes the Timelock, and the deprecated <code>authorizedSequencerAddresses</code> mapping is replaced by Timelock roles.</p>
<h4 id="what-changes"><a class="header" href="#what-changes">What changes</a></h4>
<ul>
<li>Sequencer permissions move to Timelock roles (<code>SEQUENCER</code>).</li>
<li>Commit and verify transactions must target the Timelock, not the OCP.</li>
<li>Governance and Security Council accounts control upgrades and emergency actions via the Timelock.</li>
</ul>
<h4 id="1-deploy-timelock-proxy--implementation"><a class="header" href="#1-deploy-timelock-proxy--implementation">1) Deploy Timelock (proxy + implementation)</a></h4>
<p>Deploy a Timelock proxy and implementation using your standard UUPS deployment flow. Record the proxy address; that is the address you will initialize and use later.</p>
<h4 id="2-initialize-timelock"><a class="header" href="#2-initialize-timelock">2) Initialize Timelock</a></h4>
<p>Call the Timelock initializer on the proxy:</p>
<pre><code>initialize(uint256 minDelay,address[] sequencers,address governance,address securityCouncil,address onChainProposer)
</code></pre>
<ul>
<li><code>sequencers</code> should include the L1 committer and proof sender addresses (and any other accounts that should commit or verify).</li>
<li><code>securityCouncil</code> is typically the current OCP owner (ideally a multisig).</li>
<li><code>governance</code> is the account that will schedule and execute timelocked upgrades.</li>
</ul>
<h4 id="3-transfer-ocp-ownership-to-timelock"><a class="header" href="#3-transfer-ocp-ownership-to-timelock">3) Transfer OCP ownership to Timelock</a></h4>
<p>From the current OCP owner, transfer ownership with <code>transferOwnership(address)</code>.</p>
<p>Then accept ownership from the Timelock:</p>
<ul>
<li>Normal path: schedule and execute <code>acceptOwnership()</code> through the Timelock (respects <code>minDelay</code>).</li>
<li>Emergency path: the Security Council can call <code>emergencyExecute</code> on the Timelock with calldata for <code>acceptOwnership()</code> to accept immediately.</li>
</ul>
<p>Note: <code>acceptOwnership()</code> must be executed by the Timelock (the pending owner), so it cannot be called directly from an EOA.</p>
<h4 id="4-configure-the-l2-node-to-use-timelock"><a class="header" href="#4-configure-the-l2-node-to-use-timelock">4) Configure the L2 node to use Timelock</a></h4>
<p>This is required because the sequencer can no longer call the OCP directly once the Timelock is the owner. Set the Timelock address so commit and verify calls target the Timelock:</p>
<ul>
<li>CLI flag: <code>--l1.timelock-address &lt;TIMELOCK_PROXY_ADDRESS&gt;</code></li>
<li>Env var: <code>ETHREX_TIMELOCK_ADDRESS=&lt;TIMELOCK_PROXY_ADDRESS&gt;</code></li>
</ul>
<p>The committer requires this address for non-based deployments, and the proof sender/verifier will use it when present.</p>
<p>Do this before restarting the sequencer after the ownership transfer. If the node keeps targeting the OCP after the transfer, commit/verify calls will revert (<code>onlyOwner</code>). If you point to the Timelock before the transfer, the Timelock will forward but the OCP will still reject it because the Timelock is not the owner yet.</p>
<h4 id="5-verify-the-migration"><a class="header" href="#5-verify-the-migration">5) Verify the migration</a></h4>
<ul>
<li>OCP <code>owner()</code> returns the Timelock address.</li>
<li>Sequencer addresses return <code>true</code> for <code>hasRole(SEQUENCER, &lt;addr&gt;)</code> on the Timelock.</li>
<li>The L2 node logs show commit/verify txs sent to the Timelock.</li>
</ul>
<h3 id="database-migration-local-node-1"><a class="header" href="#database-migration-local-node-1">Database migration (local node)</a></h3>
<p>This migration applies to the L2 node database only (SQL-backed store). It does not change any on-chain contracts.</p>
<p>The <code>balance_diffs</code> table added a new <code>value_per_token</code> column of type <code>BLOB</code>:</p>
<pre><code class="language-sql">ALTER TABLE balance_diffs
ADD COLUMN value_per_token BLOB;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="run-a-prover"><a class="header" href="#run-a-prover">Run a prover</a></h1>
<p>This section provides step-by-step guides for running an ethrex L2 prover, which is responsible for generating ZK proofs for L2 blocks. These proofs are then submitted to L1 for verification, finalizing the state of your L2.</p>
<p>Use this section to choose which prover setup best fits your already deployed ethrex L2 and follow the instructions accordingly.</p>
<ul>
<li><a href="l2/deployment/prover/./overview.html">Overview</a></li>
<li><a href="l2/deployment/prover/./sp1.html">Running an ethrex L2 SP1 prover</a></li>
<li><a href="l2/deployment/prover/./risc0.html">Running an ethrex L2 RISC0 prover</a></li>
<li><a href="l2/deployment/prover/./tee.html">Running an ethrex L2 TDX prover</a></li>
<li><a href="l2/deployment/prover/./multi-prover.html">Running multiple provers</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="run-an-ethrex-prover"><a class="header" href="#run-an-ethrex-prover">Run an ethrex prover</a></h1>
<p>Deploying the ethrex L2 contracts on L1 and starting the node isn't everything when it comes to setting up your full ethrex L2 stack.</p>
<p>If you've been following the deployment guide, you should already have an ethrex L2 node running and connected to L1. If that's not the case, I recommend reviewing that guide before proceeding.</p>
<p>The next step is to run the prover—the component responsible for generating ZK proofs for the L2 blocks. These proofs will then be sent to L1 for verification, finalizing the state of your L2.</p>
<p>In this section, we'll cover how to run one or more ethrex L2 provers.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>This section focuses solely on the step-by-step process for running an ethrex L2 prover in any of its forms. For a deeper understanding of how this works under the hood, refer to the <a href="l2/deployment/prover/../../fundamentals/README.html">Fundamentals</a> section. To learn more about the architecture of each mode, see the <a href="l2/deployment/prover/../../architecture/README.html">Architecture</a> section.</p>
</div>
<p>Before proceeding, note that this guide assumes you have ethrex installed. If you haven't installed it yet, follow one of the methods in the <a href="l2/deployment/prover/../../../getting-started/installation/README.html">Installation Guide</a>. If you're looking to build from source, don't skip this section—we'll cover that method here, as it is independent of the deployment approach you choose later.</p>
<h2 id="building-from-source-skip-if-ethrex-is-already-installed-1"><a class="header" href="#building-from-source-skip-if-ethrex-is-already-installed-1">Building from source (skip if ethrex is already installed)</a></h2>
<h3 id="prerequisites-8"><a class="header" href="#prerequisites-8">Prerequisites</a></h3>
<p>Ensure you have the following installed on your system:</p>
<ul>
<li>Rust and Cargo (install via <a href="https://rustup.rs/">rustup</a>)</li>
<li>Solidity compiler v0.8.31 (refer to <a href="https://docs.soliditylang.org/en/latest/installing-solidity.html">Solidity documentation</a>)</li>
<li>SP1 Toolchain (if you plan to use SP1 proving, refer to <a href="https://docs.succinct.xyz/docs/sp1/getting-started/install">SP1 documentation</a>)</li>
<li>RISC0 Toolchain (if you plan to use RISC0 proving, refer to <a href="https://dev.risczero.com/api/zkvm/install">RISC0 documentation</a>)</li>
<li>CUDA Toolkit 12.9 (if you plan to use GPU acceleration for SP1 or RISC0 proving)</li>
</ul>
<ol>
<li>
<p>Clone the official ethrex repository:</p>
<pre><code class="language-shell">git clone https://github.com/lambdaclass/ethrex
cd ethrex
</code></pre>
</li>
<li>
<p>Install the binary to your <code>$PATH</code>:</p>
<pre><code class="language-shell"># For SP1 CPU proving (very slow, not recommended)
cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql,sp1

# For RISC0 CPU proving (very slow, not recommended)
cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql,risc0

# For SP1 and RISC0 CPU proving (very slow, not recommended)
cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql,sp1,risc0

# For SP1 GPU proving
cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql,sp1,gpu

# For RISC0 GPU proving
cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql,risc0,gpu

# For SP1 and RISC0 GPU proving
cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql,sp1,risc0,gpu
</code></pre>
<p><code>cargo install</code> places the binary at <code>~/.cargo/bin/ethrex</code>; ensure that directory is on your <code>$PATH</code>. Add <code>--force</code> if you need to reinstall.</p>
</li>
</ol>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>If you want your verifying keys generation to be reproducible, prepend <code>PROVER_REPRODUCIBLE_BUILD=true</code> to the above command.</p>
<p>Example:</p>
<pre><code class="language-shell">PROVER_REPRODUCIBLE_BUILD=true COMPILE_CONTRACTS=true cargo install --locked --path cmd/ethrex --bin ethrex --features l2,l2-sql,sp1,risc0,gpu
</code></pre>
</div>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>Building with both <code>sp1</code> and <code>risc0</code> features enabled only enables both backends. Settlement will require every proof you mark as required at deploy time (e.g., passing both <code>--sp1 true</code> and <code>--risc0 true</code> in <code>ethrex l2 deploy</code> requires both proofs).</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="run-an-ethrex-l2-sp1-prover"><a class="header" href="#run-an-ethrex-l2-sp1-prover">Run an ethrex L2 SP1 prover</a></h1>
<p>In this section, we'll guide you through the steps to run an ethrex L2 prover that utilizes SP1 for generating ZK proofs. These proofs are essential for validating batch execution and state settlement on your ethrex L2.</p>
<h2 id="prerequisites-9"><a class="header" href="#prerequisites-9">Prerequisites</a></h2>
<ul>
<li>This guide assumes that you have ethrex installed with the SP1 feature and available in your PATH. If you haven't installed it yet, follow one of the methods in the Installation Guide. If you want to build the binary from source, refer to the <a href="l2/deployment/prover/./overview.html#building-from-source-skip-if-ethrex-is-already-installed">Building from source</a> section and select the appropriate build option.</li>
<li>This guide also assumes that you have already deployed an ethrex L2 with SP1 enabled. If you haven't done so yet, please refer to one of the <a href="l2/deployment/prover/../overview.html">Deploying an ethrex L2</a> guides.</li>
</ul>
<h2 id="start-an-ethrex-l2-sp1-prover"><a class="header" href="#start-an-ethrex-l2-sp1-prover">Start an ethrex L2 SP1 prover</a></h2>
<p>Once you have your ethrex L2 deployed with SP1 enabled, you can start the SP1 prover using the following command:</p>
<pre><code class="language-shell">ethrex l2 prover \
--backend sp1 \
--proof-coordinators http://localhost:3900
</code></pre>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>Cualquiera haya sido el metodo de instalacion de ethrex, asegurate de que el binario que estas utilizando tiene soporte para SP1, y tambien para GPU si es que tu intencion es correr un prover SP1 GPU.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>The flag <code>--proof-coordinators</code> is used to specify one or more proof coordinator URLs. This is so because the prover is capable of proving ethrex L2 batches from multiple sequencers. We are particularly setting it to <code>localhost:3900</code> because the command above command uses the port <code>3900</code> for the proof coordinator by default (to learn more about the proof coordinator, read the ethrex L2 sequencer and ethrex L2 prover sections).
We choose SP1 as the backend to indicate the prover to generate SP1 proofs.</p>
</div>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<h3 id="docker-error-response-from-daemon-could-not-select-device-driver--with-capabilities-gpu"><a class="header" href="#docker-error-response-from-daemon-could-not-select-device-driver--with-capabilities-gpu"><code>docker: Error response from daemon: could not select device driver "" with capabilities: [[gpu]]</code></a></h3>
<p>If you encounter the following error when starting the SP1 prover with GPU support:</p>
<pre><code class="language-plaintext">docker: Error response from daemon: could not select device driver "" with capabilities: [[gpu]]
</code></pre>
<p>This error indicates that Docker is unable to find a suitable GPU driver for running containers with GPU support. To resolve this issue, follow these steps:</p>
<ol>
<li><strong>Install NVIDIA Container Toolkit</strong>: Ensure that you have the NVIDIA Container Toolkit installed on your system. This toolkit allows Docker to utilize NVIDIA GPUs. You can follow the installation instructions from the <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html">official NVIDIA documentation</a>.</li>
<li><strong>Configure Docker to use the NVIDIA runtime</strong>: After installing the NVIDIA Container Toolkit, you need to configure Docker to use the NVIDIA runtime by default. You can do this by following the instructions in the <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html#configuring-docker">Configuring Docker documentation</a>.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="run-an-ethrex-l2-risc0-prover"><a class="header" href="#run-an-ethrex-l2-risc0-prover">Run an ethrex L2 RISC0 prover</a></h1>
<p>In this section, we'll guide you through the steps to run an ethrex L2 prover that utilizes RISC0 for generating ZK proofs. These proofs are essential for validating batch execution and state settlement on your ethrex L2.</p>
<h2 id="prerequisites-10"><a class="header" href="#prerequisites-10">Prerequisites</a></h2>
<ul>
<li>This guide assumes that you have ethrex installed with the RISC0 feature and available in your PATH. If you haven't installed it yet, follow one of the methods in the Installation Guide. If you want to build the binary from source, refer to the <a href="l2/deployment/prover/./overview.html#building-from-source-skip-if-ethrex-is-already-installed">Building from source</a> section and select the appropriate build option.</li>
<li>This guide also assumes that you have already deployed an ethrex L2 with RISC0 enabled. If you haven't done so yet, please refer to one of the <a href="l2/deployment/prover/../overview.html">Deploying an ethrex L2</a> guides.</li>
</ul>
<h2 id="start-an-ethrex-l2-risc0-prover"><a class="header" href="#start-an-ethrex-l2-risc0-prover">Start an ethrex L2 RISC0 prover</a></h2>
<p>Once you have your ethrex L2 deployed with RISC0 enabled, you can start the RISC0 prover using the following command:</p>
<pre><code class="language-shell">ethrex l2 prover \
--backend risc0 \
--proof-coordinators http://localhost:3900
</code></pre>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>Cualquiera haya sido el metodo de instalacion de ethrex, asegurate de que el binario que estas utilizando tiene soporte para RISC0, y tambien para GPU si es que tu intencion es correr un prover RISC0 GPU.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>The flag <code>--proof-coordinators</code> is used to specify one or more proof coordinator URLs. This is so because the prover is capable of proving ethrex L2 batches from multiple sequencers. We are particularly setting it to <code>localhost:3900</code> because the command above command uses the port <code>3900</code> for the proof coordinator by default (to learn more about the proof coordinator, read the ethrex L2 sequencer and ethrex L2 prover sections).
We choose RISC0 as the backend to indicate the prover to generate RISC0 proofs.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="run-an-ethrex-tdx-prover"><a class="header" href="#run-an-ethrex-tdx-prover">Run an ethrex TDX prover</a></h1>
<p>In this section, we'll guide you through the steps to run an ethrex L2 TDX prover for generating TEE proofs. These proofs are essential for validating batch execution and state settlement on your ethrex L2.</p>
<h2 id="prerequisites-11"><a class="header" href="#prerequisites-11">Prerequisites</a></h2>
<ul>
<li>This guide assumes that you have already deployed an ethrex L2 with TDX enabled. If you haven't done so yet, please refer to one of the <a href="l2/deployment/prover/../overview.html">Deploying an ethrex L2</a> guides.</li>
<li>A machine with TDX support <a href="https://github.com/canonical/tdx">with the required setup</a>.</li>
</ul>
<h2 id="start-an-ethrex-l2-tdx-prover"><a class="header" href="#start-an-ethrex-l2-tdx-prover">Start an ethrex L2 TDX prover</a></h2>
<p>There's no official release of our ethrex L2 TDX prover yet, so you need to build ethrex from source. To do this, clone the ethrex repository and run:</p>
<pre><code class="language-shell">git clone https://github.com/lambdaclass/ethrex.git

cd ethrex/crates/l2/tee/quote-gen

make run
</code></pre>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Refer to the <a href="l2/deployment/prover/../../architecture/tdx.html">TDX guide</a> for more information on setting up and running the quote generator.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="run-multiple-provers"><a class="header" href="#run-multiple-provers">Run multiple provers</a></h1>
<p>In this section, we'll guide you through the steps to run multiple ethrex L2 provers for generating ZK proofs using different backends. These proofs are essential for validating batch execution and state settlement on your ethrex L2.</p>
<h2 id="prerequisites-12"><a class="header" href="#prerequisites-12">Prerequisites</a></h2>
<ul>
<li>This guide assumes that you have already deployed an ethrex L2 with TDX enabled. If you haven't done so yet, please refer to one of the <a href="l2/deployment/prover/../overview.html">Deploying an ethrex L2</a> guides.</li>
</ul>
<h2 id="start-multiple-ethrex-l2-provers"><a class="header" href="#start-multiple-ethrex-l2-provers">Start multiple ethrex L2 provers</a></h2>
<p>Once you have your ethrex L2 deployed with multiple proving backends enabled (SP1, RISC0, TDX), refer to the following guides to start each prover:</p>
<ul>
<li><a href="l2/deployment/prover/./sp1.html">Run an ethrex L2 SP1 prover</a></li>
<li><a href="l2/deployment/prover/./risc0.html">Run an ethrex L2 RISC0 prover</a></li>
<li><a href="l2/deployment/prover/./tee.html">Run an ethrex TDX prover</a></li>
</ul>
<p>Each prover should be started in different machines to ensure they operate independently and efficiently. Make sure to configure each prover with the appropriate backend flag and proof coordinator URLs as specified in their respective guides.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="monitoring-and-metrics-1"><a class="header" href="#monitoring-and-metrics-1">Monitoring and Metrics</a></h1>
<p>Ethrex exposes metrics in Prometheus format on port <code>9090</code> by default. The easiest way to monitor your node is to use the provided Docker Compose stack, which includes Prometheus and Grafana preconfigured.</p>
<h2 id="quickstart-monitoring-stack-with-docker-compose-1"><a class="header" href="#quickstart-monitoring-stack-with-docker-compose-1">Quickstart: Monitoring Stack with Docker Compose</a></h2>
<ol>
<li>
<p><strong>Clone the repository:</strong></p>
<pre><code class="language-sh">git clone https://github.com/lambdaclass/ethrex.git
cd ethrex/metrics
</code></pre>
</li>
<li>
<p><strong>Start the monitoring stack:</strong></p>
<pre><code class="language-sh">docker compose -f docker-compose-metrics.yaml -f docker-compose-metrics-l2.overrides.yaml up -d
</code></pre>
</li>
</ol>
<p>This will launch Prometheus and Grafana, already set up to scrape ethrex metrics.</p>
<h2 id="accessing-metrics-and-dashboards-1"><a class="header" href="#accessing-metrics-and-dashboards-1">Accessing Metrics and Dashboards</a></h2>
<ul>
<li><strong>Prometheus:</strong> <a href="http://localhost:9091">http://localhost:9091</a></li>
<li><strong>Grafana:</strong> <a href="http://localhost:3001">http://localhost:3001</a>
<ul>
<li>Default login: <code>admin</code> / <code>admin</code></li>
<li>Prometheus is preconfigured as a data source</li>
<li>Example dashboards are included in the repo</li>
</ul>
</li>
</ul>
<p>Metrics from ethrex will be available at <code>http://localhost:9090/metrics</code> in Prometheus format.</p>
<h2 id="custom-configuration-1"><a class="header" href="#custom-configuration-1">Custom Configuration</a></h2>
<p>Your ethrex setup may differ from the default configuration. Check your endpoints at <code>provisioning/prometheus/prometheus_l2.yaml</code>.</p>
<hr />
<p>For manual setup or more details, see the <a href="https://prometheus.io/docs/introduction/overview/">Prometheus documentation</a> and <a href="https://grafana.com/docs/">Grafana documentation</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="admin-api"><a class="header" href="#admin-api">Admin API</a></h1>
<p>This API exposes endpoints to manage the Sequencer.</p>
<h2 id="base-url"><a class="header" href="#base-url">Base URL</a></h2>
<p>By default the server is listening on <code>127.0.0.1:5555</code> but can be configured with <code>--admin-server.addr &lt;address&gt;</code> <code>--admin-server.port &lt;port&gt;</code></p>
<h2 id="endpoints"><a class="header" href="#endpoints">Endpoints</a></h2>
<h3 id="health"><a class="header" href="#health">Health</a></h3>
<hr />
<h4 id="sequencer-health"><a class="header" href="#sequencer-health">Sequencer Health</a></h4>
<p><strong>Description</strong></p>
<p>Performs a healthcheck on all the components of the sequencer returning a json with the status</p>
<p><strong>Endpoint</strong></p>
<pre><code>GET /health
</code></pre>
<p><strong>Example</strong></p>
<pre><code>curl -X GET http://localhost:5555/health
</code></pre>
<hr />
<h4 id="admin-server-health"><a class="header" href="#admin-server-health">Admin server health</a></h4>
<p><strong>Description</strong></p>
<p>Performs a healthcheck on the http admin server</p>
<p><strong>Endpoint</strong></p>
<pre><code>GET /admin/health
</code></pre>
<p><strong>Example</strong></p>
<pre><code>curl -X GET http://localhost:5555/admin/health
</code></pre>
<h3 id="l1-committer"><a class="header" href="#l1-committer">L1 Committer</a></h3>
<hr />
<h4 id="start-committer-immediately"><a class="header" href="#start-committer-immediately">Start Committer immediately</a></h4>
<p><strong>Description</strong></p>
<p>Starts the committer immediately (with a delay of 0).</p>
<p><strong>Endpoint</strong></p>
<pre><code>GET /committer/start
</code></pre>
<p><strong>Example</strong></p>
<pre><code>curl -X GET http://localhost:5555/committer/start
</code></pre>
<hr />
<h4 id="start-committer-with-delay"><a class="header" href="#start-committer-with-delay">Start Committer (with delay)</a></h4>
<p><strong>Description</strong></p>
<p>Starts the committer with a configurable delay.</p>
<p><strong>Endpoint</strong></p>
<pre><code>GET /committer/start/{delay}
</code></pre>
<p><strong>Example</strong></p>
<pre><code>curl -X GET http://localhost:5555/committer/start/60000
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>delay</td><td>number</td><td>Delay in milliseconds before starting the committer.</td></tr>
</tbody></table>
</div>
<hr />
<h4 id="stop-committer"><a class="header" href="#stop-committer">Stop Committer</a></h4>
<p><strong>Description</strong></p>
<p>Stops the committer.</p>
<p><strong>Endpoint</strong></p>
<pre><code>GET /committer/stop
</code></pre>
<p><strong>Example</strong></p>
<pre><code>curl -X GET http://localhost:5555/committer/stop
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="rollup-stages-and-ethrex"><a class="header" href="#rollup-stages-and-ethrex">Rollup Stages and ethrex</a></h1>
<p>This document explains how the <a href="https://l2beat.com/stages">L2Beat rollup stage definitions</a> map to the current ethrex L2 stack.</p>
<h2 id="important-distinctions"><a class="header" href="#important-distinctions">Important Distinctions</a></h2>
<p>Stages are properties of a <strong>deployed</strong> L2, whereas ethrex is a framework that different projects may configure and govern in their own way. In what follows we make two simplifying assumptions:</p>
<ul>
<li>If ethrex provides the functionality required to deploy a Stage X rollup, we consider ethrex capable of achieving Stage X, even if a particular deployment chooses not to enable some features.</li>
<li>When we talk about <strong>ethrex L2</strong> we are referring to ethrex in <strong>rollup mode</strong>, not Validium. In rollup mode, Ethereum L1 is the data availability layer; in Validium mode it is not.</li>
</ul>
<p>The L2Beat framework evaluates <em>decentralization</em> specifically, not security from bugs. A Stage 2 rollup could still have vulnerabilities if the proof system is experimental or unaudited.</p>
<h2 id="stage-0"><a class="header" href="#stage-0">Stage 0</a></h2>
<p>Stage 0 ("Full Training Wheels") represents the basic operational requirements for a rollup.</p>
<h3 id="summary"><a class="header" href="#summary">Summary</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Requirement</th><th>Status</th><th>Details</th></tr></thead><tbody>
<tr><td>Project calls itself a rollup</td><td>✅ Met</td><td>Docs describe ethrex as a framework to launch an L2 rollup</td></tr>
<tr><td>L2 state roots posted on L1</td><td>✅ Met</td><td>Each committed batch stores <code>newStateRoot</code> in <code>OnChainProposer</code></td></tr>
<tr><td>Data availability on L1</td><td>✅ Met</td><td>In rollup mode every batch must publish a non-zero EIP-4844 blob hash</td></tr>
<tr><td>Software to reconstruct state</td><td>✅ Met</td><td>Node, blobs tooling, and prover docs describe how to rebuild state</td></tr>
<tr><td>Proper proof system used</td><td>✅ Met</td><td>Batches verified using zkVM validity proofs (SP1/RISC0) or TDX attestations</td></tr>
</tbody></table>
</div>
<h3 id="detailed-analysis"><a class="header" href="#detailed-analysis">Detailed Analysis</a></h3>
<h4 id="does-the-project-call-itself-a-rollup"><a class="header" href="#does-the-project-call-itself-a-rollup">Does the project call itself a rollup?</a></h4>
<p>Yes. As stated in <a href="l2/./introduction.html">the introduction</a>:</p>
<blockquote>
<p>Ethrex is a framework that lets you launch your own L2 rollup or blockchain.</p>
</blockquote>
<h4 id="are-l2-state-roots-posted-on-l1"><a class="header" href="#are-l2-state-roots-posted-on-l1">Are L2 state roots posted on L1?</a></h4>
<p>Yes. Every time a batch is committed to the <code>OnChainProposer</code> on L1, the new L2 state root is sent and stored in the <code>batchCommitments</code> mapping as <code>newStateRoot</code> for that batch.</p>
<h4 id="does-the-project-provide-data-availability-on-l1"><a class="header" href="#does-the-project-provide-data-availability-on-l1">Does the project provide data availability on L1?</a></h4>
<p>Yes. When committing a batch in rollup mode (non-validium), the transaction must include a non-zero blob hash, so a blob MUST be sent to the <code>OnChainProposer</code> on L1.</p>
<ul>
<li>The <a href="l2/./architecture/overview.html">architecture docs</a> state that the blob contains the <strong>RLP-encoded L2 blocks and fee configuration</strong></li>
<li>The blob commitment (<code>blobKZGVersionedHash</code>) is included in the batch commitment and re-checked during proof verification</li>
</ul>
<p>This means all data needed to reconstruct the L2 (transactions and state) is published on L1 as blobs.</p>
<h4 id="is-software-capable-of-reconstructing-the-rollups-state-available"><a class="header" href="#is-software-capable-of-reconstructing-the-rollups-state-available">Is software capable of reconstructing the rollup's state available?</a></h4>
<p>Yes.</p>
<ul>
<li>The L2 node provides the <code>ethrex l2 reconstruct</code> subcommand to follow L1 commitments and reconstruct the state from blobs</li>
<li>The <a href="l2/../developers/l2/state-reconstruction-blobs.html">state reconstruction blobs</a> doc explains how to generate and use blobs for replaying state</li>
<li>The <a href="l2/./fundamentals/data_availability.html">data availability</a> and <a href="l2/../prover/prover.html">prover docs</a> describe how published data is used to reconstruct and verify state</li>
</ul>
<h4 id="does-the-project-use-a-proper-proof-system"><a class="header" href="#does-the-project-use-a-proper-proof-system">Does the project use a proper proof system?</a></h4>
<p>Yes, assuming proofs are enabled.</p>
<p>ethrex supports multiple proving mechanisms:</p>
<ul>
<li><strong>zkVM validity proofs</strong>: SP1 and RISC0</li>
<li><strong>TDX attestations</strong>: TEE-based verification</li>
<li><strong>Aligned Layer</strong>: Optional proof aggregation for cost efficiency</li>
</ul>
<p>The <code>OnChainProposer</code> contract can be configured to require many combinations of these mechanisms. A batch is only verified on L1 if all configured proofs pass and their public inputs match the committed data (state roots, withdrawals, blobs, etc.).</p>
<h4 id="are-there-at-least-5-external-actors-that-can-submit-a-fraud-proof"><a class="header" href="#are-there-at-least-5-external-actors-that-can-submit-a-fraud-proof">Are there at least 5 external actors that can submit a fraud proof?</a></h4>
<p>Not applicable. ethrex uses <strong>validity proofs</strong>, not fraud proofs. There is no on-chain "challenge game" where watchers submit alternate traces to invalidate a state root.</p>
<h3 id="stage-0-assessment"><a class="header" href="#stage-0-assessment">Stage 0 Assessment</a></h3>
<p><strong>ethrex L2 meets all Stage 0 requirements.</strong></p>
<h2 id="stage-1"><a class="header" href="#stage-1">Stage 1</a></h2>
<p>Stage 1 ("Limited Training Wheels") requires that users have trustless exit guarantees, with a Security Council retaining only limited emergency powers.</p>
<h3 id="core-principle"><a class="header" href="#core-principle">Core Principle</a></h3>
<blockquote>
<p>"The only way (other than bugs) for a rollup to indefinitely block an L2→L1 message or push an invalid L2→L1 message is by compromising ≥75% of the Security Council."</p>
</blockquote>
<h3 id="summary-1"><a class="header" href="#summary-1">Summary</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Requirement</th><th>Status</th><th>Details</th></tr></thead><tbody>
<tr><td>Censorship-resistant L2→L1 messages</td><td>❌ Gap</td><td>Sequencer can indefinitely censor withdrawals; no forced-inclusion mechanism</td></tr>
<tr><td>Sequencer cannot push invalid messages</td><td>✅ Met</td><td>Invalid withdrawals require contract/VK changes controlled by owner</td></tr>
<tr><td>≥7-day exit window for non-SC upgrades</td><td>✅ Met</td><td>Only owner can upgrade; no non-SC upgrade path exists</td></tr>
</tbody></table>
</div>
<h3 id="detailed-analysis-1"><a class="header" href="#detailed-analysis-1">Detailed Analysis</a></h3>
<h4 id="can-l2l1-messages-be-censored"><a class="header" href="#can-l2l1-messages-be-censored">Can L2→L1 messages be censored?</a></h4>
<p><strong>Yes, this is the main Stage 1 gap.</strong></p>
<p>The sequencer can indefinitely block/censor an L2→L1 message (e.g., a withdrawal) by simply not including the withdrawal transaction in an L2 block. This does not require compromising the owner/Security Council.</p>
<p><strong>What's missing</strong>: A forced-inclusion mechanism where users can submit their withdrawal directly on L1, and the sequencer must include it in a subsequent batch within a bounded time window or lose sequencing rights.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>This is the primary blocker for Stage 1 compliance. Implementing forced inclusion of withdrawals enforced by L1 contracts would address this gap.</p>
</div>
<h4 id="can-the-sequencer-push-invalid-l2l1-messages"><a class="header" href="#can-the-sequencer-push-invalid-l2l1-messages">Can the sequencer push invalid L2→L1 messages?</a></h4>
<p><strong>No.</strong> The sequencer cannot unilaterally make L1 accept an invalid L2→L1 message. This would require:</p>
<ul>
<li>Changing contract code</li>
<li>Updating the verifying key in <code>OnChainProposer</code></li>
</ul>
<p>Only the Security Council (owner) can perform those upgrades.</p>
<h4 id="what-about-upgrades-from-entities-outside-the-security-council"><a class="header" href="#what-about-upgrades-from-entities-outside-the-security-council">What about upgrades from entities outside the Security Council?</a></h4>
<p>In ethrex L2 contracts, there are no entities other than the owner that can perform upgrades. Therefore:</p>
<ul>
<li>Upgrades initiated by entities outside the Security Council are not possible</li>
<li>If such an upgrade path were introduced, it would need to provide the required 7-day exit window</li>
</ul>
<h4 id="security-council-configuration"><a class="header" href="#security-council-configuration">Security Council Configuration</a></h4>
<p>Both <code>OnChainProposer</code> and <code>CommonBridge</code> are upgradeable contracts controlled by a single <code>owner</code> address. ethrex itself does not hard-code a Security Council, but a deployment can introduce one by making the <code>owner</code> a multisig.</p>
<p>According to L2Beat requirements, the Security Council should have:</p>
<ul>
<li>At least 8 members</li>
<li>≥75% threshold for critical actions</li>
<li>Diverse signers from different organizations/jurisdictions</li>
</ul>
<h3 id="stage-1-assessment"><a class="header" href="#stage-1-assessment">Stage 1 Assessment</a></h3>
<p><strong>ethrex L2 does not meet Stage 1 requirements today.</strong></p>
<p>The main gap is censorship-resistant L2→L1 messages. The sequencer can ignore withdrawal transactions indefinitely, and there is no forced-inclusion mechanism (unlike the existing forced-inclusion mechanism for deposits).</p>
<h3 id="path-to-stage-1"><a class="header" href="#path-to-stage-1">Path to Stage 1</a></h3>
<p>To achieve Stage 1, ethrex would need:</p>
<ol>
<li><strong>Forced withdrawal inclusion</strong>: Implement an L1 mechanism where users can submit withdrawals directly, with sequencer penalties for non-inclusion</li>
<li><strong>Security Council multisig</strong>: Deploy owner as an 8+ member multisig with ≥75% threshold</li>
<li><strong>Exit window enforcement</strong>: ethrex has Timelock functionality that gates the <code>OnChainProposer</code>, but deployment configuration must enforce ≥7 day delays for non-emergency upgrades</li>
</ol>
<h2 id="stage-2"><a class="header" href="#stage-2">Stage 2</a></h2>
<p>Stage 2 ("No Training Wheels") requires fully permissionless proving and tightly constrained emergency upgrade powers.</p>
<h3 id="summary-2"><a class="header" href="#summary-2">Summary</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Requirement</th><th>Status</th><th>Details</th></tr></thead><tbody>
<tr><td>Permissionless validity proofs</td><td>❌ Gap</td><td>Only authorized sequencers can commit and verify batches</td></tr>
<tr><td>≥30-day exit window</td><td>❌ Gap</td><td>No protocol-level exit window; UUPS upgrades have no mandatory delay</td></tr>
<tr><td>SC restricted to on-chain errors</td><td>❌ Gap</td><td>Owner can pause/upgrade for any reason</td></tr>
</tbody></table>
</div>
<h3 id="detailed-analysis-2"><a class="header" href="#detailed-analysis-2">Detailed Analysis</a></h3>
<h4 id="is-the-validity-proof-system-permissionless"><a class="header" href="#is-the-validity-proof-system-permissionless">Is the validity proof system permissionless?</a></h4>
<p><strong>No.</strong> In the standard <code>OnChainProposer</code> implementation (<code>crates/l2/contracts/src/l1/OnChainProposer.sol</code>), committing and verifying batches are restricted to authorized sequencer addresses only. Submitting proofs is not permissionless.</p>
<h4 id="do-users-have-at-least-30-days-to-exit-before-unwanted-upgrades"><a class="header" href="#do-users-have-at-least-30-days-to-exit-before-unwanted-upgrades">Do users have at least 30 days to exit before unwanted upgrades?</a></h4>
<p><strong>No.</strong> There is no protocol-level exit window tied to contract upgrades. UUPS upgrades can be executed by the owner without a mandatory delay.</p>
<h4 id="is-the-security-council-restricted-to-act-only-due-to-on-chain-errors"><a class="header" href="#is-the-security-council-restricted-to-act-only-due-to-on-chain-errors">Is the Security Council restricted to act only due to on-chain errors?</a></h4>
<p><strong>No.</strong> There is no built-in restriction that limits the owner to responding only to detected on-chain bugs. The owner can pause or upgrade contracts for any reason.</p>
<h3 id="stage-2-assessment"><a class="header" href="#stage-2-assessment">Stage 2 Assessment</a></h3>
<p><strong>ethrex L2 does not meet Stage 2 requirements.</strong></p>
<h3 id="path-to-stage-2"><a class="header" href="#path-to-stage-2">Path to Stage 2</a></h3>
<p>To achieve Stage 2, ethrex would need (in addition to Stage 1 requirements):</p>
<ol>
<li><strong>Permissionless proving</strong>: Allow anyone to submit validity proofs for batches</li>
<li><strong>30-day exit window</strong>: Implement mandatory delay for all contract upgrades</li>
<li><strong>Restricted SC powers</strong>: Limit Security Council actions to adjudicable on-chain bugs only</li>
<li><strong>Mature proof system</strong>: Battle-tested ZK provers with comprehensive security audits</li>
</ol>
<h2 id="comparison-with-other-rollups"><a class="header" href="#comparison-with-other-rollups">Comparison with Other Rollups</a></h2>
<h3 id="based-rollups"><a class="header" href="#based-rollups">Based Rollups</a></h3>
<p>Based rollups delegate sequencing to Ethereum L1 validators rather than using a centralized sequencer. This is particularly relevant for ethrex as it implements based sequencing (currently in development).</p>
<div class="table-wrapper"><table><thead><tr><th>Project</th><th>Current Stage</th><th>Main Gaps</th><th>Proof System</th><th>Sequencer Model</th></tr></thead><tbody>
<tr><td><strong>ethrex L2</strong></td><td>Stage 0</td><td>Forced inclusion, permissionless proving</td><td>Multi-proof (ZK + TEE)</td><td>Based (round-robin)</td></tr>
<tr><td>Taiko Alethia</td><td>Stage 0*</td><td>ZK not mandatory, upgrade delays</td><td>Multi-proof (SGX mandatory, ZK optional)</td><td>Based (permissionless)</td></tr>
<tr><td>Surge</td><td>Not deployed</td><td>N/A (template)</td><td>Based on Taiko stack</td><td>Based (L1 validators)</td></tr>
</tbody></table>
</div>
<p><strong>Taiko Alethia</strong> is the first based rollup on mainnet. It requires two proofs per block: SGX (Geth) is mandatory, plus one of SGX (Reth), SP1, or RISC0. <strong>Critically, blocks can be proven with TEE only (no ZK)</strong> if both SGX verifiers are used. As of early 2025, only ~30% of blocks use ZK proofs. L2BEAT warns that "funds can be stolen if a malicious block is proven by compromised SGX instances." Taiko plans to require 100% ZK coverage with the Shasta fork in Q4 2025.</p>
<blockquote>
<p>*L2BEAT currently classifies Taiko as "not even Stage 0" because "the proof system is still under development." However, Taiko has been a multi-prover based rollup since the Pacaya fork and the system is architecturally prepared for Stage 0. This appears to be a classification nuance rather than a fundamental gap.</p>
</blockquote>
<p><strong>Surge</strong> is a based rollup template by Nethermind, built on the Taiko stack and designed to target Stage 2 from inception. It removes centralized sequencing entirely, letting Ethereum validators handle transaction ordering. Not yet deployed as a production rollup.</p>
<h3 id="zk-rollups"><a class="header" href="#zk-rollups">ZK Rollups</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Project</th><th>Current Stage</th><th>Main Gaps</th><th>Proof System</th></tr></thead><tbody>
<tr><td><strong>ethrex L2</strong></td><td>Stage 0</td><td>Forced inclusion, permissionless proving</td><td>Multi-proof (ZK + TEE)</td></tr>
<tr><td>Scroll</td><td>Stage 1</td><td>30-day window, multi-prover</td><td>ZK validity proofs</td></tr>
<tr><td>zkSync Era</td><td>Stage 0*</td><td>Evaluation pending, forced inclusion</td><td>ZK validity proofs</td></tr>
<tr><td>Starknet</td><td>Stage 1</td><td>30-day window, SC restrictions</td><td>ZK validity proofs (STARK)</td></tr>
</tbody></table>
</div>
<p><strong>Scroll</strong> became the first ZK rollup to achieve Stage 1 (April 2025) through the Euclid upgrade, which introduced permissionless sequencing fallback and a 12-member Security Council with 75% threshold.</p>
<p><strong>zkSync Era</strong> is currently experiencing a <strong>proof system pause</strong> due to a vulnerability, causing partial liveness failure. Previously, a critical bug in zk-circuits was discovered that could have led to $1.9B in potential losses if exploited.</p>
<blockquote>
<p>*L2BEAT states they "haven't finished evaluation" of zkSync Era's Stage 1 elements - not that zkSync fails requirements. The main pending item is a forced inclusion mechanism. With 75% of proving already delegated to external provers and decentralized sequencing (ChonkyBFT) underway, zkSync appears architecturally Stage 1-ready.</p>
</blockquote>
<p><strong>Starknet</strong> reached Stage 1 but shares its SHARP verifier with other StarkEx rollups. The verifier can be changed by a 2/4 multisig with 8-day delay. The Security Council (9/12) retains instant upgrade capability. This shared verifier creates concentration risk across multiple chains.</p>
<h3 id="optimistic-rollups"><a class="header" href="#optimistic-rollups">Optimistic Rollups</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Project</th><th>Current Stage</th><th>Main Gaps</th><th>Proof System</th></tr></thead><tbody>
<tr><td>Arbitrum One</td><td>Stage 1</td><td>SC override power, 30-day window</td><td>Optimistic (fraud proofs)</td></tr>
<tr><td>Optimism</td><td>Stage 1</td><td>Exit window, SC restrictions</td><td>Optimistic (fault proofs)</td></tr>
</tbody></table>
</div>
<p><strong>Arbitrum One</strong> uses BoLD (Bounded Liquidity Delay) for permissionless fraud proofs - anyone can challenge state assertions. However, Arbitrum remains Stage 1 because the Security Council retains broad override powers. Stage 2 requires restricting SC to "provable bugs only" and extending exit windows to 30 days. The ~6.4 day withdrawal delay is inherent to the optimistic model.</p>
<p><strong>Optimism</strong> has permissionless fault proofs but L2BEAT notes: "There is no exit window for users to exit in case of unwanted regular upgrades as they are initiated by the Security Council with instant upgrade power." Both Arbitrum and Optimism are <strong>technically ready for Stage 2</strong> but held back by <strong>intentional governance constraints</strong>, not technical limitations.</p>
<h3 id="l2beat-risk-summary"><a class="header" href="#l2beat-risk-summary">L2BEAT Risk Summary</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Project</th><th>Critical Warnings</th></tr></thead><tbody>
<tr><td>Taiko Alethia</td><td>Funds at risk from compromised SGX; ZK optional; unverified contracts</td></tr>
<tr><td>Scroll</td><td>No upgrade delay; emergency verifier upgrade occurred Aug 2025</td></tr>
<tr><td>zkSync Era</td><td>Proof system currently paused; prior $1.9B bug discovered</td></tr>
<tr><td>Starknet</td><td>Shared SHARP verifier; SC has instant upgrade power</td></tr>
<tr><td>Arbitrum One</td><td>Malicious upgrade risk; optimistic delay (~6.4 days)</td></tr>
<tr><td>Optimism</td><td>No exit window for SC upgrades; dispute game vulnerabilities</td></tr>
</tbody></table>
</div><div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>All rollups carry risks. Even Stage 1 rollups retain Security Council powers that could theoretically be abused. Stage 2 remains unachieved by any production rollup as of early 2025.</p>
</div>
<h3 id="key-observations"><a class="header" href="#key-observations">Key Observations</a></h3>
<ol>
<li><strong>No rollup has achieved Stage 2 yet</strong> - All production rollups remain at Stage 0 or Stage 1</li>
<li><strong>Classification vs architecture gaps</strong> - Some rollups (Taiko, zkSync Era) are classified lower than their architecture supports due to L2BEAT evaluation timing or minor gaps</li>
<li><strong>Governance is the bottleneck</strong> - Arbitrum and Optimism have permissionless proofs but are held at Stage 1 by intentional Security Council powers, not technical limitations</li>
<li><strong>Based rollups are newer</strong> - Taiko and ethrex are pioneering based sequencing, both at Stage 0</li>
<li><strong>Multi-proof is emerging</strong> - ethrex, Taiko, and Scroll are all exploring multi-proof systems for enhanced security</li>
</ol>
<h2 id="recommendations"><a class="header" href="#recommendations">Recommendations</a></h2>
<h3 id="for-stage-1-compliance"><a class="header" href="#for-stage-1-compliance">For Stage 1 Compliance</a></h3>
<ol>
<li>
<p><strong>Implement forced withdrawal inclusion</strong></p>
<ul>
<li>Users can submit withdrawal requests directly to L1</li>
<li>Sequencer must include within N blocks or face penalties</li>
<li>Fallback mechanism if sequencer fails to include</li>
</ul>
</li>
<li>
<p><strong>Deploy Security Council as multisig</strong></p>
<ul>
<li>8+ diverse signers</li>
<li>75%+ threshold (e.g., 6/8)</li>
<li>Document emergency procedures</li>
</ul>
</li>
<li>
<p><strong>Add upgrade timelock</strong></p>
<ul>
<li>Minimum 7-day delay for non-emergency upgrades</li>
<li>Emergency path requires SC threshold</li>
</ul>
</li>
</ol>
<h3 id="for-future-stage-2-transition"><a class="header" href="#for-future-stage-2-transition">For Future Stage 2 Transition</a></h3>
<ol>
<li>
<p><strong>Open proof submission</strong></p>
<ul>
<li>Remove sequencer-only restriction on <code>verifyBatch()</code></li>
<li>Anyone can submit valid proofs</li>
</ul>
</li>
<li>
<p><strong>Extend exit window to 30+ days</strong></p>
<ul>
<li>Mandatory delay on all upgrade paths</li>
<li>Clear user notification mechanism</li>
</ul>
</li>
<li>
<p><strong>Formalize SC restrictions</strong></p>
<ul>
<li>On-chain governance limiting SC powers</li>
<li>Transparent criteria for emergency actions</li>
</ul>
</li>
<li>
<p><strong>Proof system maturity</strong></p>
<ul>
<li>Comprehensive security audits</li>
<li>Multiple independent prover implementations</li>
<li>Operational track record</li>
</ul>
</li>
</ol>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>ethrex L2 currently satisfies all <strong>Stage 0</strong> requirements and provides a solid foundation for rollup deployments.</p>
<p>The path to <strong>Stage 1</strong> is clear but requires implementing censorship-resistant withdrawals through a forced-inclusion mechanism. This is the primary gap preventing Stage 1 compliance.</p>
<p><strong>Stage 2</strong> requires additional work on permissionless proving, extended exit windows, and formal restrictions on Security Council powers.</p>
<div class="table-wrapper"><table><thead><tr><th>Stage</th><th>Status</th><th>Primary Blocker</th></tr></thead><tbody>
<tr><td>Stage 0</td><td>✅ Met</td><td>-</td></tr>
<tr><td>Stage 1</td><td>❌ Not met</td><td>Forced inclusion for withdrawals</td></tr>
<tr><td>Stage 2</td><td>❌ Not met</td><td>Permissionless proving, 30-day exit window</td></tr>
</tbody></table>
</div>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<h3 id="l2beat-resources"><a class="header" href="#l2beat-resources">L2Beat Resources</a></h3>
<ul>
<li><a href="https://l2beat.com/stages">L2Beat Stages Framework</a></li>
<li><a href="https://forum.l2beat.com/t/stages-update-a-high-level-guiding-principle-for-stage-1/338">L2Beat Forum: Stages Update</a></li>
<li><a href="https://medium.com/l2beat/introducing-stages-a-framework-to-evaluate-rollups-maturity-d290bb22befe">L2Beat: Introducing Stages</a></li>
</ul>
<h3 id="rollup-comparisons"><a class="header" href="#rollup-comparisons">Rollup Comparisons</a></h3>
<ul>
<li><a href="https://l2beat.com/scaling/projects/taiko">Taiko Alethia on L2Beat</a></li>
<li><a href="https://l2beat.com/scaling/projects/scroll">Scroll on L2Beat</a></li>
<li><a href="https://l2beat.com/scaling/projects/zksync-era">zkSync Era on L2Beat</a></li>
<li><a href="https://l2beat.com/scaling/projects/starknet">Starknet on L2Beat</a></li>
<li><a href="https://l2beat.com/scaling/projects/arbitrum">Arbitrum One on L2Beat</a></li>
<li><a href="https://l2beat.com/scaling/projects/optimism">Optimism on L2Beat</a></li>
<li><a href="https://www.nethermind.io/blog/surge-a-based-rollup-template-designed-for-ethereums-future">Surge: A Based Rollup Template</a></li>
</ul>
<h3 id="ethrex-documentation"><a class="header" href="#ethrex-documentation">ethrex Documentation</a></h3>
<ul>
<li><a href="l2/./fundamentals/data_availability.html">ethrex Data Availability</a></li>
<li><a href="l2/./fundamentals/withdrawals.html">ethrex Withdrawals</a></li>
<li><a href="l2/./fundamentals/based.html">ethrex Based Sequencing</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="architecture"><a class="header" href="#architecture">Architecture</a></h1>
<p>This section provides an overview of the architecture of an L2 rollup built with ethrex. Here you'll find:</p>
<ul>
<li>High-level diagrams and explanations of the main components</li>
<li>Details on how the sequencer, prover, and other modules interact</li>
<li>Information about aligned mode, the prover, the sequencer, and more</li>
</ul>
<p>Use this section to understand how the different parts of an ethrex L2 fit together.  The <a href="l2/architecture/./overview.html">overview</a> is a good place to start.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="general-overview-of-the-ethrex-l2-stack"><a class="header" href="#general-overview-of-the-ethrex-l2-stack">General overview of the ethrex L2 stack</a></h1>
<p>This document aims to explain how the Lambda ethrex L2 and all its moving parts work.</p>
<h2 id="intro"><a class="header" href="#intro">Intro</a></h2>
<p>At a high level, the way an L2 works is as follows:</p>
<ul>
<li>There is a contract in L1 that tracks the current state of the L2. Anyone who wants to know the current state of the chain need only consult this contract.</li>
<li>Every once in a while, someone (usually the sequencer, but could be a decentralized network, or even anyone at all in the case of a based contestable rollup) builds a batch of new L2 blocks and publishes it to L1. We will call this the <code>commit</code> L1 transaction.</li>
<li>For L2 batches to be considered finalized, a zero-knowledge proof attesting to the validity of the batch needs to be sent to L1, and its verification needs to pass. If it does, everyone is assured that all blocks in the batch were valid and thus the new state is. We call this the <code>verification</code> L1 transaction.</li>
</ul>
<p>We ommited a lot of details in this high level explanation. Some questions that arise are:</p>
<ul>
<li>What does it mean for the L1 contract to track the state of L2? Is the entire L2 state kept on it? Isn't it really expensive to store a bunch of state on an Ethereum smart contract?</li>
<li>What does the ZK proof prove exactly?</li>
<li>How do we make sure that the sequencer can't do anything malicious if it's the one proposing blocks and running every transaction?</li>
<li>How does someone go in and out of the L2, i.e., how do you deposit money from L1 into L2 and then withdraw it? How do you ensure this can't be tampered with? Bridges are by far the most vulnerable part of blockchains today and going in and out of the L2 totally sounds like a bridge.</li>
</ul>
<p>Below some answers to these questions, along with an overview of all the moving parts of the system.</p>
<h2 id="how-do-you-prove-state"><a class="header" href="#how-do-you-prove-state">How do you prove state?</a></h2>
<p>Now that general purpose <code>zkVM</code>s exist, most people have little trouble with the idea that you can prove execution. Just take the usual EVM code you wrote in Rust, compile to some <code>zkVM</code> target instead and you're mostly done. You can now prove it.</p>
<p>What's usually less clear is how you prove state. Let's say we want to prove a new L2 batch of blocks that were just built. Running the <code>ethrex</code> <code>execute_block</code> function on a Rust <code>zkVM</code> for all the blocks in the batch does the trick, but that only proves that you ran the VM correctly on <strong>some</strong> previous state/batch. How do you know it was the actual previous state of the L2 and not some other, modified one?</p>
<p>In other words, how do you ensure that:</p>
<ul>
<li>Every time the EVM <strong>reads</strong> from some storage slot (think an account balance, some contract's bytecode), the value returned matches the actual value present on the previous state of the chain.</li>
</ul>
<p>For this, the VM needs to take as a public input the previous state of the L2, so the prover can show that every storage slot it reads is consistent with it, and the verifier contract on L1 can check that the given public input is the actual previous state it had stored. However, we can't send the entire previous state as public input because it would be too big; this input needs to be sent on the <code>verification</code> transaction, and the entire L2 state does not fit on it.</p>
<p>To solve this, we do what we always do: instead of having the actual previous state be the public input, we build a <strong>Merkle Tree</strong> of the state and <strong>use its root as the input</strong>. Now the state is compressed into a single 32-byte value, an unforgeable representation of it; if you try to change a single bit, the root will change. This means we now have, for every L2 batch, a single hash that we use to represent it, which we call the batch <code>commitment</code> (we call it "commitment" and not simply "state root" because, as we'll see later, this won't just be the state root, but rather the hash of a few different values including the state root).</p>
<p>The flow for the prover is then roughly as follows:</p>
<ul>
<li>Take as public input the previous batch commitment and the next (output) batch commitment.</li>
<li>Execute all blocks in the batch to prove its execution is valid. Here "execution" means more than just transaction execution; there's also header validation, transaction validation, etc. (essentially all the logic <code>ethrex</code> needs to follow when executing and adding a new block to the chain).</li>
<li>For every storage slot read, present and verify a merkle path from it to the previous state root (i.e. previous batch commitment).</li>
<li>For every storage slot written, present and verify a merkle path from it to the next state root (i.e. next batch commitment).</li>
</ul>
<p>As a final note, to keep the public input a 32 byte value, instead of passing the previous and next batch commitments separately, we hash the two of them and pass that. The L1 contract will then have an extra step of first taking both commitments and hashing them together to form the public input.</p>
<p>These two ideas will be used extensively throughout the rest of the documentation:</p>
<ul>
<li>Whenever we need to add some state as input, we build a merkle tree and use its <strong>root</strong> instead. Whenever we use some part of that state in some way, the prover provides merkle paths to the values involved. Sometimes, if we don't care about efficient inclusion proofs of parts of the state, we just hash the data altogether and use that instead.</li>
<li>To keep the batch commitment (i.e. the value attesting to the entire state of the chain) a 32 byte value, we hash the different public inputs into one. The L1 contract is given all the public inputs on <code>commit</code>, checks their validity and then squashes them into one through hashing.</li>
</ul>
<h2 id="reconstructing-statedata-availability"><a class="header" href="#reconstructing-statedata-availability">Reconstructing state/Data Availability</a></h2>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>The <strong>state diff</strong> mechanism is retained here for historical and conceptual reference.<br />
Ethrex now publishes <strong>RLP-encoded blocks</strong> (with fee configs) in blobs.<br />
The principles of verification and compression described below still apply conceptually to this new model.</p>
</div>
<p>While using a merkle root as a public input for the proof works well, there is still a need to have the state on L1. If the only thing that's published to it is the state root, then the sequencer could withhold data on the state of the chain. Because it is the one proposing and executing blocks, if it refuses to deliver certain data (like a merkle path to prove a withdrawal on L1), people may not have any place to get it from and get locked out of the chain or some of their funds.</p>
<p>This is called the <strong>Data Availability</strong> problem. As discussed before, sending the entire state of the chain on every new L2 batch is impossible; state is too big. As a first next step, what we could do is:</p>
<ul>
<li>For every new L2 batch, send as part of the <code>commit</code> transaction the list of transactions in the batch. Anyone who needs to access the state of the L2 at any point in time can track all <code>commit</code> transactions, start executing them from the beginning and recontruct the state.</li>
</ul>
<p>This is now feasible; if we take 200 bytes as a rough estimate for the size of a single transfer between two users (see <a href="https://ethereum.stackexchange.com/questions/30175/what-is-the-size-bytes-of-a-simple-ethereum-transaction-versus-a-bitcoin-trans">this post</a> for the calculation on legacy transactions) and 128 KB as <a href="https://github.com/ethereum/go-ethereum/blob/830f3c764c21f0d314ae0f7e60d6dd581dc540ce/core/txpool/legacypool/legacypool.go#L49-L53">a reasonable transaction size limit</a> we get around ~650 transactions at maximum per <code>commit</code> transaction (we are assuming we use calldata here, blobs can increase this limit as each one is 128 KB and we could use multiple per transaction).</p>
<p>Going a bit further, instead of posting the entire transaction, we could just post which accounts have been modified and their new values (this includes deployed contracts and their bytecode of course). This can reduce the size a lot for most cases; in the case of a regular transfer as above, we only need to record balance updates of two accounts, which requires sending just two <code>(address, balance)</code> pairs, so (20 + 32) * 2 = 104 bytes, or around half as before. Some other clever techniques and compression algorithms can push down the publishing cost of this and other transactions much further.</p>
<p>This is called <code>state diffs</code>. Instead of publishing entire transactions for data availability, we only publish whatever state they modified. This is enough for anyone to reconstruct the entire state of the chain.</p>
<p>Detailed documentation on <a href="l2/architecture/../fundamentals/state_diffs.html">the state diffs spec</a>.</p>
<h3 id="how-do-we-prevent-the-sequencer-from-publishing-the-wrong-state-diffs"><a class="header" href="#how-do-we-prevent-the-sequencer-from-publishing-the-wrong-state-diffs">How do we prevent the sequencer from publishing the wrong state diffs?</a></h3>
<p>Once again, state diffs have to be part of the public input. With them, the prover can show that they are equal to the ones returned by the VM after executing all blocks in the batch. As always, the actual state diffs are not part of the public input, but <strong>their hash</strong> is, so the size is a fixed 32 bytes. This hash is then part of the batch commitment. The prover then assures us that the given state diff hash is correct (i.e. it exactly corresponds to the changes in state of the executed blocks).</p>
<p>There's still a problem however: the L1 contract needs to have the actual state diff for data availability, not just the hash. This is sent as part of calldata of the <code>commit</code> transaction (actually later as a blob, we'll get to that), so the sequencer could in theory send the wrong state diff. To make sure this can't happen, the L1 contract hashes it to make sure that it matches the actual state diff hash that is included as part of the public input.</p>
<p>With that, we can be sure that state diffs are published and that they are correct. The sequencer cannot mess with them at all; either it publishes the correct state diffs or the L1 contract will reject its batch.</p>
<h3 id="compression"><a class="header" href="#compression">Compression</a></h3>
<p>Because state diffs are compressed to save space on L1, this compression needs to be proven as well. Otherwise, once again, the sequencer could send the wrong (compressed) state diffs. This is easy though, we just make the prover run the compression and we're done.</p>
<h2 id="eip-4844-aka-blobs"><a class="header" href="#eip-4844-aka-blobs">EIP 4844 (a.k.a. Blobs)</a></h2>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>The explanations below originally refer to <em>state diffs</em>, but the same blob-based mechanism now carries <strong>RLP-encoded block data</strong> and their associated <strong>fee configs</strong>.</p>
</div>
<p>While we could send state diffs through calldata, there is a (hopefully) cheaper way to do it: blobs. The Ethereum Cancun upgrade introduced a new type of transaction where users can submit a list of opaque blobs of data, each one of size at most 128 KB. The main purpose of this new type of transaction is precisely to be used by rollups for data availability; they are priced separately through a <code>blob_gas</code> market instead of the regular <code>gas</code> one and for all intents and purposes should be much cheaper than calldata.</p>
<p>Using EIP 4844, our state diffs would now be sent through blobs. While this is cheaper, there's a new problem to address with it. The whole point of blobs is that they're cheaper because they are only kept around for approximately two weeks and ONLY in the beacon chain, i.e. the consensus side. The execution side (and thus the EVM when running contracts) does not have access to the contents of a blob. Instead, the only thing it has access to is a <strong>KZG commitment</strong> of it.</p>
<p>This is important. If you recall, the way the L1 ensured that the state diff published by the sequencer was correct was by hashing its contents and ensuring that the hash matched the given state diff hash. With the contents of the state diff now no longer accesible by the contract, we can't do that anymore, so we need another way to ensure the correct contents of the state diff (i.e. the blob).</p>
<p>The solution is through a <a href="https://ethresear.ch/t/easy-proof-of-equivalence-between-multiple-polynomial-commitment-schemes-to-the-same-data/8188">proof of equivalence</a> between polynomial commitment schemes. The idea is as follows: proofs of equivalence allow you to show that two (polynomial) commitments point to the same underlying data. In our case, we have two commitments:</p>
<ul>
<li>The state diff commitment calculated by the sequencer/prover.</li>
<li>The KZG commitment of the blob sent on the commit transaction (recall that the blob should just be the state diff).</li>
</ul>
<p>If we turn the first one into a polynomial commitment, we can take a random evaluation point through Fiat Shamir and prove that it evaluates to the same value as the KZG blob commitment at that point. The <code>commit</code> transaction then sends the blob commitment and, through the point evaluation precompile, verifies that the given blob evaluates to that same value. If it does, the underlying blob is indeed the correct state diff.</p>
<p>Our proof of equivalence implementation follows Method 1 <a href="https://notes.ethereum.org/@dankrad/kzg_commitments_in_proofs">here</a>. What we do is the following:</p>
<h3 id="prover-side"><a class="header" href="#prover-side">Prover side</a></h3>
<ul>
<li>
<p>Take the state diff being commited to as <code>4096</code> 32-byte chunks (these will be interpreted as field elements later on, but for now we don't care). Call these chunks <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, with <code>i</code> ranging from 0 to 4095.</p>
</li>
<li>
<p>Build a merkle tree with the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> as leaves. Note that we can think of the merkle root as a polynomial commitment, where the <code>i</code>-th leaf is the evaluation of the polynomial on the <code>i</code>-th power of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span></span></span></span>, the <code>4096</code>-th root of unity on <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>, the field modulus of the <code>BLS12-381</code> curve. Call this polynomial <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span>. This is the same polynomial that the L1 KZG blob commits to (by definition). Call the L1 blob KZG commitment <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and the merkle root we just computed <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>
</li>
<li>
<p>Choose <code>x</code> as keccak(<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) and calculate the evaluation <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span>; call it <code>y</code>. To do this calculation, because we only have the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, the easiest way to do it is through the <a href="https://dankradfeist.de/ethereum/2021/06/18/pcs-multiproofs.html#evaluating-a-polynomial-in-evaluation-form-on-a-point-outside-the-domain">barycentric formula</a>. IMPORTANT: we are taking the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, <code>x</code>, <code>y</code>, and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span></span></span></span> as elements of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>, NOT the native field used by our prover. The evaluation thus is:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.0788em;vertical-align:-1.2777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4096</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4096</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8011em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4095</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5017em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7507em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8247em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
</li>
<li>
<p>Set <code>x</code> and <code>y</code> as public inputs. All the above shows the verifier on L1 that we made a polynomial commitment to the state diff, that its evaluation on <code>x</code> is <code>y</code>, and that <code>x</code> was chosen through Fiat-Shamir by hashing the two commitments.</p>
</li>
</ul>
<h3 id="verifier-side"><a class="header" href="#verifier-side">Verifier side</a></h3>
<ul>
<li>When commiting to the data on L1 send, as part of the calldata, a kzg blob commitment along with an opening proving that it evaluates to <code>y</code> on <code>x</code>. The contract, through the point evaluation precompile, checks that both:
<ul>
<li>The commitment's hash is equal to the versioned hash for that blob.</li>
<li>The evaluation is correct.</li>
</ul>
</li>
</ul>
<h2 id="transition-to-rlp-encoded-blocks"><a class="header" href="#transition-to-rlp-encoded-blocks">Transition to RLP-encoded Blocks</a></h2>
<p>The state diff approach has been deprecated. While it provided a more compact representation, it only guaranteed the availability of the modified state, not the original transactions themselves. To ensure that transactions are also publicly available, Ethrex now publishes <strong>RLP-encoded blocks</strong>, together with their corresponding <strong>fee configurations</strong>, directly in blobs (see <a href="l2/architecture/../fundamentals/transaction_fees.html">Transaction fees</a>).</p>
<p>This new approach guarantees both transaction and state availability, at the cost of higher data size. According to our internal measurements (<a href="l2/architecture/../fundamentals/block_vs_state_diff_measurements.html"><code>block_vs_state_diff_measurements.md</code></a>), sending block lists in blobs instead of state diffs decreases the number of transactions that can fit in a single blob by approximately <strong>2× for ETH transfers</strong> and <strong>3× for ERC20 transfers</strong>.</p>
<h2 id="l1-l2-communication"><a class="header" href="#l1-l2-communication">L1&lt;-&gt;L2 communication</a></h2>
<p>To communicate between L1 and L2, we use two mechanisms called <em>Privileged transactions</em>, and <em>L1 messages</em>.
In this section we talk a bit about them, first going through the more specific use cases for <em>Deposits</em> and <em>Withdrawals</em>.</p>
<h3 id="deposits"><a class="header" href="#deposits">Deposits</a></h3>
<p>The mechanism for depositing funds to L2 from L1 is explained in detail in <a href="l2/architecture/../fundamentals/deposits.html">"Deposits"</a>.</p>
<h3 id="withdrawals"><a class="header" href="#withdrawals">Withdrawals</a></h3>
<p>The mechanism for withdrawing funds from L2 back to L1 is explained in detail in <a href="l2/architecture/../fundamentals/withdrawals.html">"Withdrawals"</a>.</p>
<h2 id="recap"><a class="header" href="#recap">Recap</a></h2>
<h3 id="batch-commitment"><a class="header" href="#batch-commitment">Batch Commitment</a></h3>
<p>An L2 batch commitment contains:</p>
<ul>
<li>The new L2 state root.</li>
<li>The latest block's hash</li>
<li>The KZG versioned hash of the blobs published by the L2</li>
<li>The rolling hash of the processed privileged transactions</li>
<li>The Merkle root of the withdrawal logs</li>
</ul>
<p>These are committed as public inputs of the zk proof that validates a new L2 state.</p>
<h2 id="l1-contract-checks"><a class="header" href="#l1-contract-checks">L1 contract checks</a></h2>
<h3 id="commit-transaction"><a class="header" href="#commit-transaction">Commit transaction</a></h3>
<p>For the <code>commit</code> transaction, the L1 verifier contract receives the batch commitment, as defined previously, for the new batch.</p>
<p>The contract will then:</p>
<ul>
<li>Check that the batch number is the immediate successor of the last committed batch.</li>
<li>Check that the batch has not been committed already.</li>
<li>Check that the <code>lastBlockHash</code> is not zero.</li>
<li>If privileged transactions were processed, it checks the submitted hash against the one in the <code>CommonBridge</code> contract.</li>
<li>If withdrawals were processed, it publishes them to the <code>CommonBridge</code> contract.</li>
<li>It checks that a blob was published if the L2 is running as a rollup, or that no blob was published if it's running as a validium.</li>
<li>Calculate the new batch commitment and store it.</li>
</ul>
<h3 id="verify-transaction"><a class="header" href="#verify-transaction">Verify transaction</a></h3>
<p>On a <code>verification</code> transaction, the L1 contract receives the following:</p>
<ul>
<li>The batch number.</li>
<li>The RISC-V Zero-Knowledge proof of the batch execution (if enabled).</li>
<li>The SP1 Zero-Knowledge proof of the batch execution (if enabled).</li>
<li>The TDX Zero-Knowledge proof of the batch execution (if enabled).</li>
</ul>
<p>The contract will then:</p>
<ul>
<li>Check that the batch number is the immediate successor of the last verified batch.</li>
<li>Check that the batch has been committed.</li>
<li>It removes the pending transaction hashes from the <code>CommonBridge</code> contract.</li>
<li>It verifies the public data of the proof, checking that the data committed in the <code>commitBatch</code> call matches the data in the public inputs of the proof.</li>
<li>Pass the proof and public inputs to the verifier and assert the proof passes.</li>
<li>If the proof passes, finalize the L2 state, setting the latest batch as the given one and allowing any withdrawals for that batch to occur.</li>
</ul>
<h2 id="what-the-sequencer-cannot-do"><a class="header" href="#what-the-sequencer-cannot-do">What the sequencer cannot do</a></h2>
<ul>
<li><strong>Forge Transactions</strong>: Invalid transactions (e.g. sending money from someone who did not authorize it) are not possible, since part of transaction execution requires signature verification. Every transaction has to come along with a signature from the sender. That signature needs to be verified; the L1 verifier will reject any block containing a transaction whose signature is not valid.</li>
<li><strong>Withhold State</strong>: Every L1 <code>commit</code> transaction needs to send the corresponding state diffs for it and the contract, along with the proof, make sure that they indeed correspond to the given batch. TODO: Expand with docs on how this works.</li>
<li><strong>Mint money for itself or others</strong>: The only valid protocol transaction that can mint money for a user is an L1 deposit. Every one of these mint transactions is linked to exactly one deposit transaction on L1. TODO: Expand with some docs on the exact details of how this works.</li>
</ul>
<h2 id="what-the-sequencer-can-do"><a class="header" href="#what-the-sequencer-can-do">What the sequencer can do</a></h2>
<p>The main thing the sequencer can do is CENSOR transactions. Any transaction sent to the sequencer could be arbitrarily dropped and not included in blocks. This is not completely enforceable by the protocol, but there is a big mitigation in the form of an <strong>escape hatch</strong>.</p>
<p>TODO: Explain this in detail.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ethrex-l2-sequencer"><a class="header" href="#ethrex-l2-sequencer">Ethrex L2 sequencer</a></h1>
<h2 id="components"><a class="header" href="#components">Components</a></h2>
<p>The L2 Proposer is composed of the following components:</p>
<h3 id="block-producer"><a class="header" href="#block-producer">Block Producer</a></h3>
<p>Creates Blocks with a connection to the <code>auth.rpc</code> port.</p>
<h3 id="l1-watcher"><a class="header" href="#l1-watcher">L1 Watcher</a></h3>
<p>This component monitors the L1 for new deposits made by users. For that, it queries the CommonBridge contract on L1 at regular intervals (defined by the config file) for new DepositInitiated() events. Once a new deposit event is detected, it creates the corresponding deposit transaction on the L2. It also periodically fetches the <code>BlobBaseFee</code> from L1 (at a configured interval), which is used to compute the <a href="l2/architecture/../fundamentals/transaction_fees.html#l1-fees">L1 fees</a>.</p>
<h3 id="l1-transaction-sender-aka-l1-committer"><a class="header" href="#l1-transaction-sender-aka-l1-committer">L1 Transaction Sender (a.k.a. L1 Committer)</a></h3>
<p>As the name suggests, this component sends transactions to the L1. But not any transaction, only commit and verify transactions.</p>
<p>Commit transactions are sent when the Proposer wants to commit to a new batch of blocks. These transactions contain the batch data to be committed in the L1.</p>
<p>Verify transactions are sent by the Proposer after the prover has successfully generated a proof of block execution to verify it. These transactions contains the new state root of the L2, the hash of the state diffs produced in the block, the root of the withdrawals logs merkle tree and the hash of the processed deposits.</p>
<h3 id="proof-coordinator"><a class="header" href="#proof-coordinator">Proof Coordinator</a></h3>
<p>The Proof Coordinator is a simple TCP server that manages communication with a component called the Prover. The Prover acts as a simple TCP client that makes requests to prove a block to the Coordinator. It responds with the proof input data required to generate the proof. Then, the Prover executes a zkVM, generates the Groth16 proof, and sends it back to the Coordinator.</p>
<p>The Proof Coordinator centralizes the responsibility of determining which block needs to be proven next and how to retrieve the necessary data for proving. This design simplifies the system by reducing the complexity of the Prover, it only makes requests and proves blocks.</p>
<p>For more information about the Proof Coordinator, the Prover, and the proving process itself, see the <a href="l2/architecture/./prover.html">Prover Docs</a>.</p>
<h3 id="l1-proof-sender"><a class="header" href="#l1-proof-sender">L1 Proof Sender</a></h3>
<p>The L1 Proof Sender is responsible for interacting with Ethereum L1 to manage proof verification. Its key functionalities include:</p>
<ul>
<li>Connecting to Ethereum L1 to send proofs for verification.</li>
<li>Dynamically determine required proof types based on active verifier contracts (<code>REQUIRE_&lt;prover&gt;_PROOF</code>).</li>
<li>Ensure blocks are verified in the correct order by invoking the <code>verify(..)</code> function in the <code>OnChainProposer</code> contract. Upon successful verification, an event is emitted to confirm the block's verification status.</li>
<li>Operating on a configured interval defined by <code>proof_send_interval_ms</code>.</li>
</ul>
<h2 id="configuration-3"><a class="header" href="#configuration-3">Configuration</a></h2>
<p>Configuration is done either by CLI flags or through environment variables. Run <code>cargo run --release --bin ethrex -- l2 --help</code> in the repository's root directory to see the available CLI flags and envs.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ethrex-prover-for-l2"><a class="header" href="#ethrex-prover-for-l2">ethrex-prover for L2</a></h1>
<h2 id="intro-1"><a class="header" href="#intro-1">Intro</a></h2>
<p>The prover consists of two main components: handling incoming proving data from the L2 sequencer, specifically from the <code>ProofCoordinator</code> component, and the actual zkVM running and generating proofs of execution.</p>
<p>In summary, the prover manages the inputs from the <code>ProofCoordinator</code> and then calls the zkVM to perform the proving process and generate the zero-knowledge proof (groth16 for on-chain verification, or a compressed STARK for verification via Aligned Layer).</p>
<h2 id="workflow"><a class="header" href="#workflow">Workflow</a></h2>
<p>The <code>ProofCoordinator</code> monitors requests for new jobs from the <code>Prover</code>, which are sent when the prover is available. Upon receiving a new job, the Prover generates the proof, after which the <code>Prover</code> sends the proof back to the <code>ProofCoordinator</code>.</p>
<pre class="mermaid">sequenceDiagram
    participant zkVM
    participant Prover
    participant ProofCoordinator
    Prover-&gt;&gt;+ProofCoordinator: ProofData::Request
    ProofCoordinator--&gt;&gt;-Prover: ProofData::Response(inputs)
    Prover-&gt;&gt;+zkVM: Prove(inputs)
    zkVM--&gt;&gt;-Prover: generates zk proof
    Prover-&gt;&gt;+ProofCoordinator: ProofData::Submit(batch number, proof)
    ProofCoordinator--&gt;&gt;-Prover: ProofData::SubmitAck(batch number)
</pre>
<p>For running the prover, see <a href="l2/architecture/../../l2/deployment/overview.html">Deploy an L2</a>.
For developer-focused setup and run instructions, see <a href="l2/architecture/../../developers/l2/prover.html">Running the Prover</a>.
For comprehensive details on the internals of the prover, see <a href="l2/architecture/../../prover/prover.html">ethrex-prover</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="tdx-execution-module"><a class="header" href="#tdx-execution-module">TDX execution module</a></h1>
<p>This document has documentation related to proving ethrex blocks using TDX.</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<ul>
<li>Running the following without an L2 running will continuously throw the error: <code>Error sending quote: Failed to get ProverSetupAck: Connection refused (os error 111)</code>. If you want to run this in a proper setup go to the <a href="l2/architecture/tdx.html#running">Running</a> section.</li>
<li>The quote generator runs in a QEMU, to quit it press <code>CTRL+A X</code>.</li>
</ul>
</div>
<p>On a machine with TDX support <a href="https://github.com/canonical/tdx">with the required setup</a> go to quote-gen and run</p>
<pre><code class="language-sh">make run
</code></pre>
<h2 id="what-is-tdx"><a class="header" href="#what-is-tdx">What is TDX?</a></h2>
<p>TDX is an Intel technology implementing a Trusted Execution Environment.
Such an environment allows verifying certain code was executed without being tampered with or observed.</p>
<p>These verifications (attestations) are known as "quotes" and contain signatures verifying the attestation was generated by a genuine processor, the measurements at the time, and a user-provided piece of data binding the proof.</p>
<p>The measurements are saved to four Run Time Measurement Registers (RTMR), with each RTMR respresenting a boot stage.
This is analogous to <a href="https://uapi-group.org/specifications/specs/linux_tpm_pcr_registry/">how PCRs work</a>.</p>
<h2 id="usage-considerations"><a class="header" href="#usage-considerations">Usage considerations</a></h2>
<p>Do not hardcode quote verification parameters as <a href="https://cc-enabling.trustedservices.intel.com/intel-tdx-enabling-guide/02/infrastructure_setup/#tcb-recovery-tcb-r">they might change</a>.</p>
<p>It's easy to silently overlook non-verified areas such as accidentally leaving login enabled, or not verifying the integrity of the state.</p>
<h2 id="boot-sequence"><a class="header" href="#boot-sequence">Boot sequence</a></h2>
<ul>
<li>Firmware (OVMF here) is loaded (and hashed into RTMR[0])</li>
<li><a href="https://uapi-group.org/specifications/specs/unified_kernel_image/">UKI</a> is loaded (and hashed into a RTMR)</li>
<li>kernel and initrd are extracted from the UKI and executed</li>
<li>root partition is verified using the <code>roothash=</code> value provided on the kernel cmdline and the <code>hash</code> partition with the dm-verity merkle tree</li>
<li>root partition is mounted read-only</li>
<li>(WIP) systemd executes the payload</li>
</ul>
<h2 id="image-build-components"><a class="header" href="#image-build-components">Image build components</a></h2>
<p>For reproducibility of images and hypervisor runtime we use <a href="https://en.wikipedia.org/wiki/Nix_(package_manager)">Nix</a>.</p>
<h3 id="hypervisornix"><a class="header" href="#hypervisornix">hypervisor.nix</a></h3>
<p>This builds the modified (with patches for TDX support) qemu, and TDX-specific VBIOS (OVMF) and exports a script to run a given image (the parameters, specifically added devices, affect the measurements).</p>
<h3 id="servicenix"><a class="header" href="#servicenix">service.nix</a></h3>
<p>This contains the quote-gen service. It's hash changes every time a non-gitignored file changes.</p>
<h3 id="imagenix"><a class="header" href="#imagenix">image.nix</a></h3>
<p>Exports an image that uses <a href="https://uapi-group.org/specifications/specs/unified_kernel_image/">UKI</a> and <a href="https://source.android.com/docs/security/features/verifiedboot/dm-verity?hl=en">dm-verity</a> to generate an image where changing any component changes the hash of the bootloader (the UKI image), which is measured by the BIOS.</p>
<h2 id="running"><a class="header" href="#running">Running</a></h2>
<p>You can enable the prover by setting <code>ETHREX_L2_TDX=true</code>.</p>
<p>For development purposes, you can use the flag <code>ETHREX_TDX_DEV_MODE=true</code> to disable quote verification. This allows you to run the quote generator even without having TDX-capable hardware.</p>
<p>Ensure the proof coordinator is reachable at 172.17.0.1. You can bring up the network by first starting the L2 components:</p>
<pre><code class="language-sh">// cd crates/l2
make init ETHREX_L2_TDX=true PROOF_COORDINATOR_ADDRESS=0.0.0.0
</code></pre>
<p>And in another terminal, running the VM:</p>
<pre><code class="language-sh">// cd crates/l2
make -C tee/quote-gen run
</code></pre>
<h2 id="troubleshooting-1"><a class="header" href="#troubleshooting-1">Troubleshooting</a></h2>
<h3 id="unshare-write-failed-procselfuid_map-operation-not-permitted"><a class="header" href="#unshare-write-failed-procselfuid_map-operation-not-permitted"><code>unshare: write failed /proc/self/uid_map: Operation not permitted</code></a></h3>
<p>If you get this error when building the image, it's probably because your OS has unprivileged userns restricted by default. You can undo this by running the following commands as root, or running the build as root while disabling sandboxing.</p>
<pre><code class="language-sh">sysctl kernel.unprivileged_userns_apparmor_policy=0
sysctl kernel.apparmor_restrict_unprivileged_userns=0
</code></pre>
<h3 id="rtmrmrtd-mismatch"><a class="header" href="#rtmrmrtd-mismatch">RTMR/MRTD mismatch</a></h3>
<p>If any code or dependencies changed, the measurements will change.</p>
<p>To obtain the new measurements, first you obtain the quote by running the prover (you don't need to have the l2 running). It's output will contain <code>Sending quote &lt;very long hex string&gt;</code>.</p>
<p>This usually causes a RTMR1 mismatch. The easiest way to obtain the new RTMR values is by looking at the printed quote for the next 96 bytes after the RTMR0, corresponding to RTMR1||RTMR2 (48 bytes each).</p>
<p>More generally, you can generate a report with DCAP.verifyAndAttestOnChain(quote) which validates and extracts the report.</p>
<p>Look at bytes 341..485 of the output for RTMRs and bytes 149..197 for the MRTD.</p>
<p>For example, the file <code>quote.example</code> contains a quote, which can be turned into the following report:</p>
<pre><code class="language-text">00048100000000b0c06f000000060103000000000000000000000000005b38e33a6487958b72c3c12a938eaa5e3fd4510c51aeeab58c7d5ecee41d7c436489d6c8e4f92f160b7cad34207b00c100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000e702060000000000

91eb2b44d141d4ece09f0c75c2c53d247a3c68edd7fafe8a3520c942a604a407de03ae6dc5f87f27428b2538873118b7 # MRTD

000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

4f3d617a1c89bd9a89ea146c15b04383b7db7318f41a851802bba8eace5a6cf71050e65f65fd50176e4f006764a42643 # RTMR0
53827a034d1e4c7f13fd2a12aee4497e7097f15a04794553e12fe73e2ffb8bd57585e771951115a13ec4d7e6bc193038 # RTMR1
2ca1a728ff13c36195ad95e8f725bf00d7f9c5d6ed730fb8f50cccad692ab81aefc83d594819375649be934022573528 # RTMR2
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 # RTMR3

39618efd10b14136ab416d6acfff8e36b23533a90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="interacting-with-the-l2"><a class="header" href="#interacting-with-the-l2">Interacting with the L2</a></h1>
<p>This section explains how to interact with your L2 rollup built with ethrex. Here you'll find guides for:</p>
<ul>
<li><a href="l2/interacting/./deposit.html">Depositing</a> and <a href="l2/interacting/./withdraw.html">withdrawing</a> assets</li>
<li><a href="l2/interacting/./wallet.html">Connecting wallets</a> like MetaMask</li>
<li><a href="l2/interacting/./deploy_contracts.html">Deploying</a> smart contracts</li>
<li>Maintaining and operating the sequencer</li>
<li><a href="l2/interacting/./shared_bridge.html">Interacting with shared bridge</a></li>
</ul>
<p>Use these guides to perform common actions and manage your L2 network.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="deposit-assets-into-the-l2"><a class="header" href="#deposit-assets-into-the-l2">Deposit assets into the L2</a></h1>
<p>To transfer ETH from Ethereum L1 to your L2 account, you need to use the <code>CommonBridge</code> as explained in this section.</p>
<h2 id="prerequisites-for-l1-deposit"><a class="header" href="#prerequisites-for-l1-deposit">Prerequisites for L1 deposit</a></h2>
<ul>
<li>An L1 account with sufficient ETH balance, for developing purposes you can use:
<ul>
<li>Address: <code>0x8943545177806ed17b9f23f0a21ee5948ecaa776</code></li>
<li>Private Key: <code>0xbcdf20249abf0ed6d944c0288fad489e33f66b3960d9e6229c1cd214ed3bbe31</code></li>
</ul>
</li>
<li>The address of the deployed <code>CommonBridge</code> contract.</li>
<li>An Ethereum utility tool like <a href="https://github.com/lambdaclass/rex">Rex</a></li>
</ul>
<h2 id="making-a-deposit"><a class="header" href="#making-a-deposit">Making a deposit</a></h2>
<p>Making a deposit in the Bridge, using Rex, is as simple as:</p>
<pre><code class="language-sh"># Format: rex l2 deposit &lt;AMOUNT&gt; &lt;PRIVATE_KEY&gt; &lt;BRIDGE_ADDRESS&gt; [L1_RPC_URL]
rex l2 deposit 50000000 0xbcdf20249abf0ed6d944c0288fad489e33f66b3960d9e6229c1cd214ed3bbe31 0x65dd6dc5df74b7e08e92c910122f91d7b2d5184f
</code></pre>
<h2 id="verifying-the-updated-l2-balance"><a class="header" href="#verifying-the-updated-l2-balance">Verifying the updated L2 balance</a></h2>
<p>Once the deposit is made you can verify the balance has increase with:</p>
<pre><code class="language-sh"># Format: rex l2 balance &lt;ADDRESS&gt; [RPC_URL]
rex l2 balance 0x8943545177806ed17b9f23f0a21ee5948ecaa776
</code></pre>
<p>For more information on what you can do with the <code>CommonBridge</code> see <a href="l2/interacting/../fundamentals/contracts.html">Ethrex L2 contracts</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="withdraw-assets-from-the-l2"><a class="header" href="#withdraw-assets-from-the-l2">Withdraw assets from the L2</a></h1>
<p>This section explains how to withdraw funds from the L2 through the native bridge.</p>
<h2 id="prerequisites-for-l2-withdrawal"><a class="header" href="#prerequisites-for-l2-withdrawal">Prerequisites for L2 withdrawal</a></h2>
<ul>
<li>An L2 account with sufficient ETH balance, for developing purpose you can use:
<ul>
<li>Address: <code>0x8943545177806ed17b9f23f0a21ee5948ecaa776</code></li>
<li>Private Key: <code>0xbcdf20249abf0ed6d944c0288fad489e33f66b3960d9e6229c1cd214ed3bbe31</code></li>
</ul>
</li>
<li>The address of the deployed <code>CommonBridge</code> L2 contract (note here that we are calling the L2 contract instead of the L1 as in the deposit case). If not specified, You can use:
<ul>
<li><code>CommonBridge</code> L2: <code>0x000000000000000000000000000000000000ffff</code></li>
</ul>
</li>
<li>An Ethereum utility tool like <a href="https://github.com/lambdaclass/rex">Rex</a>.</li>
</ul>
<h2 id="making-a-withdrawal"><a class="header" href="#making-a-withdrawal">Making a withdrawal</a></h2>
<p>Using Rex, we simply run the <code>rex l2 withdraw</code> command, which uses the default <code>CommonBridge</code> address.</p>
<pre><code class="language-sh"># Format: rex l2 withdraw &lt;AMOUNT&gt; &lt;PRIVATE_KEY&gt; [RPC_URL]
rex l2 withdraw 5000 0xbcdf20249abf0ed6d944c0288fad489e33f66b3960d9e6229c1cd214ed3bbe31
</code></pre>
<p>If the withdrawal is successful, the hash will be printed like this:</p>
<pre><code class="language-text">Withdrawal sent: &lt;L2_WITHDRAWAL_TX_HASH&gt;
...
</code></pre>
<h2 id="claiming-the-withdrawal"><a class="header" href="#claiming-the-withdrawal">Claiming the withdrawal</a></h2>
<p>After making a withdrawal, it has to be claimed in the L1, through the L1 <code>CommonBridge</code> contract.
For that, we can use the Rex command <code>rex l2 claim-withdraw</code>, with the tx hash obtained in the previous step.
But first, it is necessary to wait for the block that includes the withdraw to be verified.</p>
<!-- TODO: how can we check the withdrawal was verified? -->
<pre><code class="language-sh"># Format: rex l2 claim-withdraw &lt;L2_WITHDRAWAL_TX_HASH&gt; &lt;PRIVATE_KEY&gt; &lt;BRIDGE_ADDRESS&gt; [L1_RPC_URL] [RPC_URL]
rex l2 claim-withdraw &lt;L2_WITHDRAWAL_TX_HASH&gt; 0xbcdf20249abf0ed6d944c0288fad489e33f66b3960d9e6229c1cd214ed3bbe31 0x65dd6dc5df74b7e08e92c910122f91d7b2d5184f
</code></pre>
<h2 id="verifying-the-withdrawal"><a class="header" href="#verifying-the-withdrawal">Verifying the withdrawal</a></h2>
<p>Once the withdrawal is made you can verify the balance has decreased in the L2 with:</p>
<pre><code class="language-sh">rex l2 balance 0x8943545177806ed17b9f23f0a21ee5948ecaa776
</code></pre>
<p>And also increased in the L1:</p>
<pre><code class="language-sh">rex balance 0x8943545177806ed17b9f23f0a21ee5948ecaa776
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="connect-a-wallet"><a class="header" href="#connect-a-wallet">Connect a Wallet</a></h1>
<p>You can connect your L2 network to MetaMask to interact with your rollup using a familiar wallet interface.</p>
<h2 id="add-your-l2-network-to-metamask"><a class="header" href="#add-your-l2-network-to-metamask">Add Your L2 Network to MetaMask</a></h2>
<ol>
<li>Open MetaMask and click the network dropdown.</li>
<li>Select "Add custom network".</li>
<li>Enter your L2 network details:
<ul>
<li><strong>Network Name:</strong> (choose any name, e.g. "My L2 Rollup")</li>
<li><strong>RPC URL:</strong> <code>http://localhost:1729</code> (or your L2 node's RPC endpoint)</li>
<li><strong>Chain ID:</strong> (use the chain ID from your L2 genesis config)</li>
<li><strong>Currency Symbol:</strong> (e.g. ETH)</li>
<li><strong>Block Explorer URL:</strong> (optional, can be left blank)</li>
</ul>
</li>
<li>Save the network.</li>
</ol>
<p>You can now use MetaMask to send transactions and interact with contracts on your L2.</p>
<blockquote>
<p><strong>Tip:</strong> If you are running the L2 node on a remote server, replace <code>localhost</code> with the server's IP or domain.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="deploy-a-contract-to-l2"><a class="header" href="#deploy-a-contract-to-l2">Deploy a Contract to L2</a></h1>
<p>You can deploy smart contracts to your L2 using <a href="https://github.com/lambdaclass/rex"><code>rex</code></a>, a simple CLI tool for interacting with Ethereum-compatible networks.</p>
<h2 id="1-generate-the-contract-bytecode"><a class="header" href="#1-generate-the-contract-bytecode">1. Generate the Contract Bytecode</a></h2>
<p>First, compile your Solidity contract to get the deployment bytecode. You can use <a href="https://docs.soliditylang.org/en/latest/installing-solidity.html">solc (v0.8.31)</a> for this:</p>
<pre><code class="language-sh">solc --bin MyContract.sol -o out/
</code></pre>
<p>The bytecode will be in out/MyContract.bin</p>
<h2 id="2-deploy-with-rex"><a class="header" href="#2-deploy-with-rex">2. Deploy with rex</a></h2>
<p>Use the following command to deploy your contract:</p>
<pre><code class="language-sh">rex deploy --rpc-url http://localhost:1729 &lt;BYTECODE&gt; 0 &lt;PRIVATE_KEY&gt;
</code></pre>
<ul>
<li>Replace <code>&lt;BYTECODE&gt;</code> with the hex string from your compiled contract (e.g., contents of <code>MyContract.bin</code>)</li>
<li>Replace <code>&lt;PRIVATE_KEY&gt;</code> with your wallet's private key. It must have funds in L2</li>
<li>Adjust the <code>--rpc-url</code> if your L2 node is running elsewhere</li>
</ul>
<p>For more details and advanced usage, see the <a href="https://github.com/lambdaclass/rex">rex repository</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="blockscout-for-ethrex-l2"><a class="header" href="#blockscout-for-ethrex-l2">Blockscout for ethrex L2</a></h1>
<p>TDB</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="l2-hub"><a class="header" href="#l2-hub">L2 Hub</a></h1>
<p>TDB</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="interacting-with-the-shared-bridge"><a class="header" href="#interacting-with-the-shared-bridge">Interacting with the shared bridge</a></h1>
<p>This document details different scenarios for interacting with shared bridge enabled L2s.</p>
<h2 id="prerequisites-13"><a class="header" href="#prerequisites-13">Prerequisites</a></h2>
<p>This guide assumes you already have two L2s running with the shared bridge enabled.
Refer to <a href="l2/interacting/../deployment/shared_bridge.html">Deploy a shared bridge enabled L2</a></p>
<h2 id="eth-transfer"><a class="header" href="#eth-transfer">ETH Transfer</a></h2>
<h3 id="check-balances"><a class="header" href="#check-balances">Check balances</a></h3>
<p>Check the balances before sending the transfer</p>
<pre><code class="language-bash">rex balance 0xe25583099ba105d9ec0a67f5ae86d90e50036425 http://localhost:1729 # Receiver balance on first L2
rex balance 0x8943545177806ed17b9f23f0a21ee5948ecaa776 http://localhost:1730 # Sender balance on second L2
</code></pre>
<h3 id="send-the-transfer"><a class="header" href="#send-the-transfer">Send the transfer</a></h3>
<pre><code class="language-bash">rex send --rpc-url http://localhost:1730 --private-key 0xbcdf20249abf0ed6d944c0288fad489e33f66b3960d9e6229c1cd214ed3bbe31 --value 10000000000000001 0x000000000000000000000000000000000000FFFF 'sendToL2(uint256,address,uint256,bytes)' 65536999 0xe25583099ba105d9ec0a67f5ae86d90e50036425 100000 "" --gas-price 3946771033
</code></pre>
<h3 id="check-balances-1"><a class="header" href="#check-balances-1">Check balances</a></h3>
<p>After some time the balances should change (about 1-2 minutes)</p>
<pre><code class="language-bash">rex balance 0xe25583099ba105d9ec0a67f5ae86d90e50036425 http://localhost:1729 # Receiver balance on first L2
rex balance 0x8943545177806ed17b9f23f0a21ee5948ecaa776 http://localhost:1730 # Sender balance on second L2
</code></pre>
<h2 id="contract-call"><a class="header" href="#contract-call">Contract Call</a></h2>
<h3 id="add-the-contract"><a class="header" href="#add-the-contract">Add the contract</a></h3>
<p>Create a <code>Counter.sol</code> file with the following content</p>
<pre><code class="language-solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

contract Counter {
    uint256 public count;

    function increment() external {
        count += 1;
    }

    function get() external view returns (uint256) {
        return count;
    }
}
</code></pre>
<h3 id="deploy-the-contract"><a class="header" href="#deploy-the-contract">Deploy the contract</a></h3>
<pre><code class="language-bash">rex deploy --rpc-url http://localhost:1729 --remappings 0 --contract-path ./Counter.sol 0 0xbcdf20249abf0ed6d944c0288fad489e33f66b3960d9e6229c1cd214ed3bbe31
</code></pre>
<p>Save the contract address for the next steps:</p>
<pre><code class="language-bash">export COUNTER_ADDRESS=&lt;COUNTER_ADDRESS&gt; 
</code></pre>
<h3 id="check-counter-value"><a class="header" href="#check-counter-value">Check counter value</a></h3>
<pre><code class="language-bash">rex call $COUNTER_ADDRESS "get()" --rpc-url http://localhost:1729
</code></pre>
<h3 id="increase-the-counter-from-the-other-l2"><a class="header" href="#increase-the-counter-from-the-other-l2">Increase the counter from the other L2</a></h3>
<pre><code class="language-bash">rex send --rpc-url http://localhost:1730 --private-key 0xbcdf20249abf0ed6d944c0288fad489e33f66b3960d9e6229c1cd214ed3bbe31 0x000000000000000000000000000000000000FFFF 'sendToL2(uint256,address,uint256,bytes)' 65536999 $COUNTER_ADDRESS 100000 d09de08a --gas-price 3946771033
</code></pre>
<h3 id="check-counter-value-1"><a class="header" href="#check-counter-value-1">Check counter value</a></h3>
<pre><code class="language-bash">rex call $COUNTER_ADDRESS "get()" --rpc-url http://localhost:1729
</code></pre>
<h2 id="contract-call-and-eth-transfer"><a class="header" href="#contract-call-and-eth-transfer">Contract Call and ETH Transfer</a></h2>
<h3 id="add-the-contract-1"><a class="header" href="#add-the-contract-1">Add the contract</a></h3>
<p>Create a <code>Counter.sol</code> file with the following content (The increment function is now payable)</p>
<pre><code class="language-solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

contract Counter {
    uint256 public count;

    function increment() external payable {
        count += 1;
    }

    function get() external view returns (uint256) {
        return count;
    }
}
</code></pre>
<h3 id="deploy-the-contract-1"><a class="header" href="#deploy-the-contract-1">Deploy the contract</a></h3>
<pre><code class="language-bash">rex deploy --rpc-url http://localhost:1729 --remappings 0 --contract-path ./Counter.sol 0 0xbcdf20249abf0ed6d944c0288fad489e33f66b3960d9e6229c1cd214ed3bbe31
</code></pre>
<p>Save the contract address for the next steps:</p>
<pre><code class="language-bash">export COUNTER_ADDRESS=&lt;COUNTER_ADDRESS&gt; 
</code></pre>
<h3 id="check-counter-value-2"><a class="header" href="#check-counter-value-2">Check counter value</a></h3>
<pre><code class="language-bash">rex call $COUNTER_ADDRESS "get()" --rpc-url http://localhost:1729
</code></pre>
<h3 id="check-counter-balance"><a class="header" href="#check-counter-balance">Check counter balance</a></h3>
<pre><code class="language-bash">rex balance $COUNTER_ADDRESS http://localhost:1729
</code></pre>
<h3 id="increase-the-counter-from-the-other-l2-1"><a class="header" href="#increase-the-counter-from-the-other-l2-1">Increase the counter from the other L2</a></h3>
<pre><code class="language-bash">rex send --rpc-url http://localhost:1730 --private-key 0xbcdf20249abf0ed6d944c0288fad489e33f66b3960d9e6229c1cd214ed3bbe31 --value 1000 0x000000000000000000000000000000000000FFFF 'sendToL2(uint256,address,uint256,bytes)' 65536999 $COUNTER_ADDRESS 100000 d09de08a --gas-price 3946771033
</code></pre>
<h3 id="check-counter-value-3"><a class="header" href="#check-counter-value-3">Check counter value</a></h3>
<pre><code class="language-bash">rex call $COUNTER_ADDRESS "get()" --rpc-url http://localhost:1729
</code></pre>
<h3 id="check-counter-balance-1"><a class="header" href="#check-counter-balance-1">Check counter balance</a></h3>
<pre><code class="language-bash">rex balance $COUNTER_ADDRESS http://localhost:1729
</code></pre>
<h2 id="troubleshooting-2"><a class="header" href="#troubleshooting-2">Troubleshooting</a></h2>
<p>If you can't deploy the counter contract, either because of <code>Transaction intrinsic gas overflow</code> or because the transaction is never included in a block.
Retry the deploy command adding <code>--priority-gas-price</code> and <code>--gas-price</code> with the same value, increment it by 10 until it deploys correctly.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="fundamentals-1"><a class="header" href="#fundamentals-1">Fundamentals</a></h1>
<p>In L2 mode, the ethrex code is repurposed to run a rollup that settles on Ethereum as the L1.</p>
<p>The main differences between this mode and regular ethrex are:</p>
<ul>
<li>In regular rollup mode, there is no consensus; the node is turned into a sequencer that proposes blocks for the chain. In based rollup mode, consensus is achieved by a mechanism that rotates sequencers, enforced by the L1.</li>
<li>Block execution is proven using a RISC-V zkVM (or attested to using TDX, a Trusted Execution Environment) and its proofs (or signatures/attestations) are sent to L1 for verification.</li>
<li>A set of Solidity contracts to be deployed to the L1 are included as part of chain initialization.</li>
<li>Two new types of transactions are included: deposits (native token mints) and withdrawals.</li>
</ul>
<p>At a high level, the following new parts are added to the node:</p>
<ul>
<li>A <code>proposer</code> component, in charge of continually creating new blocks from the mempool transactions. This replaces the regular flow that an Ethereum L1 node has, where new blocks come from the consensus layer through the <code>forkChoiceUpdate</code> -&gt; <code>getPayload</code> -&gt; <code>NewPayload</code> Engine API flow in communication with the consensus layer.</li>
<li>A <code>prover</code> subsystem, which itself consists of two parts:
<ul>
<li>A <code>proverClient</code> that takes new blocks from the node, proves them, then sends the proof back to the node to send to the L1. This is a separate binary running outside the node, as proving has very different (and higher) hardware requirements than the sequencer.</li>
<li>A <code>proverServer</code> component inside the node that communicates with the prover, sending witness data for proving and receiving proofs for settlement on L1.</li>
</ul>
</li>
<li>L1 contracts with functions to commit to new state and then verify the state transition function, only advancing the state of the L2 if the proof verifies. It also has functionality to process deposits and withdrawals to/from the L2.</li>
<li>The EVM is lightly modified with new features to process deposits and withdrawals accordingly.</li>
</ul>
<h2 id="ethrex-l2-documentation"><a class="header" href="#ethrex-l2-documentation">Ethrex L2 documentation</a></h2>
<p>For general documentation, see:</p>
<ul>
<li><a href="l2/fundamentals/../architecture/overview.html">Architecture overview</a> for a high-level view of the ethrex L2 stack.</li>
<li><a href="l2/fundamentals/./contracts.html">Smart contracts</a> has information on L1 and L2 smart contracts including steps to upgrade and transfer ownserhip.</li>
<li><a href="l2/fundamentals/./based.html">Based sequencing</a> contains ethrex's roadmap for becoming based.</li>
<li><a href="l2/fundamentals/./state_diffs.html">State diffs</a> explains the mechanism needed to provide data availability.</li>
<li>How asset <a href="l2/fundamentals/./deposits.html">deposits</a> and <a href="l2/fundamentals/./withdrawals.html">withdrawals</a> work.</li>
<li><a href="l2/fundamentals/./fee_token.html">Fee token</a></li>
<li><a href="l2/fundamentals/./exit_window.html">Exit window</a> and <a href="l2/fundamentals/./timelock.html">Timelock</a> for upgrade safety mechanisms.</li>
<li><a href="l2/fundamentals/./ethrex_l2_aligned_integration.html">Aligned Layer Integration</a> details how ethrex L2 integrates with Aligned Layer for proof aggregation and verification.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="state-diffs"><a class="header" href="#state-diffs">State diffs</a></h1>
<div class="mdbook-alerts mdbook-alerts-warning">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  warning
</p>
<p>Data availability through <code>state diffs</code> has been deprecated in #5135.<br />
See the <code>Transition to RLP encoded blocks</code> section <a href="l2/fundamentals/../architecture/overview.html">here</a> for more details.</p>
</div>
<p>This architecture was inspired by <a href="https://github.com/matter-labs/zksync-era/blob/main/docs/src/specs/contracts/settlement_contracts/data_availability/pubdata.md">MatterLabs' ZKsync pubdata architecture</a>.</p>
<p>To provide data availability for our blockchain, we need to publish enough information on every commit transaction to be able to reconstruct the entire state of the L2 from the beginning by querying the L1.</p>
<p>The data needed is:</p>
<ul>
<li>The nonce and balance of every <code>EOA</code>.</li>
<li>The nonce, balance, and storage of every contract account. Note that storage here is a mapping <code>(U256 → U256)</code>, so there are a lot of values inside it.</li>
<li>The bytecode of every contract deployed on the chain.</li>
<li>All withdrawal Logs.</li>
</ul>
<p>After executing a batch of L2 blocks, the EVM will return the following data:</p>
<ul>
<li>A list of every storage slot modified in the batch, with their previous and next values. A storage slot is a mapping <code>(address, slot) -&gt; value</code>. Note that, in a batch, there could be repeated writes to the same slot. In that case, we keep only the latest write; all the others are discarded since they are not needed for state reconstruction.</li>
<li>The bytecode of every newly deployed contract. Every contract deployed is then a pair <code>(address, bytecode)</code>.</li>
<li>A list of withdrawal logs (as explained in milestone 1 we already collect these and publish a merkle root of their values as calldata, but we still need to send them as the state diff).</li>
<li>A list of triples <code>(address, nonce_increase, balance)</code> for every modified account. The <code>nonce_increase</code> is a value that says by how much the nonce of the account was increased in the batch (this could be more than one as there can be multiple transactions for the account in the batch). The balance is just the new balance value for the account.</li>
</ul>
<p>The full state diff sent for each batch will then be a sequence of bytes encoded as follows. We use the notation <code>un</code> for a sequence of <code>n</code> bits, so <code>u16</code> is a 16-bit sequence and <code>u96</code> a 96-bit one, we don't really care about signedness here; if we don't specify it, the value is of variable length and a field before it specifies it.</p>
<ul>
<li>The first byte is a <code>u8</code>: the version header. For now it should always be one, but we reserve it for future changes to the encoding/compression format.</li>
<li>Next come the block header info of the last block in the batch:
<ul>
<li>The <code>tx_root</code>, <code>receipts_root</code> and <code>parent_hash</code> are <code>u256</code> values.</li>
<li>The <code>gas_limit</code>, <code>gas_used</code>, <code>timestamp</code>,  <code>block_number</code> and <code>base_fee_per_gas</code> are <code>u64</code> values.</li>
</ul>
</li>
<li>Next the <code>ModifiedAccounts</code> list. The first two bytes (<code>u16</code>) are the amount of element it has, followed by its entries. Each entry correspond to an altered address and has the form:
<ul>
<li>The first byte is the <code>type</code> of the modification. The value is a <code>u8</code>, constrained to the range <code>[1; 23]</code>, computed by adding the following values:
<ul>
<li><code>1</code> if the balance of the EOA/contract was modified.</li>
<li><code>2</code> if the nonce of the EOA/contract was modified.</li>
<li><code>4</code> if the storage of the contract was modified.</li>
<li><code>8</code> if the contract was created and the bytecode is previously unknown.</li>
<li><code>16</code> if the contract was created and the bytecode is previously known.</li>
</ul>
</li>
<li>The next 20 bytes, a <code>u160</code>, is the address of the modified account.</li>
<li>If the balance was modified (i.e. <code>type &amp; 0x01 == 1</code>), the next 32 bytes, a <code>u256</code>, is the new balance of the account.</li>
<li>If the nonce was modified (i.e. <code>type &amp; 0x02 == 2</code>), the next 2 bytes, a <code>u16</code>, is the increase in the nonce.</li>
<li>If the storage was modified (i.e. <code>type &amp; 0x04 == 4</code>), the next 2 bytes, a <code>u16</code>, is the number of storage slots modified. Then come the sequence of <code>(key_u256, new_value_u256)</code> key value pairs with the modified slots.</li>
<li>If the contract was created and the bytecode is previously unknown (i.e. <code>type &amp; 0x08 == 8</code>), the next 2 bytes, a <code>u16</code>, is the length of the bytecode in bytes. Then come the bytecode itself.</li>
<li>If the contract was created and the bytecode is previously known (i.e. <code>type &amp; 0x10 == 16</code>), the next 32 bytes, a <code>u256</code>, is the hash of the bytecode of the contract.</li>
<li>Note that values <code>8</code> and <code>16</code> are mutually exclusive, and if <code>type</code> is greater or equal to <code>4</code>, then the address is a contract. Each address can only appear once in the list.</li>
</ul>
</li>
<li>Next the <code>WithdrawalLogs</code> field:
<ul>
<li>First two bytes are the number of entries, then come the tuples <code>(to_u160, amount_u256, tx_hash_u256)</code>.</li>
</ul>
</li>
<li>Next the <code>PrivilegedTransactionLogs</code> field:
<ul>
<li>First two bytes are the number of entries, then come the tuples <code>(to_u160, value_u256)</code>.</li>
</ul>
</li>
<li>In case of the only changes on an account are produced by withdrawals, the <code>ModifiedAccounts</code> for that address field must be omitted. In this case, the state diff can be computed by incrementing the nonce in one unit and subtracting the amount from the balance.</li>
</ul>
<p>To recap, using <code>||</code> for byte concatenation and <code>[]</code> for optional parameters, the full encoding for state diffs is:</p>
<pre><code class="language-jsx">version_header_u8 ||
// Last Block Header info
tx_root_u256 || receipts_root_u256 || parent_hash_u256 ||
gas_limit_u64 || gas_used_u64 || timestamp_u64 ||
block_number_u64 || base_fee_per_gas_u64
// Modified Accounts
number_of_modified_accounts_u16 ||
(
  type_u8 || address_u160 || [balance_u256] || [nonce_increase_u16] ||
  [number_of_modified_storage_slots_u16 || (key_u256 || value_u256)... ] ||
  [bytecode_len_u16 || bytecode ...] ||
  [code_hash_u256]
)...
// Withdraw Logs
number_of_withdraw_logs_u16 ||
(to_u160 || amount_u256 || tx_hash_u256) ...
// Privileged Transactions Logs
number_of_privileged_transaction_logs_u16 ||
(to_u160 || value_u256) ...
</code></pre>
<p>The sequencer will then make a commitment to this encoded state diff (explained in the EIP 4844 section how this is done) and send on the <code>commit</code> transaction:</p>
<ul>
<li>Through calldata, the state diff commitment (which is part of the public input to the proof).</li>
<li>Through the blob, the encoded state diff.</li>
</ul>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>As the blob is encoded as 4096 BLS12-381 field elements, every 32-bytes chunk cannot be greater than the subgroup <code>r</code> size: <code>0x73eda753299d7d483339d80809a1d80553bda402fffe5bfeffffffff00000001</code>. <em>i.e.</em>, the most significant byte must be less than <code>0x73</code>. To avoid conflicts, we insert a <code>0x00</code> byte before every 31-bytes chunk to ensure this condition is met.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="comparative-analysis-transaction-volume-in-blobs-using-state-diffs-and-transaction-lists"><a class="header" href="#comparative-analysis-transaction-volume-in-blobs-using-state-diffs-and-transaction-lists">Comparative Analysis: Transaction Volume in Blobs Using State Diffs and Transaction Lists</a></h1>
<p>The following are results from measurements conducted to understand the efficiency of blob utilization in an ethrex L2 network through the simulation of different scenarios with varying transaction complexities (e.g., ETH transfers, ERC20 transfers, and other complex smart contract interactions) and data encoding strategies, with the final goal of estimating the approximate number of transactions that can be packed into a single blob using state diffs versus full transaction lists, thereby optimizing calldata costs and achieving greater scalability.</p>
<h2 id="measurements-amount-of-transactions-per-batch"><a class="header" href="#measurements-amount-of-transactions-per-batch">Measurements (Amount of transactions per batch)</a></h2>
<h3 id="eth-transfers"><a class="header" href="#eth-transfers">ETH Transfers</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Blob Payload</th><th>Batch 2</th><th>Batch 3</th><th>Batch 4</th><th>Batch 5</th><th>Batch 6</th><th>Batch 7</th><th>Batch 8</th><th>Batch 9</th><th>Batch 10</th><th>Batch 11</th></tr></thead><tbody>
<tr><td>State Diff</td><td>2373</td><td>2134</td><td>2367</td><td>2141</td><td>2191</td><td>2370</td><td>2309</td><td>2361</td><td>2375</td><td>2367</td></tr>
<tr><td>Block List</td><td>913</td><td>871</td><td>886</td><td>935</td><td>1019</td><td>994</td><td>1002</td><td>1011</td><td>1012</td><td>1015</td></tr>
</tbody></table>
</div>
<h3 id="erc20-transfers"><a class="header" href="#erc20-transfers">ERC20 Transfers</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Blob Payload</th><th>Batch 2</th><th>Batch 3</th><th>Batch 4</th><th>Batch 5</th><th>Batch 6</th><th>Batch 7</th><th>Batch 8</th><th>Batch 9</th><th>Batch 10</th><th>Batch 11</th></tr></thead><tbody>
<tr><td>State Diff</td><td>1942</td><td>1897</td><td>1890</td><td>1900</td><td>1915</td><td>1873</td><td>1791</td><td>1773</td><td>1867</td><td>1858</td></tr>
<tr><td>Block List</td><td>655</td><td>661</td><td>638</td><td>638</td><td>645</td><td>644</td><td>615</td><td>530</td><td>532</td><td>532</td></tr>
</tbody></table>
</div>
<h3 id="summary-3"><a class="header" href="#summary-3">Summary</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Blob Payload</th><th>Avg. ETH Transfers per Batch</th><th>Avg. ERC20 Transfers per Batch</th></tr></thead><tbody>
<tr><td>State Diff</td><td>2298</td><td>1870</td></tr>
<tr><td>Block List</td><td>965</td><td>609</td></tr>
</tbody></table>
</div>
<h2 id="conclusion-1"><a class="header" href="#conclusion-1">Conclusion</a></h2>
<p>Sending block lists in blobs instead of state diffs decreases the number of transactions that can fit in a single blob by approximately 2x for ETH transfers and 3x for ERC20 transfers.</p>
<h2 id="how-this-measurements-were-done"><a class="header" href="#how-this-measurements-were-done">How this measurements were done</a></h2>
<h3 id="prerequisites-14"><a class="header" href="#prerequisites-14">Prerequisites</a></h3>
<ul>
<li>Fresh cloned ethrex repository</li>
<li>The spammer and measurer code provided in the appendix set up for running (you can create a new cargo project and copy the code there)</li>
</ul>
<h3 id="steps-1"><a class="header" href="#steps-1">Steps</a></h3>
<h4 id="1-run-an-l2-ethrex"><a class="header" href="#1-run-an-l2-ethrex">1. Run an L2 ethrex:</a></h4>
<p>For running the measurements, we need to run an ethrex L2 node. For doing that, change your current directory to <code>ethrex/crates/l2</code> in your fresh-cloned ethrex and run the following in a terminal:</p>
<pre><code class="language-shell">ETHREX_COMMITTER_COMMIT_TIME=120000 MEMPOOL_MAX_SIZE=1000000 make init-l2-dev
</code></pre>
<p>This will set up and run an ethrex L2 node in dev mode with a mempool size big-enough to be able to handle the spammer transactions. And after this you should see the ethrex L2 monitor running.</p>
<h4 id="2-run-the-desired-transactions-spammer"><a class="header" href="#2-run-the-desired-transactions-spammer">2. Run the desired transactions spammer</a></h4>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>Wait a few seconds after running the L2 node to make sure it's fully up and running before starting the spammer, and to ensure that the rich account used by the spammer has funds.</p>
</div>
<p>In another terminal, change your current directory to the spammer code you want to run (either ETH or ERC20) and run:</p>
<pre><code class="language-shell">cargo run
</code></pre>
<p>It's ok not to see any logs or prints as output, since the spammer code doesn't print anything.</p>
<p>If you go back to the terminal where the L2 node is running, you should start seeing the following:</p>
<ol>
<li>The mempool table growing in size as transactions are being sent to the L2 node.</li>
<li>In the L2 Blocks table, new blocks with <code>#Txs</code> greater than 0 being created as the spammer transactions are included in blocks.</li>
<li>Every 2 minutes (or the time you set in <code>ETHREX_COMMITTER_COMMIT_TIME</code>), new batches being created in the L2 Batches table.</li>
</ol>
<h4 id="3-run-the-measurer"><a class="header" href="#3-run-the-measurer">3. Run the measurer</a></h4>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<ul>
<li>Wait until enough batches are created before running the measurer.</li>
<li>Ignore the results of the first 2/3 batches, since they contain other transactions created during the L2 node initialization.</li>
</ul>
</div>
<p>In another terminal, change your current directory to the measurer code and run:</p>
<pre><code class="language-shell">cargo run
</code></pre>
<p>This will start printing the total number of transactions included in each batch until the last committed one.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<ul>
<li>The measurer will query batches starting from batch 1 and will continue indefinitely until it fails to find a batch (e.g. because the L2 node hasn't created it yet), so it is ok to see an error at the end of the output once the measurer reaches a batch that hasn't been created yet.</li>
</ul>
</div>
<h2 id="appendix"><a class="header" href="#appendix">Appendix</a></h2>
<ul>
<li><a href="l2/fundamentals/block_vs_state_diff_measurements.html#eth-transactions-spammer">ETH Transactions Spammer</a>
<ul>
<li><a href="l2/fundamentals/block_vs_state_diff_measurements.html#mainrs"><code>main.rs</code></a></li>
<li><a href="l2/fundamentals/block_vs_state_diff_measurements.html#cargotoml"><code>Cargo.toml</code></a></li>
</ul>
</li>
<li><a href="l2/fundamentals/block_vs_state_diff_measurements.html#measurer">Measurer</a>
<ul>
<li><a href="l2/fundamentals/block_vs_state_diff_measurements.html#mainrs-1"><code>main.rs</code></a></li>
<li><a href="l2/fundamentals/block_vs_state_diff_measurements.html#cargotoml-1"><code>Cargo.toml</code></a></li>
</ul>
</li>
<li><a href="l2/fundamentals/block_vs_state_diff_measurements.html#erc20-transactions-spammer">ERC20 Transactions Spammer</a>
<ul>
<li><a href="l2/fundamentals/block_vs_state_diff_measurements.html#mainrs-2"><code>main.rs</code></a></li>
<li><a href="l2/fundamentals/block_vs_state_diff_measurements.html#cargotoml-2"><code>Cargo.toml</code></a></li>
</ul>
</li>
</ul>
<h3 id="eth-transactions-spammer"><a class="header" href="#eth-transactions-spammer">ETH Transactions Spammer</a></h3>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>This is using ethrex v6.0.0</p>
</div>
<h4 id="mainrs"><a class="header" href="#mainrs"><code>main.rs</code></a></h4>
<pre><code class="language-rs">use ethrex_common::{
    Address, U256,
    types::{EIP1559Transaction, Transaction, TxKind},
};
use ethrex_l2_rpc::signer::{LocalSigner, Signable, Signer};
use ethrex_l2_sdk::send_generic_transaction;
use ethrex_rpc::EthClient;
use tokio::time::sleep;
use url::Url;

#[tokio::main]
async fn main() {
    let chain_id = 65536999;
    let senders = vec![
        "7a738a3a8ee9cdbb5ee8dfc1fc5d97847eaba4d31fd94f89e57880f8901fa029",
        "8cfe380955165dd01f4e33a3c68f4e08881f238fbbea71a2ab407f4a3759705b",
        "5bb463c0e64039550de4f95b873397b36d76b2f1af62454bb02cf6024d1ea703",
        "3c0924743b33b5f06b056bed8170924ca12b0d52671fb85de1bb391201709aaf",
        "6aeeda1e7eda6d618de89496fce01fb6ec685c38f1c5fccaa129ec339d33ff87",
    ]
    .iter()
    .map(|s| Signer::Local(LocalSigner::new(s.parse().expect("invalid private key"))))
    .collect::&lt;Vec&lt;Signer&gt;&gt;();
    let eth_client: EthClient =
        EthClient::new(Url::parse("http://localhost:1729").expect("Invalid URL"))
            .expect("Failed to create EthClient");
    let mut nonce = 0;
    loop {
        for sender in senders.clone() {
            let signed_tx = generate_signed_transaction(nonce, chain_id, &amp;sender).await;
            send_generic_transaction(&amp;eth_client, signed_tx.into(), &amp;sender)
                .await
                .expect("Failed to send transaction");
            sleep(std::time::Duration::from_millis(10)).await;
        }
        nonce += 1;
    }
}

async fn generate_signed_transaction(nonce: u64, chain_id: u64, signer: &amp;Signer) -&gt; Transaction {
    Transaction::EIP1559Transaction(EIP1559Transaction {
        nonce,
        value: U256::one(),
        gas_limit: 250000,
        max_fee_per_gas: u64::MAX,
        max_priority_fee_per_gas: 10,
        chain_id,
        to: TxKind::Call(Address::random()),
        ..Default::default()
    })
    .sign(&amp;signer)
    .await
    .expect("failed to sign transaction")
}
</code></pre>
<h4 id="cargotoml"><a class="header" href="#cargotoml"><code>Cargo.toml</code></a></h4>
<pre><code class="language-toml">[package]
name = "tx_spammer"
version = "0.1.0"
edition = "2024"

[dependencies]
ethrex-sdk = { git = "https://github.com/lambdaclass/ethrex.git", tag = "v6.0.0" }
ethrex-common = { git = "https://github.com/lambdaclass/ethrex.git", tag = "v6.0.0" }
ethrex-l2-rpc = { git = "https://github.com/lambdaclass/ethrex.git", tag = "v6.0.0" }
ethrex-rpc = { git = "https://github.com/lambdaclass/ethrex.git", tag = "v6.0.0" }

tokio = { version = "1", features = ["full"] }
url = "2"
hex = "0.4"
</code></pre>
<h3 id="measurer"><a class="header" href="#measurer">Measurer</a></h3>
<p>A simple program that queries the L2 node for batches and blocks, counting the number of transactions in each block, and summing them up per batch.</p>
<h4 id="mainrs-1"><a class="header" href="#mainrs-1"><code>main.rs</code></a></h4>
<pre><code class="language-rs">use reqwest::Client;
use serde_json::{Value, json};

#[tokio::main]
async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
    let mut batch = 1;

    loop {
        let (first, last) = fetch_batch(batch).await;
        let mut txs = 0u64;
        for number in first as u64..=last as u64 {
            txs += fetch_block(number).await;
        }
        println!("Total transactions in batch {}: {}", batch, txs);

        batch += 1;
    }
}

async fn fetch_batch(number: u64) -&gt; (i64, i64) {
    // Create the JSON body equivalent to the --data in curl
    let body = json!({
        "method": "ethrex_getBatchByNumber",
        "params": [format!("0x{:x}", number), false],
        "id": 1,
        "jsonrpc": "2.0"
    });

    // Create a blocking HTTP client
    let client = Client::new();

    // Send the POST request
    let response = client
        .post("http://localhost:1729")
        .header("Content-Type", "application/json")
        .json(&amp;body)
        .send()
        .await
        .expect("Failed to send request")
        .json::&lt;Value&gt;()
        .await
        .unwrap();

    let result = &amp;response["result"];
    let first_block = &amp;result["first_block"].as_i64().unwrap();
    let last_block = &amp;result["last_block"].as_i64().unwrap();
    (*first_block, *last_block)
}

async fn fetch_block(number: u64) -&gt; u64 {
    // Create the JSON body equivalent to the --data in curl
    let body = json!({
        "method": "eth_getBlockByNumber",
        "params": [format!("0x{:x}", number), false],
        "id": 1,
        "jsonrpc": "2.0"
    });

    // Create a blocking HTTP client
    let client = Client::new();

    // Send the POST request
    let response = client
        .post("http://localhost:1729")
        .header("Content-Type", "application/json")
        .json(&amp;body)
        .send()
        .await
        .expect("Failed to send request")
        .json::&lt;Value&gt;()
        .await
        .unwrap();

    let result = &amp;response["result"];
    let transactions = &amp;result["transactions"];
    transactions.as_array().unwrap().len() as u64
}
</code></pre>
<h4 id="cargotoml-1"><a class="header" href="#cargotoml-1"><code>Cargo.toml</code></a></h4>
<pre><code class="language-toml">[package]
name = "measurer"
version = "0.1.0"
edition = "2024"

[dependencies]
reqwest = { version = "0.11", features = ["json"] }
serde_json = "1.0"
tokio = { version = "1", features = ["full"] }
</code></pre>
<h3 id="erc20-transactions-spammer"><a class="header" href="#erc20-transactions-spammer">ERC20 Transactions Spammer</a></h3>
<h4 id="mainrs-2"><a class="header" href="#mainrs-2"><code>main.rs</code></a></h4>
<pre><code class="language-rs">use ethrex_blockchain::constants::TX_GAS_COST;
use ethrex_common::{
    Address, U256,
    types::{EIP1559Transaction, GenericTransaction, Transaction, TxKind, TxType},
};
use ethrex_l2_rpc::signer::{LocalSigner, Signable, Signer};
use ethrex_l2_sdk::{
    build_generic_tx, calldata::encode_calldata, create_deploy, send_generic_transaction,
    wait_for_transaction_receipt,
};
use ethrex_rpc::{EthClient, clients::Overrides};
use tokio::time::sleep;
use url::Url;

// ERC20 compiled artifact generated from this tutorial:
// https://medium.com/@kaishinaw/erc20-using-hardhat-a-comprehensive-guide-3211efba98d4
// If you want to modify the behaviour of the contract, edit the ERC20.sol file,
// and compile it with solc.
const ERC20: &amp;str = include_str!("./TestToken.bin").trim_ascii();

#[tokio::main]
async fn main() {
    let chain_id = 65536999;
    let signer = Signer::Local(LocalSigner::new(
        "39725efee3fb28614de3bacaffe4cc4bd8c436257e2c8bb887c4b5c4be45e76d"
            .parse()
            .expect("invalid private key"),
    ));
    let eth_client: EthClient =
        EthClient::new(Url::parse("http://localhost:1729").expect("Invalid URL"))
            .expect("Failed to create EthClient");
    let contract_address = erc20_deploy(eth_client.clone(), &amp;signer)
        .await
        .expect("Failed to deploy ERC20 contract");

    let senders = vec![
        "7a738a3a8ee9cdbb5ee8dfc1fc5d97847eaba4d31fd94f89e57880f8901fa029",
        "8cfe380955165dd01f4e33a3c68f4e08881f238fbbea71a2ab407f4a3759705b",
        "5bb463c0e64039550de4f95b873397b36d76b2f1af62454bb02cf6024d1ea703",
        "3c0924743b33b5f06b056bed8170924ca12b0d52671fb85de1bb391201709aaf",
        "6aeeda1e7eda6d618de89496fce01fb6ec685c38f1c5fccaa129ec339d33ff87",
    ]
    .iter()
    .map(|s| Signer::Local(LocalSigner::new(s.parse().expect("invalid private key"))))
    .collect::&lt;Vec&lt;Signer&gt;&gt;();
    claim_erc20_balances(contract_address, eth_client.clone(), senders.clone())
        .await
        .expect("Failed to claim ERC20 balances");
    let mut nonce = 1;
    loop {
        for sender in senders.clone() {
            let signed_tx =
                generate_erc20_transaction(nonce, chain_id, &amp;sender, &amp;eth_client, contract_address)
                    .await;
            send_generic_transaction(&amp;eth_client, signed_tx.into(), &amp;sender)
                .await
                .expect("Failed to send transaction");
            println!(
                "Sent transaction with nonce {} for address {}",
                nonce,
                sender.address()
            );
            sleep(std::time::Duration::from_millis(10)).await;
        }
        nonce += 1;
    }
}

// Given an account vector and the erc20 contract address, claim balance for all accounts.
async fn claim_erc20_balances(
    contract_address: Address,
    client: EthClient,
    accounts: Vec&lt;Signer&gt;,
) -&gt; eyre::Result&lt;()&gt; {
    for account in accounts {
        let claim_balance_calldata = encode_calldata("freeMint()", &amp;[]).unwrap();

        let claim_tx = build_generic_tx(
            &amp;client,
            TxType::EIP1559,
            contract_address,
            account.address(),
            claim_balance_calldata.into(),
            Default::default(),
        )
        .await
        .unwrap();
        let tx_hash = send_generic_transaction(&amp;client, claim_tx, &amp;account)
            .await
            .unwrap();
        wait_for_transaction_receipt(tx_hash, &amp;client, 1000)
            .await
            .unwrap();
    }

    Ok(())
}

async fn deploy_contract(
    client: EthClient,
    deployer: &amp;Signer,
    contract: Vec&lt;u8&gt;,
) -&gt; eyre::Result&lt;Address&gt; {
    let (_, contract_address) =
        create_deploy(&amp;client, deployer, contract.into(), Overrides::default()).await?;

    eyre::Ok(contract_address)
}

async fn erc20_deploy(client: EthClient, deployer: &amp;Signer) -&gt; eyre::Result&lt;Address&gt; {
    let erc20_bytecode = hex::decode(ERC20).expect("Failed to decode ERC20 bytecode");
    deploy_contract(client, deployer, erc20_bytecode).await
}

async fn generate_erc20_transaction(
    nonce: u64,
    chain_id: u64,
    signer: &amp;Signer,
    client: &amp;EthClient,
    contract_address: Address,
) -&gt; GenericTransaction {
    let send_calldata = encode_calldata(
        "transfer(address,uint256)",
        &amp;[
            ethrex_l2_common::calldata::Value::Address(Address::random()),
            ethrex_l2_common::calldata::Value::Uint(U256::one()),
        ],
    )
    .unwrap();

    let tx = build_generic_tx(
        client,
        TxType::EIP1559,
        contract_address,
        signer.address(),
        send_calldata.into(),
        Overrides {
            chain_id: Some(chain_id),
            value: None,
            nonce: Some(nonce),
            max_fee_per_gas: Some(i64::MAX as u64),
            max_priority_fee_per_gas: Some(10_u64),
            gas_limit: Some(TX_GAS_COST * 100),
            ..Default::default()
        },
    )
    .await
    .unwrap();

    tx
}
</code></pre>
<h4 id="cargotoml-2"><a class="header" href="#cargotoml-2"><code>Cargo.toml</code></a></h4>
<pre><code class="language-toml">[package]
name = "tx_spammer"
version = "0.1.0"
edition = "2024"

[dependencies]
ethrex-sdk = { git = "https://github.com/lambdaclass/ethrex.git", tag = "v6.0.0" }
ethrex-common = { git = "https://github.com/lambdaclass/ethrex.git", tag = "v6.0.0" }
ethrex-l2-rpc = { git = "https://github.com/lambdaclass/ethrex.git", tag = "v6.0.0" }
ethrex-rpc = { git = "https://github.com/lambdaclass/ethrex.git", tag = "v6.0.0" }
tokio = { version = "1", features = ["full"] }
ethrex-l2-common = { git = "https://github.com/lambdaclass/ethrex.git", tag = "v6.0.0" }
ethrex-blockchain = { git = "https://github.com/lambdaclass/ethrex.git", tag = "v6.0.0" }
url = "2"
hex = "0.4"
eyre = "0.6"
</code></pre>
<h4 id="testtokenbin"><a class="header" href="#testtokenbin"><code>TestToken.bin</code></a></h4>
<pre><code>608060405234801561000f575f5ffd5b506040518060400160405280600881526020017f46756e546f6b656e0000000000000000000000000000000000000000000000008152506040518060400160405280600381526020017f46554e0000000000000000000000000000000000000000000000000000000000815250816003908161008b9190610598565b50806004908161009b9190610598565b5050506100b83369d3c21bcecceda10000006100bd60201b60201c565b61077c565b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361012d575f6040517fec442f0500000000000000000000000000000000000000000000000000000000815260040161012491906106a6565b60405180910390fd5b61013e5f838361014260201b60201c565b5050565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610192578060025f82825461018691906106ec565b92505081905550610260565b5f5f5f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205490508181101561021b578381836040517fe450d38c0000000000000000000000000000000000000000000000000000000081526004016102129392919061072e565b60405180910390fd5b8181035f5f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2081905550505b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036102a7578060025f82825403925050819055506102f1565b805f5f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f82825401925050819055505b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405161034e9190610763565b60405180910390a3505050565b5f81519050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806103d657607f821691505b6020821081036103e9576103e8610392565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f6008830261044b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610410565b6104558683610410565b95508019841693508086168417925050509392505050565b5f819050919050565b5f819050919050565b5f61049961049461048f8461046d565b610476565b61046d565b9050919050565b5f819050919050565b6104b28361047f565b6104c66104be826104a0565b84845461041c565b825550505050565b5f5f905090565b6104dd6104ce565b6104e88184846104a9565b505050565b5b8181101561050b576105005f826104d5565b6001810190506104ee565b5050565b601f82111561055057610521816103ef565b61052a84610401565b81016020851015610539578190505b61054d61054585610401565b8301826104ed565b50505b505050565b5f82821c905092915050565b5f6105705f1984600802610555565b1980831691505092915050565b5f6105888383610561565b9150826002028217905092915050565b6105a18261035b565b67ffffffffffffffff8111156105ba576105b9610365565b5b6105c482546103bf565b6105cf82828561050f565b5f60209050601f831160018114610600575f84156105ee578287015190505b6105f8858261057d565b86555061065f565b601f19841661060e866103ef565b5f5b8281101561063557848901518255600182019150602085019450602081019050610610565b86831015610652578489015161064e601f891682610561565b8355505b6001600288020188555050505b505050505050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61069082610667565b9050919050565b6106a081610686565b82525050565b5f6020820190506106b95f830184610697565b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f6106f68261046d565b91506107018361046d565b9250828201905080821115610719576107186106bf565b5b92915050565b6107288161046d565b82525050565b5f6060820190506107415f830186610697565b61074e602083018561071f565b61075b604083018461071f565b949350505050565b5f6020820190506107765f83018461071f565b92915050565b610e8c806107895f395ff3fe608060405234801561000f575f5ffd5b506004361061009c575f3560e01c80635b70ea9f116100645780635b70ea9f1461015a57806370a082311461016457806395d89b4114610194578063a9059cbb146101b2578063dd62ed3e146101e25761009c565b806306fdde03146100a0578063095ea7b3146100be57806318160ddd146100ee57806323b872dd1461010c578063313ce5671461013c575b5f5ffd5b6100a8610212565b6040516100b59190610b05565b60405180910390f35b6100d860048036038101906100d39190610bb6565b6102a2565b6040516100e59190610c0e565b60405180910390f35b6100f66102c4565b6040516101039190610c36565b60405180910390f35b61012660048036038101906101219190610c4f565b6102cd565b6040516101339190610c0e565b60405180910390f35b6101446102fb565b6040516101519190610cba565b60405180910390f35b610162610303565b005b61017e60048036038101906101799190610cd3565b610319565b60405161018b9190610c36565b60405180910390f35b61019c61035e565b6040516101a99190610b05565b60405180910390f35b6101cc60048036038101906101c79190610bb6565b6103ee565b6040516101d99190610c0e565b60405180910390f35b6101fc60048036038101906101f79190610cfe565b610410565b6040516102099190610c36565b60405180910390f35b60606003805461022190610d69565b80601f016020809104026020016040519081016040528092919081815260200182805461024d90610d69565b80156102985780601f1061026f57610100808354040283529160200191610298565b820191905f5260205f20905b81548152906001019060200180831161027b57829003601f168201915b5050505050905090565b5f5f6102ac610492565b90506102b9818585610499565b600191505092915050565b5f600254905090565b5f5f6102d7610492565b90506102e48582856104ab565b6102ef85858561053e565b60019150509392505050565b5f6012905090565b6103173369d3c21bcecceda100000061062e565b565b5f5f5f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20549050919050565b60606004805461036d90610d69565b80601f016020809104026020016040519081016040528092919081815260200182805461039990610d69565b80156103e45780601f106103bb576101008083540402835291602001916103e4565b820191905f5260205f20905b8154815290600101906020018083116103c757829003601f168201915b5050505050905090565b5f5f6103f8610492565b905061040581858561053e565b600191505092915050565b5f60015f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054905092915050565b5f33905090565b6104a683838360016106ad565b505050565b5f6104b68484610410565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8110156105385781811015610529578281836040517ffb8f41b200000000000000000000000000000000000000000000000000000000815260040161052093929190610da8565b60405180910390fd5b61053784848484035f6106ad565b5b50505050565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036105ae575f6040517f96c6fd1e0000000000000000000000000000000000000000000000000000000081526004016105a59190610ddd565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361061e575f6040517fec442f050000000000000000000000000000000000000000000000000000000081526004016106159190610ddd565b60405180910390fd5b61062983838361087c565b505050565b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361069e575f6040517fec442f050000000000000000000000000000000000000000000000000000000081526004016106959190610ddd565b60405180910390fd5b6106a95f838361087c565b5050565b5f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff160361071d575f6040517fe602df050000000000000000000000000000000000000000000000000000000081526004016107149190610ddd565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361078d575f6040517f94280d620000000000000000000000000000000000000000000000000000000081526004016107849190610ddd565b60405180910390fd5b8160015f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20819055508015610876578273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258460405161086d9190610c36565b60405180910390a35b50505050565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036108cc578060025f8282546108c09190610e23565b9250508190555061099a565b5f5f5f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054905081811015610955578381836040517fe450d38c00000000000000000000000000000000000000000000000000000000815260040161094c93929190610da8565b60405180910390fd5b8181035f5f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2081905550505b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036109e1578060025f8282540392505081905550610a2b565b805f5f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f82825401925050819055505b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051610a889190610c36565b60405180910390a3505050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f610ad782610a95565b610ae18185610a9f565b9350610af1818560208601610aaf565b610afa81610abd565b840191505092915050565b5f6020820190508181035f830152610b1d8184610acd565b905092915050565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610b5282610b29565b9050919050565b610b6281610b48565b8114610b6c575f5ffd5b50565b5f81359050610b7d81610b59565b92915050565b5f819050919050565b610b9581610b83565b8114610b9f575f5ffd5b50565b5f81359050610bb081610b8c565b92915050565b5f5f60408385031215610bcc57610bcb610b25565b5b5f610bd985828601610b6f565b9250506020610bea85828601610ba2565b9150509250929050565b5f8115159050919050565b610c0881610bf4565b82525050565b5f602082019050610c215f830184610bff565b92915050565b610c3081610b83565b82525050565b5f602082019050610c495f830184610c27565b92915050565b5f5f5f60608486031215610c6657610c65610b25565b5b5f610c7386828701610b6f565b9350506020610c8486828701610b6f565b9250506040610c9586828701610ba2565b9150509250925092565b5f60ff82169050919050565b610cb481610c9f565b82525050565b5f602082019050610ccd5f830184610cab565b92915050565b5f60208284031215610ce857610ce7610b25565b5b5f610cf584828501610b6f565b91505092915050565b5f5f60408385031215610d1457610d13610b25565b5b5f610d2185828601610b6f565b9250506020610d3285828601610b6f565b9150509250929050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f6002820490506001821680610d8057607f821691505b602082108103610d9357610d92610d3c565b5b50919050565b610da281610b48565b82525050565b5f606082019050610dbb5f830186610d99565b610dc86020830185610c27565b610dd56040830184610c27565b949350505050565b5f602082019050610df05f830184610d99565b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610e2d82610b83565b9150610e3883610b83565b9250828201905080821115610e5057610e4f610df6565b5b9291505056fea2646970667358221220c2ace90351a6254148d1d6fc391d67d42f65e41f9290478674caf67a0ec34ec964736f6c634300081b0033
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="reconstructing-state-or-data-availability"><a class="header" href="#reconstructing-state-or-data-availability">Reconstructing state or Data Availability</a></h1>
<p>Rollups, unlike validiums, need to have their state on L1. If the only thing that's published to it is the state root, then the sequencer could withhold data on the state of the chain. Because it is the one proposing and executing blocks, if it refuses to deliver certain data (like a merkle path to prove a withdrawal on L1), people may not have any place to get it from and get locked out of the chain or some of their funds.</p>
<p>This is called the <strong>Data Availability</strong> problem. Sending the entire state of the chain on every new L2 batch is impossible; state is too big. As a first next step, what we could do is:</p>
<ul>
<li>For every new L2 batch, send as part of the <code>commit</code> transaction the list of transactions in the batch. Anyone who needs to access the state of the L2 at any point in time can track all <code>commit</code> transactions, start executing them from the beginning and reconstruct the state.</li>
</ul>
<p>This is now feasible; if we take 200 bytes as a rough estimate for the size of a single transfer between two users (see <a href="https://ethereum.stackexchange.com/questions/30175/what-is-the-size-bytes-of-a-simple-ethereum-transaction-versus-a-bitcoin-trans">this post</a> for the calculation on legacy transactions) and 128 KB as <a href="https://github.com/ethereum/go-ethereum/blob/830f3c764c21f0d314ae0f7e60d6dd581dc540ce/core/txpool/legacypool/legacypool.go#L49-L53">a reasonable transaction size limit</a> we get around ~650 transactions at maximum per <code>commit</code> transaction (we are assuming we use calldata here, blobs can increase this limit as each one is 128 KB and we could use multiple per transaction).</p>
<p>Going a bit further, instead of posting the entire transaction, we could just post which accounts have been modified and their new values (this includes deployed contracts and their bytecode of course). This can reduce the size a lot for most cases; in the case of a regular transfer as above, we only need to record balance updates of two accounts, which requires sending just two <code>(address, balance)</code> pairs, so (20 + 32) * 2 = 104 bytes, or around half as before. Some other clever techniques and compression algorithms can push down the publishing cost of this and other transactions much further.</p>
<p>This is called <code>state diffs</code>. Instead of publishing entire transactions for data availability, we only publish whatever state they modified. This is enough for anyone to reconstruct the entire state of the chain.</p>
<p>Detailed documentation on <a href="l2/fundamentals/./state_diffs.html">the state diffs spec</a>.</p>
<h3 id="how-do-we-prevent-the-sequencer-from-publishing-the-wrong-state-diffs-1"><a class="header" href="#how-do-we-prevent-the-sequencer-from-publishing-the-wrong-state-diffs-1">How do we prevent the sequencer from publishing the wrong state diffs?</a></h3>
<p>Once again, state diffs have to be part of the public input. With them, the prover can show that they are equal to the ones returned by the VM after executing all blocks in the batch. As always, the actual state diffs are not part of the public input, but <strong>their hash</strong> is, so the size is a fixed 32 bytes. This hash is then part of the batch commitment. The prover then assures us that the given state diff hash is correct (i.e. it exactly corresponds to the changes in state of the executed blocks).</p>
<p>There's still a problem however: the L1 contract needs to have the actual state diff for data availability, not just the hash. This is sent as part of calldata of the <code>commit</code> transaction (actually later as a blob, we'll get to that), so the sequencer could in theory send the wrong state diff. To make sure this can't happen, the L1 contract hashes it to make sure that it matches the actual state diff hash that is included as part of the public input.</p>
<p>With that, we can be sure that state diffs are published and that they are correct. The sequencer cannot mess with them at all; either it publishes the correct state diffs or the L1 contract will reject its batch.</p>
<h3 id="compression-1"><a class="header" href="#compression-1">Compression</a></h3>
<p>Because state diffs are compressed to save space on L1, this compression needs to be proven as well. Otherwise, once again, the sequencer could send the wrong (compressed) state diffs. This is easy though, we just make the prover run the compression and we're done.</p>
<h2 id="eip-4844-aka-blobs-1"><a class="header" href="#eip-4844-aka-blobs-1">EIP 4844 (a.k.a. Blobs)</a></h2>
<p>While we could send state diffs through calldata, there is a (hopefully) cheaper way to do it: blobs. The Ethereum Cancun upgrade introduced a new type of transaction where users can submit a list of opaque blobs of data, each one of size at most 128 KB. The main purpose of this new type of transaction is precisely to be used by rollups for data availability; they are priced separately through a <code>blob_gas</code> market instead of the regular <code>gas</code> one and for all intents and purposes should be much cheaper than calldata.</p>
<p>Using EIP 4844, our state diffs would now be sent through blobs. While this is cheaper, there's a new problem to address with it. The whole point of blobs is that they're cheaper because they are only kept around for approximately two weeks and ONLY in the beacon chain, i.e. the consensus side. The execution side (and thus the EVM when running contracts) does not have access to the contents of a blob. Instead, the only thing it has access to is a <strong>KZG commitment</strong> of it.</p>
<p>This is important. If you recall, the way the L1 ensured that the state diff published by the sequencer was correct was by hashing its contents and ensuring that the hash matched the given state diff hash. With the contents of the state diff now no longer accessible by the contract, we can't do that anymore, so we need another way to ensure the correct contents of the state diff (i.e. the blob).</p>
<p>The solution is to make the prover take the KZG commitment as a public input and the KZG proof as a private input, compute the state diffs after correctly executing a batch of blocks, and verify the proof to check that the commitment binds to the correct state diffs.</p>
<p>Because the KZG commitment is a public input, we can use the <code>BLOBHASH</code> EVM opcode to retrieve the blob rolling hash (which is just the hash of the KZG commitment and some other constant data) and compare it to the public input KZG commitment (which needs to be hashed too).</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="execution-witness"><a class="header" href="#execution-witness">Execution witness</a></h1>
<p>The purpose of the execution witness is to allow executing blocks without having access to the whole Ethereum state, as it wouldn't fit in a zkVM program. It contains only the state values needed during the execution.</p>
<p>An execution witness contains all the initial state values (state nodes, codes, storage keys, block headers) that will be read or written to during the blocks' execution.</p>
<p>An execution witness is created from a prior execution of the blocks. This execution can be done by a synced node, and it would expose the data to a RPC endpoint. This is the <code>debug_executionWitness</code> endpoint which is implemented by ethrex and other clients.</p>
<p>If this endpoint is not available, the prover needs to do the following:</p>
<ol>
<li>execute the blocks (also called "pre-execution") to identify which state values will be accessed.</li>
<li>log every initial state value accessed or updated during this execution.</li>
<li>retrieve an MPT proof for each value, linking it (or its non-existence) to the initial state root hash, using the <code>eth_getProof</code> RPC endpoint of a synced node.</li>
</ol>
<p>Steps 1 and 2 are data collection steps only - no validation is performed at this stage. The actual validation happens later inside the zkVM guest program. Step 3 involves more complex logic due to potential issues when restructuring the pruned state trie after value removals. In sections <a href="l2/fundamentals/../../prover/guest_program.html#step-1-initial-state-validation">initial state validation</a> and <a href="l2/fundamentals/../../prover/guest_program.html#step-3-final-state-validation">final state validation</a> we explain what are pruned tries and in which case they get restructured.</p>
<p>If a value is removed during block execution (meaning it existed initially but not finally), two pathological cases can occur where the witness lacks sufficient information to update the trie structure correctly:</p>
<p><strong>Case 1</strong></p>
<p><img src="l2/fundamentals/../img/execw_case1.png" alt="Image showing restructuration for case 1" /></p>
<p>Here, only <strong>leaf 1</strong> is part of the execution witness, so we lack the proof (and thus the node data) for <strong>leaf 2</strong>. After removing <strong>leaf 1</strong>, <strong>branch 1</strong> becomes redundant. During trie restructuring, it's replaced by <strong>leaf 3</strong>, whose path is the path of <strong>leaf 2</strong> concatenated with a prefix nibble (<code>k</code>) representing the choice taken at the original <strong>branch 1</strong>, and keeping <strong>leaf 2</strong>'s value.</p>
<pre><code class="language-text">branch1 = {c_1, c_2, ..., c_k, ..., c_16} # Only c_k = hash(leaf2) is non-empty
leaf2 = {value, path}
leaf3 = {value, concat(k, path)} # New leaf replacing branch1 and leaf2
</code></pre>
<p>Without <strong>leaf 2</strong>'s data, we cannot construct <strong>leaf 3</strong>. The solution is to fetch the <em>final</em> state proof for the key of <strong>leaf 2</strong>. This yields an exclusion proof containing <strong>leaf 3</strong>. By removing the prefix nibble <code>k</code>, we can reconstruct the original path and value of <strong>leaf 2</strong>. This process might need to be repeated if similar restructuring occurred at higher levels of the trie.</p>
<p><strong>Case 2</strong></p>
<p><img src="l2/fundamentals/../img/execw_case2.png" alt="Image showing restructuration for case 2" /></p>
<p>In this case, restructuring requires information about <strong>branch/ext 2</strong> (which could be a branch or extension node), but this node might not be in the witness. Checking the final <strong>extension</strong> node might seem sufficient to deduce <strong>branch/ext 2</strong> in simple scenarios. However, this fails if similar restructuring occurred at higher trie levels involving more removals, as the final <strong>extension</strong> node might combine paths from multiple original branches, making it ambiguous to reconstruct the specific missing <strong>branch/ext 2</strong> node.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="comparative-analysis-debug_executionwitness-latency-using-pre-generated-vs-on-demand-execution-witnesses"><a class="header" href="#comparative-analysis-debug_executionwitness-latency-using-pre-generated-vs-on-demand-execution-witnesses">Comparative Analysis: <code>debug_executionWitness</code> Latency Using Pre-Generated vs On-Demand Execution Witnesses</a></h1>
<p>This document presents the results of measurements conducted to analyze the latency improvements of the <code>debug_executionWitness</code> RPC method when execution witnesses are pre-generated during payload execution and stored in the database for a period of time (128 blocks), compared to generating them on demand.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>All measurements were obtained using an RPC node running on the same machine, avoiding network-related latency.</p>
</div>
<h2 id="measurements"><a class="header" href="#measurements">Measurements</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Pre-Generated</th><th>On-Demand</th></tr></thead><tbody>
<tr><td><strong>Total Blocks Analyzed</strong></td><td>176</td><td>176</td></tr>
<tr><td><strong>Min Time</strong></td><td>3 ms</td><td>56 ms</td></tr>
<tr><td><strong>Max Time</strong></td><td>255 ms</td><td>521 ms</td></tr>
<tr><td><strong>Average Time</strong></td><td>131 ms</td><td>242 ms</td></tr>
<tr><td><strong>Median Time</strong></td><td>130 ms</td><td>224 ms</td></tr>
<tr><td><strong>Block Range</strong></td><td>24191178 – 24191353</td><td>24190748 – 24190923</td></tr>
</tbody></table>
</div>
<h2 id="conclusions"><a class="header" href="#conclusions">Conclusions</a></h2>
<p>The average latency drops from <strong>242 ms (on-demand)</strong> to <strong>131 ms (pre-generated)</strong>, representing an improvement of approximately <strong>46%</strong>. Median latency shows a similar improvement, decreasing from <strong>224 ms</strong> to <strong>130 ms</strong>.</p>
<p>Pre-generated execution witnesses exhibit a much tighter latency distribution. The maximum observed latency is reduced by more than half (<strong>521 ms → 255 ms</strong>).</p>
<p>On-demand requests frequently experience high-latency spikes due to witness generation at request time. Pre-generating execution witnesses during payload execution effectively eliminates most of these spikes and results in more predictable response times.</p>
<h2 id="how-these-measurements-were-done"><a class="header" href="#how-these-measurements-were-done">How These Measurements Were Done</a></h2>
<p>These metrics were obtained from an <code>ethrex</code> node synced to the Ethereum mainnet.</p>
<p>Two configurations were compared:</p>
<ul>
<li><strong>Pre-Generated</strong>: Execution witnesses are generated during payload execution and stored in the database.</li>
<li><strong>On-Demand</strong>: Execution witnesses are generated when calling <code>debug_executionWitness</code>.</li>
</ul>
<p>Each configuration was measured over a contiguous range of blocks, and latency was recorded for each request.</p>
<h2 id="how-to-get-metrics"><a class="header" href="#how-to-get-metrics">How to Get Metrics</a></h2>
<ol>
<li>
<p>Ensure the node is synced.<br />
Use the <code>--precompute-witnesses</code> flag to generate and store execution witnesses upon receiving a <code>newPayload</code> message.</p>
</li>
<li>
<p>Enable debug logging for <code>ethrex-replay</code> by editing <code>src/main.rs:21</code>:</p>
<pre><code>add_directive(Directive::from(tracing::Level::DEBUG))
</code></pre>
</li>
<li>
<p>Run <code>ethrex-replay</code> using the <code>--endless</code> flag:</p>
<pre><code>cargo run -r -- blocks --endless --rpc-url [RPC_URL]
</code></pre>
</li>
<li>
<p>Filter logs to capture execution witness latency:</p>
<pre><code>cargo run -r -- blocks --endless --rpc-url [RPC_URL] 2&gt;&amp;1 | grep --line-buffered 'Got execution witness for block' | tee execution_witness_times.txt
</code></pre>
</li>
<li>
<p>Post-process the captured measurements to compute min, max, average, and median latencies.</p>
</li>
</ol>
<h2 id="appendix-1"><a class="header" href="#appendix-1">Appendix</a></h2>
<h3 id="full-measurement-data"><a class="header" href="#full-measurement-data">Full Measurement Data</a></h3>
<h4 id="pre-generated"><a class="header" href="#pre-generated">Pre-Generated</a></h4>
<p><em>Total blocks analyzed: 176</em></p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Block Number</th><th style="text-align: right">Time (ms)</th></tr></thead><tbody>
<tr><td style="text-align: right">24191178</td><td style="text-align: right">103</td></tr>
<tr><td style="text-align: right">24191179</td><td style="text-align: right">156</td></tr>
<tr><td style="text-align: right">24191180</td><td style="text-align: right">61</td></tr>
<tr><td style="text-align: right">24191181</td><td style="text-align: right">127</td></tr>
<tr><td style="text-align: right">24191182</td><td style="text-align: right">103</td></tr>
<tr><td style="text-align: right">24191183</td><td style="text-align: right">126</td></tr>
<tr><td style="text-align: right">24191184</td><td style="text-align: right">132</td></tr>
<tr><td style="text-align: right">24191185</td><td style="text-align: right">106</td></tr>
<tr><td style="text-align: right">24191186</td><td style="text-align: right">97</td></tr>
<tr><td style="text-align: right">24191187</td><td style="text-align: right">136</td></tr>
<tr><td style="text-align: right">24191188</td><td style="text-align: right">64</td></tr>
<tr><td style="text-align: right">24191189</td><td style="text-align: right">212</td></tr>
<tr><td style="text-align: right">24191190</td><td style="text-align: right">50</td></tr>
<tr><td style="text-align: right">24191191</td><td style="text-align: right">167</td></tr>
<tr><td style="text-align: right">24191192</td><td style="text-align: right">132</td></tr>
<tr><td style="text-align: right">24191193</td><td style="text-align: right">131</td></tr>
<tr><td style="text-align: right">24191194</td><td style="text-align: right">97</td></tr>
<tr><td style="text-align: right">24191195</td><td style="text-align: right">124</td></tr>
<tr><td style="text-align: right">24191196</td><td style="text-align: right">99</td></tr>
<tr><td style="text-align: right">24191197</td><td style="text-align: right">99</td></tr>
<tr><td style="text-align: right">24191198</td><td style="text-align: right">113</td></tr>
<tr><td style="text-align: right">24191199</td><td style="text-align: right">104</td></tr>
<tr><td style="text-align: right">24191200</td><td style="text-align: right">113</td></tr>
<tr><td style="text-align: right">24191201</td><td style="text-align: right">135</td></tr>
<tr><td style="text-align: right">24191202</td><td style="text-align: right">157</td></tr>
<tr><td style="text-align: right">24191203</td><td style="text-align: right">120</td></tr>
<tr><td style="text-align: right">24191204</td><td style="text-align: right">120</td></tr>
<tr><td style="text-align: right">24191205</td><td style="text-align: right">131</td></tr>
<tr><td style="text-align: right">24191206</td><td style="text-align: right">186</td></tr>
<tr><td style="text-align: right">24191207</td><td style="text-align: right">116</td></tr>
<tr><td style="text-align: right">24191208</td><td style="text-align: right">108</td></tr>
<tr><td style="text-align: right">24191209</td><td style="text-align: right">44</td></tr>
<tr><td style="text-align: right">24191210</td><td style="text-align: right">181</td></tr>
<tr><td style="text-align: right">24191211</td><td style="text-align: right">119</td></tr>
<tr><td style="text-align: right">24191212</td><td style="text-align: right">114</td></tr>
<tr><td style="text-align: right">24191213</td><td style="text-align: right">111</td></tr>
<tr><td style="text-align: right">24191214</td><td style="text-align: right">135</td></tr>
<tr><td style="text-align: right">24191215</td><td style="text-align: right">167</td></tr>
<tr><td style="text-align: right">24191216</td><td style="text-align: right">61</td></tr>
<tr><td style="text-align: right">24191217</td><td style="text-align: right">155</td></tr>
<tr><td style="text-align: right">24191218</td><td style="text-align: right">131</td></tr>
<tr><td style="text-align: right">24191219</td><td style="text-align: right">143</td></tr>
<tr><td style="text-align: right">24191220</td><td style="text-align: right">4</td></tr>
<tr><td style="text-align: right">24191221</td><td style="text-align: right">139</td></tr>
<tr><td style="text-align: right">24191222</td><td style="text-align: right">66</td></tr>
<tr><td style="text-align: right">24191223</td><td style="text-align: right">246</td></tr>
<tr><td style="text-align: right">24191224</td><td style="text-align: right">194</td></tr>
<tr><td style="text-align: right">24191225</td><td style="text-align: right">111</td></tr>
<tr><td style="text-align: right">24191226</td><td style="text-align: right">153</td></tr>
<tr><td style="text-align: right">24191227</td><td style="text-align: right">30</td></tr>
<tr><td style="text-align: right">24191228</td><td style="text-align: right">136</td></tr>
<tr><td style="text-align: right">24191229</td><td style="text-align: right">152</td></tr>
<tr><td style="text-align: right">24191230</td><td style="text-align: right">112</td></tr>
<tr><td style="text-align: right">24191231</td><td style="text-align: right">124</td></tr>
<tr><td style="text-align: right">24191232</td><td style="text-align: right">123</td></tr>
<tr><td style="text-align: right">24191233</td><td style="text-align: right">116</td></tr>
<tr><td style="text-align: right">24191234</td><td style="text-align: right">71</td></tr>
<tr><td style="text-align: right">24191235</td><td style="text-align: right">187</td></tr>
<tr><td style="text-align: right">24191236</td><td style="text-align: right">89</td></tr>
<tr><td style="text-align: right">24191237</td><td style="text-align: right">226</td></tr>
<tr><td style="text-align: right">24191238</td><td style="text-align: right">145</td></tr>
<tr><td style="text-align: right">24191239</td><td style="text-align: right">130</td></tr>
<tr><td style="text-align: right">24191240</td><td style="text-align: right">120</td></tr>
<tr><td style="text-align: right">24191241</td><td style="text-align: right">189</td></tr>
<tr><td style="text-align: right">24191242</td><td style="text-align: right">3</td></tr>
<tr><td style="text-align: right">24191243</td><td style="text-align: right">197</td></tr>
<tr><td style="text-align: right">24191244</td><td style="text-align: right">117</td></tr>
<tr><td style="text-align: right">24191245</td><td style="text-align: right">142</td></tr>
<tr><td style="text-align: right">24191246</td><td style="text-align: right">144</td></tr>
<tr><td style="text-align: right">24191247</td><td style="text-align: right">143</td></tr>
<tr><td style="text-align: right">24191248</td><td style="text-align: right">166</td></tr>
<tr><td style="text-align: right">24191249</td><td style="text-align: right">106</td></tr>
<tr><td style="text-align: right">24191250</td><td style="text-align: right">35</td></tr>
<tr><td style="text-align: right">24191251</td><td style="text-align: right">236</td></tr>
<tr><td style="text-align: right">24191252</td><td style="text-align: right">141</td></tr>
<tr><td style="text-align: right">24191253</td><td style="text-align: right">121</td></tr>
<tr><td style="text-align: right">24191254</td><td style="text-align: right">109</td></tr>
<tr><td style="text-align: right">24191255</td><td style="text-align: right">165</td></tr>
<tr><td style="text-align: right">24191256</td><td style="text-align: right">125</td></tr>
<tr><td style="text-align: right">24191257</td><td style="text-align: right">128</td></tr>
<tr><td style="text-align: right">24191258</td><td style="text-align: right">130</td></tr>
<tr><td style="text-align: right">24191259</td><td style="text-align: right">89</td></tr>
<tr><td style="text-align: right">24191260</td><td style="text-align: right">126</td></tr>
<tr><td style="text-align: right">24191261</td><td style="text-align: right">124</td></tr>
<tr><td style="text-align: right">24191262</td><td style="text-align: right">118</td></tr>
<tr><td style="text-align: right">24191263</td><td style="text-align: right">147</td></tr>
<tr><td style="text-align: right">24191264</td><td style="text-align: right">108</td></tr>
<tr><td style="text-align: right">24191265</td><td style="text-align: right">136</td></tr>
<tr><td style="text-align: right">24191266</td><td style="text-align: right">159</td></tr>
<tr><td style="text-align: right">24191267</td><td style="text-align: right">98</td></tr>
<tr><td style="text-align: right">24191268</td><td style="text-align: right">157</td></tr>
<tr><td style="text-align: right">24191269</td><td style="text-align: right">98</td></tr>
<tr><td style="text-align: right">24191270</td><td style="text-align: right">100</td></tr>
<tr><td style="text-align: right">24191271</td><td style="text-align: right">145</td></tr>
<tr><td style="text-align: right">24191272</td><td style="text-align: right">119</td></tr>
<tr><td style="text-align: right">24191273</td><td style="text-align: right">150</td></tr>
<tr><td style="text-align: right">24191274</td><td style="text-align: right">119</td></tr>
<tr><td style="text-align: right">24191275</td><td style="text-align: right">107</td></tr>
<tr><td style="text-align: right">24191276</td><td style="text-align: right">127</td></tr>
<tr><td style="text-align: right">24191277</td><td style="text-align: right">41</td></tr>
<tr><td style="text-align: right">24191278</td><td style="text-align: right">236</td></tr>
<tr><td style="text-align: right">24191279</td><td style="text-align: right">147</td></tr>
<tr><td style="text-align: right">24191280</td><td style="text-align: right">86</td></tr>
<tr><td style="text-align: right">24191281</td><td style="text-align: right">205</td></tr>
<tr><td style="text-align: right">24191282</td><td style="text-align: right">117</td></tr>
<tr><td style="text-align: right">24191283</td><td style="text-align: right">172</td></tr>
<tr><td style="text-align: right">24191284</td><td style="text-align: right">122</td></tr>
<tr><td style="text-align: right">24191285</td><td style="text-align: right">39</td></tr>
<tr><td style="text-align: right">24191286</td><td style="text-align: right">177</td></tr>
<tr><td style="text-align: right">24191287</td><td style="text-align: right">143</td></tr>
<tr><td style="text-align: right">24191288</td><td style="text-align: right">118</td></tr>
<tr><td style="text-align: right">24191289</td><td style="text-align: right">115</td></tr>
<tr><td style="text-align: right">24191290</td><td style="text-align: right">146</td></tr>
<tr><td style="text-align: right">24191291</td><td style="text-align: right">115</td></tr>
<tr><td style="text-align: right">24191292</td><td style="text-align: right">173</td></tr>
<tr><td style="text-align: right">24191293</td><td style="text-align: right">143</td></tr>
<tr><td style="text-align: right">24191294</td><td style="text-align: right">118</td></tr>
<tr><td style="text-align: right">24191295</td><td style="text-align: right">86</td></tr>
<tr><td style="text-align: right">24191296</td><td style="text-align: right">159</td></tr>
<tr><td style="text-align: right">24191297</td><td style="text-align: right">133</td></tr>
<tr><td style="text-align: right">24191298</td><td style="text-align: right">154</td></tr>
<tr><td style="text-align: right">24191299</td><td style="text-align: right">132</td></tr>
<tr><td style="text-align: right">24191300</td><td style="text-align: right">118</td></tr>
<tr><td style="text-align: right">24191301</td><td style="text-align: right">141</td></tr>
<tr><td style="text-align: right">24191302</td><td style="text-align: right">111</td></tr>
<tr><td style="text-align: right">24191303</td><td style="text-align: right">179</td></tr>
<tr><td style="text-align: right">24191304</td><td style="text-align: right">86</td></tr>
<tr><td style="text-align: right">24191305</td><td style="text-align: right">37</td></tr>
<tr><td style="text-align: right">24191306</td><td style="text-align: right">171</td></tr>
<tr><td style="text-align: right">24191307</td><td style="text-align: right">255</td></tr>
<tr><td style="text-align: right">24191308</td><td style="text-align: right">211</td></tr>
<tr><td style="text-align: right">24191309</td><td style="text-align: right">138</td></tr>
<tr><td style="text-align: right">24191310</td><td style="text-align: right">133</td></tr>
<tr><td style="text-align: right">24191311</td><td style="text-align: right">173</td></tr>
<tr><td style="text-align: right">24191312</td><td style="text-align: right">153</td></tr>
<tr><td style="text-align: right">24191313</td><td style="text-align: right">109</td></tr>
<tr><td style="text-align: right">24191314</td><td style="text-align: right">135</td></tr>
<tr><td style="text-align: right">24191315</td><td style="text-align: right">181</td></tr>
<tr><td style="text-align: right">24191316</td><td style="text-align: right">128</td></tr>
<tr><td style="text-align: right">24191317</td><td style="text-align: right">85</td></tr>
<tr><td style="text-align: right">24191318</td><td style="text-align: right">126</td></tr>
<tr><td style="text-align: right">24191319</td><td style="text-align: right">121</td></tr>
<tr><td style="text-align: right">24191320</td><td style="text-align: right">83</td></tr>
<tr><td style="text-align: right">24191321</td><td style="text-align: right">214</td></tr>
<tr><td style="text-align: right">24191322</td><td style="text-align: right">197</td></tr>
<tr><td style="text-align: right">24191323</td><td style="text-align: right">180</td></tr>
<tr><td style="text-align: right">24191324</td><td style="text-align: right">141</td></tr>
<tr><td style="text-align: right">24191325</td><td style="text-align: right">160</td></tr>
<tr><td style="text-align: right">24191326</td><td style="text-align: right">128</td></tr>
<tr><td style="text-align: right">24191327</td><td style="text-align: right">86</td></tr>
<tr><td style="text-align: right">24191328</td><td style="text-align: right">181</td></tr>
<tr><td style="text-align: right">24191329</td><td style="text-align: right">158</td></tr>
<tr><td style="text-align: right">24191330</td><td style="text-align: right">84</td></tr>
<tr><td style="text-align: right">24191331</td><td style="text-align: right">178</td></tr>
<tr><td style="text-align: right">24191332</td><td style="text-align: right">134</td></tr>
<tr><td style="text-align: right">24191333</td><td style="text-align: right">117</td></tr>
<tr><td style="text-align: right">24191334</td><td style="text-align: right">128</td></tr>
<tr><td style="text-align: right">24191335</td><td style="text-align: right">152</td></tr>
<tr><td style="text-align: right">24191336</td><td style="text-align: right">139</td></tr>
<tr><td style="text-align: right">24191337</td><td style="text-align: right">136</td></tr>
<tr><td style="text-align: right">24191338</td><td style="text-align: right">170</td></tr>
<tr><td style="text-align: right">24191339</td><td style="text-align: right">131</td></tr>
<tr><td style="text-align: right">24191340</td><td style="text-align: right">136</td></tr>
<tr><td style="text-align: right">24191341</td><td style="text-align: right">181</td></tr>
<tr><td style="text-align: right">24191342</td><td style="text-align: right">126</td></tr>
<tr><td style="text-align: right">24191343</td><td style="text-align: right">123</td></tr>
<tr><td style="text-align: right">24191344</td><td style="text-align: right">168</td></tr>
<tr><td style="text-align: right">24191345</td><td style="text-align: right">68</td></tr>
<tr><td style="text-align: right">24191346</td><td style="text-align: right">42</td></tr>
<tr><td style="text-align: right">24191347</td><td style="text-align: right">249</td></tr>
<tr><td style="text-align: right">24191348</td><td style="text-align: right">172</td></tr>
<tr><td style="text-align: right">24191349</td><td style="text-align: right">178</td></tr>
<tr><td style="text-align: right">24191350</td><td style="text-align: right">127</td></tr>
<tr><td style="text-align: right">24191351</td><td style="text-align: right">150</td></tr>
<tr><td style="text-align: right">24191352</td><td style="text-align: right">138</td></tr>
<tr><td style="text-align: right">24191353</td><td style="text-align: right">32</td></tr>
</tbody></table>
</div>
<h4 id="on-demand"><a class="header" href="#on-demand">On-Demand</a></h4>
<p><em>Total blocks analyzed: 176</em></p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Block Number</th><th style="text-align: right">Time (ms)</th></tr></thead><tbody>
<tr><td style="text-align: right">24190748</td><td style="text-align: right">228</td></tr>
<tr><td style="text-align: right">24190749</td><td style="text-align: right">286</td></tr>
<tr><td style="text-align: right">24190750</td><td style="text-align: right">308</td></tr>
<tr><td style="text-align: right">24190751</td><td style="text-align: right">290</td></tr>
<tr><td style="text-align: right">24190752</td><td style="text-align: right">272</td></tr>
<tr><td style="text-align: right">24190753</td><td style="text-align: right">334</td></tr>
<tr><td style="text-align: right">24190754</td><td style="text-align: right">208</td></tr>
<tr><td style="text-align: right">24190755</td><td style="text-align: right">189</td></tr>
<tr><td style="text-align: right">24190756</td><td style="text-align: right">118</td></tr>
<tr><td style="text-align: right">24190757</td><td style="text-align: right">367</td></tr>
<tr><td style="text-align: right">24190758</td><td style="text-align: right">128</td></tr>
<tr><td style="text-align: right">24190759</td><td style="text-align: right">411</td></tr>
<tr><td style="text-align: right">24190760</td><td style="text-align: right">226</td></tr>
<tr><td style="text-align: right">24190761</td><td style="text-align: right">179</td></tr>
<tr><td style="text-align: right">24190762</td><td style="text-align: right">451</td></tr>
<tr><td style="text-align: right">24190763</td><td style="text-align: right">489</td></tr>
<tr><td style="text-align: right">24190764</td><td style="text-align: right">350</td></tr>
<tr><td style="text-align: right">24190765</td><td style="text-align: right">254</td></tr>
<tr><td style="text-align: right">24190766</td><td style="text-align: right">304</td></tr>
<tr><td style="text-align: right">24190767</td><td style="text-align: right">220</td></tr>
<tr><td style="text-align: right">24190768</td><td style="text-align: right">154</td></tr>
<tr><td style="text-align: right">24190769</td><td style="text-align: right">521</td></tr>
<tr><td style="text-align: right">24190770</td><td style="text-align: right">56</td></tr>
<tr><td style="text-align: right">24190771</td><td style="text-align: right">311</td></tr>
<tr><td style="text-align: right">24190772</td><td style="text-align: right">436</td></tr>
<tr><td style="text-align: right">24190773</td><td style="text-align: right">226</td></tr>
<tr><td style="text-align: right">24190774</td><td style="text-align: right">235</td></tr>
<tr><td style="text-align: right">24190775</td><td style="text-align: right">216</td></tr>
<tr><td style="text-align: right">24190776</td><td style="text-align: right">222</td></tr>
<tr><td style="text-align: right">24190777</td><td style="text-align: right">259</td></tr>
<tr><td style="text-align: right">24190778</td><td style="text-align: right">165</td></tr>
<tr><td style="text-align: right">24190779</td><td style="text-align: right">232</td></tr>
<tr><td style="text-align: right">24190780</td><td style="text-align: right">197</td></tr>
<tr><td style="text-align: right">24190781</td><td style="text-align: right">206</td></tr>
<tr><td style="text-align: right">24190782</td><td style="text-align: right">424</td></tr>
<tr><td style="text-align: right">24190783</td><td style="text-align: right">209</td></tr>
<tr><td style="text-align: right">24190784</td><td style="text-align: right">232</td></tr>
<tr><td style="text-align: right">24190785</td><td style="text-align: right">213</td></tr>
<tr><td style="text-align: right">24190786</td><td style="text-align: right">262</td></tr>
<tr><td style="text-align: right">24190787</td><td style="text-align: right">190</td></tr>
<tr><td style="text-align: right">24190788</td><td style="text-align: right">233</td></tr>
<tr><td style="text-align: right">24190789</td><td style="text-align: right">206</td></tr>
<tr><td style="text-align: right">24190790</td><td style="text-align: right">178</td></tr>
<tr><td style="text-align: right">24190791</td><td style="text-align: right">277</td></tr>
<tr><td style="text-align: right">24190792</td><td style="text-align: right">167</td></tr>
<tr><td style="text-align: right">24190793</td><td style="text-align: right">329</td></tr>
<tr><td style="text-align: right">24190794</td><td style="text-align: right">408</td></tr>
<tr><td style="text-align: right">24190795</td><td style="text-align: right">368</td></tr>
<tr><td style="text-align: right">24190796</td><td style="text-align: right">160</td></tr>
<tr><td style="text-align: right">24190797</td><td style="text-align: right">221</td></tr>
<tr><td style="text-align: right">24190798</td><td style="text-align: right">208</td></tr>
<tr><td style="text-align: right">24190799</td><td style="text-align: right">296</td></tr>
<tr><td style="text-align: right">24190800</td><td style="text-align: right">256</td></tr>
<tr><td style="text-align: right">24190801</td><td style="text-align: right">222</td></tr>
<tr><td style="text-align: right">24190802</td><td style="text-align: right">131</td></tr>
<tr><td style="text-align: right">24190803</td><td style="text-align: right">318</td></tr>
<tr><td style="text-align: right">24190804</td><td style="text-align: right">270</td></tr>
<tr><td style="text-align: right">24190805</td><td style="text-align: right">179</td></tr>
<tr><td style="text-align: right">24190806</td><td style="text-align: right">220</td></tr>
<tr><td style="text-align: right">24190807</td><td style="text-align: right">201</td></tr>
<tr><td style="text-align: right">24190808</td><td style="text-align: right">205</td></tr>
<tr><td style="text-align: right">24190809</td><td style="text-align: right">279</td></tr>
<tr><td style="text-align: right">24190810</td><td style="text-align: right">252</td></tr>
<tr><td style="text-align: right">24190811</td><td style="text-align: right">140</td></tr>
<tr><td style="text-align: right">24190812</td><td style="text-align: right">378</td></tr>
<tr><td style="text-align: right">24190813</td><td style="text-align: right">221</td></tr>
<tr><td style="text-align: right">24190814</td><td style="text-align: right">325</td></tr>
<tr><td style="text-align: right">24190815</td><td style="text-align: right">241</td></tr>
<tr><td style="text-align: right">24190816</td><td style="text-align: right">186</td></tr>
<tr><td style="text-align: right">24190817</td><td style="text-align: right">193</td></tr>
<tr><td style="text-align: right">24190818</td><td style="text-align: right">174</td></tr>
<tr><td style="text-align: right">24190819</td><td style="text-align: right">327</td></tr>
<tr><td style="text-align: right">24190820</td><td style="text-align: right">210</td></tr>
<tr><td style="text-align: right">24190821</td><td style="text-align: right">208</td></tr>
<tr><td style="text-align: right">24190822</td><td style="text-align: right">195</td></tr>
<tr><td style="text-align: right">24190823</td><td style="text-align: right">244</td></tr>
<tr><td style="text-align: right">24190824</td><td style="text-align: right">80</td></tr>
<tr><td style="text-align: right">24190825</td><td style="text-align: right">128</td></tr>
<tr><td style="text-align: right">24190826</td><td style="text-align: right">363</td></tr>
<tr><td style="text-align: right">24190827</td><td style="text-align: right">231</td></tr>
<tr><td style="text-align: right">24190828</td><td style="text-align: right">286</td></tr>
<tr><td style="text-align: right">24190829</td><td style="text-align: right">368</td></tr>
<tr><td style="text-align: right">24190830</td><td style="text-align: right">198</td></tr>
<tr><td style="text-align: right">24190831</td><td style="text-align: right">293</td></tr>
<tr><td style="text-align: right">24190832</td><td style="text-align: right">275</td></tr>
<tr><td style="text-align: right">24190833</td><td style="text-align: right">309</td></tr>
<tr><td style="text-align: right">24190834</td><td style="text-align: right">219</td></tr>
<tr><td style="text-align: right">24190835</td><td style="text-align: right">91</td></tr>
<tr><td style="text-align: right">24190836</td><td style="text-align: right">319</td></tr>
<tr><td style="text-align: right">24190837</td><td style="text-align: right">269</td></tr>
<tr><td style="text-align: right">24190838</td><td style="text-align: right">292</td></tr>
<tr><td style="text-align: right">24190839</td><td style="text-align: right">193</td></tr>
<tr><td style="text-align: right">24190840</td><td style="text-align: right">203</td></tr>
<tr><td style="text-align: right">24190841</td><td style="text-align: right">188</td></tr>
<tr><td style="text-align: right">24190842</td><td style="text-align: right">124</td></tr>
<tr><td style="text-align: right">24190843</td><td style="text-align: right">305</td></tr>
<tr><td style="text-align: right">24190844</td><td style="text-align: right">236</td></tr>
<tr><td style="text-align: right">24190845</td><td style="text-align: right">179</td></tr>
<tr><td style="text-align: right">24190846</td><td style="text-align: right">148</td></tr>
<tr><td style="text-align: right">24190847</td><td style="text-align: right">280</td></tr>
<tr><td style="text-align: right">24190848</td><td style="text-align: right">208</td></tr>
<tr><td style="text-align: right">24190849</td><td style="text-align: right">265</td></tr>
<tr><td style="text-align: right">24190850</td><td style="text-align: right">197</td></tr>
<tr><td style="text-align: right">24190851</td><td style="text-align: right">225</td></tr>
<tr><td style="text-align: right">24190852</td><td style="text-align: right">266</td></tr>
<tr><td style="text-align: right">24190853</td><td style="text-align: right">181</td></tr>
<tr><td style="text-align: right">24190854</td><td style="text-align: right">225</td></tr>
<tr><td style="text-align: right">24190855</td><td style="text-align: right">256</td></tr>
<tr><td style="text-align: right">24190856</td><td style="text-align: right">216</td></tr>
<tr><td style="text-align: right">24190857</td><td style="text-align: right">374</td></tr>
<tr><td style="text-align: right">24190858</td><td style="text-align: right">225</td></tr>
<tr><td style="text-align: right">24190859</td><td style="text-align: right">296</td></tr>
<tr><td style="text-align: right">24190860</td><td style="text-align: right">175</td></tr>
<tr><td style="text-align: right">24190861</td><td style="text-align: right">171</td></tr>
<tr><td style="text-align: right">24190862</td><td style="text-align: right">406</td></tr>
<tr><td style="text-align: right">24190863</td><td style="text-align: right">236</td></tr>
<tr><td style="text-align: right">24190864</td><td style="text-align: right">196</td></tr>
<tr><td style="text-align: right">24190865</td><td style="text-align: right">184</td></tr>
<tr><td style="text-align: right">24190866</td><td style="text-align: right">265</td></tr>
<tr><td style="text-align: right">24190867</td><td style="text-align: right">172</td></tr>
<tr><td style="text-align: right">24190868</td><td style="text-align: right">123</td></tr>
<tr><td style="text-align: right">24190869</td><td style="text-align: right">470</td></tr>
<tr><td style="text-align: right">24190870</td><td style="text-align: right">184</td></tr>
<tr><td style="text-align: right">24190871</td><td style="text-align: right">244</td></tr>
<tr><td style="text-align: right">24190872</td><td style="text-align: right">172</td></tr>
<tr><td style="text-align: right">24190873</td><td style="text-align: right">99</td></tr>
<tr><td style="text-align: right">24190874</td><td style="text-align: right">387</td></tr>
<tr><td style="text-align: right">24190875</td><td style="text-align: right">209</td></tr>
<tr><td style="text-align: right">24190876</td><td style="text-align: right">207</td></tr>
<tr><td style="text-align: right">24190877</td><td style="text-align: right">133</td></tr>
<tr><td style="text-align: right">24190878</td><td style="text-align: right">161</td></tr>
<tr><td style="text-align: right">24190879</td><td style="text-align: right">223</td></tr>
<tr><td style="text-align: right">24190880</td><td style="text-align: right">217</td></tr>
<tr><td style="text-align: right">24190881</td><td style="text-align: right">234</td></tr>
<tr><td style="text-align: right">24190882</td><td style="text-align: right">261</td></tr>
<tr><td style="text-align: right">24190883</td><td style="text-align: right">203</td></tr>
<tr><td style="text-align: right">24190884</td><td style="text-align: right">234</td></tr>
<tr><td style="text-align: right">24190885</td><td style="text-align: right">263</td></tr>
<tr><td style="text-align: right">24190886</td><td style="text-align: right">193</td></tr>
<tr><td style="text-align: right">24190887</td><td style="text-align: right">211</td></tr>
<tr><td style="text-align: right">24190888</td><td style="text-align: right">168</td></tr>
<tr><td style="text-align: right">24190889</td><td style="text-align: right">344</td></tr>
<tr><td style="text-align: right">24190890</td><td style="text-align: right">88</td></tr>
<tr><td style="text-align: right">24190891</td><td style="text-align: right">399</td></tr>
<tr><td style="text-align: right">24190892</td><td style="text-align: right">191</td></tr>
<tr><td style="text-align: right">24190893</td><td style="text-align: right">244</td></tr>
<tr><td style="text-align: right">24190894</td><td style="text-align: right">140</td></tr>
<tr><td style="text-align: right">24190895</td><td style="text-align: right">195</td></tr>
<tr><td style="text-align: right">24190896</td><td style="text-align: right">275</td></tr>
<tr><td style="text-align: right">24190897</td><td style="text-align: right">121</td></tr>
<tr><td style="text-align: right">24190898</td><td style="text-align: right">462</td></tr>
<tr><td style="text-align: right">24190899</td><td style="text-align: right">291</td></tr>
<tr><td style="text-align: right">24190900</td><td style="text-align: right">192</td></tr>
<tr><td style="text-align: right">24190901</td><td style="text-align: right">183</td></tr>
<tr><td style="text-align: right">24190902</td><td style="text-align: right">268</td></tr>
<tr><td style="text-align: right">24190903</td><td style="text-align: right">294</td></tr>
<tr><td style="text-align: right">24190904</td><td style="text-align: right">277</td></tr>
<tr><td style="text-align: right">24190905</td><td style="text-align: right">271</td></tr>
<tr><td style="text-align: right">24190906</td><td style="text-align: right">190</td></tr>
<tr><td style="text-align: right">24190907</td><td style="text-align: right">222</td></tr>
<tr><td style="text-align: right">24190908</td><td style="text-align: right">109</td></tr>
<tr><td style="text-align: right">24190909</td><td style="text-align: right">335</td></tr>
<tr><td style="text-align: right">24190910</td><td style="text-align: right">252</td></tr>
<tr><td style="text-align: right">24190911</td><td style="text-align: right">91</td></tr>
<tr><td style="text-align: right">24190912</td><td style="text-align: right">143</td></tr>
<tr><td style="text-align: right">24190913</td><td style="text-align: right">414</td></tr>
<tr><td style="text-align: right">24190914</td><td style="text-align: right">73</td></tr>
<tr><td style="text-align: right">24190915</td><td style="text-align: right">457</td></tr>
<tr><td style="text-align: right">24190916</td><td style="text-align: right">93</td></tr>
<tr><td style="text-align: right">24190917</td><td style="text-align: right">148</td></tr>
<tr><td style="text-align: right">24190918</td><td style="text-align: right">479</td></tr>
<tr><td style="text-align: right">24190919</td><td style="text-align: right">156</td></tr>
<tr><td style="text-align: right">24190920</td><td style="text-align: right">80</td></tr>
<tr><td style="text-align: right">24190921</td><td style="text-align: right">421</td></tr>
<tr><td style="text-align: right">24190922</td><td style="text-align: right">411</td></tr>
<tr><td style="text-align: right">24190923</td><td style="text-align: right">220</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="deposits-1"><a class="header" href="#deposits-1">Deposits</a></h1>
<p>This document contains a detailed explanation of how asset deposits work.</p>
<h2 id="native-eth-deposits"><a class="header" href="#native-eth-deposits">Native ETH deposits</a></h2>
<p>This section explains step by step how native ETH deposits work.</p>
<p>On L1:</p>
<ol>
<li>
<p>The user sends ETH to the <code>CommonBridge</code> contract.
Alternatively, they can also call <code>deposit</code> and specify the address to receive the deposit in (the <code>l2Recipient</code>).</p>
</li>
<li>
<p>The bridge adds the deposit's hash to the <code>pendingTxHashes</code>.
We explain how to compute this hash in <a href="l2/fundamentals/deposits.html#generic-l1-l2-messaging">"Generic L1-&gt;L2 messaging"</a></p>
</li>
<li>
<p>The bridge emits a <code>PrivilegedTxSent</code> event:</p>
<pre><code class="language-solidity">bytes memory callData = abi.encodeCall(ICommonBridgeL2.mintETH, (l2Recipient));

emit PrivilegedTxSent(
    0xffff,         // sender in L2 (the L2 bridge)
    0xffff,         // to (the L2 bridge)
    transactionId,
    msg.value,      // value
    gasLimit,
    callData
);
</code></pre>
</li>
</ol>
<p>Off-chain:</p>
<ol>
<li>On each L2 node, the L1 watcher processes <code>PrivilegedTxSent</code> events, each adding a <code>PrivilegedL2Transaction</code> to the L2 mempool.</li>
<li>The privileged transaction is an <a href="https://eips.ethereum.org/EIPS/eip-2718">EIP-2718 typed transaction</a>, somewhat similar to an <a href="https://eips.ethereum.org/EIPS/eip-1559">EIP-1559 transaction</a>, but with some changes.
For this case, the important difference is that the sender of the transaction is set by our L1 bridge.
This enables our L1 bridge to "forge" transactions from any sender, even arbitrary addresses like the L2 bridge.</li>
<li>Privileged transactions sent by the L2 bridge don't deduct from the bridge's balance their value.
In practice, this means ETH equal to the transactions <code>value</code> is minted.</li>
</ol>
<p>On L2:</p>
<ol>
<li>The privileged transaction calls <code>mintETH</code> on the <code>CommonBridgeL2</code> with the intended recipient as parameter.</li>
<li>The bridge verifies the sender is itself, which can only happen for deposits sent through the L1 bridge.</li>
<li>The bridge sends the minted ETH to the recipient.
In case of failure, it initiates an ETH withdrawal for the same amount.</li>
</ol>
<p>Back on L1:</p>
<ol>
<li>A sequencer commits a batch on L1 including the privileged transaction.</li>
<li>The <code>OnChainProposer</code> asserts the included privileged transactions exist and are included in order.</li>
<li>The <code>OnChainProposer</code> notifies the bridge of the consumed privileged transactions and they are removed from <code>pendingTxHashes</code>.</li>
</ol>
<pre class="mermaid">---
title: User makes an ETH deposit
---
sequenceDiagram
    box rgb(33,66,99) L1
        actor L1Alice as Alice
        participant CommonBridge
        participant OnChainProposer
    end

    actor Sequencer

    box rgb(139, 63, 63) L2
        actor CommonBridgeL2
        actor L2Alice as Alice
    end

    L1Alice-&gt;&gt;CommonBridge: sends 42 ETH
    CommonBridge-&gt;&gt;CommonBridge: pendingTxHashes.push(txHash)
    CommonBridge-&gt;&gt;CommonBridge: emit PrivilegedTxSent

    CommonBridge--&gt;&gt;Sequencer: receives event
    Sequencer--&gt;&gt;CommonBridgeL2: mints 42 ETH and&lt;br&gt;starts processing tx
    CommonBridgeL2-&gt;&gt;CommonBridgeL2: calls mintETH
    CommonBridgeL2-&gt;&gt;L2Alice: sends 42 ETH

    Sequencer-&gt;&gt;OnChainProposer: publishes batch
    OnChainProposer-&gt;&gt;CommonBridge: consumes pending deposits
    CommonBridge--&gt;&gt;CommonBridge: pendingTxHashes.pop()
</pre>
<h2 id="erc20-deposits-through-the-native-bridge"><a class="header" href="#erc20-deposits-through-the-native-bridge">ERC20 deposits through the native bridge</a></h2>
<p>This section explains step by step how native ERC20 deposits work.</p>
<p>On L1:</p>
<ol>
<li>
<p>The user gives the <code>CommonBridge</code> allowance via an <code>approve</code> call to the L1 token contract.</p>
</li>
<li>
<p>The user calls <code>depositERC20</code> on the bridge, specifying the L1 and L2 token addresses, the amount to deposit, along with the intended L2 recipient.</p>
</li>
<li>
<p>The bridge locks the specified L1 token amount in the bridge, updating the mapping with the amount locked for the L1 and L2 token pair.
This ensures that L2 token withdrawals don't consume L1 tokens that weren't deposited into that L2 token (see <a href="l2/fundamentals/deposits.html#why-store-the-provenance-of-bridged-tokens">"Why store the provenance of bridged tokens?"</a> for more information).</p>
</li>
<li>
<p>The bridge emits a <code>PrivilegedTxSent</code> event:</p>
<pre><code class="language-solidity">emit PrivilegedTxSent(
    0,            // amount (unused)
    0xffff,       // to (the L2 bridge)
    depositId,
    0xffff,       // sender in L2 (the L2 bridge)
    gasLimit,
    callData
);
</code></pre>
</li>
</ol>
<p>Off-chain:</p>
<ol>
<li>On each L2 node, the L1 watcher processes <code>PrivilegedTxSent</code> events, each adding a <code>PrivilegedL2Transaction</code> to the L2 mempool.</li>
<li>The privileged transaction is an <a href="https://eips.ethereum.org/EIPS/eip-2718">EIP-2718 typed transaction</a>, somewhat similar to an <a href="https://eips.ethereum.org/EIPS/eip-1559">EIP-1559 transaction</a>, but with some changes.
For this case, the important differences is that the sender of the transaction is set by our L1 bridge.
This enables our L1 bridge to "forge" transactions from any sender, even arbitrary addresses like the L2 bridge.</li>
</ol>
<p>On L2:</p>
<ol>
<li>The privileged transaction performs a call to <code>mintERC20</code> on the <code>CommonBridgeL2</code> from the L2 bridge's address, specifying the address of the L1 and L2 tokens, along with the amount and recipient.</li>
<li>The bridge verifies the sender is itself, which can only happen for deposits sent through the L1 bridge.</li>
<li>The bridge calls <code>l1Address()</code> on the L2 token, to verify it matches the received L1 token address.</li>
<li>The bridge calls <code>crosschainMint</code> on the L2 token, minting the specified amount of tokens and sending them to the L2 recipient.
In case of failure, it initiates an ERC20 withdrawal for the same amount.</li>
</ol>
<p>Back on L1:</p>
<ol>
<li>A sequencer commits a batch on L1 including the privileged transaction.</li>
<li>The <code>OnChainProposer</code> asserts the included privileged transactions exist and are included in order.</li>
<li>The <code>OnChainProposer</code> notifies the bridge of the consumed privileged transactions and they are removed from <code>pendingTxHashes</code>.</li>
</ol>
<pre class="mermaid">---
title: User makes an ERC20 deposit
---
sequenceDiagram
    box rgb(33,66,99) L1
        actor L1Alice as Alice
        participant L1Token
        participant CommonBridge
        participant OnChainProposer
    end

    actor Sequencer

    box rgb(139, 63, 63) L2
        participant CommonBridgeL2
        participant L2Token
        actor L2Alice as Alice
    end

    L1Alice-&gt;&gt;L1Token: approves token transfer
    L1Alice-&gt;&gt;CommonBridge: calls depositERC20
    CommonBridge-&gt;&gt;CommonBridge: pendingTxHashes.push(txHash)
    CommonBridge-&gt;&gt;CommonBridge: emit PrivilegedTxSent

    CommonBridge--&gt;&gt;Sequencer: receives event
    Sequencer--&gt;&gt;CommonBridgeL2: starts processing tx
    CommonBridgeL2-&gt;&gt;CommonBridgeL2: calls mintERC20

    CommonBridgeL2-&gt;&gt;L2Token: calls l1Address
    L2Token-&gt;&gt;CommonBridgeL2: returns address of L1Token

    CommonBridgeL2-&gt;&gt;L2Token: calls crosschainMint
    L2Token--&gt;&gt;L2Alice: mints 42 tokens

    Sequencer-&gt;&gt;OnChainProposer: publishes batch
    OnChainProposer-&gt;&gt;CommonBridge: consumes pending deposits
    CommonBridge--&gt;&gt;CommonBridge: pendingTxHashes.pop()
</pre>
<h3 id="why-store-the-provenance-of-bridged-tokens"><a class="header" href="#why-store-the-provenance-of-bridged-tokens">Why store the provenance of bridged tokens?</a></h3>
<p>As said before, storing the provenance of bridged tokens or, in other words, how many tokens were sent from each L1 token to each L2 token, ensures that L2 token withdrawals don't unlock L1 tokens that weren't deposited into another L2 token.</p>
<p>This can be better understood with an example:</p>
<pre class="mermaid">---
title: Attacker exploits alternative bridge without token provenance
---
sequenceDiagram
    box rgb(33,66,99) L1
        actor L1Eve as Eve
        actor L1Alice as Alice
        participant CommonBridge
    end

    box rgb(139, 63, 63) L2
        participant CommonBridgeL2
        actor L2Alice as Alice
        actor L2Eve as Eve
    end

    Note over L1Eve,L2Eve: Alice does a normal deposit
    L1Alice -&gt;&gt; CommonBridge: Deposits 100 Foo tokens into FooL2
    CommonBridge --&gt;&gt; CommonBridgeL2: Notifies deposit
    CommonBridgeL2 -&gt;&gt; L2Alice: Sends 100 FooL2 tokens

    Note over L1Eve,L2Eve: Eve does a deposit to ensure the L2 token they control is registered with the bridge
    L1Eve -&gt;&gt; CommonBridge: Deposits 1 Foo token into Bar
    CommonBridge --&gt;&gt; CommonBridgeL2: Notifies deposit
    CommonBridgeL2 -&gt;&gt; L2Eve: Sends 1 Bar token

    Note over L1Eve,L2Eve: Eve does a malicious withdawal of Alice's funds
    L2Eve -&gt;&gt; CommonBridgeL2: Withdraws 101 Bar tokens into Foo
    CommonBridgeL2 --&gt;&gt; CommonBridge: Notifies withdrawal
    CommonBridge -&gt;&gt; L1Eve: Sends 101 Foo tokens
</pre>
<h2 id="generic-l1-l2-messaging"><a class="header" href="#generic-l1-l2-messaging">Generic L1-&gt;L2 messaging</a></h2>
<!-- TODO: extend this version once we have generic L1->L2 messages -->
<p>Privileged transactions are signaled by the L1 bridge through <code>PrivilegedTxSent</code> events.
These events are emitted by the <code>CommonBridge</code> contract on L1 and processed by the L1 watcher on each L2 node.</p>
<pre><code class="language-solidity">event PrivilegedTxSent (
    address indexed from,
    address indexed to,
    uint256 indexed transactionId,
    uint256 value,
    uint256 gasLimit,
    bytes data
);
</code></pre>
<p>As seen before, this same event is used for native deposits, but with the <code>from</code> artificially set to the L2 bridge address, which is also the <code>to</code> address.</p>
<p>For tracking purposes, we might want to know the hash of the L2 transaction.
We can compute it as follows:</p>
<pre><code class="language-solidity">keccak256(
    bytes.concat(
        bytes20(from),
        bytes20(to),
        bytes32(transactionId),
        bytes32(value),
        bytes32(gasLimit),
        keccak256(data)
    )
)
</code></pre>
<h2 id="address-aliasing"><a class="header" href="#address-aliasing">Address Aliasing</a></h2>
<p>To prevent attacks where a L1 impersonates an L2 contract, we implement Address Aliasing <a href="https://docs.optimism.io/stack/differences#address-aliasing">like Optimism</a> (albeit with we a different constant, to prevent confusion).</p>
<p>The attack prevented would've looked like this:</p>
<ul>
<li>An L2 contract gets deployed at address A</li>
<li>Someone malicious deploys a contract at the same address (through deterministic deployments, etc)</li>
<li>The malicious contract sends a privileged transaction, which can steal A's resourced on the L2</li>
</ul>
<p>By modifying the address of L1 contracts by adding a constant, we prevent this attack since both won't have the same address.</p>
<h2 id="forced-inclusion"><a class="header" href="#forced-inclusion">Forced Inclusion</a></h2>
<p>Each transaction is given a deadline for processing. If the sequencer is unwilling to include a privileged transaction before this timer expires, batches stop being processed and the chain halts until the sequencer processes every expired transaction.</p>
<p>After an extended downtime, the sequencer can catch up by sending batches made solely out of privileged transactions.</p>
<pre class="mermaid">---
title: Sequencer goes offline
---
sequenceDiagram
    box rgb(33,66,99) L1
        actor L1Alice
        actor Sequencer
        participant CommonBridge
        participant OnChainProposer
    end

    L1Alice -&gt;&gt; CommonBridge: Sends a privileged transaction

    Note over Sequencer: Sequencer goes offline for a long time
    Sequencer -&gt;&gt; OnChainProposer: Sends batch as usual
    OnChainProposer -&gt;&gt; Sequencer: Error
    Note over Sequencer: Operator configures the sequencer to catch up
    Sequencer -&gt;&gt; OnChainProposer: Sends batch of only privileged transactions
    OnChainProposer -&gt;&gt; Sequencer: OK
    Sequencer -&gt;&gt; OnChainProposer: Sends batch with remaining expired privileged transactions, along with other transactions
    OnChainProposer -&gt;&gt; Sequencer: OK
    Note over Sequencer: Sequencer is now catched up
    Sequencer -&gt;&gt; OnChainProposer: Sends batch as usual
    OnChainProposer -&gt;&gt; Sequencer: OK
</pre>
<h2 id="limitations"><a class="header" href="#limitations">Limitations</a></h2>
<p>Due to the gas cost of computing rolling hashes, there is a limit to how many deposits can be handled in a single batch.<br />
To prevent the creation of invalid batches, we enforce a maximum cap on deposits per batch in the <code>l1_committer</code>.<br />
We also enforce the same maximum cap per block in the <code>block_producer</code>, to avoid situations where the <code>l1_committer</code> could get stuck if a single block contains more deposits than the configured batch cap.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="withdrawals-1"><a class="header" href="#withdrawals-1">Withdrawals</a></h1>
<p>This document contains a detailed explanation of how asset withdrawals work.</p>
<h2 id="native-eth-withdrawals"><a class="header" href="#native-eth-withdrawals">Native ETH withdrawals</a></h2>
<p>This section explains step by step how native ETH withdrawals work.</p>
<p>On L2:</p>
<ol>
<li>
<p>The user sends a transaction calling <code>withdraw(address _receiverOnL1)</code> on the <code>CommonBridgeL2</code> contract, along with the amount of ETH to be withdrawn.</p>
</li>
<li>
<p>The bridge sends the withdrawn amount to the burn address.</p>
</li>
<li>
<p>The bridge calls <code>sendMessageToL1(bytes32 data)</code> on the <code>Messenger</code> contract, with <code>data</code> being:</p>
<pre><code class="language-solidity">bytes32 data = keccak256(abi.encodePacked(ETH_ADDRESS, ETH_ADDRESS, _receiverOnL1, msg.value))
</code></pre>
<p>The <code>ETH_ADDRESS</code> is an arbitrary address we use, meaning the "token" to transfer is ETH.</p>
</li>
<li>
<p><code>Messenger</code> emits an <code>L1Message</code> event, with the address of the L2 bridge contract and <code>data</code> as topics, along with a unique message ID.</p>
</li>
</ol>
<p>Off-chain:</p>
<ol>
<li>On each L2 node, the L1 watcher extracts <code>L1Message</code> events, generating a merkle tree with the hashed messages as leaves.
The merkle tree format is explained in the <a href="l2/fundamentals/withdrawals.html#l1message-merkle-tree">"<code>L1Message</code> Merkle tree"</a> section below.</li>
</ol>
<p>On L1:</p>
<ol>
<li>A sequencer commits the batch on L1, publishing the merkle tree's root with <code>publishWithdrawals</code> on the L1 <code>CommonBridge</code>.</li>
<li>The user submits a withdrawal proof when calling <code>claimWithdrawal</code> on the L1 <code>CommonBridge</code>.
The proof can be obtained by calling <code>ethrex_getWithdrawalProof</code> in any L2 node, after the batch containing the withdrawal transaction was verified in the L1.</li>
<li>The bridge asserts the proof is valid and wasn't previously claimed.</li>
<li>The bridge sends the locked funds specified in the <code>L1Message</code> to the user.</li>
</ol>
<pre class="mermaid">---
title: User makes an ETH withdrawal
---
sequenceDiagram
    box rgb(139, 63, 63) L2
        actor L2Alice as Alice
        participant CommonBridgeL2
        participant Messenger
    end

    actor Sequencer

    box rgb(33,66,99) L1
        participant OnChainProposer
        participant CommonBridge
        actor L1Alice as Alice
    end

    L2Alice-&gt;&gt;CommonBridgeL2: withdraws 42 ETH
    CommonBridgeL2-&gt;&gt;CommonBridgeL2: burns 42 ETH
    CommonBridgeL2-&gt;&gt;Messenger: calls sendMessageToL1
    Messenger-&gt;&gt;Messenger: emits L1Message event

    Messenger--&gt;&gt;Sequencer: receives event

    Sequencer-&gt;&gt;OnChainProposer: publishes batch
    OnChainProposer-&gt;&gt;CommonBridge: publishes L1 message root

    L1Alice-&gt;&gt;CommonBridge: submits withdrawal proof
    CommonBridge--&gt;&gt;CommonBridge: asserts proof is valid
    CommonBridge-&gt;&gt;L1Alice: sends 42 ETH
</pre>
<h2 id="erc20-withdrawals-through-the-native-bridge"><a class="header" href="#erc20-withdrawals-through-the-native-bridge">ERC20 withdrawals through the native bridge</a></h2>
<p>This section explains step by step how native ERC20 withdrawals work.</p>
<p>On L2:</p>
<ol>
<li>
<p>The user calls <code>approve</code> on the L2 tokens to allow the bridge to transfer the asset.</p>
</li>
<li>
<p>The user sends a transaction calling <code>withdrawERC20(address _token, address _receiverOnL1, uint256 _value)</code> on the <code>CommonBridgeL2</code> contract.</p>
</li>
<li>
<p>The bridge calls <code>crosschainBurn</code> on the L2 token, burning the amount to be withdrawn by the user.</p>
</li>
<li>
<p>The bridge fetches the address of the L1 token by calling <code>l1Address()</code> on the L2 token contract.</p>
</li>
<li>
<p>The bridge calls <code>sendMessageToL1(bytes32 data)</code> on the <code>Messenger</code> contract, with <code>data</code> being:</p>
<pre><code class="language-solidity">bytes32 data = keccak256(abi.encodePacked(_token.l1Address(), _token, _receiverOnL1, _value))
</code></pre>
</li>
<li>
<p><code>Messenger</code> emits an <code>L1Message</code> event, with the address of the L2 bridge contract and <code>data</code> as topics, along with a unique message ID.</p>
</li>
</ol>
<p>Off-chain:</p>
<ol>
<li>On each L2 node, the L1 watcher extracts <code>L1Message</code> events, generating a merkle tree with the hashed messages as leaves.
The merkle tree format is explained in the <a href="l2/fundamentals/withdrawals.html#l1message-merkle-tree">"<code>L1Message</code> Merkle tree"</a> section below.</li>
</ol>
<p>On L1:</p>
<ol>
<li>A sequencer commits the batch on L1, publishing the <code>L1Message</code> with <code>publishWithdrawals</code> on the L1 <code>CommonBridge</code>.</li>
<li>The user submits a withdrawal proof when calling <code>claimWithdrawalERC20</code> on the L1 <code>CommonBridge</code>.
The proof can be obtained by calling <code>ethrex_getWithdrawalProof</code> in any L2 node, after the batch containing the withdrawal transaction was verified in the L1.</li>
<li>The bridge asserts the proof is valid and wasn't previously claimed, and that the locked tokens mapping contains enough balance for the L1 and L2 token pair to cover the transfer.</li>
<li>The bridge transfers the locked tokens specified in the <code>L1Message</code> to the user and discounts the transferred amount from the L1 and L2 token pair in the mapping.</li>
</ol>
<pre class="mermaid">---
title: User makes an ERC20 withdrawal
---
sequenceDiagram
    box rgb(139, 63, 63) L2
        actor L2Alice as Alice
        participant L2Token
        participant CommonBridgeL2
        participant Messenger
    end

    actor Sequencer

    box rgb(33,66,99) L1
        participant OnChainProposer
        participant CommonBridge
        participant L1Token
        actor L1Alice as Alice
    end

    L2Alice-&gt;&gt;L2Token: approves token transfer
    L2Alice-&gt;&gt;CommonBridgeL2: withdraws 42 of L2Token
    CommonBridgeL2-&gt;&gt;L2Token: burns the 42 tokens
    CommonBridgeL2-&gt;&gt;Messenger: calls sendMessageToL1
    Messenger-&gt;&gt;Messenger: emits L1Message event

    Messenger--&gt;&gt;Sequencer: receives event

    Sequencer-&gt;&gt;OnChainProposer: publishes batch
    OnChainProposer-&gt;&gt;CommonBridge: publishes L1 message root

    L1Alice-&gt;&gt;CommonBridge: submits withdrawal proof
    CommonBridge-&gt;&gt;L1Token: transfers tokens
    L1Token--&gt;&gt;L1Alice: sends 42 tokens
</pre>
<h2 id="generic-l2-l1-messaging"><a class="header" href="#generic-l2-l1-messaging">Generic L2-&gt;L1 messaging</a></h2>
<p>First, we need to understand the generic mechanism behind it:</p>
<h3 id="l1message"><a class="header" href="#l1message"><code>L1Message</code></a></h3>
<p>To allow generic L2-&gt;L1 messages, a system contract is added which allows sending arbitrary data. This data is emitted as <code>L1Message</code> events, which nodes automatically extract from blocks.</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct L1Message {
    tx_hash: H256,    // L2 transaction where it was included
    from: Address,    // Who sent the message in L2
    data_hash: H256,  // Hashed payload
    message_id: U256, // Unique message ID
}
<span class="boring">}</span></code></pre></pre>
<h3 id="l1message-merkle-tree"><a class="header" href="#l1message-merkle-tree"><code>L1Message</code> Merkle tree</a></h3>
<p>When sequencers commit a new batch, they include the merkle root of all the <code>L1Message</code>s inside the batch.
That way, L1 contracts can verify some data was sent from a specific L2 sender.</p>
<pre class="mermaid">---
title: L1Message Merkle tree
---
flowchart TD
    
    Msg2[L1Message&lt;sub&gt;2&lt;/sub&gt;]
    Root([Root])
    Node1([Node&lt;sub&gt;1&lt;/sub&gt;])
    Node2([Node&lt;sub&gt;2&lt;/sub&gt;])

    Root --- Node1
    Root --- Node2

    subgraph Msg1[&quot;L1Message&lt;sub&gt;1&lt;/sub&gt;&quot;]
        direction LR

        txHash1[&quot;txHash&lt;sub&gt;1&lt;/sub&gt;&quot;]
        from1[&quot;from&lt;sub&gt;1&lt;/sub&gt;&quot;]
        dataHash1[&quot;hash(data&lt;sub&gt;1&lt;/sub&gt;)&quot;]
        messageId1[&quot;messageId&lt;sub&gt;1&lt;/sub&gt;&quot;]

        txHash1 --- from1
        from1 --- dataHash1
        dataHash1 --- messageId1
    end

    Node1 --- Msg1
    Node2 --- Msg2
</pre>
<p>As shown in the diagram, the leaves of the tree are the hash of each encoded <code>L1Message</code>.
Messages are encoded by packing, in order:</p>
<ul>
<li>the transaction hash that generated it in the L2</li>
<li>the address of the L2 sender</li>
<li>the hashed data attached to the message</li>
<li>the unique message ID</li>
</ul>
<h3 id="bridging"><a class="header" href="#bridging">Bridging</a></h3>
<p>On the L2 side, for the case of asset bridging, a contract burns some assets.
It then sends a message to the L1 containing the details of this operation:</p>
<ul>
<li>From: L2 token address that was burnt</li>
<li>To: L1 token address that will be withdrawn</li>
<li>Destination: L1 address that can claim the deposit</li>
<li>Amount: how much was burnt</li>
</ul>
<p>When the batch is committed on the L1, the <code>OnChainProposer</code> notifies the bridge which saves the message tree root.
Once the batch containing this transaction is verified, the user can claim their funds on the L1.
To do this, they compute a merkle proof for the included batch and call the L1 <code>CommonBridge</code> contract.</p>
<p>This contract then:</p>
<ul>
<li>Checks that the batch is verified</li>
<li>Ensures the withdrawal wasn't already claimed</li>
<li>Computes the expected leaf</li>
<li>Validates that the proof leads from the leaf to the root of the message tree</li>
<li>Gives the funds to the user</li>
<li>Marks the withdrawal as claimed</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ethrex-l2-contracts"><a class="header" href="#ethrex-l2-contracts">Ethrex L2 contracts</a></h1>
<p>There are two L1 contracts: OnChainProposer and CommonBridge. Both contracts are deployed using UUPS proxies, so they are upgradeables.</p>
<h2 id="l1-contracts"><a class="header" href="#l1-contracts">L1 Contracts</a></h2>
<h3 id="commonbridge"><a class="header" href="#commonbridge"><code>CommonBridge</code></a></h3>
<p>The <code>CommonBridge</code> is an upgradeable smart contract that facilitates cross-chain transfers between L1 and L2.</p>
<h4 id="state-variables"><a class="header" href="#state-variables"><strong>State Variables</strong></a></h4>
<ul>
<li><strong><code>pendingTxHashes</code></strong>: Array storing hashed pending privileged transactions</li>
<li><strong><code>batchWithdrawalLogsMerkleRoots</code></strong>: Mapping of L2 batch numbers to merkle roots of withdrawal logs</li>
<li><strong><code>deposits</code></strong>: Tracks how much of each L1 token was deposited for each L2 token (L1 → L2 → amount)</li>
<li><strong><code>claimedWithdrawalIDs</code></strong>: Tracks which withdrawals have been claimed by message ID</li>
<li><strong><code>ON_CHAIN_PROPOSER</code></strong>: Address of the contract that can commit and verify batches</li>
<li><strong><code>L2_BRIDGE_ADDRESS</code></strong>: Constant address (0xffff) representing the L2 bridge</li>
</ul>
<h4 id="core-functionality"><a class="header" href="#core-functionality"><strong>Core Functionality</strong></a></h4>
<ol>
<li>
<p><strong>Deposits (L1 → L2)</strong></p>
<ul>
<li><strong><code>deposit()</code></strong>: Allows users to deposit ETH to L2</li>
<li><strong><code>depositERC20()</code></strong>: Allows users to deposit ERC20 tokens to L2</li>
<li><strong><code>receive()</code></strong>: Fallback function for ETH deposits, forwarding to the sender's address on the L2</li>
<li><strong><code>sendToL2()</code></strong>: Sends arbitrary data to L2 via privileged transaction</li>
</ul>
<p>Internally the deposit functions will use the <code>SendValues</code> struct defined as:</p>
<pre><code class="language-solidity">struct SendValues {
    address to; // Target address on L2
    uint256 gasLimit; // Maximum gas for L2 execution
    uint256 value; // The value of the transaction
    bytes data; // Calldata to execute on the target L2 contract
}
</code></pre>
<p>This expresivity allows for arbitrary cross-chain actions, e.g., depositing ETH then interacting with an L2 contract.</p>
</li>
<li>
<p><strong>Withdrawals (L2 → L1)</strong></p>
<ul>
<li><strong><code>claimWithdrawal()</code></strong>: Withdraw ETH from <code>CommonBridge</code> via Merkle proof</li>
<li><strong><code>claimWithdrawalERC20()</code></strong>: Withdraw ERC20 tokens from <code>CommonBridge</code> via Merkle proof</li>
<li><strong><code>publishWithdrawals()</code></strong>: Priviledged function to add merkle root of L2 withdrawal logs to <code>batchWithdrawalLogsMerkleRoots</code> mapping to make them claimable</li>
</ul>
</li>
<li>
<p><strong>Transaction Management</strong></p>
<ul>
<li><strong><code>getPendingTransactionHashes()</code></strong>: Returns pending privileged transaction hashes</li>
<li><strong><code>removePendingTransactionHashes()</code></strong>: Removes processed privileged transactions (only callable by OnChainProposer)</li>
<li><strong><code>getPendingTransactionsVersionedHash()</code></strong>: Returns a versioned hash of the first <code>number</code> of pending privileged transactions</li>
</ul>
</li>
</ol>
<h3 id="onchainoperator"><a class="header" href="#onchainoperator"><code>OnChainOperator</code></a></h3>
<p>The <code>OnChainProposer</code> is an upgradeable smart contract that ensures the advancement of the L2. It's used by sequencers to commit batches of L2 blocks and verify their proofs.</p>
<h4 id="state-variables-1"><a class="header" href="#state-variables-1"><strong>State Variables</strong></a></h4>
<ul>
<li><strong><code>batchCommitments</code></strong>: Mapping of batch numbers to submitted <code>BatchCommitmentInfo</code> structs</li>
<li><strong><code>lastVerifiedBatch</code></strong>: The latest verified batch number (all batches ≤ this are considered verified)</li>
<li><strong><code>lastCommittedBatch</code></strong>: The latest committed batch number (all batches ≤ this are considered committed)</li>
<li><strong><code>authorizedSequencerAddresses</code></strong>: Mapping of authorized sequencer addresses that can commit and verify batches</li>
</ul>
<h4 id="core-functionality-1"><a class="header" href="#core-functionality-1"><strong>Core Functionality</strong></a></h4>
<ol>
<li>
<p><strong>Batch Commitment</strong></p>
<ul>
<li><strong><code>commitBatch()</code></strong>: Commits a batch of L2 blocks by storing its commitment data and publishing withdrawals</li>
<li><strong><code>revertBatch()</code></strong>: Removes unverified batches (only callable when paused)</li>
</ul>
</li>
<li>
<p><strong>Proof Verification</strong></p>
<ul>
<li><strong><code>verifyBatch()</code></strong>: Verifies a single batch using RISC0, SP1, or TDX proofs</li>
<li><strong><code>verifyBatchesAligned()</code></strong>: Verifies multiple batches in sequence using aligned proofs with Merkle verification</li>
</ul>
</li>
</ol>
<h2 id="l2-contracts-1"><a class="header" href="#l2-contracts-1">L2 Contracts</a></h2>
<h3 id="commonbridgel2"><a class="header" href="#commonbridgel2"><code>CommonBridgeL2</code></a></h3>
<p>The <code>CommonBridgeL2</code> is an L2 smart contract that facilitates cross-chain transfers between L1 and L2.</p>
<h4 id="state-variables-2"><a class="header" href="#state-variables-2"><strong>State Variables</strong></a></h4>
<ul>
<li><strong><code>L1_MESSENGER</code></strong>: Constant address (<code>0x000000000000000000000000000000000000FFFE</code>) representing the L2-to-L1 messenger contract</li>
<li><strong><code>BURN_ADDRESS</code></strong>: Constant address (<code>0x0000000000000000000000000000000000000000</code>) used to burn ETH during withdrawals</li>
<li><strong><code>ETH_TOKEN</code></strong>: Constant address (<code>0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE</code>) representing ETH as a token</li>
</ul>
<h4 id="core-functionality-2"><a class="header" href="#core-functionality-2"><strong>Core Functionality</strong></a></h4>
<ol>
<li>
<p><strong>ETH Operations</strong></p>
<ul>
<li><strong><code>withdraw()</code></strong>: Initiates ETH withdrawal to L1 by burning ETH on L2 and sending a message to L1</li>
<li><strong><code>mintETH()</code></strong>: Transfers ETH to a recipient (called by privileged L1 bridge transactions). If it fails a withdrawal is queued.</li>
</ul>
</li>
<li>
<p><strong>ERC20 Token Operations</strong></p>
<ul>
<li><strong><code>mintERC20()</code></strong>: Attempts to mint ERC20 tokens on L2 (only callable by the bridge itself via privileged transactions). If it fails a withdrawal is queued.</li>
<li><strong><code>tryMintERC20()</code></strong>: Internal function that validates token L1 address and performs a cross-chain mint</li>
<li><strong><code>withdrawERC20()</code></strong>: Initiates ERC20 token withdrawal to L1 by burning tokens on L2 and sending a message to L1</li>
</ul>
</li>
<li>
<p><strong>Cross-Chain Messaging</strong></p>
<ul>
<li><strong><code>_withdraw()</code></strong>: Private function that sends withdrawal messages to L1 via the L2-to-L1 messenger</li>
<li>Uses keccak256 hashing to encode withdrawal data for L1 processing</li>
</ul>
</li>
<li>
<p><strong>Access Control</strong></p>
<ul>
<li><strong><code>onlySelf</code></strong>: Modifier ensuring only the bridge contract itself can call privileged functions</li>
<li>Validates that privileged operations (like minting) are only performed by the bridge</li>
</ul>
</li>
</ol>
<h3 id="messenger"><a class="header" href="#messenger"><code>Messenger</code></a></h3>
<p>The <code>Messenger</code> is a simple L2 smart contract that enables communication from L2 to L1 by emitting the data as <code>L1Message</code> events for sequencers to pick up.</p>
<h4 id="state-variables-3"><a class="header" href="#state-variables-3"><strong>State Variables</strong></a></h4>
<ul>
<li><strong><code>lastMessageId</code></strong>: Counter that tracks the ID of the last emitted message (incremented before each message is sent)</li>
</ul>
<h4 id="core-functionality-3"><a class="header" href="#core-functionality-3"><strong>Core Functionality</strong></a></h4>
<ol>
<li><strong>Message Sending</strong>
<ul>
<li><strong><code>sendMessageToL1()</code></strong>: Sends a message to L1 by emitting an <code>L1Message</code> event with the sender, data, and <code>lastMessageId</code></li>
</ul>
</li>
</ol>
<h2 id="upgrade-the-contracts"><a class="header" href="#upgrade-the-contracts">Upgrade the contracts</a></h2>
<p>To upgrade a contract, you have to create the new contract and, as the original one, inherit from OpenZeppelin's <code>UUPSUpgradeable</code>. Make sure to implement the <code>_authorizeUpgrade</code> function and follow the <a href="https://docs.openzeppelin.com/upgrades-plugins/writing-upgradeable">proxy pattern restrictions</a>.</p>
<p>Once you have the new contract, you need to do the following three steps:</p>
<ol>
<li>
<p>Deploy the new contract</p>
<pre><code class="language-sh">rex deploy &lt;NEW_IMPLEMENTATION_BYTECODE&gt; 0 &lt;DEPLOYER_PRIVATE_KEY&gt;
</code></pre>
</li>
<li>
<p>Upgrade the proxy by calling the method <code>upgradeToAndCall(address newImplementation, bytes memory data)</code>. The <code>data</code> parameter is the calldata to call on the new implementation as an initialization, you can pass an empty stream.</p>
<pre><code class="language-sh">rex send &lt;PROXY_ADDRESS&gt; 'upgradeToAndCall(address,bytes)' &lt;NEW_IMPLEMENTATION_ADDRESS&gt; &lt;INITIALIZATION_CALLDATA&gt; --private-key &lt;PRIVATE_KEY&gt;
</code></pre>
</li>
<li>
<p>Check the proxy updated the pointed address to the new implementation. It should return the address of the new implementation:</p>
<pre><code class="language-sh">curl http://localhost:8545 -d '{"jsonrpc": "2.0", "id": "1", "method": "eth_getStorageAt", "params": [&lt;PROXY_ADDRESS&gt;, "0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc", "latest"]}'
</code></pre>
</li>
</ol>
<h2 id="transfer-ownership"><a class="header" href="#transfer-ownership">Transfer ownership</a></h2>
<p>The contracts are <code>Ownable2Step</code>, that means that whenever you want to transfer the ownership, the new owner have to accept it to effectively apply the change. This is an extra step of security, to avoid accidentally transfer ownership to a wrong account. You can make the transfer in these steps:</p>
<ol>
<li>
<p>Start the transfer:</p>
<pre><code class="language-sh">rex send &lt;PROXY_ADDRESS&gt; 'transferOwnership(address)' &lt;NEW_OWNER_ADDRESS&gt; --private-key &lt;CURRENT_OWNER_PRIVATE_KEY&gt;
</code></pre>
</li>
<li>
<p>Accept the ownership:</p>
<pre><code class="language-sh">rex send &lt;PROXY_ADDRESS&gt; 'acceptOwnership()' --private-key &lt;NEW_OWNER_PRIVATE_KEY&gt;
</code></pre>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="based-sequencing"><a class="header" href="#based-sequencing">Based sequencing</a></h1>
<p>This section covers the fundamentals of "based" rollups in the context of L2s built with ethrex.</p>
<h2 id="what-is-a-based-rollup"><a class="header" href="#what-is-a-based-rollup">What is a Based Rollup?</a></h2>
<p>A based rollup is a type of Layer 2 (L2) rollup that relies on the Ethereum mainnet (L1) for sequencing and ordering transactions, instead of using its own independent sequencer. This design leverages Ethereum's security and neutrality for transaction ordering, making the rollup more trust-minimized and censorship-resistant.</p>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>This documentation is about the current state of the <code>based</code> feature development and not about the final implementation. It is subject to change as the feature evolves and their still could be unmitigated issues.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>This is an extension of the <a href="l2/fundamentals/../architecture/sequencer.html">ethrex-L2-Sequencer documentation</a> and is intended to be merged with it in the future.</p>
</div>
<h2 id="components-1"><a class="header" href="#components-1">Components</a></h2>
<p>In addition to the components outlined in the <a href="l2/fundamentals/../architecture/sequencer.html">ethrex-L2-Sequencer documentation</a>, the <code>based</code> feature introduces new components to enable decentralized L2 sequencing. These additions enhance the system's ability to operate across multiple nodes, ensuring resilience, scalability, and state consistency.</p>
<h3 id="sequencer-state"><a class="header" href="#sequencer-state">Sequencer State</a></h3>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>While not a traditional component, the <strong>Sequencer State</strong> is a fundamental element of the <code>based</code> feature and deserves its own dedicated section.</p>
</div>
<p>The <code>based</code> feature decentralizes L2 sequencing, moving away from a single, centralized Sequencer to a model where multiple nodes can participate, with only one acting as the lead Sequencer at any time. This shift requires nodes to adapt their behavior depending on their role, leading to the introduction of the <strong>Sequencer State</strong>. The Sequencer State defines two possible modes:</p>
<ul>
<li><code>Sequencing</code>: The node is the lead Sequencer, responsible for proposing and committing new blocks to the L2 chain.</li>
<li><code>Following</code>: The node is not the lead Sequencer and must synchronize with and follow the blocks proposed by the current lead Sequencer.</li>
</ul>
<p>To keep the system simple and avoid intricate inter-process communication, the Sequencer State is implemented as a <strong>global state</strong>, accessible to all Sequencer components. This design allows each component to check the state and adjust its operations accordingly. The <strong>State Updater</strong> component manages this global state.</p>
<h3 id="state-updater"><a class="header" href="#state-updater">State Updater</a></h3>
<p>The <strong>State Updater</strong> is a new component tasked with maintaining and updating the Sequencer State. It interacts with the <strong>Sequencer Registry</strong> contract on L1 to determine the current lead Sequencer and adjusts the node’s state based on this information and local conditions. Its responsibilities include:</p>
<ul>
<li><strong>Periodic Monitoring</strong>: The State Updater runs at regular intervals, querying the <code>SequencerRegistry</code> contract to identify the current lead Sequencer.</li>
<li><strong>State Transitions</strong>: It manages transitions between <code>Sequencing</code> and <code>Following</code> states based on these rules:
<ul>
<li>If the node is designated as the lead Sequencer, it enters the <code>Sequencing</code> state.</li>
<li>If the node is not the lead Sequencer, it enters the <code>Following</code> state.</li>
<li>When a node ceases to be the lead Sequencer, it transitions to <code>Following</code> and reverts any uncommitted state to ensure consistency with the network.</li>
<li>When a node becomes the lead Sequencer, it transitions to <code>Sequencing</code> only if it is fully synced (i.e., has processed all blocks up to the last committed batch). If not, it remains in <code>Following</code> until it catches up.</li>
</ul>
</li>
</ul>
<p>This component ensures that the node’s behavior aligns with its role, preventing conflicts and maintaining the integrity of the L2 state across the network.</p>
<h3 id="block-fetcher"><a class="header" href="#block-fetcher">Block Fetcher</a></h3>
<p>Decentralization poses a risk: a lead Sequencer could advance the L2 chain without sharing blocks, potentially isolating other nodes. To address this, the <code>OnChainProposer</code> contract (see <a href="l2/fundamentals/./contracts.html">ethrex-L2-Contracts documentation</a>) has been updated to include an RLP-encoded list of blocks committed in each batch. This makes block data publicly available on L1, enabling nodes to reconstruct the L2 state if needed.</p>
<p>The <strong>Block Fetcher</strong> is a new component designed to retrieve these blocks from L1 when the node is in the <code>Following</code> state. Its responsibilities include:</p>
<ul>
<li><strong>Querying L1</strong>: It queries the <code>OnChainProposer</code> contract to identify the last committed batch.</li>
<li><strong>Scouting Transactions</strong>: Similar to how the L1 Watcher monitors deposit transactions, the Block Fetcher scans L1 for commit transactions containing the RLP-encoded block list.</li>
<li><strong>State Reconstruction</strong>: It uses the retrieved blocks to rebuild the L2 state, ensuring the node remains synchronized with the network.</li>
</ul>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Currently, the Block Fetcher is the primary mechanism for nodes to sync with the lead Sequencer. Future enhancements will introduce P2P gossiping to enable direct block sharing between nodes, improving efficiency.</p>
</div>
<h2 id="contracts"><a class="header" href="#contracts">Contracts</a></h2>
<p>In addition to the components described above, the based feature introduces new contracts and modifies existing ones to enhance decentralization, security, and transparency. Below are the key updates and additions:</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>This is an extension of the <a href="l2/fundamentals/./contracts.html">ethrex-L2-Contracts documentation</a> and is intended to be merged with it in the future.</p>
</div>
<h3 id="onchainproposer-modified"><a class="header" href="#onchainproposer-modified">OnChainProposer (Modified)</a></h3>
<p>The <code>OnChainProposer</code> contract, which handles batch proposals and management on L1, has been updated with the following modifications:</p>
<ul>
<li><strong>New Constant:</strong>
A public constant <code>SEQUENCER_REGISTRY</code> has been added. This constant holds the address of the <code>SequencerRegistry</code> contract, linking the two contracts for sequencer management.</li>
<li><strong>Modifier Update:</strong>
The <code>onlySequencer</code> modifier has been renamed to <code>onlyLeadSequencer</code>. It now checks whether the caller is the current lead Sequencer, as determined by the <code>SequencerRegistry</code> contract. This ensures that only the designated leader can commit batches.</li>
<li><strong>Initialization:</strong>
The <code>initialize</code> method now accepts the address of the <code>SequencerRegistry</code> contract as a parameter. During initialization, this address is set to the <code>SEQUENCER_REGISTRY</code> constant, establishing the connection between the contracts.</li>
<li><strong>Batch Commitment:</strong>
The <code>commitBatch</code> method has been revised to improve data availability and streamline sequencer validation:
<ul>
<li>It now requires an RLP-encoded list of blocks included in the batch. This list is published on L1 to ensure transparency and enable verification.</li>
<li>The list of sequencers has been removed from the method parameters. Instead, the <code>SequencerRegistry</code> contract is now responsible for tracking and validating sequencers.</li>
</ul>
</li>
<li><strong>Event Modification:</strong>
The <code>BatchCommitted</code> event has been updated to include the batch number of the committed batch. This addition enhances traceability and allows external systems to monitor batch progression more effectively.</li>
<li><strong>Batch Verification:</strong>
The <code>verifyBatch</code> method has been made more flexible and decentralized:
<ul>
<li>The <code>onlySequencer</code> modifier has been removed, allowing anyone—not just the lead Sequencer—to verify batches.</li>
<li>The restriction preventing multiple verifications of the same batch has been lifted. While multiple verifications are now permitted, only one valid verification is required to advance the L2 state. This change improves resilience and reduces dependency on a single actor.</li>
</ul>
</li>
</ul>
<h3 id="sequencerregistry-new-contract"><a class="header" href="#sequencerregistry-new-contract">SequencerRegistry (New Contract)</a></h3>
<p>The <code>SequencerRegistry</code> is a new contract designed to manage the pool of Sequencers and oversee the leader election process in a decentralized manner.</p>
<ul>
<li>
<p><strong>Registration:</strong></p>
<ul>
<li>Anyone can register as a Sequencer by calling the <code>register</code> method and depositing a minimum collateral of 1 ETH. This collateral serves as a Sybil resistance mechanism, ensuring that only committed participants join the network.</li>
<li>Sequencers can exit the registry by calling the <code>unregister</code> method, which refunds their 1 ETH collateral upon successful deregistration.</li>
</ul>
</li>
<li>
<p><strong>Leader Election:</strong>
The leader election process operates on a round-robin basis to fairly distribute the lead Sequencer role:</p>
<ul>
<li><strong>Single Sequencer Case:</strong> If only one Sequencer is registered, it remains the lead Sequencer indefinitely.</li>
<li><strong>Multiple Sequencers:</strong> When two or more Sequencers are registered, the lead Sequencer rotates every 32 batches. This ensures that no single Sequencer dominates the network for an extended period.</li>
</ul>
</li>
<li>
<p><strong>Future Leader Prediction:</strong>
The <code>futureLeaderSequencer</code> method allows querying the lead Sequencer for a batch n batches in the future. The calculation is based on the following logic:</p>
<p><strong>Inputs:</strong></p>
<ul>
<li><code>sequencers</code>: An array of registered Sequencer addresses.</li>
<li><code>currentBatch</code>: The next batch to be committed, calculated as <code>lastCommittedBatch() + 1</code> from the <code>OnChainProposer</code> contract.</li>
<li><code>nBatchesInTheFuture</code>: A parameter specifying how many batches ahead to look.</li>
<li><code>targetBatch</code>: Calculated as <code>currentBatch</code> + <code>nBatchesInTheFuture</code>.</li>
<li><code>BATCHES_PER_SEQUENCER</code>: A constant set to 32, representing the number of batches each lead Sequencer gets to commit.</li>
</ul>
<p><strong>Logic:</strong></p>
<pre><code class="language-solidity">uint256 _currentBatch = IOnChainProposer(ON_CHAIN_PROPOSER).lastCommittedBatch() + 1;
uint256 _targetBatch = _currentBatch + nBatchesInTheFuture;
uint256 _id = _targetBatch / BATCHES_PER_SEQUENCER;
address _leader = sequencers[_id % sequencers.length];
</code></pre>
<p><strong>Example:</strong> Assume 3 Sequencers are registered: <code>[S0, S1, S2]</code>, and the current committed batch is 0:</p>
<ul>
<li>For batches 0–31: <code>_id = 0 / 32 = 0, 0 % 3 = 0</code>, lead Sequencer = <code>S0</code>.</li>
<li>For batches 32–63: <code>_id = 32 / 32 = 1, 1 % 3 = 1</code>, lead Sequencer = <code>S1</code>.</li>
<li>For batches 64–95: <code>_id = 64 / 32 = 2, 2 % 3 = 2</code>, lead Sequencer = <code>S2</code>.</li>
<li>For batches 96–127: <code>_id = 96 / 32 = 3, 3 % 3 = 0</code>, lead Sequencer = <code>S0</code>.</li>
</ul>
<p>This round-robin rotation repeats every 96 committed batches (32 committed batches per Sequencer × 3 Sequencers), ensuring equitable distribution of responsibilities.</p>
</li>
</ul>
<h2 id="roadmap"><a class="header" href="#roadmap">Roadmap</a></h2>
<p><em>Special thanks to <a href="https://x.com/_eltitan">Lorenzo</a> and <a href="https://x.com/kubimensah">Kubi</a>, <a href="https://x.com/gd_gattaca">George</a>, and Louis from <a href="https://x.com/gattacahq">Gattaca</a>, <a href="https://x.com/jasnoodle">Jason</a> from <a href="https://x.com/fabric_ethereum">Fabric</a>, and <a href="https://x.com/mteamisloading">Matthew</a> from <a href="https://x.com/Spire_Labs">Spire Labs</a> for their feedback and suggestions.</em></p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>This document is still under development, and everything stated in it is subject to change after feedback and iteration.
Feedback is more than welcome.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>We believe that <a href="https://ethresear.ch/t/becoming-based-a-path-towards-decentralised-sequencing/21733">Gattaca's model</a>—permissionless with preconfs using L1 proposers (either directly or through delegations) as L2 sequencers—is the ideal approach. However, this model cannot achieve permissionlessness until the deterministic lookahead becomes available after Fusaka. In the meantime, we consider the Spire approach, based on a Dutch auction, to be the most suitable for our current needs. It is important to note that Rogue cannot implement a centralized mechanism for offering preconfs, so we have chosen to prioritize a permissionless structure before enabling preconfirmations. This initial approach is <strong>decentralized</strong> and <strong>permissionless</strong> but not <strong>based</strong> yet. Although sequencing rights aren't currently guaranteed to the L1 proposer, there will be incentives for L1 proposers to eventually participate in the L2, moving toward <a href="https://ethresear.ch/t/based-rollups-superpowers-from-l1-sequencing/15016">Justin Drake's definition</a>.</p>
</div>
<p>From the beginning, <a href="https://github.com/lambdaclass/ethrex">ethrex</a> was conceived not just as an Ethereum L1 client, but also as an L2 (ZK Rollup). This means anyone will be able to use ethrex to deploy an EVM-equivalent, multi-prover (supporting SP1, RISC Zero, and TEEs) based rollup with just one command. We recently wrote a <a href="https://blog.lambdaclass.com/celebrating-a-year-of-ethrex/">blog post</a> where we expand this idea more in depth.</p>
<p>The purpose of this document is to provide a high-level overview of how ethrex will implement its based rollup feature.</p>
<h2 id="state-of-the-art"><a class="header" href="#state-of-the-art">State of the art</a></h2>
<p>Members of the Ethereum Foundation are actively discussing and proposing EIPs to integrate based sequencing into the Ethereum network. Efforts are also underway to coordinate and standardize the components required for these based rollups; one such initiative is <a href="https://ethresear.ch/t/fabric-fabric-to-accelerate-based-rollup-infrastructure-connectivity/21640">FABRIC</a>.</p>
<p>The following table provides a high-level comparison of different based sequencing approaches, setting the stage for our own proposal.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>This table compares the different based rollups in the ecosystem based on their current development state, not their final form.</p>
</div>
<div class="table-wrapper"><table><thead><tr><th>Based Rollup</th><th>Protocol</th><th>Sequencer Election</th><th>Proof System</th><th>Preconfs</th><th>Additional Context</th></tr></thead><tbody>
<tr><td><a href="https://github.com/taikoxyz/taiko-mono">Taiko Alethia (Taiko Labs)</a></td><td>Permissioned</td><td>Fixed Deterministic Lookahead</td><td>Multi-proof (sgxGeth (TEE), and sgxReth (ZK/TEE))</td><td>Yes</td><td>-</td></tr>
<tr><td><a href="https://github.com/gattaca-com/based-op">Gattaca's Based OP (Gattaca + Lambdaclass)</a></td><td>Permissioned</td><td>Round Robin</td><td>Single Proof (optimistic)</td><td>Yes</td><td>For phase 1, the Sequencer/Gateway was centralized. For phase 2 (current phase) the Sequencer/Gateway is permissioned.</td></tr>
<tr><td><a href="https://ethereumr1.org/">R1</a></td><td>Permissionless</td><td>Total Anarchy</td><td>Multi-proof (ZK, TEE, Guardian)</td><td>No</td><td>R1 is yet to be specified but plans are for it to be built on top of Surge and Taiko's Stack. They're waiting until Taiko is mature enough to have preconfs</td></tr>
<tr><td><a href="https://github.com/NethermindEth/surge">Surge (Nethermind)</a></td><td>Permissionless</td><td>Total Anarchy</td><td>Multi-proof (ZK, TEE, Guardian)</td><td>No</td><td>Surge is built on top of Taiko Alethia but it's tuned enough to be a Stage 2 rollup. Surge is not designed to compete with existing rollups for users or market share. Instead, it serves as a technical showcase, experimentation platform, and reference implementation.</td></tr>
<tr><td><a href="https://github.com/spire-labs/based-stack">Spire (Spire Labs)</a></td><td>Permissionless</td><td>Dutch Auction</td><td>Single Proof (optimistic)</td><td>Yes</td><td>-</td></tr>
<tr><td><a href="https://x.com/fede_intern/status/1846035499799978475">Rogue (LambdaClass)</a></td><td>Permissionless</td><td>Dutch Auction</td><td>Multi-Proof (ZK + TEE)</td><td>Not Yet</td><td>We are prioritizing decentralization and permissionlessness at the expense of preconfirmations until the deterministic lookahead is available after Fusaka</td></tr>
</tbody></table>
</div>
<p>Other based rollups not mentioned will be added later.</p>
<h2 id="ethrex-proposal-for-based-sequencing"><a class="header" href="#ethrex-proposal-for-based-sequencing">Ethrex proposal for based sequencing</a></h2>
<p>According to Justin Drake's definition of "based", being "based" implies that the L1 proposers are the ones who, at the end of the day, sequence the L2, either directly or by delegating the responsibility to a third party.</p>
<p>However, today, the "based" ecosystem is very immature. Despite the constant efforts of various teams, no stack is fully prepared to meet this definition. Additionally, L1 proposers do not have sufficient economic incentives to be part of the protocol.</p>
<p>But there's a way out. As mentioned in Spire's <a href="https://docs.spire.dev/education-hub/what-is-a-based-rollup">"What is a based rollup?"</a></p>
<blockquote>
<p>The key to this definition is that sequencing is "driven" by a base layer and not controlled by a completely external party.</p>
</blockquote>
<p>Following this, our proposal's main focus is <strong>decentralization</strong> and <strong>low operation cost</strong>, and we don't want to sacrifice them in favor of preconfirmations or composability.</p>
<p>Considering this, after researching existing approaches, we concluded that a decentralized, permissionless ticket auction is the most practical first step for ethrex's based sequencing solution.</p>
<p>Ultimately, we aim to align with <a href="https://ethresear.ch/t/becoming-based-a-path-towards-decentralised-sequencing/21733">Gattaca's model for based sequencing</a> and collaborate with <a href="https://ethresear.ch/t/fabric-fabric-to-accelerate-based-rollup-infrastructure-connectivity/21640">FABRIC</a> efforts to standardize based rollups and helping interoperability.</p>
<p><a href="https://x.com/fede_intern/status/1846035499799978475">Rogue</a> and many upcoming rollups will be following this approach.</p>
<h2 id="benefits-of-our-approach"><a class="header" href="#benefits-of-our-approach">Benefits of our approach</a></h2>
<p>The key benefits of our approach to based sequencing are:</p>
<ul>
<li><strong>Decentralization and Permissionlessness from the Get-Go:</strong> We've decentralized ethrex L2 by allowing anyone to participate in the L2 block proposal; actors willing to participate on it can do this permissionlessly, as the execution ticket auction approach we are taking provides a governance free leader election mechanism.</li>
<li><strong>Robust Censorship Resistance:</strong> By being decentralized and permissionless, and with the addition of Sequencer challenges, we increased the cost of censorship in the protocol.</li>
<li><strong>Low Operational Cost:</strong> We strived to make the sequencer operating costs as low as possible by extending the sequencing window, allowing infrequent L1 finalization for low traffic periods.</li>
<li><strong>Configurability:</strong> We intentionally designed our protocol to be configurable at its core. This allows different rollup setups to be tailored based on their unique needs, ensuring optimal performance, efficiency, and UX.</li>
</ul>
<h2 id="key-points"><a class="header" href="#key-points">Key points</a></h2>
<h3 id="terminology"><a class="header" href="#terminology">Terminology</a></h3>
<ul>
<li><strong>Ticket:</strong> non-transferable right of a Sequencer to build and commit an L2 batch. One or more are auctioned during each <strong>auction period</strong>.</li>
<li><strong>Sequencing Period:</strong> the period during which a ticket holder has sequencing rights.</li>
<li><strong>Auction Period:</strong> the period during which the auction is performed.</li>
<li><strong>Auction Challenge:</strong> instance within a sequencing period where lead Sequencer sequencing rights can be challenged.</li>
<li><strong>Challenge Period:</strong> the period during which a lead sequencer can be challenged.</li>
<li><strong>Allocated Period:</strong> the set of <strong>contiguous sequencing periods</strong> allocated among the winners <strong>of the corresponding auctioning period</strong> -during an auctioning period, multiple sequencing periods are auctioned, the set of these is the allocated period.</li>
<li><strong>L2 batch:</strong> A collection of L2 blocks submitted to L1 in a single transaction.</li>
<li><strong>Block/Batch Soft-commit Message:</strong> A signed P2P message from the Lead Sequencer publishing a new block or sealed batch.</li>
<li><strong>Commit Transaction:</strong> An L1 transaction submitted by the Lead Sequencer to commit to an L2 batch execution. It is also called Batch Commitment.</li>
<li><strong>Sequencer:</strong> An L2 node registered in the designated L1 contract.</li>
<li><strong>Lead Sequencer:</strong> The Sequencer currently authorized to build L2 blocks and post L2 batches during a specific L1 block.</li>
<li><strong>Follower:</strong> Non-Lead Sequencer nodes, which may be Sequencers awaiting leadership or passive nodes.</li>
</ul>
<h3 id="how-it-will-work"><a class="header" href="#how-it-will-work">How it will work</a></h3>
<p>As outlined earlier, sequencing rights for future blocks are allocated through periodic ticket auctions. To participate, sequencers must register and provide collateral. Each auction occurs during a designated auction period, which spans a defined range of L1 blocks. These auctions are held a certain number of blocks in advance of the allocated period.</p>
<p>During each auction period, a configurable number of tickets are auctioned off. Each ticket grants its holder the right to sequence transactions during one sequencing period within the allocated period. However, at the time of the auction, the specific sequencing period assigned to each ticket remains undetermined. Once the auction period ends, the sequencing periods are randomly assigned (shuffled) among the ticket holders, thereby determining which sequencing period each ticket corresponds to.</p>
<p>Parameters like the amount of tickets auctioned (i.e. amount of sequencing periods per allocated period), the duration of the auction periods, the duration of the sequencing periods, and more, are configurable. This configurability is not merely a feature but a deliberate and essential design choice. The complete list of all configurable parameters can be found under the “Protocol details” section.</p>
<p><img src="l2/fundamentals/../img/leader_election_process.png" alt="Diagram showing leader election process" /></p>
<ol>
<li>Sequencers individually opt in before auction period <code>n</code> ends, providing collateral via an L1 contract. This registration is a one-time process per Sequencer.</li>
<li>During the auction, registered Sequencers bid for sequencing rights for a yet-to-be-revealed sequencing period within the allocated period.</li>
<li>At the auction's conclusion, sequencing rights for the sequencing periods within the allocated period are assigned among the ticket holders.</li>
<li>Finally, Sequencers submit L2 batch transactions to L1 during their assigned sequencing period (note: this step does not immediately follow step 3, as additional auctions and sequencing might occur in-between).</li>
</ol>
<p>In each sequencing period, the Lead Sequencer is initially determined through a bidding process. However, this position can be contested by other Sequencers who are willing to pay a higher price than the winning bid. The number of times such challenges can occur within a single sequencing period is configurable, allowing for control over the stability of the leadership. Should a challenge succeed, the challenging Sequencer takes over as the Lead Sequencer for the remainder of the period, and the original Lead Sequencer is refunded a portion of their bid corresponding to the time left in the period. For example, if a challenge is successful at the midpoint of the sequencing period, the original Lead Sequencer would be refunded half of their bid.</p>
<p>The following example assumes a sequencing period of 1 day, 1 auction challenge per hour with challenge periods of 1 hour.</p>
<p><img src="l2/fundamentals/../img/challenges_to_leaders.png" alt="Diagram showing how challenges work" /></p>
<ol>
<li>Auction winner (Sequencer green) starts as the lead Sequencer of the sequencing period.</li>
<li>No one can challenge the lead in the first hour.</li>
<li>During the second hour, the first auction challenge starts, and multiple Sequencers bid to challenge the lead. Finally, the lead Sequencer is overthrown and the new lead (Sequencer blue) starts sequencing.</li>
<li>In the third hour a new auction challenge opens and the former lead Sequencer takes back the lead.</li>
<li>Until the last hour of the sequencing period, the same cycle repeats having many leader changes.</li>
</ol>
<p>To ensure L2 liveness in this decentralized protocol, Sequencers must participate in a peer-to-peer (P2P) network. The diagram below illustrates this process:</p>
<p><img src="l2/fundamentals/../img/l2_p2p_diagram.png" alt="Diagram showing the end-to-end flow of a transaction in the ethrex L2 P2P layer" /></p>
<ol>
<li>A User: sends a transaction to the network.</li>
<li>Any node: Gossips in the P2P a received transaction. So every transaction lives in a public distributed mempool</li>
<li>The Lead Sequencer: Produces an L2 block including that transaction.</li>
<li>The Lead Sequencer: Broadcasts the L2 block, including the transaction, to the network via P2P.</li>
<li>Any node: Executes the block, gossips it, and keeps its state up to date.</li>
<li>The Lead Sequencer: Seals the batch in L2.</li>
<li>The Lead Sequencer: Posts the batch to the L1 in a single transaction.</li>
<li>The Lead Sequencer: Broadcasts the "batch sealed" message to the network via P2P.</li>
<li>Any node: Seals the batch locally and gossips the message.</li>
<li>A User: Receives a non-null receipt for the transaction.</li>
</ol>
<!--
Lead Sequencers will follow the following pipeline for L2 block building and batch commitment:

TODO: add updated graph with L1 block time distribution
-->
<h2 id="protocol-details"><a class="header" href="#protocol-details">Protocol details</a></h2>
<h3 id="additional-terminology"><a class="header" href="#additional-terminology">Additional Terminology</a></h3>
<ul>
<li><strong>Next Batch</strong>: The L2 batch being built by the lead Sequencer.</li>
<li><strong>Up-to-date Nodes:</strong> Nodes that have the last committed batch in their storage and only miss the next batch.</li>
<li><strong>Following:</strong> We say that up-to-date nodes are <strong>following</strong> the lead Sequencer.</li>
<li><strong>Syncing:</strong> Nodes are <strong>syncing</strong> if they are not up-to-date. They’ll stop syncing after they reach the <strong>following</strong> state.</li>
<li><strong>Verify Transaction:</strong> An L1 transaction submitted by anyone to verify a ZK proof to an L2 batch execution.</li>
</ul>
<h3 id="network-participants"><a class="header" href="#network-participants">Network participants</a></h3>
<ul>
<li>Sequencer Nodes: Nodes that have opted in to serve as Sequencers.</li>
<li>Follower Nodes: State or RPC Nodes.</li>
<li>Prover Nodes:</li>
</ul>
<p>By default, every ethrex L2 node begins as a Follower Node. A process will periodically query the L1 smart contract registry for the Lead Sequencer's address and update each node's state accordingly.</p>
<h3 id="network-parameters"><a class="header" href="#network-parameters">Network parameters</a></h3>
<p>A list of all the configurable parameters of the network.</p>
<ul>
<li>Sequencing period duration</li>
<li>Auction period duration</li>
<li>Number of sequencing periods in an allocated period</li>
<li>Time between auction and allocated period</li>
<li>L2 block time</li>
<li>Minimum collateral in ETH for Sequencers registration</li>
<li>Withdrawal delay for Sequencers that quit the protocol</li>
<li>Initial ticket auction price multiplier</li>
<li>Batch verification time limit</li>
<li>Amount of auction challenges within a sequencing period</li>
<li>Challenge period duration</li>
<li>Time between auction challenges</li>
<li>Challenge price multiplier</li>
</ul>
<h3 id="lead-sequencer-election"><a class="header" href="#lead-sequencer-election">Lead Sequencer election</a></h3>
<ul>
<li>Aspiring Lead Sequencers must secure sequencing rights through a Dutch auction in advance, enabling them to post L2 batches to L1.</li>
<li>Sequencing rights are tied to tickets: one ticket grants the right to sequence and post batches during a specific sequencing period.</li>
<li>For each sequencing period within an allocated period, sequencing rights are randomly assigned from the pool of ticket holders.</li>
<li>Each auction period determines tickets for the nth epoch ahead (configurable).</li>
<li>Once Ethereum incorporates deterministic lookahead (e.g., <a href="https://eips.ethereum.org/EIPS/eip-7917">EIP-7917</a>), the Lead Sequencer for a given L1 slot will be the current proposer, provided they hold a ticket.</li>
</ul>
<h3 id="auction-challenges"><a class="header" href="#auction-challenges">Auction challenges</a></h3>
<ul>
<li>During a sequencing period, other Sequencers can pay a higher price than the winning bid to challenge the Lead Sequencer.</li>
<li>This can only happen a configurable number of times per sequencing period.</li>
<li>After a successful challenge, the current Lead Sequencer is replaced by the challenging sequencer for the rest of the Sequencing Period and is refunded the portion of its bid corresponding to the remaining sequencing period (e.g. half of its bid if it loses half of its sequencing period).</li>
</ul>
<h3 id="sequencers-registry"><a class="header" href="#sequencers-registry">Sequencers registry</a></h3>
<ul>
<li>L1 contract that manages Sequencer registration and ticket auctions for sequencing rights.</li>
<li>Sequencers can register permissionlessly by providing a minimum collateral in ETH.</li>
<li>Sequencers may opt out of an allocated period by not purchasing tickets for that period.</li>
<li>Sequencers can unregister and withdraw their collateral after a delay.</li>
</ul>
<h3 id="lead-sequencers-role"><a class="header" href="#lead-sequencers-role">Lead Sequencers role</a></h3>
<ul>
<li>Build L2 blocks and post L2 batches to the L1 within the sequencing period.</li>
<li>Broadcast to the network:
<ul>
<li>Transactions.</li>
<li>Sequenced blocks as they are built.</li>
<li>Batch seal messages to prompt the network to seal the batch locally.</li>
</ul>
</li>
<li>Serve state.</li>
</ul>
<h3 id="follower-nodes-role"><a class="header" href="#follower-nodes-role">Follower nodes role</a></h3>
<ul>
<li>Broadcast to the network:
<ul>
<li>Transactions.</li>
<li>Sequenced blocks.</li>
<li>Batch seal messages.</li>
</ul>
</li>
<li>Store incoming blocks sequentially.</li>
<li>Seal batches upon receiving batch seal messages (after storing all batch blocks).</li>
<li>Serve state.</li>
<li>Monitor the L1 contract for batch updates and reorgs.</li>
</ul>
<h3 id="prover-nodes-role"><a class="header" href="#prover-nodes-role">Prover nodes role</a></h3>
<ul>
<li>For this stage, it is the Sequencers' responsibility to prove their own batches.</li>
<li>The prover receives the proof generation inputs of a batch from another node and returns a proof.</li>
</ul>
<h3 id="batch-commitmentproposal"><a class="header" href="#batch-commitmentproposal">Batch commitment/proposal</a></h3>
<div class="mdbook-alerts mdbook-alerts-tip">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  tip
</p>
<p>To enrich the understanding of this part, we suggest reading <a href="https://github.com/lambdaclass/ethrex/blob/main/docs/l2/overview.md">ethrex L2 High-Level docs</a> as this only details the diff with what we already have.</p>
</div>
<ul>
<li>Only lead Sequencer can post batches.</li>
<li>Lead Sequencer batches are accepted during their sequencing period and rejected outside this period.</li>
<li>Batch commitment now includes posting the list of blocks in the batch to the L1 for data availability.</li>
</ul>
<h3 id="batch-verification"><a class="header" href="#batch-verification">Batch verification</a></h3>
<div class="mdbook-alerts mdbook-alerts-tip">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  tip
</p>
<p>To enrich the understanding of this part, we suggest reading <a href="https://github.com/lambdaclass/ethrex/blob/main/docs/l2/overview.md">ethrex L2 High-Level docs</a> as this only details the diff with what we already have.</p>
</div>
<ul>
<li>Anyone can verify batches.</li>
<li>Only one valid verification is required to advance the network.</li>
<li>Valid proofs include the blocks of the batch being verified.</li>
<li>In this initial version, the lead Sequencer is penalized if they fail to correctly verify the batches they post.</li>
</ul>
<h3 id="p2p"><a class="header" href="#p2p">P2P</a></h3>
<ul>
<li>Ethrex's L1 P2P network will be used to gossip transactions and for out-of-date nodes to sync.</li>
<li>A new capability will be added for gossipping L2 blocks and batch seal messages (<code>NewBlock</code> and <code>BatchSealed</code>).</li>
<li>The <code>NewBlock</code> message includes an RLP-encoded list of transactions in the block, along with metadata for re-execution and validation. It is signed, and receivers must verify the signature (additional data may be required in practice).</li>
<li>The <code>SealedBatch</code> message specifies the batch number and the number of blocks it contains (additional data may be needed in practice).</li>
<li>Follower Nodes must validate all messages. They add <code>NewBlock</code>s to storage sequentially and seal the batch when the <code>SealedBatch</code> message arrives. If a node's current block is <code>n</code> and it receives block <code>n + 2</code>, it queues <code>n + 2</code>, waits for <code>n + 1</code>, adds it, then processes <code>n + 2</code>. Similarly, a SealedBatch message includes block numbers, and the node delays sealing until all listed blocks are stored.</li>
</ul>
<h3 id="syncing"><a class="header" href="#syncing">Syncing</a></h3>
<p>Nodes that join a live network will need to sync up to the latest state.</p>
<p>For this we'll divide nodes into two different states:</p>
<ul>
<li><strong>Following nodes</strong>: These will keep up-to-date via the based P2P.</li>
<li><strong>Syncing nodes</strong>: These will sync via 2 different mechanisms:
<ul>
<li><strong>P2P Syncing:</strong> This is the same as full-sync and snap-sync on L1, but with some changes.</li>
<li><strong>L1 Syncing:</strong> Also used by provers to download batches from the L1.</li>
<li>In practice, these methods will compete to sync the node.</li>
</ul>
</li>
</ul>
<h2 id="downsides"><a class="header" href="#downsides">Downsides</a></h2>
<p>Below we list some of the risks and known issues we are aware of that this protocol introduces. Some of them were highlighted thanks to the feedback of different teams that took the time to review our first draft.</p>
<ul>
<li><strong>Inconsistent UX:</strong> If a Sequencer fails to include its batch submit transaction in the L1, the blocks it contains will simply be reorged out once the first batch of the next sequencer is published. Honest sequencers can avoid this by not building new batches some slots before their turn ends. The next Sequencer can, in turn, start building their first batch earlier to avoid dead times. This is similar to Taiko’s permissioned network, where sequencers coordinate to stop proposing 4 slots before their turn ends to avoid reorgs.</li>
<li><strong>Batch Stealing:</strong> Lead Sequencers that fail to publish their batches before their sequencing period ends might have their batches "stolen" by the next Lead Sequencer, which can republish those batches as their own. We can mitigate in the same way as the last point.</li>
<li><strong>Long Finalization Times:</strong> Since publishing batches to L1 is infrequent, users might experience long finalization times during low traffic periods. We can solve this by assuming a transaction in an L2 block transmitted through P2P will eventually be published to L1, and punishing Sequencers that don't include some of their blocks in a batch.</li>
<li><strong>Temporary Network Blinding:</strong> A dishonest Sequencer may blind the network if they don't gossip blocks nor publish the batches to the L1 as part of the commit transactions' calldata. While the first case alone is mitigated through an L1 syncing mechanism, if the necessary data to sync is not available we can't rely on it. In this case, the prover ensures this doesn't happen by requiring the batch as a public input to the proof verification. That way, the bad batch can't be verified, and will be reverted.</li>
<li><strong>High-Fee Transactions Hoarding:</strong> A dishonest Sequencer might not share high-fee transactions with the Lead Sequencer with the hope of processing them once it's their turn to be Lead Sequencer. This is a non-issue, since transaction senders can simply propagate their transaction themselves, either by sending it to multiple RPC providers, or to their own node.</li>
<li><strong>Front-running and Sandwiching Attacks:</strong> Lead Sequencers have the right to reorder transactions as they like and we expect they'll use this to extract MEV, including front-running and sandwiching attacks, which impact user experience. We don't have plans to address this at the protocol level, but we expect solutions to appear at the application level, same as in L1.</li>
<li><strong>No Sequencers Scenario:</strong> If a sequencing period has no elected Lead Sequencer, we establish Full Anarchy during that period, so anyone can advance the chain. This is a last resort, and we don't expect this happening in practice.</li>
</ul>
<h2 id="conclusion-2"><a class="header" href="#conclusion-2">Conclusion</a></h2>
<p>To preserve decentralization and permissionlessness, we chose ticket auctions for leader election, at the expense of preconfirmations and composability.</p>
<p>As mentioned at the beginning, this approach does not fully align with <a href="https://ethresear.ch/t/based-rollups-superpowers-from-l1-sequencing/15016">Justin Drake's definition</a> of "based" rollups but is "based enough" to serve as a starting point. Although the current design cannot guarantee that sequencing rights are assigned exclusively to the L1 proposer for each slot, we're interested in achieving this, and will do so once the conditions are met, namely, that L1 proposer lookahead is available.</p>
<p>So what about "based" Ethrex tomorrow? Eventually, there will be enough incentives for L1 proposers to either run their own L2 Sequencers or delegate their L1 rights to an external one. At that stage, the auction and assignment of L2 sequencing rights will be linked to the current L1 proposer or their delegated Sequencer. Periods may also adjust as lookahead tables, such as the <a href="https://eips.ethereum.org/EIPS/eip-7917">Deterministic Lookahead Proposal</a> or <a href="https://eth-fabric.github.io/website/research/raid">RAID</a>, become viable.</p>
<p>This proposal is intentionally minimalistic and adaptable for future refinements. How this will change and adapt to future necessities is something we don't know right now, and we don't care about it until those necessities arrive; this is <a href="https://blog.lambdaclass.com/lambdas-engineering-philosophy/">Lambda's engineering philosophy</a>.</p>
<h2 id="further-considerations"><a class="header" href="#further-considerations">Further considerations</a></h2>
<p>The following are things we are looking to tackle in the future, but which are not blockers for our current work.</p>
<ul>
<li>Ticket Pricing Strategies.</li>
<li>Delegation Processes.</li>
<li>Preconfirmations.</li>
<li>Bonding.</li>
<li>L1 Reorgs Handling.</li>
</ul>
<h2 id="references-and-acknowledgements"><a class="header" href="#references-and-acknowledgements">References and acknowledgements</a></h2>
<p>The following links, repos, and projects have been important in the development of this document, we have learned a lot from them and want to thank and acknowledge them.</p>
<h3 id="context"><a class="header" href="#context">Context</a></h3>
<ul>
<li><a href="https://medium.com/l2beat/introducing-stages-a-framework-to-evaluate-rollups-maturity-d290bb22befe">Stages of a Rollup</a></li>
<li><a href="https://ethereum.org/en/roadmap/pbs/">PBS</a></li>
<li><a href="https://vitalik.eth.limo/general/2021/01/05/rollup.html">Total Anarchy</a></li>
<li><a href="https://ethresear.ch/t/fabric-fabric-to-accelerate-based-rollup-infrastructure-connectivity/21640">FABRIC</a></li>
</ul>
<h3 id="intro-to-based-rollups"><a class="header" href="#intro-to-based-rollups">Intro to based rollups</a></h3>
<ul>
<li><a href="https://ethresear.ch/t/based-rollups-superpowers-from-l1-sequencing/15016">Based Rollups by Justin Drake (current accepted definition)</a></li>
<li><a href="https://docs.spire.dev/education-hub/what-is-a-based-rollup">Based Rollups by Spire</a></li>
<li><a href="https://docs.taiko.xyz/taiko-alethia-protocol/protocol-design/based-rollups/">Based Rollups by Taiko</a></li>
<li><a href="https://ethresear.ch/t/becoming-based-a-path-towards-decentralised-sequencing/21733">Based Rollups by Gattaca</a>
<ul>
<li><a href="https://docs.spire.dev/education-hub/based-rollups-overview">Analysis on Gattaca's Based Rollup Approach by Spire</a></li>
</ul>
</li>
</ul>
<h3 id="based-rollups-benefits"><a class="header" href="#based-rollups-benefits">Based rollups benefits</a></h3>
<ul>
<li><a href="https://ethresear.ch/t/based-preconfirmations/17353">Based Preconfirmations</a></li>
</ul>
<h3 id="based-rollups--extra-steps"><a class="header" href="#based-rollups--extra-steps">Based rollups + extra steps</a></h3>
<ul>
<li><a href="https://hackmd.io/@Perseverance/Syk2oQU36">Based Ticketing Rollup by George Spasov</a></li>
<li><a href="https://docs.taiko.xyz/taiko-alethia-protocol/protocol-design/contestable-rollup">Based Contestable Rollup by Taiko (Taiko Alethia)</a></li>
<li><a href="https://docs.taiko.xyz/taiko-gwyneth-protocol/what-is-taiko-gwyneth/">Native Based Rollup by Taiko (Taiko Gwyneth)</a></li>
</ul>
<h3 id="misc"><a class="header" href="#misc">Misc</a></h3>
<ul>
<li><a href="https://ethresear.ch/t/understanding-based-rollups-pga-challenges-total-anarchy-and-potential-solutions/21320">Why Total Anarchy Doesn't Pay the Bills</a></li>
<li><a href="https://hackmd.io/@EspressoSystems/BasedEspresso">Based Espresso: Based Sequencing for all L2s</a></li>
</ul>
<h3 id="execution-tickets"><a class="header" href="#execution-tickets">Execution tickets</a></h3>
<ul>
<li><a href="https://ethresear.ch/t/execution-tickets/17944">Execution Tickets</a></li>
<li><a href="https://ethresear.ch/t/execution-auctions-as-an-alternative-to-execution-tickets/19894">Execution Tickets vs Execution Auctions</a></li>
<li><a href="https://ethresear.ch/t/economic-analysis-of-execution-tickets/18894">Economic Analysis of Execution Tickets</a></li>
<li><a href="https://www.ephema.io/blog/beyond-the-stars-an-introduction-to-execution-tickets-on-ethereum">Beyond the Stars: An Introduction to Execution Tickets on Ethereum</a></li>
</ul>
<h3 id="current-based-rollups"><a class="header" href="#current-based-rollups">Current based rollups</a></h3>
<ul>
<li><a href="https://x.com/fede_intern/status/1846035499799978475">Rogue (LambdaClass)</a></li>
<li><a href="https://github.com/NethermindEth/surge">Surge (Nethermind)</a></li>
<li><a href="https://github.com/taikoxyz/taiko-mono">Taiko Alethia (Taiko Labs)</a>
<ul>
<li>Whitelisted preconfers:
<ul>
<li><a href="https://github.com/gattaca-com/taiko-gateway">Gattaca's</a></li>
<li><a href="https://github.com/chainbound/taiko-mk1">Chainbound's</a></li>
<li><a href="https://github.com/NethermindEth/Taiko-Preconf-AVS">Nethermind's</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="https://github.com/gattaca-com/based-op">Based OP (Gattaca + Lambdaclass)</a></li>
<li><a href="https://ethereumr1.org/">R1</a></li>
<li><a href="https://github.com/OpenZeppelin/minimal-rollup">Minimal Rollup (OpenZeppelin)</a></li>
</ul>
<h3 id="educational-sources"><a class="header" href="#educational-sources">Educational sources</a></h3>
<ul>
<li><a href="https://eth-fabric.github.io/website/education">FABRIC's list</a></li>
<li><a href="https://docs.spire.dev/education-hub/based-resources">Spire's list</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="transaction-fees"><a class="header" href="#transaction-fees">Transaction Fees</a></h1>
<p>This page describes the different types of transaction fees that the Ethrex L2 rollup can charge and how they can be configured.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Privileged transactions are exempt from all fees.</p>
</div>
<h2 id="priority-fee"><a class="header" href="#priority-fee">Priority Fee</a></h2>
<p>The priority fee works exactly the same way as on Ethereum L1.<br />
It is an additional tip paid by the transaction sender to incentivize the sequencer to prioritize the inclusion of their transaction.<br />
The priority fee is always forwarded directly to the sequencer’s coinbase address.</p>
<h2 id="base-fee"><a class="header" href="#base-fee">Base Fee</a></h2>
<p>The base fee follows the same rules as the Ethereum L1 base fee. It adjusts dynamically depending on network congestion to ensure stable transaction pricing.<br />
By default, base fees are burned. However, a sequencer can configure a <code>base fee vault</code> address to receive the collected base fees instead of burning them.</p>
<pre><code class="language-sh">ethrex l2 --block-producer.base-fee-vault-address &lt;l2-base-fee-vault-address&gt;
</code></pre>
<div class="mdbook-alerts mdbook-alerts-caution">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  caution
</p>
<p>If the base fee vault and coinbase addresses are the same, its balance will change in a way that differs from the standard L1 behavior, which may break assumptions about EVM compatibility.</p>
</div>
<h2 id="operator-fee"><a class="header" href="#operator-fee">Operator Fee</a></h2>
<p>The operator fee represents an additional per-gas cost charged by the sequencer to cover the operational costs of maintaining the L2 infrastructure.</p>
<p>This fee works similarly to the base fee — it is <strong>multiplied by the gas used</strong> for each transaction.<br />
All collected operator fees are deposited into a dedicated <code>operator fee vault</code> address.</p>
<p>To set the operator fee amount:</p>
<pre><code class="language-sh">ethrex l2 --block-producer.operator-fee-per-gas &lt;amount-in-wei&gt;
</code></pre>
<p>To set the operator fee vault address:</p>
<pre><code class="language-sh">ethrex l2 --block-producer.operator-fee-vault-address &lt;operator-fee-vault-address&gt;
</code></pre>
<div class="mdbook-alerts mdbook-alerts-caution">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  caution
</p>
<p>If the operator fee vault and coinbase addresses are the same, its balance will change in a way that differs from the standard L1 behavior, which may break assumptions about EVM compatibility.</p>
</div>
<hr />
<h2 id="fee-calculation"><a class="header" href="#fee-calculation">Fee Calculation</a></h2>
<p>When executing a transaction, all gas-related fees are subject to the <strong><code>max_fee_per_gas</code></strong> value defined in the transaction.<br />
This value acts as an absolute cap over the <strong>sum of all fee components</strong>.</p>
<p>This means that the <strong>effective priority fee</strong> is capped to ensure the total does not exceed <code>max_fee_per_gas</code>.<br />
Specifically:</p>
<pre><code>effective_priority_fee_per_gas = min(
    max_priority_fee_per_gas,
    max_fee_per_gas - base_fee_per_gas - operator_fee_per_gas
)
</code></pre>
<p>Then, the total fees are calculated as:</p>
<pre><code class="language-sh">total_fees = (base_fee_per_gas + operator_fee_per_gas + priority_fee_per_gas) * gas_used
</code></pre>
<p>This behavior ensures that transaction senders <strong>never pay more than <code>max_fee_per_gas * gas_used</code></strong>, even when the operator fee is enabled.</p>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>The current <code>effective_gas_price</code> field in the transaction receipt <strong>does not include</strong> the operator fee component.<br />
Therefore, <code>effective_gas_price * gas_used</code> will only reflect the <strong>base + priority</strong> portions of the total cost.</p>
</div>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>The <code>eth_gasPrice</code> RPC endpoint has been <strong>modified</strong> to include the <code>operator_fee_per_gas</code> value when the operator fee mechanism is active.<br />
This means that the value returned by <code>eth_gasPrice</code> corresponds to <code>base_fee_per_gas + operator_fee_per_gas + estimated_gas_tip</code>.</p>
</div>
<h2 id="l1-fees"><a class="header" href="#l1-fees">L1 Fees</a></h2>
<p>L1 fees represent the cost of posting data from the L2 to the L1.<br />
Each transaction is charged based on the amount of <strong>L1 Blob space</strong> it occupies (the size of the transaction when RLP-encoded).</p>
<p>Each time a transaction is executed, the sequencer calculates its RLP-encoded size.
Then, the L1 fee for that transaction is computed as:</p>
<pre><code>l1_fee = blob_base_fee_per_byte * tx_encoded_size
</code></pre>
<p>An additional amount of gas (<code>l1_gas</code>) is added to the transaction execution so that:</p>
<pre><code>l1_gas * gas_price = l1_fee
</code></pre>
<p>This guarantees that the total amount charged to the user never exceeds <code>gas_limit * gas_price</code>, while transparently accounting for the L1 posting cost.<br />
Importantly, this process happens automatically — users do <strong>not</strong> need to perform any additional steps.<br />
Calls to <code>eth_estimateGas</code> already inherit this behavior and will include the extra gas required for the L1 fee.</p>
<p>The computed L1 fee is deducted from the sender’s balance and transferred to the <code>L1 Fee Vault</code> address.</p>
<p>The <strong>blob base fee per byte</strong> is derived from the L1 <code>BlobBaseFee</code>.<br />
The <code>L1Watcher</code> periodically fetches the <code>BlobBaseFee</code> from L1 (at a configured interval) and uses it to compute:</p>
<pre><code>blob_base_fee_per_byte = (l1_fee_per_blob_gas * GAS_PER_BLOB) / SAFE_BYTES_PER_BLOB
</code></pre>
<p>See the <code>Data availability</code> section <a href="l2/fundamentals/../architecture/overview.html">here</a> for more information about how data availability works.</p>
<p>L1 fee is deactivated by default. To activate it, configure the <strong>L1 fee vault address</strong>:</p>
<pre><code class="language-sh">ethrex l2 --block-producer.l1-fee-vault-address &lt;l1-fee-vault-address&gt;
</code></pre>
<p>To configure the <strong>interval</strong> at which the <code>BlobBaseFee</code> is fetched from L1:</p>
<pre><code class="language-sh">ethrex l2 --block-producer.blob-base-fee-update-interval &lt;milliseconds&gt;
</code></pre>
<div class="mdbook-alerts mdbook-alerts-caution">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  caution
</p>
<p>If the L1 fee vault and coinbase addresses are the same, its balance will change in a way that differs from the standard L1 behavior, which may break assumptions about EVM compatibility.</p>
</div>
<h2 id="useful-rpc-methods"><a class="header" href="#useful-rpc-methods">Useful RPC Methods</a></h2>
<p>The following custom RPC methods are available to query fee-related parameters directly from the L2 node.<br />
Each method accepts a single argument: the <strong><code>block_number</code></strong> to query historical or current values.</p>
<div class="table-wrapper"><table><thead><tr><th>Method Name</th><th>Description</th><th>Example</th></tr></thead><tbody>
<tr><td><code>ethrex_getBaseFeeVaultAddress</code></td><td>Returns the address configured to receive the <strong>base fees</strong> collected in the specified block.</td><td><code>ethrex_getBaseFeeVaultAddress {"block_number": 12345}</code></td></tr>
<tr><td><code>ethrex_getOperatorFeeVaultAddress</code></td><td>Returns the address configured as the <strong>operator fee vault</strong> in the specified block.</td><td><code>ethrex_getOperatorFeeVaultAddress {"block_number": 12345}</code></td></tr>
<tr><td><code>ethrex_getOperatorFee</code></td><td>Returns the <strong>operator fee per gas</strong> value active at the specified block.</td><td><code>ethrex_getOperatorFee {"block_number": 12345}</code></td></tr>
<tr><td><code>ethrex_getL1BlobBaseFee</code></td><td>Returns the <strong>L1 blob base fee per gas</strong> fetched from L1 and used for L1 fee computation at the specified block.</td><td><code>ethrex_getL1BlobBaseFee {"block_number": 12345}</code></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="exit-window"><a class="header" href="#exit-window">Exit Window</a></h1>
<p>An exit window is a time window, or period, during which users can opt to exit the network before the execution of an upgrade or system modification. The purpose of exit windows in L2 rollups is to protect users from unwanted changes to the system, such as those mentioned above.</p>
<p>The <a href="https://forum.l2beat.com/t/the-stages-framework/291">Stages Framework</a> defines exit windows for rollup upgrades with subtle differences between stages. For Stage 1 rollups, updates initiated outside the Security Council require an exit window of at least 7 days, though the Security Council can upgrade instantly. For Stage 2 rollups, the Security Council can upgrade immediately only if a bug is detected on-chain; otherwise, the exit window should be at least 30 days. This period may vary if there is a withdrawal delay, as it is subtracted from the total exit window.</p>
<p>The ethrex L2 stack provides this security functionality through a <code>Timelock</code> contract that is deployed and configured with the exit window duration, which we will learn more about in the next section.</p>
<h2 id="how-exit-windows-work"><a class="header" href="#how-exit-windows-work">How exit windows work</a></h2>
<p>Before understanding how exit windows work, it is necessary to keep in mind which specific functionality of the L1 contracts we need to protect. For this, we recommend reading in advance about the <code>OnChainProposer</code> and <code>CommonBridge</code> contracts in the <a href="l2/fundamentals/./contracts.html">contracts fundamentals section</a>. To make it simpler, we will initially focus only on the upgrade logic, as the same logic applies to the rest of the modifications.</p>
<p>All our contracts are <a href="https://docs.openzeppelin.com/contracts/5.x/api/proxy#UUPSUpgradeable"><code>UUPSUpgradeable</code></a> (an upgradeability pattern recommended by OpenZeppelin). In particular, to upgrade this type of contract, the operator must call the <code>upgradeToAndCall</code> function, which invokes an internal function called <code>_authorizeUpgrade</code>. It is recommended to override this function by implementing authorization logic. This is the function we must protect in the case of both contracts, and we do so by “delaying” its execution.</p>
<p>Currently, the function used to upgrade the contracts is protected by an <code>onlyOwner</code> modifier, which verifies that the caller corresponds to the owner of the contract (all L1 contracts but the <code>Timelock</code> are <a href="https://docs.openzeppelin.com/contracts/5.x/api/access#ownable2step"><code>Ownable2StepUpgradeable</code></a>), configured during its initialization. In other words, only the owner can call it. Keeping this in mind is important for understanding how we implement the functionality.</p>
<p>As mentioned earlier, exit windows must prevent the instantaneous execution of upgrades and modifications to the system (from now on, operations). This is achieved through the aforementioned <code>Timelock</code> contract, which introduces a notion of “delay” to the execution of operations.</p>
<p>To accomplish this, the <code>Timelock</code> contract divides the execution of operations into two steps:</p>
<ol>
<li>A first step where the operation is scheduled.</li>
<li>A second step that finally executes the previously scheduled operation.</li>
</ol>
<p>In the scheduling step, the information corresponding to the operation (calldata, target address, value, etc.) is stored in the contract’s storage along with the timestamp from which the operation can be executed (essentially the current timestamp at the time of scheduling plus the delay configured during the contract’s initialization). The caller is also granted an operation ID.</p>
<p>It is in the second and final step where the previously scheduled operation is executed. This occurs if and only if the waiting time has been met (i.e., the timestamp at the time of executing the operation is greater than or equal to the operation’s timestamp stored in the contract’s storage). It is worth noting that any attempt to execute prior to the fulfillment of the waiting time will revert. The contract offers additional functionality to check the status of operations and thus avoid reverting execution attempts.</p>
<p>We achieve an exit window by configuring the <code>Timelock</code> contract as the owner of the L1 contracts. In this way, it is the only one capable of executing upgrades on the L1 contracts, and it will do so through the scheduling and execution of operations, which provide the desired delay. With this, it is sufficient to add the onlyOwner modifier to the functions we want to execute with a certain delay.</p>
<h2 id="settlement-window"><a class="header" href="#settlement-window">Settlement window</a></h2>
<p>Also known as “withdrawal delay”, the settlement window is the batch verification delay that needs to be fulfilled for the sequencer to be able to verify a committed batch, even if the proof is already available for verification.</p>
<p>The goal of the settlement window is to give enough time to the rollup operator to react in the event of a bug exploit in the L2 before the state is settled on the L1 and, thus, irreversible.</p>
<p>As said before, the settlement window must be taken into account to calculate the real exit window.</p>
<h2 id="who-owns-the-timelock"><a class="header" href="#who-owns-the-timelock">Who owns the <code>Timelock</code></a></h2>
<p>There's no such thing as an unique owner of the <code>Timelock</code> necessarily. <code>Timelock</code> is a <code>TimelockController</code>, which is also an <code>AccessControl</code>, so we can define different roles and assign them to different entities. By "owner" of the <code>Timelock</code>, we refer to the account that has the role to update the contract (i.e. the one that can modify the delay).</p>
<p>That said, whoever owns the <code>Timelock</code> decides its functioning. In our stack, the owner of the contract is established during its initialization, and then that owner can transfer the ownership to another account if desired.</p>
<p>It's worth noting that the designated security council can execute operations instantly in case of emergencies, so it's crucial that the members are trustworthy and committed to the network's security. The <a href="https://forum.l2beat.com/t/the-stages-framework/291">Stages Framework</a> recommends that the security council be in the form of a multisig composed of at least 8 people with a consensus threshold of 75%, and the participants in the set need to be decentralized and diverse enough, possibly coming from different companies and jurisdictions.</p>
<p>In the case of our <code>Timelock</code>, the owner is not the only one who can act on it. In fact, it is recommended that the security council only act in specific emergencies. The <code>Timelock</code> is also <code>AccessControl</code>, which means it has special functionality for managing accesses, in this case, in the form of roles.</p>
<p><code>TimelockController</code> defines two roles in its business logic: the “proposer” and the “executor.” The first is enabled to schedule operations and cancel them, while the second is enabled to execute them. These roles are assigned to a given set of addresses during the contract’s initialization.</p>
<p>We define two additional roles besides the defaults: the “sequencer” and the “security council.” The first is confined to performing settlement operations (meaning it cannot operate as “proposer” or “executor”), while the second is enabled to revert batches, pause and unpause contracts, and execute emergency operations (i.e., without delay).</p>
<h2 id="how-are-timelock-upgrades-protected"><a class="header" href="#how-are-timelock-upgrades-protected">How are <code>Timelock</code> upgrades protected</a></h2>
<p>Today, we only expose two types of modifications to our <code>Timelock</code> contract:</p>
<ol>
<li>Upgrade of the contract itself.</li>
<li>Update of the delay time.</li>
</ol>
<p>An interesting question is how we protect users from instantaneous executions of these types of operations. One might think of a scenario where the <code>Timelock</code> owner updates the delay to 0 to execute a malicious operation, having removed the exit window for users; or perhaps upgrade the <code>Timelock</code> contract by removing the delay logic with the same objective.</p>
<p>We solve this by making the <code>Timelock</code> itself the only one capable of invoking the corresponding functions for those operations. In this way, if the contract owner wants to push a malicious upgrade or modification to the “protector” contract, they must comply with the configured delay at the time of proposing the operation. For example, if a malicious or compromised owner wishes to set the delay to 0, they must wait the duration of the current exit window for the execution of their malicious operation, thus giving users sufficient time to exit the network.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="timelock-contract"><a class="header" href="#timelock-contract">Timelock Contract</a></h1>
<p>The Timelock contract gates access to the OnChainProposer (OCP) contract. Changes to the OCP can only be made by first interacting with the Timelock, which manages permissions based on roles assigned to different users.</p>
<h2 id="timelock-roles"><a class="header" href="#timelock-roles">Timelock Roles</a></h2>
<ul>
<li>Sequencers: Can commit and verify batches.</li>
<li>Governance: Can schedule and execute operations, respecting a delay. In practice this could be the role of a DAO, though it depends on the implementation.</li>
<li>Security Council: Can bypass the minimum delay for executing any operation that the Timelock can execute. It can also manage other roles in the Timelock.</li>
</ul>
<p><strong>Sequencers</strong> will send <code>commitBatch</code>, <code>verifyBatch</code>, and <code>verifyBatchesAligned</code> to the Timelock, and this will execute the operations in the <code>OnChainProposer</code>. Eventually there will be Timelock logic, and there will be a time window between commitment and proof verification for security reasons.</p>
<p>The <strong>Governance</strong> is able to schedule important operations like contract upgrades respecting the minimum time window for the L2 participants to exit in case of undesired updates. Not only can they make changes in the logic of the OnChainProposer, but they can also update the Timelock itself.</p>
<p>The <strong>Security Council</strong> is designed as a powerful entity that can execute anything within the Timelock or OnChainProposer without delay. We call it security council because its actions are limitless, as it can upgrade any of the contracts whenever it wants, so ideally it should be a multisig composed of many diverse members, and it should be able to take action only if 75% of members agree. Ideally, in a more mature rollup the Security Council would have fewer permissions and would only need to act upon bugs detected on-chain if such a mechanism exists.
We call this mechanism of executing without delay the <code>emergencyExecute</code>.</p>
<h2 id="basic-functionalities"><a class="header" href="#basic-functionalities">Basic Functionalities</a></h2>
<p>These are the things that we can do with the Timelock:</p>
<ul>
<li>Schedule: <code>schedule(...)</code> and <code>scheduleBatch(...)</code></li>
<li>Execute: <code>execute(...)</code> and <code>executeBatch(...)</code></li>
<li>Cancel: <code>cancel(bytes32 id)</code></li>
<li>Update Delay: <code>updateDelay(uint256 newDelay)</code></li>
</ul>
<p>When an operation is <strong>scheduled</strong>, the Governance role may <strong>cancel</strong> it or, after the established delay, <strong>execute</strong> it.
The delay can be updated, always respecting the current delay to do so.</p>
<p>It also has a few utility functions:</p>
<ul>
<li><code>getMinDelay()</code>: current minimum delay for new schedules.</li>
<li><code>hashOperation(...)</code>, <code>hashOperationBatch(...)</code>: pure helpers to compute ids.</li>
<li><code>getTimestamp(id)</code>, <code>getOperationState(id)</code>, <code>isOperation*</code>: query operation status.</li>
</ul>
<p>Remember that <code>Timelock</code> inherits from <code>TimelockControllerUpgradeable</code> (which itself extends <code>AccessControlUpgradeable</code>) and <code>UUPSUpgradeable</code>, so it will inherit their behavior as well.</p>
<h2 id="important-remarks"><a class="header" href="#important-remarks">Important Remarks</a></h2>
<h3 id="operation-id-collision"><a class="header" href="#operation-id-collision">Operation ID collision</a></h3>
<p>Every scheduled operation is identified by a 32-byte <strong>operation id</strong>. This ID is determined by hashing fields like the target address, value transferred, data, predecessor, and salt.
Two operations with the same fields will result in the same ID. That's why, if we want to schedule the same operation more than once, we should probably use a salt.
Example: If for some reason we want to schedule the pause of the OnChainProposer and we use salt zero, the next time we schedule that same operation we'll have to change the salt (assuming no predecessor was specified) in order for the id to be different.</p>
<h3 id="cancelling-a-scheduled-operation"><a class="header" href="#cancelling-a-scheduled-operation">Cancelling a scheduled operation</a></h3>
<p><code>cancel(bytes32 id)</code> requires the operation id. You typically get it by:</p>
<ol>
<li>Reading it from the <code>CallScheduled(id, ...)</code> event emitted by <code>schedule</code>/<code>scheduleBatch</code>, or</li>
<li>Computing it yourself (off-chain), or</li>
<li>Calling <code>hashOperation(...)</code> / <code>hashOperationBatch(...)</code> on-chain to compute it.</li>
</ol>
<p>Note that:</p>
<ul>
<li><code>hashOperation(...) = keccak256(abi.encode(target, value, data, predecessor, salt))</code></li>
<li><code>hashOperationBatch(...) = keccak256(abi.encode(targets, values, payloads, predecessor, salt))</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="fee-token-overview"><a class="header" href="#fee-token-overview">Fee Token Overview</a></h1>
<p>Ethrex lets L2 transactions pay execution costs with an ERC-20 instead of ETH. A fee-token-enabled transaction behaves like a normal call or transfer, but the sequencer locks fees in the ERC-20 and distributes them (sender refund, coinbase priority fee, base-fee vault, operator vault, L1 data fee) using the hooks in <code>l2_hook.rs</code>.</p>
<p>Key requirements:</p>
<ul>
<li>The token must implement <code>IFeeToken</code> (see <code>crates/l2/contracts/src/example/FeeToken.sol</code>), which extends <code>IERC20L2</code> and adds the <code>lockFee</code> / <code>payFee</code> entry points consumed by the sequencer.</li>
<li><code>lockFee</code> must reserve funds when invoked by the l2 bridge (the L2 bridge/<code>COMMON_BRIDGE_L2_ADDRESS</code>), and <code>payFee</code> must release or burn those funds when the transaction finishes.</li>
<li>The token address must be registered in the L2 <code>FeeTokenRegistry</code> system contract (<code>0x…fffc</code>). Registration happens through the L1 <code>CommonBridge</code> by calling <code>registerNewFeeToken(address)</code>; only the bridge owner can do this, and the call queues a privileged transaction that the sequencer forces on L2. Likewise, <code>unregisterFeeToken(address)</code> removes it.</li>
</ul>
<p>Fee token ratios are also updated through the same privileged transaction path (deposits from L1 to L2). This is because we want the changes to be done through the L1, and via an owner that we want to be the same as the owner in the L1 bridge.</p>
<h3 id="minimal-contract-surface"><a class="header" href="#minimal-contract-surface">Minimal Contract Surface</a></h3>
<pre><code class="language-solidity">contract FeeToken is ERC20, IFeeToken {
    address internal constant BRIDGE = 0x000000000000000000000000000000000000FFFF;

    ...

    modifier onlyBridge() {
        require(msg.sender == BRIDGE, "only bridge");
        _;
    }
    function lockFee(address payer, uint256 amount)
        external
        override(IFeeToken)
        onlyBridge
    {
        _transfer(payer, BRIDGE, amount);
    }

    function payFee(address receiver, uint256 amount)
        external
        override(IFeeToken)
        onlyBridge
    {
        if (receiver == address(0)) {
            _burn(BRIDGE, amount);
        } else {
            _transfer(BRIDGE, receiver, amount);
        }
    }
}
</code></pre>
<p>For deployment and operator steps, see <a href="l2/fundamentals/../deployment/fee_token.html">Deploying a Fee Token</a>.</p>
<h2 id="user-workflow"><a class="header" href="#user-workflow">User Workflow</a></h2>
<p>Once a token is registered, users can submit fee-token transactions:</p>
<ol>
<li>Instantiate an <code>EthClient</code> connected to L2 and create a signer.</li>
<li>Build a <code>TxType::FeeToken</code> transaction with <code>build_generic_tx</code>, setting <code>Overrides::fee_token = Some(&lt;token&gt;)</code> and the desired <code>value</code> / calldata.</li>
<li>Send the transaction with <code>send_generic_transaction</code> and wait for the receipt.</li>
</ol>
<p>Fee locking and distribution happen automatically inside <code>l2_hook.rs</code>.</p>
<h3 id="minimal-cargotoml"><a class="header" href="#minimal-cargotoml">Minimal <code>Cargo.toml</code></a></h3>
<pre><code class="language-toml">[package]
name = "fee-token-client"
version = "0.1.0"
edition = "2024"

[dependencies]
anyhow = "1.0.86"
hex = "0.4.3"
secp256k1 = { version = "0.30.0", default-features = false, features = ["global-context", "recovery", "rand"] }
tokio = { version = "1.41.1", features = ["macros", "rt-multi-thread"] }
url = { version = "2.5.4", features = ["serde"] }
ethrex_l2_sdk = { package = "ethrex-sdk", git = "https://github.com/lambdaclass/ethrex", tag = "v6.0.0" }
ethrex-rpc = { git = "https://github.com/lambdaclass/ethrex", tag = "v6.0.0" }
ethrex-common = { git = "https://github.com/lambdaclass/ethrex", tag = "v6.0.0" }
ethrex-l2-rpc = { git = "https://github.com/lambdaclass/ethrex", tag = "v6.0.0" }
</code></pre>
<pre><pre class="playground"><code class="language-rust edition2024">use anyhow::Result;
use ethrex_l2_sdk::{build_generic_tx, send_generic_transaction};
use ethrex_rpc::clients::eth::{EthClient, Overrides};
use ethrex_common::types::TxType;
use ethrex_common::{Address, Bytes, U256};
use ethrex_l2_sdk::wait_for_transaction_receipt;
use ethrex_l2_rpc::signer::{LocalSigner, Signer};
use secp256k1::SecretKey;
use url::Url;

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    // 1. Connect and create the signer.
    let l2 = EthClient::new(Url::parse("http://localhost:1729")?)?;
    let private_key = SecretKey::from_slice(&amp;hex::decode("&lt;hex-private-key&gt;")?)?;
    let signer = Signer::Local(LocalSigner::new(private_key));

    // 2. Build the fee-token transaction.
    let fee_token: Address = "&lt;fee-token-address&gt;".parse()?;
    let recipient: Address = "&lt;recipient-address&gt;".parse()?;
    let mut tx = build_generic_tx(
        &amp;l2,
        TxType::FeeToken,
        recipient,
        signer.address(),
        Bytes::default(),
        Overrides {
            fee_token: Some(fee_token),
            value: Some(U256::from(100_000u64)),
            ..Default::default()
        },
    )
    .await?;

    // 3. Send and wait for the receipt.
    let tx_hash = send_generic_transaction(&amp;l2, tx, &amp;signer).await?;
    wait_for_transaction_receipt(tx_hash, &amp;l2, 100).await?;
    Ok(())
}</code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="shared-bridge"><a class="header" href="#shared-bridge">Shared Bridge</a></h1>
<h2 id="introduction-3"><a class="header" href="#introduction-3">Introduction</a></h2>
<p>If a user wants to transfer funds from L2-A to an account on L2-B, the conventional process involves several steps: withdrawing assets from L2-A to Ethereum, claiming the unlocked funds on Ethereum, and then depositing those assets from Ethereum to L2-B. These multiple steps degrade the UX, and two of them require transactions on Ethereum, which are often expensive. This inefficiency arises because there is currently no direct communication channel between different L2s, forcing all interactions to route through their common hub: Ethereum.</p>
<p>The Shared Bridge feature changes this by enabling seamless message passing between L2s. As a result, a user can achieve the same transfer by interacting only with the source chain (L2-A), with the outcome eventually reflecting on the destination chain (L2-B).</p>
<p>While the user performs just one interaction and waits for the result, a similar process to the conventional flow occurs behind the scenes. In the following sections, we'll explore how it works.</p>
<h2 id="high-level-overview"><a class="header" href="#high-level-overview">High-Level Overview</a></h2>
<p>To understand the behind-the-scenes mechanics, we'll revisit the earlier example. For a quick recap, here's a high-level breakdown of what happens when Alice (on L2-A) wants to send ETH to Bob (on L2-B):</p>
<p><img src="l2/fundamentals/../img/shared_bridge.png" alt="Diagram illustrating the cross-L2 transfer flow from L2-A to L2-B" /></p>
<ul>
<li><strong>Source L2 (L2-A, Alice's side):</strong> Alice invokes the <code>sendToL2</code> function on the <code>CommonBridgeL2</code> contract, specifying the destination chain ID (L2-B), Bob's address on L2-B, the ETH amount to send, the gas limit she is willing to consume for the final transaction on L2-B (this gas is burned on L2-A), and optionally the calldata for any custom transaction to execute on L2-B.</li>
<li><strong>Source L2 Sequencer (L2-A):</strong> Alice's transaction is included in a block on L2-A. Eventually, a batch containing that block is sealed, and a commitment is submitted to L1 (Ethereum). This commitment includes, among other things, the list of balances to transfer to destination L2s, as well as the hashes of all messages addressed to those L2s.</li>
<li><strong>Source L2 Prover (L2-A):</strong> A zero-knowledge (ZK) proof is generated to validate the commitment for the batch containing Alice's message to Bob.</li>
<li><strong>Source L2 Sequencer (L2-A):</strong> Once the prover delivers the ZK proof, it is submitted to L1 for verification. If the proof is valid, the commitment is marked as verified, the message is considered settled, the funds are transferred between bridges via the Router contract on L1, and the list of transaction hashes is stored in the respective target bridges.</li>
<li><strong>Destination L2 Sequencer (L2-B):</strong> A dedicated process periodically polls a permissioned set of sequencers from other L2s to check for newly emitted messages. It receives Alice's message to Bob preemptively (i.e., possibly before the message is fully settled on L1). Upon receipt, it verifies the message's validity by checking whether the message hash is already present in its own bridge. If the message hash is not yet present (the batch has not been verified on L1), the message is discarded and retried in the next iteration. If the message validates, it is processed, and the transferred ETH is minted to Bob's address on L2-B.<br />
Eventually, the sequencer commits and verifies a batch containing the received and processed messages in the OnChainProposer, clearing their hashes from the pending message hash list in the CommonBridge contract.</li>
</ul>
<h2 id="protocol-details-1"><a class="header" href="#protocol-details-1">Protocol Details</a></h2>
<h3 id="cross-chain-messaging"><a class="header" href="#cross-chain-messaging">Cross-chain Messaging</a></h3>
<p>A cross-chain message directed from a source L2 to a destination L2 is essentially an event emitted by the CommonBridgeL2 contract within a block on the source L2. These events are triggered upon successful invocations of the sendToL2 function in the CommonBridgeL2.</p>
<p>During batch preparation on the source L2, cross-chain messages are collected. For each target L2, a list of message hashes is constructed, and the balance diffs generated by the messages are calculated. These values are included in the batch commitment submitted to L1 by the <code>L1Committer</code>.</p>
<p>Once the <code>L1Committer</code> prepares the inputs for the prover, the prover requests them and initiates generation of the ZK proof for the specific batch. As part of this process, the prover recomputes hashes of the cross-chain messages and the balance diffs, returning them to be used as public values during on-chain verification. Upon completing proof generation, the prover sends it back to the sequencer—specifically, to the <code>ProofCoordinator</code>.</p>
<p>After the prover delivers the ZK proof validating the batch prepared by the <code>L1Committer</code>, the <code>L1Sender</code> submits it along with the public values for on-chain verification. On-chain, before verifying the proof itself, the submitted public values are compared against the previously committed ones, confirming that the hashes of cross-chain messages and the balance diffs match. If verification succeeds, the involved cross-chain messages are deemed settled, and the state is transferred from the source bridge to the corresponding destination bridges.</p>
<p>To execute a cross-chain message on the destination L2, the message(s) must first be settled on L1. Additionally, the <code>Watcher</code> on the destination L2 must obtain them in advance via internal communication among permissioned sequencers.
While the source L2's batch is being prepared and verified, the destination L2 has already preemptively acquired its corresponding messages. This is feasible because L2s with the Shared Bridge feature enabled are aware of the other sequencers participating in the same Shared Bridge ecosystem. The Watcher—a sequencer component originally designed to handle L1-incoming privileged transactions—periodically scans for relevant correspondence across the permissioned set of L2s. Upon receiving potential matches, the L2 queries its <code>CommonBridge</code> contract on L1 to validate the message (i.e., confirm it has been settled) before processing it. If the message is not yet validated, it is discarded and retried in the next polling iteration.</p>
<h3 id="replay-attack"><a class="header" href="#replay-attack">Replay Attack</a></h3>
<p>Once a cross-chain message is settled on L1, the destination L2's sequencer processes it. To do so, it constructs a privileged transaction from the message's payload and adds it to the mempool only if the hash of this constructed transaction does not match the hash of any previously executed transaction. Hash collisions are prevented, among other measures, by incorporating the source L2's chain ID and the message's nonce (as recorded on the source L2). Each L2 maintains a mapping in its corresponding <code>CommonBridgeL2</code> contract, using the destination chain ID as the key and the message nonce as the value.</p>
<h3 id="state-availability"><a class="header" href="#state-availability">State Availability</a></h3>
<p>Cross-chain messages are forcibly included in recipient chains (see <a href="l2/fundamentals/shared_bridge.html#forced-inclusion">Forced Inclusion</a>). In adverse scenarios—such as a sequencer shutdown, loss of communication with the source L2, or the destination L2's inability to retrieve messages directly—a security mechanism must enable recovery of these messages from L1. This fallback is not yet implemented. However, the necessary data is already available on L1 to support this functionality since the state of the L2 lives in the blobs, so it'd be available as long as the blob containing the L2's data is available.</p>
<h3 id="proving"><a class="header" href="#proving">Proving</a></h3>
<p>Batch proving encompasses several tasks, including recomputing cross-chain messages hashes within the batch and the associated balance diffs. These values are returned as part of the guest program execution output and serve as public inputs for on-chain proof verification.</p>
<h3 id="source-l2-not-available"><a class="header" href="#source-l2-not-available">Source L2 not available</a></h3>
<p>In situations where the destination L2 is unable to retrieve the relevant messages directly, because the source l2 is not available, we need a mechanism to still be able to retrieve them.
What should be done is</p>
<ul>
<li>The destination L2 should periodically scan the L1 and store the blobs sent on the commitBatch call of the source L2.</li>
<li>Run the state reconstruct command</li>
<li>Initialize a sequencer with the reconstructed state</li>
<li>Use that sequencer as the source for getting the messages</li>
</ul>
<p>Keep in mind that since you are not the owner of that source L2, the chain will not advance, but you will still be able to get all pending messages to execute, as long as they were previously verified.</p>
<h3 id="forced-inclusion-1"><a class="header" href="#forced-inclusion-1">Forced Inclusion</a></h3>
<p>Once a cross-chain message is settled, each target <code>commonBridge</code> receives, along with the resulting ETH value, a list of all message hashes with their associated timestamps. When a batch is verified, the prover outputs the rolling hash of the received messages processed in the batch, and the included message hashes are removed from the bridge after verification.
A message is considered expired if a certain deadline is reached and it has not yet been included in a batch on the destination chain. The <code>commonBridge</code> then prevents the sequencer from committing batches that contain non-privileged transactions (deposits and received messages) until all expired messages are included.</p>
<h3 id="rollbacks"><a class="header" href="#rollbacks">Rollbacks</a></h3>
<p>Once a cross-chain message is settled, there is no rollback mechanism in scenarios where the destination L2 either cannot or chooses not to execute the transaction. <a href="l2/fundamentals/shared_bridge.html#forced-inclusion">Forced Inclusion</a> guarantees that the destination sequencer will eventually have to execute the received message in order to include non-privileged transactions in a batch. Therefore, once a message is settled, the user waits for the destination L2 to include the message, just as when the user performs a deposit to that L2.</p>
<h2 id="recommendations-1"><a class="header" href="#recommendations-1">Recommendations</a></h2>
<p>We advice not to register more than 100 chains, since this will enquire a high cost when verifying a batch (About 1.6M gas), due to the transfers between bridges.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ethrex-l2-integration-with-aligned-layer"><a class="header" href="#ethrex-l2-integration-with-aligned-layer">Ethrex L2 Integration with Aligned Layer</a></h1>
<p>This document provides a comprehensive technical overview of how ethrex L2 integrates with Aligned Layer for proof aggregation and verification.</p>
<h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h2>
<ol>
<li><a href="l2/fundamentals/ethrex_l2_aligned_integration.html#overview">Overview</a></li>
<li><a href="l2/fundamentals/ethrex_l2_aligned_integration.html#what-is-aligned-layer">What is Aligned Layer?</a></li>
<li><a href="l2/fundamentals/ethrex_l2_aligned_integration.html#architecture">Architecture</a></li>
<li><a href="l2/fundamentals/ethrex_l2_aligned_integration.html#component-details">Component Details</a></li>
<li><a href="l2/fundamentals/ethrex_l2_aligned_integration.html#smart-contract-integration">Smart Contract Integration</a></li>
<li><a href="l2/fundamentals/ethrex_l2_aligned_integration.html#configuration">Configuration</a></li>
<li><a href="l2/fundamentals/ethrex_l2_aligned_integration.html#behavioral-differences">Behavioral Differences</a></li>
<li><a href="l2/fundamentals/ethrex_l2_aligned_integration.html#error-handling">Error Handling</a></li>
<li><a href="l2/fundamentals/ethrex_l2_aligned_integration.html#monitoring">Monitoring</a></li>
</ol>
<hr />
<h2 id="overview-2"><a class="header" href="#overview-2">Overview</a></h2>
<p>Ethrex L2 supports two modes of proof verification:</p>
<ol>
<li><strong>Standard Mode</strong>: Proofs are verified directly on L1 via smart contract verifiers (SP1Verifier, RISC0Verifier, TDXVerifier)</li>
<li><strong>Aligned Mode</strong>: Proofs are sent to Aligned Layer for aggregation, then verified on L1 via the <code>AlignedProofAggregatorService</code> contract</li>
</ol>
<p>Aligned mode offers significant cost savings by aggregating multiple proofs before on-chain verification, reducing the gas cost per proof verification.</p>
<h3 id="key-benefits-of-aligned-mode"><a class="header" href="#key-benefits-of-aligned-mode">Key Benefits of Aligned Mode</a></h3>
<ul>
<li><strong>Lower verification costs</strong>: Proof aggregation amortizes verification costs across multiple proofs</li>
<li><strong>Multi-batch verification</strong>: Multiple L2 batches can be verified in a single L1 transaction (via <code>verifyBatchesAligned()</code>)</li>
<li><strong>Compressed proofs</strong>: Uses STARK compressed format instead of Groth16, optimized for aggregation</li>
</ul>
<hr />
<h2 id="what-is-aligned-layer"><a class="header" href="#what-is-aligned-layer">What is Aligned Layer?</a></h2>
<p><a href="https://docs.alignedlayer.com/">Aligned Layer</a> is a proof aggregation and verification infrastructure for Ethereum. It provides:</p>
<ul>
<li><strong>Proof Aggregation Service</strong>: Collects proofs from multiple sources and aggregates them</li>
<li><strong>Batcher</strong>: Receives individual proofs and batches them for aggregation</li>
<li><strong>On-chain Verification</strong>: Verifies aggregated proofs via the <code>AlignedProofAggregatorService</code> contract</li>
<li><strong>SDK</strong>: Client libraries for submitting proofs and checking verification status</li>
</ul>
<h3 id="supported-proving-systems"><a class="header" href="#supported-proving-systems">Supported Proving Systems</a></h3>
<p>Ethrex L2 supports the following proving systems with Aligned:</p>
<div class="table-wrapper"><table><thead><tr><th>Prover Type</th><th>Aligned ProvingSystemId</th><th>Notes</th></tr></thead><tbody>
<tr><td>SP1</td><td><code>ProvingSystemId::SP1</code></td><td>Compressed STARK format</td></tr>
<tr><td>RISC0</td><td><code>ProvingSystemId::Risc0</code></td><td>Compressed STARK format</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="architecture-1"><a class="header" href="#architecture-1">Architecture</a></h2>
<h3 id="high-level-system-flow"><a class="header" href="#high-level-system-flow">High-Level System Flow</a></h3>
<pre><code>┌──────────────────┐
│      Prover      │ (Separate binary)
│    (SP1/RISC0)   │
└────────┬─────────┘
         │ TCP
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              ETHREX L2 NODE                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐       │
│  │ ProofCoordinator │───▶│  L1ProofSender   │───▶│  Aligned Batcher │       │
│  │   (TCP Server)   │    │                  │    │   (WebSocket)    │       │
│  └────────┬─────────┘    └────────┬─────────┘    └────────┬─────────┘       │
│           │                       │                       │                 │
│           ▼                       ▼                       │                 │
│  ┌─────────────────────────────────────┐                  │                 │
│  │          RollupStorage              │                  │                 │
│  │     (Proofs, Batch State)           │                  │                 │
│  └─────────────────────────────────────┘                  │                 │
│                                                           │                 │
└───────────────────────────────────────────────────────────┼─────────────────┘
                                                            │
                                                            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ALIGNED LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐       │
│  │  Proof Batcher   │───▶│ Proof Aggregator │───▶│  L1 Settlement   │       │
│  │                  │    │   (SP1/RISC0)    │    │                  │       │
│  └──────────────────┘    └──────────────────┘    └──────────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
                                                            │
                                                            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              ETHEREUM L1                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────┐    ┌──────────────────────────────┐    │
│  │      OnChainProposer            │───▶│ AlignedProofAggregatorService│    │
│  │  (verifyBatchesAligned())       │    │   (Merkle proof validation)  │    │
│  └─────────────────────────────────┘    └──────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>The Prover runs as a separate binary outside the L2 node, connecting via TCP to the ProofCoordinator. For deployment instructions, see <a href="l2/fundamentals/../deployment/aligned.html">Running Ethrex in Aligned Mode</a>.</p>
</div>
<h3 id="component-interactions"><a class="header" href="#component-interactions">Component Interactions</a></h3>
<h4 id="proof-sender-flow-aligned-mode"><a class="header" href="#proof-sender-flow-aligned-mode">Proof Sender Flow (Aligned Mode)</a></h4>
<p><img src="l2/fundamentals/../img/aligned_mode_proof_sender.png" alt="Proof Sender Aligned Mode" /></p>
<p>The proof sender tracks the last sent proof in the rollup storage and submits compressed proofs to the Aligned Batcher.</p>
<h4 id="proof-verifier-flow-aligned-mode"><a class="header" href="#proof-verifier-flow-aligned-mode">Proof Verifier Flow (Aligned Mode)</a></h4>
<p><img src="l2/fundamentals/../img/aligned_mode_proof_verifier.png" alt="Proof Verifier Aligned Mode" /></p>
<p>The proof verifier:</p>
<ol>
<li>Queries <code>lastVerifiedBatch</code> from <code>OnChainProposer</code></li>
<li>Checks proof aggregation status via <code>AlignedProofAggregatorService</code></li>
<li>Calls <code>verifyBatchesAligned()</code> on <code>OnChainProposer</code></li>
<li>Which internally calls <code>verifyProofInclusion()</code> on the aggregator service</li>
</ol>
<hr />
<h2 id="component-details"><a class="header" href="#component-details">Component Details</a></h2>
<h3 id="1-l1proofsender-l1_proof_senderrs"><a class="header" href="#1-l1proofsender-l1_proof_senderrs">1. L1ProofSender (<code>l1_proof_sender.rs</code>)</a></h3>
<p>The <code>L1ProofSender</code> handles submitting proofs to Aligned Layer.</p>
<p><strong>Key Responsibilities</strong>:</p>
<ul>
<li>Monitors for completed proofs in the rollup store</li>
<li>Sends compressed proofs to the Aligned Batcher via WebSocket</li>
<li>Tracks the last sent batch proof number</li>
<li>Handles nonce management for the Aligned batcher</li>
</ul>
<p><strong>Aligned-Specific Logic</strong>:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn send_proof_to_aligned(
    &amp;self,
    batch_number: u64,
    batch_proofs: impl IntoIterator&lt;Item = &amp;BatchProof&gt;,
) -&gt; Result&lt;(), ProofSenderError&gt; {
    // Estimate fee from Aligned
    let fee_estimation = Self::estimate_fee(self).await?;

    // Get nonce from Aligned batcher
    let nonce = get_nonce_from_batcher(self.network.clone(), self.signer.address()).await?;

    for batch_proof in batch_proofs {
        // Build verification data for Aligned
        let verification_data = VerificationData {
            proving_system: match prover_type {
                ProverType::RISC0 =&gt; ProvingSystemId::Risc0,
                ProverType::SP1 =&gt; ProvingSystemId::SP1,
            },
            proof: batch_proof.compressed(),
            proof_generator_addr: self.signer.address(),
            vm_program_code: Some(vm_program_code),  // ELF or VK
            pub_input: Some(batch_proof.public_values()),
            verification_key: None,
        };

        // Submit to Aligned batcher
        submit(self.network.clone(), &amp;verification_data, fee_estimation, wallet, nonce).await?;
    }
}
<span class="boring">}</span></code></pre></pre>
<p>See the <a href="l2/fundamentals/ethrex_l2_aligned_integration.html#configuration">Configuration</a> section for <code>AlignedConfig</code> details.</p>
<h3 id="2-l1proofverifier-l1_proof_verifierrs"><a class="header" href="#2-l1proofverifier-l1_proof_verifierrs">2. L1ProofVerifier (<code>l1_proof_verifier.rs</code>)</a></h3>
<p>The <code>L1ProofVerifier</code> monitors Aligned Layer for aggregated proofs and triggers on-chain verification.</p>
<p><strong>Key Responsibilities</strong>:</p>
<ul>
<li>Polls Aligned Layer to check if proofs have been aggregated</li>
<li>Collects Merkle proofs of inclusion for verified proofs</li>
<li>Batches multiple verified proofs into a single L1 transaction</li>
<li>Calls <code>verifyBatchesAligned()</code> on the OnChainProposer contract</li>
</ul>
<p><strong>Verification Flow</strong>:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn verify_proofs_aggregation(&amp;self, first_batch_number: u64) -&gt; Result&lt;Option&lt;H256&gt;&gt; {
    let mut sp1_merkle_proofs_list = Vec::new();
    let mut risc0_merkle_proofs_list = Vec::new();

    // For each consecutive batch
    loop {
        for (prover_type, proof) in proofs_for_batch {
            // Build verification data
            let verification_data = match prover_type {
                ProverType::SP1 =&gt; AggregationModeVerificationData::SP1 {
                    vk: self.sp1_vk,
                    public_inputs: proof.public_values(),
                },
                ProverType::RISC0 =&gt; AggregationModeVerificationData::Risc0 {
                    image_id: self.risc0_vk,
                    public_inputs: proof.public_values(),
                },
            };

            // Check if proof was aggregated by Aligned
            if let Some((merkle_root, merkle_path)) =
                self.check_proof_aggregation(verification_data).await?
            {
                aggregated_proofs.insert(prover_type, merkle_path);
            }
        }

        // Collect merkle proofs for this batch
        sp1_merkle_proofs_list.push(sp1_merkle_proof);
        risc0_merkle_proofs_list.push(risc0_merkle_proof);
    }

    // Send single transaction to verify all batches
    let calldata = encode_calldata(
        "verifyBatchesAligned(uint256,uint256,bytes32[][],bytes32[][])",
        &amp;[first_batch, last_batch, sp1_proofs, risc0_proofs]
    );

    send_verify_tx(calldata, target_address).await
}
<span class="boring">}</span></code></pre></pre>
<h3 id="3-prover-modification"><a class="header" href="#3-prover-modification">3. Prover Modification</a></h3>
<p>In Aligned mode, the prover generates <strong>Compressed</strong> proofs instead of <strong>Groth16</strong> proofs.</p>
<p><strong>Proof Format Selection</strong>:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum ProofFormat {
    /// Groth16 - EVM-friendly, for direct on-chain verification
    Groth16,
    /// Compressed STARK - For Aligned Layer aggregation
    Compressed,
}
<span class="boring">}</span></code></pre></pre>
<p><strong>BatchProof Types</strong>:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum BatchProof {
    /// For direct on-chain verification (Standard mode)
    ProofCalldata(ProofCalldata),
    /// For Aligned Layer submission (Aligned mode)
    ProofBytes(ProofBytes),
}

pub struct ProofBytes {
    pub prover_type: ProverType,
    pub proof: Vec&lt;u8&gt;,           // Compressed STARK proof
    pub public_values: Vec&lt;u8&gt;,   // Public inputs
}
<span class="boring">}</span></code></pre></pre>
<hr />
<h2 id="smart-contract-integration"><a class="header" href="#smart-contract-integration">Smart Contract Integration</a></h2>
<h3 id="onchainproposer-contract"><a class="header" href="#onchainproposer-contract">OnChainProposer Contract</a></h3>
<p>The <code>OnChainProposer.sol</code> contract supports both verification modes:</p>
<p><strong>State Variables</strong>:</p>
<pre><code class="language-solidity">/// True if verification is done through Aligned Layer
bool public ALIGNED_MODE;

/// Address of the AlignedProofAggregatorService contract
address public ALIGNEDPROOFAGGREGATOR;

/// Verification keys per git commit hash and verifier type
mapping(bytes32 commitHash =&gt; mapping(uint8 verifierId =&gt; bytes32 vk))
    public verificationKeys;
</code></pre>
<p><strong>Standard Verification</strong> (<code>verifyBatch</code>):</p>
<pre><code class="language-solidity">function verifyBatch(
    uint256 batchNumber,
    bytes memory risc0BlockProof,
    bytes memory sp1ProofBytes,
    bytes memory tdxSignature
) external onlyOwner whenNotPaused {
    require(!ALIGNED_MODE, "008");  // Use verifyBatchesAligned instead

    // Verify proofs directly via verifier contracts
    if (REQUIRE_SP1_PROOF) {
        ISP1Verifier(SP1_VERIFIER_ADDRESS).verifyProof(sp1Vk, publicInputs, sp1ProofBytes);
    }
    if (REQUIRE_RISC0_PROOF) {
        IRiscZeroVerifier(RISC0_VERIFIER_ADDRESS).verify(risc0BlockProof, risc0Vk, sha256(publicInputs));
    }
}
</code></pre>
<p><strong>Aligned Verification</strong> (<code>verifyBatchesAligned</code>):</p>
<pre><code class="language-solidity">function verifyBatchesAligned(
    uint256 firstBatchNumber,
    uint256 lastBatchNumber,
    bytes32[][] calldata sp1MerkleProofsList,
    bytes32[][] calldata risc0MerkleProofsList
) external onlyOwner whenNotPaused {
    require(ALIGNED_MODE, "00h");  // Use verifyBatch instead

    for (uint256 i = 0; i &lt; batchesToVerify; i++) {
        bytes memory publicInputs = _getPublicInputsFromCommitment(batchNumber);

        if (REQUIRE_SP1_PROOF) {
            _verifyProofInclusionAligned(
                sp1MerkleProofsList[i],
                verificationKeys[commitHash][SP1_VERIFIER_ID],
                publicInputs
            );
        }

        if (REQUIRE_RISC0_PROOF) {
            _verifyProofInclusionAligned(
                risc0MerkleProofsList[i],
                verificationKeys[commitHash][RISC0_VERIFIER_ID],
                publicInputs
            );
        }
    }
}
</code></pre>
<p><strong>Aligned Proof Inclusion Verification</strong>:</p>
<pre><code class="language-solidity">function _verifyProofInclusionAligned(
    bytes32[] calldata merkleProofsList,
    bytes32 verificationKey,
    bytes memory publicInputsList
) internal view {
    bytes memory callData = abi.encodeWithSignature(
        "verifyProofInclusion(bytes32[],bytes32,bytes)",
        merkleProofsList,
        verificationKey,
        publicInputsList
    );

    (bool callResult, bytes memory response) = ALIGNEDPROOFAGGREGATOR.staticcall(callData);
    require(callResult, "00y");  // Call to ALIGNEDPROOFAGGREGATOR failed

    bool proofVerified = abi.decode(response, (bool));
    require(proofVerified, "00z");  // Aligned proof verification failed
}
</code></pre>
<h3 id="public-inputs-structure"><a class="header" href="#public-inputs-structure">Public Inputs Structure</a></h3>
<p>The public inputs for proof verification are reconstructed from batch commitments:</p>
<pre><code>Fixed-size fields (256 bytes):
├── bytes 0-32:    Initial state root (from last verified batch)
├── bytes 32-64:   Final state root (from current batch)
├── bytes 64-96:   Withdrawals merkle root
├── bytes 96-128:  Processed privileged transactions rolling hash
├── bytes 128-160: Blob KZG versioned hash
├── bytes 160-192: Last block hash
├── bytes 192-224: Chain ID
└── bytes 224-256: Non-privileged transactions count

Variable-size fields:
├── For each balance diff:
│   ├── Chain ID (32 bytes)
│   ├── Value (32 bytes)
│   └── Asset diffs + Message hashes
└── For each L2 message rolling hash:
    ├── Chain ID (32 bytes)
    └── Rolling hash (32 bytes)
</code></pre>
<hr />
<h2 id="configuration-4"><a class="header" href="#configuration-4">Configuration</a></h2>
<h3 id="sequencer-configuration"><a class="header" href="#sequencer-configuration">Sequencer Configuration</a></h3>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct AlignedConfig {
    /// Enable Aligned mode
    pub aligned_mode: bool,

    /// Interval (ms) between verification checks
    pub aligned_verifier_interval_ms: u64,

    /// Beacon client URLs for blob verification
    pub beacon_urls: Vec&lt;Url&gt;,

    /// Aligned network (devnet, testnet, mainnet)
    pub network: Network,

    /// Fee estimation type ("instant" or "default")
    pub fee_estimate: String,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="cli-flags"><a class="header" href="#cli-flags">CLI Flags</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Flag</th><th>Description</th></tr></thead><tbody>
<tr><td><code>--aligned</code></td><td>Enable Aligned mode</td></tr>
<tr><td><code>--aligned-network</code></td><td>Network for Aligned SDK (devnet/testnet/mainnet)</td></tr>
<tr><td><code>--aligned.beacon-url</code></td><td>Beacon client URL supporting <code>/eth/v1/beacon/blobs</code></td></tr>
</tbody></table>
</div>
<h3 id="environment-variables"><a class="header" href="#environment-variables">Environment Variables</a></h3>
<p><strong>Node Configuration:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Description</th></tr></thead><tbody>
<tr><td><code>ETHREX_ALIGNED_MODE</code></td><td>Enable Aligned mode</td></tr>
<tr><td><code>ETHREX_ALIGNED_BEACON_URL</code></td><td>Beacon client URL</td></tr>
<tr><td><code>ETHREX_ALIGNED_NETWORK</code></td><td>Aligned network</td></tr>
</tbody></table>
</div>
<p><strong>Deployer Configuration:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Description</th></tr></thead><tbody>
<tr><td><code>ETHREX_L2_ALIGNED</code></td><td>Enable Aligned during deployment</td></tr>
<tr><td><code>ETHREX_DEPLOYER_ALIGNED_AGGREGATOR_ADDRESS</code></td><td>Address of <code>AlignedProofAggregatorService</code></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="behavioral-differences"><a class="header" href="#behavioral-differences">Behavioral Differences</a></h2>
<h3 id="standard-mode-vs-aligned-mode"><a class="header" href="#standard-mode-vs-aligned-mode">Standard Mode vs Aligned Mode</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Aspect</th><th>Standard Mode</th><th>Aligned Mode</th></tr></thead><tbody>
<tr><td><strong>Proof Format</strong></td><td>Groth16 (EVM-friendly)</td><td>Compressed STARK</td></tr>
<tr><td><strong>Submission Target</strong></td><td>OnChainProposer contract</td><td>Aligned Batcher (WebSocket)</td></tr>
<tr><td><strong>Verification Method</strong></td><td><code>verifyBatch()</code></td><td><code>verifyBatchesAligned()</code></td></tr>
<tr><td><strong>Verifier Contract</strong></td><td>SP1Verifier/RISC0Verifier</td><td>AlignedProofAggregatorService</td></tr>
<tr><td><strong>Batch Verification</strong></td><td>One batch per tx</td><td>Multiple batches per tx</td></tr>
<tr><td><strong>Gas Cost</strong></td><td>Higher (per-proof verification)</td><td>Lower (amortized via aggregation)</td></tr>
<tr><td><strong>Additional Component</strong></td><td>None</td><td>L1ProofVerifier process</td></tr>
<tr><td><strong>Proof Tracking</strong></td><td>Via rollup store</td><td>Via Aligned SDK</td></tr>
</tbody></table>
</div>
<h3 id="prover-differences"><a class="header" href="#prover-differences">Prover Differences</a></h3>
<p><strong>Standard Mode</strong>:</p>
<ul>
<li>Generates Groth16 proof (calldata format)</li>
<li>Proof sent directly to <code>OnChainProposer.verifyBatch()</code></li>
</ul>
<p><strong>Aligned Mode</strong>:</p>
<ul>
<li>Generates Compressed STARK proof (bytes format)</li>
<li>Proof submitted to Aligned Batcher via SDK</li>
<li>Must wait for Aligned aggregation before on-chain verification</li>
</ul>
<h3 id="verification-flow-differences"><a class="header" href="#verification-flow-differences">Verification Flow Differences</a></h3>
<p><strong>Standard Mode</strong>:</p>
<pre><code>Prover → ProofCoordinator → L1ProofSender → OnChainProposer.verifyBatch()
                                                    │
                                                    ▼
                                          SP1Verifier/RISC0Verifier
</code></pre>
<p><strong>Aligned Mode</strong>:</p>
<pre><code>Prover → ProofCoordinator → L1ProofSender → Aligned Batcher
                                                     │
                                                     ▼
                                            Aligned Aggregation
                                                     │
                                                     ▼
L1ProofVerifier  ←  (polls for aggregation)  ←  AlignedProofAggregatorService
        │
        ▼
OnChainProposer.verifyBatchesAligned()
        │
        ▼
AlignedProofAggregatorService.verifyProofInclusion()
</code></pre>
<hr />
<h2 id="error-handling-1"><a class="header" href="#error-handling-1">Error Handling</a></h2>
<h3 id="proof-sender-errors"><a class="header" href="#proof-sender-errors">Proof Sender Errors</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Error</th><th>Description</th><th>Recovery</th></tr></thead><tbody>
<tr><td><code>AlignedGetNonceError</code></td><td>Failed to get nonce from batcher</td><td>Retry with backoff</td></tr>
<tr><td><code>AlignedFeeEstimateError</code></td><td>Fee estimation failed</td><td>Retry all RPC URLs</td></tr>
<tr><td><code>AlignedWrongProofFormat</code></td><td>Proof is not compressed</td><td>Re-generate proof in Aligned mode</td></tr>
<tr><td><code>InvalidProof</code></td><td>Aligned rejected the proof</td><td>Delete proof, regenerate</td></tr>
</tbody></table>
</div>
<h3 id="proof-verifier-errors"><a class="header" href="#proof-verifier-errors">Proof Verifier Errors</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Error</th><th>Description</th><th>Recovery</th></tr></thead><tbody>
<tr><td><code>MismatchedPublicInputs</code></td><td>Proofs have different public inputs</td><td>Investigation required</td></tr>
<tr><td><code>UnsupportedProverType</code></td><td>Prover type not supported by Aligned</td><td>Use SP1 or RISC0</td></tr>
<tr><td><code>BeaconClient</code></td><td>Beacon URL failed</td><td>Try next beacon URL</td></tr>
<tr><td><code>EthereumProviderError</code></td><td>RPC URL failed</td><td>Try next RPC URL</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="monitoring"><a class="header" href="#monitoring">Monitoring</a></h2>
<h3 id="key-metrics"><a class="header" href="#key-metrics">Key Metrics</a></h3>
<ul>
<li><code>batch_verification_gas</code>: Gas used per batch verification</li>
<li><code>latest_sent_batch_proof</code>: Last batch proof submitted to Aligned</li>
<li><code>last_verified_batch</code>: Last batch verified on L1</li>
</ul>
<h3 id="log-messages"><a class="header" href="#log-messages">Log Messages</a></h3>
<p><strong>Proof Sender</strong>:</p>
<pre><code>INFO ethrex_l2::sequencer::l1_proof_sender: Sending batch proof(s) to Aligned Layer batch_number=1
INFO ethrex_l2::sequencer::l1_proof_sender: Submitted proof to Aligned prover_type=SP1 batch_number=1
</code></pre>
<p><strong>Proof Verifier</strong>:</p>
<pre><code>INFO ethrex_l2::sequencer::l1_proof_verifier: Proof aggregated by Aligned batch_number=1 merkle_root=0x... commitment=0x...
INFO ethrex_l2::sequencer::l1_proof_verifier: Batches verified in OnChainProposer, with transaction hash 0x...
</code></pre>
<hr />
<h2 id="references-1"><a class="header" href="#references-1">References</a></h2>
<ul>
<li><a href="https://docs.alignedlayer.com/">Aligned Layer Documentation</a></li>
<li><a href="https://docs.alignedlayer.com/guides/1.2_sdk_api_reference">Aligned SDK API Reference</a></li>
<li><a href="https://docs.alignedlayer.com/guides/7_contract_addresses">Aligned Contract Addresses</a></li>
<li><a href="l2/fundamentals/../deployment/aligned.html">Running Ethrex in Aligned Mode</a></li>
<li><a href="l2/fundamentals/../deployment/overview.html">ethrex L2 Deployment Guide</a></li>
<li><a href="l2/fundamentals/../architecture/prover.html">ethrex Prover Documentation</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="developer-docs"><a class="header" href="#developer-docs">Developer docs</a></h1>
<p>Welcome to the ethrex developer docs!</p>
<p>This section contains documentation on the internals of the project.</p>
<p>To get started first, read the developer <a href="developers/./installing.html">installation guide</a> to learn about ethrex and its features. Then you can look into the <a href="developers/../developers/l1/introduction.html">L1 developer docs</a> or the <a href="developers/../developers/l2/introduction.html">L2 developer docs</a></p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="setting-up-a-development-environment-for-ethrex"><a class="header" href="#setting-up-a-development-environment-for-ethrex">Setting up a development environment for ethrex</a></h1>
<h2 id="prerequisites-15"><a class="header" href="#prerequisites-15">Prerequisites</a></h2>
<ul>
<li><a href="https://www.rust-lang.org/tools/install">Rust</a></li>
<li><a href="https://git-scm.com/downloads">Git</a></li>
<li><a href="https://www.docker.com/get-started/">Docker</a></li>
</ul>
<h2 id="cloning-the-repo"><a class="header" href="#cloning-the-repo">Cloning the repo</a></h2>
<p>The full code of ethrex is available at <a href="https://github.com/lambdaclass/ethrex">GitHub</a> and can be cloned using git</p>
<pre><code>git clone https://github.com/lambdaclass/ethrex &amp;&amp; cd ethrex
</code></pre>
<h2 id="building-the-ethrex-binary"><a class="header" href="#building-the-ethrex-binary">Building the ethrex binary</a></h2>
<p>Ethrex can be built using cargo</p>
<p>To build the client run</p>
<pre><code>cargo build --release --bin ethrex
</code></pre>
<p>the following feature can be enable with <code>--features &lt;features&gt;</code></p>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th>Description</th></tr></thead><tbody>
<tr><td><strong>default</strong></td><td>Enables "rocksdb", "c-kzg", "rollup_storage_sql", "dev", "metrics" features</td></tr>
<tr><td>debug</td><td>Enables <a href="developers/../vm/levm/debug.html">debug mode</a> for LEVM</td></tr>
<tr><td><strong>dev</strong></td><td>Makes the <a href="developers/./l1/dev-mode.html">--dev</a> flag available</td></tr>
<tr><td><strong>metrics</strong></td><td>Enables metrics gathering for use with a monitoring stack</td></tr>
<tr><td><strong>c-kzg</strong></td><td>Enables the c-kzg crate instead of kzg-rs</td></tr>
<tr><td><strong>rocksdb</strong></td><td>Enables rocksdb as the database for the ethereum state</td></tr>
<tr><td><strong>rollup_storage_sql</strong></td><td>Enables sql as the database for the L2 batch data</td></tr>
<tr><td>sp1</td><td>Enables the sp1 backend for the L2 prover</td></tr>
<tr><td>risc0</td><td>Enables the risc0 backend for the L2 prover</td></tr>
<tr><td>gpu</td><td>Enables CUDA support for the zk backends risc0 and sp1</td></tr>
</tbody></table>
</div>
<p><strong>Bolded</strong> are features enabled by default</p>
<p>Additionally the environment variable <code>COMPILE_CONTRACTS</code> can be set to <code>true</code> to enable embedding the solidity contracts used by the rollup, into the binary to enable the <a href="developers/../developers/l2/dev-mode.html">L2 dev mode</a>.</p>
<h2 id="building-the-docker-image"><a class="header" href="#building-the-docker-image">Building the docker image</a></h2>
<p>The Dockerfile is located at the root of the repository and can be built by running</p>
<pre><code>docker build -t ethrex .
</code></pre>
<p>Build arguments:</p>
<ul>
<li><code>PROFILE</code>: Cargo profile to use (default: <code>release</code>). Example: <code>release-with-debug-assertions</code></li>
<li><code>BUILD_FLAGS</code>: Additional cargo flags (features, etc.)</li>
</ul>
<pre><code># Custom profile
docker build -t ethrex --build-arg PROFILE="release-with-debug-assertions" .

# With features
docker build -t ethrex --build-arg BUILD_FLAGS="--features l2" .

# Both
docker build -t ethrex --build-arg PROFILE="release-with-debug-assertions" --build-arg BUILD_FLAGS="--features l2" .
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="l1-developer-docs"><a class="header" href="#l1-developer-docs">L1 Developer Docs</a></h1>
<p>Welcome to the ethrex L1 developer documentation!</p>
<p>This section provides information about the internals of the L1 side of the project.</p>
<h2 id="table-of-contents-1"><a class="header" href="#table-of-contents-1">Table of contents</a></h2>
<ul>
<li><a href="developers/l1/./dev-mode.html">Dev mode</a></li>
<li><a href="developers/l1/./kurtosis-localnet.html">Kurtosis localnet</a></li>
<li><a href="developers/l1/./importing-blocks.html">Importing blocks</a></li>
<li><a href="developers/l1/./metrics.html">Metrics</a></li>
<li><a href="developers/l1/./dashboards.html">Dashboards</a></li>
<li><a href="developers/l1/./testing/README.html">Testing</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ethrex-as-a-local-development-node"><a class="header" href="#ethrex-as-a-local-development-node">Ethrex as a local development node</a></h1>
<h2 id="prerequisites-16"><a class="header" href="#prerequisites-16">Prerequisites</a></h2>
<p>This guide assumes you've read the dev <a href="developers/l1/../installing.html">installation guide</a></p>
<h2 id="dev-mode"><a class="header" href="#dev-mode">Dev mode</a></h2>
<p>In dev mode ethrex acts as a local Ethereum development node it can be run with the following command</p>
<pre><code class="language-sh">ethrex --dev
</code></pre>
<p>Then you can use a tool like <a href="https://github.com/lambdaclass/rex">rex</a> to make sure that the network is advancing</p>
<pre><code class="language-sh">rex block-number
</code></pre>
<p>Rich account private keys are listed at the folder <code>fixtures/keys/private_keys_l1.txt</code> located at the root of the repo. You can then use these keys to deploy contracts and send transactions in the localnet.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h2 id="importing-blocks"><a class="header" href="#importing-blocks">Importing blocks</a></h2>
<p>The simplest task a node can do is import blocks offline. We would do so like this:</p>
<h2 id="prerequisites-17"><a class="header" href="#prerequisites-17">Prerequisites</a></h2>
<p>This guide assumes you've read the dev <a href="developers/l1/../installing.html">installation guide</a></p>
<h2 id="import-blocks"><a class="header" href="#import-blocks">Import blocks</a></h2>
<pre><code class="language-bash"># Execute the import
# Notice that the .rlp file is stored with Git LFS, it needs to be downloaded before importing
ethrex --network fixtures/genesis/perf-ci.json import  fixtures/blockchain/l2-1k-erc20.rlp
</code></pre>
<ul>
<li>The network argument is common to all ethrex commands. It specifies the genesis file, or a public network like holesky. This is the starting state of the blockchain.</li>
<li>The import command means that this node will not start rpc endpoints or peer to peer communication. It will just read a file, parse the blocks, execute them, and save the EVM state (accounts info and storage) after each execution.</li>
<li>The file is an RLP encoded file with a list of blocks.</li>
</ul>
<h3 id="block-execution"><a class="header" href="#block-execution">Block execution</a></h3>
<p>The CLI import subcommand executes <code>cmd/ethrex/cli.rs:import_blocks</code>, which can be summarized as:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let store = init_store(&amp;datadir, network).await;
let blockchain = init_blockchain(evm, store.clone());
for block in parse(rlp_file) {
    blockchain.add_block(block)
}
<span class="boring">}</span></code></pre></pre>
<p>The blockchain struct is our main point of interaction with our data. It contains references to key structures like our store (key-value db) and the EVM engine (knows how to execute transactions).</p>
<p>Adding a block is performed in <code>crates/blockchain/blockchain.rs:add_block</code>, and performs several tasks:</p>
<ol>
<li>Block execution (<code>execute_block</code>).
<ol>
<li>Pre-validation. Checks that the block parent is present, that the base fee matches the parent's expectations, timestamps, header number, transaction root and withdrawals root.</li>
<li>VM execution. The block contains all the transactions, which is all needed to perform a state transition. The VM has a reference to the store, so it can get the current state to apply transactions on top of it.</li>
<li>Post execution validations: gas used, receipts root, requets hash.</li>
<li>The VM execution does not mutate the store itself. It returns a list of all changes that happened in execution so they can be applied in any custom way.</li>
</ol>
</li>
<li>Post-state storage (<code>store_block</code>)
<ol>
<li><code>apply_account_updates</code> gets the pre-state from the store, applies the updates to get an updated post-transition-state, calculates the root and commits the new state to disk.</li>
<li>The state root is a merkle root, a cryptographic summary of a state. The one we just calculated is compared with the one in the block header. If it matches, it proves that your node's post-state is the same as the one the block producer reached after executing that same block.</li>
<li>The block and the receipts are saved to disk.</li>
</ol>
</li>
</ol>
<h3 id="states"><a class="header" href="#states">States</a></h3>
<p>In ethereum the first state is determined by the genesis file. After that, each block represents a state transition. To be formal about it, if we have a state <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> and a block <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>, we can define <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span> as the application of a state transition function.</p>
<p>This means that a blockchain, internally, looks like this.</p>
<pre class="mermaid">flowchart LR
    Sg[&quot;Sg (genesis)&quot;]
    S1a[&quot;S1&quot;]
    S2a[&quot;S2&quot;]
    S3a[&quot;S3&quot;]

    Sg -- &quot;f(Sg, B1)&quot; --&gt; S1a
    S1a -- &quot;f(S1, B2)&quot; --&gt; S2a
    S2a -- &quot;f(S2, B3)&quot; --&gt; S3a
</pre>
<p>We start from a genesis state, and each time we add a block we generate a new state. We don't only save the current state (<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>), we save all of them in the DB after execution. This seems wasteful, but the reason will become more obvious very soon. This means that we can get the state for any block number. We say that if we get the state for block number one, we actually are getting the state right after applying <code>B1</code>.</p>
<p>Due to the highly available nature of ethereum, sometimes multiple different blocks can be proposed for a single state. This creates what we call "soft forks".</p>
<pre class="mermaid">flowchart LR
    Sg[&quot;Sg (genesis)&quot;]
    S1a[&quot;S1&quot;]
    S2a[&quot;S2&quot;]
    S3a[&quot;S3&quot;]
    S1b[&quot;S1'&quot;]
    S2b[&quot;S2'&quot;]
    S3b[&quot;S3'&quot;]

    Sg -- &quot;f(Sg, B1)&quot; --&gt; S1a
    S1a -- &quot;f(S1, B2)&quot; --&gt; S2a
    S2a -- &quot;f(S2, B3)&quot; --&gt; S3a

    Sg -- &quot;f(Sg, B1')&quot; --&gt; S1b
    S1b -- &quot;f(S1', B2')&quot; --&gt; S2b
    S2b -- &quot;f(S2', B3')&quot; --&gt; S3b
</pre>
<p>This means that for a single block number we actually have different post-states, depending on which block we executed. In turn, this means that using a block number is not a reliable way of getting a state. To fix this, what we do is calculate the hash of a block, which is unique, and use that as an identifier for both the block and its corresponding block state. In that way, if I request the DB the state for <code>hash(B1)</code> it understands that I'm looking for <code>S1</code>, whereas if I request the DB the state for <code>hash(B1')</code> I'm looking for <code>S1'</code>.</p>
<p>How we determine which is the right fork is called <strong>Fork choice</strong>, which is not done by the execution client, but by the consensus client. What concerns to us is that if we currently think we are on <code>S3</code> and the consensus client notifies us that actually <code>S3'</code> is the current fork, we need to change our current state to that one. That means that we need to save every post-state in case we need to change forks. This changing of the nodes perception of the correct soft fork to a different one is called <strong>reorg</strong>.</p>
<h3 id="vm---state-interaction"><a class="header" href="#vm---state-interaction">VM - State interaction</a></h3>
<p>As mentioned in the previous point, the VM execution doesn't directly mutate the store. It just calculates all necessary updates. There's an important clarification we need to go through about the starting point for that calculation.</p>
<p>This is a key piece of code in <code>Blockchain.execute_block</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let vm_db = StoreVmDatabase::new(self.storage.clone(), parent_header)?;
let mut vm = Evm::new(vm_db);
let execution_result = vm.execute_block(block)?;
let account_updates = vm.get_state_transitions()?;
<span class="boring">}</span></code></pre></pre>
<p>The VM is a transient object. It is created with an engine/backend (LEVM or REVM) and a db reference. It is discarded after executing each block.</p>
<p>The <code>StoreVmDatabase</code> is just an implementation of the <code>VmDatabase</code> trait, using our <code>Store</code> (reference to a key-value store). It's an adapter between the store and the vm and allows the VM to not depend on a concrete DB.</p>
<p>The main piece of context a VM DB needs to be created is the <code>parent_hash</code>, which is the hash of the parent's block. As we mentioned previously, this hash uniquely identifies an ethereum state, so we are basically telling the VM what it's pre-state is. If we give it that, plus the block, the VM can execute the state-transition function <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span> previously mentioned.</p>
<p>The <code>VmDatabase</code> context just requires the implementation of the following methods:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn get_account_info(&amp;self, address: Address) -&gt; Result&lt;Option&lt;AccountInfo&gt;, EvmError&gt;;
fn get_storage_slot(&amp;self, address: Address, key: H256) -&gt; Result&lt;Option&lt;U256&gt;, EvmError&gt;;
fn get_block_hash(&amp;self, block_number: u64) -&gt; Result&lt;H256, EvmError&gt;;
fn get_chain_config(&amp;self) -&gt; Result&lt;ChainConfig, EvmError&gt;;
fn get_account_code(&amp;self, code_hash: H256) -&gt; Result&lt;Bytes, EvmError&gt;;
<span class="boring">}</span></code></pre></pre>
<p>That is, it needs to know how to get information about accounts, about storage, get a block hash according to a specific number, get the config, and the account code for a specific hash.</p>
<p>Internally, the <code>StoreVmDatabase</code> implementation just calls the db for this. For example:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn get_account_info(&amp;self, address: Address) -&gt; Result&lt;Option&lt;AccountInfo&gt;, EvmError&gt; {
    self.store
        .get_account_info_by_hash(self.block_hash, address)
        .map_err(|e| EvmError::DB(e.to_string()))
}
<span class="boring">}</span></code></pre></pre>
<p>You may note that the <code>get_account_info_by_hash</code> receives not only the address, but also the block hash. That is because it doesn't get the account state for the "current" state, it gets it for the post-state of the parent block. That is, the pre-state for the state transition. And this makes sense: we don't want to apply a transaction anywhere, we want to apply it precisely on top of the parent's state, so that's where we'll be getting all of our state.</p>
<h3 id="what-is-state-anyway"><a class="header" href="#what-is-state-anyway">What is state anyway</a></h3>
<p>The ethereum state is, logically, two things: accounts and their storage slots. If we were to represent them in memory, they would be something like:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct VmState {
    accounts: HashMap&lt;H256, Option&lt;AccountState&gt;&gt;,
    storage: HashMap&lt;H256, HashMap&lt;H256, Option&lt;U256&gt;&gt;&gt;,
}
<span class="boring">}</span></code></pre></pre>
<p>The accounts are indexed by the hash of their address. The storage has a two level lookup: an index by account address hash, and then an index by hashed slot. The reasons why we use hashes of the addresses and slots instead of using them directly is an implementation detail.</p>
<p>This flat key-value representation is what we usually call a snapshot. To write and get state, it would be enough and efficient to have a table in the db with some snapshot in the past and then the differences in each account and storage each block. This are precisely the account updates, and this is precisely what we do in our snapshots implementation.</p>
<p>However, we also need to be able to efficiently summarize a state, which is done using a structure called the Merkle Patricia Trie (MPT). This is a big topic, not covered by this document. A link to an in-detail document will be added soon. The most important part of it is that it's a merkle tree and we can calculate it's root/hash to summarize a whole state. When a node proposes a block, the root of the post-state is included as metadata in the header. That means that after executing a block, we can calculate the root of the resulting post-state MPT and compare it with the metadata. If it matches, we have a cryptographic proof that both nodes arrived at the same conclusion.</p>
<p>This means that we will need to maintain both a snapshot (for efficient reads) and a trie (for efficient summaries) for every state in the blockchain. Here's an interesting blogpost by the go ethereum (geth) team explaning this need in detail: https://blog.ethereum.org/2020/07/17/ask-about-geth-snapshot-acceleration</p>
<h1 id="todo"><a class="header" href="#todo">TODO</a></h1>
<p>Imports</p>
<ul>
<li>Add references to our code for MPT and snapshots.</li>
<li>What account updates are. What does it mean to apply them.</li>
</ul>
<p>Live node block execution</p>
<ul>
<li>Engine api endpoints (fork choice updated with no attrs, new payload).</li>
<li>applying fork choice and reorg.</li>
<li>JSON RPC endpoints to get state.</li>
</ul>
<p>Block building</p>
<ul>
<li>Mempool and P2P.</li>
<li>Fork choice updated with attributes and get_payload.</li>
<li>Payload building.</li>
</ul>
<p>Syncing on node startup</p>
<ul>
<li>Discovery.</li>
<li>Getting blocks and headers via p2p.</li>
<li>Snap sync.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="quick-start-l1-localnet"><a class="header" href="#quick-start-l1-localnet">Quick Start (L1 localnet)</a></h1>
<p>This page will show you how to quickly spin up a local development network with ethrex.</p>
<h2 id="prerequisites-18"><a class="header" href="#prerequisites-18">Prerequisites</a></h2>
<ul>
<li><a href="https://docs.kurtosis.com/install/#ii-install-the-cli">Kurtosis</a></li>
<li><a href="https://www.rust-lang.org/tools/install">Rust</a></li>
<li><a href="https://docs.docker.com/engine/install/">Docker</a></li>
</ul>
<h2 id="starting-a-local-devnet"><a class="header" href="#starting-a-local-devnet">Starting a local devnet</a></h2>
<pre><code class="language-shell">make localnet
</code></pre>
<p>This make target will:</p>
<ol>
<li>Build our node inside a docker image.</li>
<li>Fetch our fork <a href="https://github.com/ethpandaops/ethereum-package">ethereum package</a>, a private testnet on which multiple ethereum clients can interact.</li>
<li>Start the localnet with kurtosis.</li>
</ol>
<p>If everything went well, you should be faced with our client's logs (ctrl-c to leave).</p>
<h2 id="stopping-a-local-devnet"><a class="header" href="#stopping-a-local-devnet">Stopping a local devnet</a></h2>
<p>To stop everything, simply run:</p>
<pre><code class="language-shell">make stop-localnet
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="metrics-1"><a class="header" href="#metrics-1">Metrics</a></h1>
<h2 id="quickstart"><a class="header" href="#quickstart">Quickstart</a></h2>
<p>For a high level quickstart guide, please refer to <a href="developers/l1/../../l1/running/monitoring.html">Monitoring</a>.</p>
<h2 id="ethereum-metrics-exporter"><a class="header" href="#ethereum-metrics-exporter">Ethereum Metrics Exporter</a></h2>
<p>We use the <a href="https://github.com/ethpandaops/ethereum-metrics-exporter">Ethereum Metrics Exporter</a>, a Prometheus metrics exporter for Ethereum execution and consensus nodes, as an additional tool to gather metrics during L1 execution. The exporter uses the prometheus data source to create a Grafana dashboard and display the metrics.</p>
<h2 id="l1-metrics-dashboard"><a class="header" href="#l1-metrics-dashboard">L1 Metrics Dashboard</a></h2>
<p>We provide a pre-configured Grafana dashboard to monitor Ethrex L1 nodes. For detailed information on the provided dashboard, see our <a href="developers/l1/./dashboards.html">L1 Dashboard document</a>.</p>
<h3 id="running-the-execution-node-on-other-networks-with-metrics-enabled"><a class="header" href="#running-the-execution-node-on-other-networks-with-metrics-enabled">Running the execution node on other networks with metrics enabled</a></h3>
<p>As shown in <a href="developers/l1/../../l1/running/monitoring.html">Monitoring</a> <code>docker-compose</code> is used to bundle prometheus and grafana services, the <code>*overrides</code> files define the ports and mounts the prometheus' configuration file.
If a new dashboard is designed, it can be mounted only in that <code>*overrides</code> file.
A consensus node must be running for the syncing to work.</p>
<p>To run the execution node on any network with metrics, the next steps should be followed:</p>
<ol>
<li>
<p>Build the <code>ethrex</code> binary for the network you want (see node options in <a href="developers/l1/../../CLI.html#cli-commands">CLI Commands</a>) with the <code>metrics</code> feature enabled.</p>
</li>
<li>
<p>Enable metrics by using the <code>--metrics</code> flag when starting the node.</p>
</li>
<li>
<p>Set the <code>--metrics.port</code> cli arg of the ethrex binary to match the port defined in <code>metrics/provisioning/prometheus/prometheus_l1_sync_docker.yaml</code>, which is <code>3701</code> right now.</p>
</li>
<li>
<p>Run the docker containers:</p>
<pre><code class="language-bash">cd metrics

docker compose -f docker-compose-metrics.yaml -f docker-compose-metrics-l1.overrides.yaml up
</code></pre>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ethrex-l1-performance-dashboard-dec-2025"><a class="header" href="#ethrex-l1-performance-dashboard-dec-2025">Ethrex L1 Performance Dashboard (Dec 2025)</a></h1>
<p>Our Grafana dashboard provides a comprehensive overview of key metrics to help developers and operators ensure optimal performance and reliability of their Ethrex nodes. The only configured datasource today is <code>prometheus</code>, and the <code>job</code> variable defaults to <code>ethrex L1</code>, which is the job configured by default in our provisioning.</p>
<p><img src="developers/l1/img/overview.png" alt="Overview" /></p>
<h2 id="how-to-use-it"><a class="header" href="#how-to-use-it">How to use it</a></h2>
<p>Use the <code>network</code> variable (discovered via the consensus config metric) to scope the view by network, then pick one or more <code>instance</code> entries. Every panel honors these selectors. Tip: several panels rely on Grafana transforms such as Organize fields, Join by field, Filter by value, and Group by—keep those in mind if you customize the layout.</p>
<p><img src="developers/l1/img/variables.png" alt="dashboard variables" /></p>
<h2 id="execution-and-consensus-summary"><a class="header" href="#execution-and-consensus-summary">Execution and consensus summary</a></h2>
<h3 id="execution-client"><a class="header" href="#execution-client">Execution Client</a></h3>
<p>Confirms the execution client name, build and network that each monitored instance is running so you can spot mismatched deployments quickly.</p>
<p><img src="developers/l1/img/execution_client.png" alt="Execution Client" /></p>
<h3 id="consensus-fork"><a class="header" href="#consensus-fork">Consensus Fork</a></h3>
<p>Highlights the active fork reported by <code>ethereum-metrics-exporter</code>, which is a useful signal during planned upgrades.</p>
<p><img src="developers/l1/img/consensus_fork.png" alt="Consensus Fork" /></p>
<h2 id="logs-1"><a class="header" href="#logs-1">Logs</a></h2>
<p>Collapsed row that allows you to view the logs of the selected instances directly within the dashboard. This is useful for correlating metrics with log events without leaving Grafana.</p>
<p><img src="developers/l1/img/logs_row.png" alt="Logs row" /></p>
<h2 id="block-processing"><a class="header" href="#block-processing">Block processing</a></h2>
<p>Row panels showing key block processing metrics across all selected instances.</p>
<p><img src="developers/l1/img/block_processing_row.png" alt="Block Processing row" /></p>
<h3 id="gas-used-"><a class="header" href="#gas-used-">Gas Used %</a></h3>
<p>Tracks how much of the block gas limit is consumed across instances, surfacing heavy traffic or underfilled blocks at a glance.</p>
<p><img src="developers/l1/img/gas_used.png" alt="Gas Used %" /></p>
<h3 id="ggass"><a class="header" href="#ggass">Ggas/s</a></h3>
<p>Charts gigagas per second to compare execution throughput between nodes and reveal sustained load versus isolated spikes.</p>
<p><img src="developers/l1/img/ggas_per_sec.png" alt="Ggas/s" /></p>
<h3 id="block-height"><a class="header" href="#block-height">Block Height</a></h3>
<p>Plots the head block seen by each instance so you can immediately detect stalled sync or lagging nodes.</p>
<p><img src="developers/l1/img/block_height.png" alt="Block Height" /></p>
<h3 id="ggass-by-block"><a class="header" href="#ggass-by-block">Ggas/s by Block</a></h3>
<p>Scatter view that ties throughput to the specific block number once all selected instances agree on the same head, making block-level investigations straightforward.</p>
<p><img src="developers/l1/img/ggas_by_block.png" alt="Ggas by Block" /></p>
<p><em><strong>Limitations</strong>: This panel only shows data when all selected instances agree on the same head block, and it doesn't handle reorgs gracefully. Here are a couple of things to have in mind when looking at it:</em></p>
<ul>
<li>During reorgs, we might see weird shapes in the data, with lines at a certain block connected to past ones when more than one slot reorgs happen.</li>
<li>We could see double measurements for the same block number if reorgs on the same block occur.</li>
<li>Mean could vary when adding or removing instances, as only blocks agreed upon by all selected instances are shown.</li>
</ul>
<h3 id="block-time"><a class="header" href="#block-time">Block Time</a></h3>
<p>Estimates per-block execution time and lines it up with block numbers, helping you correlate latency spikes with particular blocks.</p>
<p><img src="developers/l1/img/block_time.png" alt="Block Time" /></p>
<p><em><strong>Limitations</strong>: This panel has the same limitations as the "Ggas/s by Block" panel above, as it relies on the same logic to align blocks across instances.</em></p>
<h2 id="block-execution-breakdown"><a class="header" href="#block-execution-breakdown">Block execution breakdown</a></h2>
<p>Collapsed row that surfaces instrumentation from the <code>add_block_pipeline</code> and <code>execute_block_pipeline</code> timer series so you can understand how each instance spends time when processing blocks. Every panel repeats per instance vertically to facilitate comparisons.</p>
<p><img src="developers/l1/img/block_execution_breakdown.png" alt="Block Execution Breakdown" /></p>
<h3 id="block-execution-breakdown-pie"><a class="header" href="#block-execution-breakdown-pie">Block Execution Breakdown pie</a></h3>
<p>Pie chart showing how execution time splits between storage reads, account reads, and non-database work so you can confirm what are the bottlenecks outside of execution itself.</p>
<p><img src="developers/l1/img/block_execution_breakdown_pie.png" alt="Block Execution Breakdown pie" /></p>
<h3 id="execution-vs-merkleization-diff-"><a class="header" href="#execution-vs-merkleization-diff-">Execution vs Merkleization Diff %</a></h3>
<p>Tracks how much longer we spend merkleizing versus running the execution phase inside <code>execute_block_pipeline</code>. Values above zero mean merkleization dominates; negative readings flag when pure execution becomes the bottleneck (which should be extremely rare). Both run concurrently and merkleization depends on execution, 99% of the actual <code>execute_block_pipeline</code> time is just the max of both.</p>
<p><img src="developers/l1/img/execution_vs_merkleization_diff.png" alt="Execution vs Merkleization Diff %" /></p>
<h3 id="block-execution-deaggregated-by-block"><a class="header" href="#block-execution-deaggregated-by-block">Block Execution Deaggregated by Block</a></h3>
<p>Plots execution-stage timers (storage/account reads, execution without reads, merkleization) against the block number once all selected instances report the same head.</p>
<p><img src="developers/l1/img/block_execution_deaggregated_by_block.png" alt="Block Execution Deaggregated by Block" /></p>
<p><em><strong>Limitations</strong>: This panel has the same limitations as the other <code>by block</code> panels, as it relies on the same logic to align blocks across instances. Can look odd during multi-slot reorgs</em></p>
<h2 id="engine-api"><a class="header" href="#engine-api">Engine API</a></h2>
<p>Collapsed row that surfaces the <code>namespace="engine"</code> Prometheus timers so you can keep an eye on EL &lt;&gt; CL Engine API health. Each panel repeats per instance to be able to compare behaviour across nodes.</p>
<p><img src="developers/l1/img/engine_api_row.png" alt="Engine API row" /></p>
<h3 id="engine-total-time-per-method"><a class="header" href="#engine-total-time-per-method">Engine Total Time per Method</a></h3>
<p>Pie chart that shows where Engine time is spent across methods over the selected range. Quickly surfaces which endpoints dominate total processing time.</p>
<p><img src="developers/l1/img/engine_total_time_per_method.png" alt="Engine Total Time per Method" /></p>
<h3 id="engine-latency-by-methods-avg-duration"><a class="header" href="#engine-latency-by-methods-avg-duration">Engine Latency by Methods (Avg Duration)</a></h3>
<p>Bar gauge of the historical average latency per Engine method over the selected time range.</p>
<p><img src="developers/l1/img/engine_latency_by_methods.png" alt="Engine Latency by Methods" /></p>
<h3 id="engine-request-rate-by-method"><a class="header" href="#engine-request-rate-by-method">Engine Request Rate by Method</a></h3>
<p>Shows how many Engine API calls per second we process, split by JSON-RPC method and averaged across the currently selected dashboard range.</p>
<p><img src="developers/l1/img/engine_request_rate_by_method.png" alt="Engine Request Rate by Method" /></p>
<h3 id="engine-latency-by-method"><a class="header" href="#engine-latency-by-method">Engine Latency by Method</a></h3>
<p>Live timeseries that tries to correlate to the per-block execution time by showing real-time latency per Engine method with an 18 s lookback window.</p>
<p><img src="developers/l1/img/engine_latency_by_method.png" alt="Engine Latency by Method" /></p>
<p><em><strong>Limitations</strong>: The aggregated panels pull averages across the current dashboard range, so very short ranges can look noisy while long ranges may smooth out brief incidents. The live latency chart still relies on an 18 s window for calculate the average, which should be near-exact per-block executions but we can lose some intermediary measure.</em></p>
<h2 id="rpc-api"><a class="header" href="#rpc-api">RPC API</a></h2>
<p>Another collapsed row focused on the public JSON-RPC surface (<code>namespace="rpc"</code>). Expand it when you need to diagnose endpoint hotspots or validate rate limiting. Each panel repeats per instance to be able to compare behaviour across nodes.</p>
<p><img src="developers/l1/img/rpc_api_row.png" alt="RPC API row" /></p>
<h3 id="rpc-total-time-per-method"><a class="header" href="#rpc-total-time-per-method">RPC Total Time per Method</a></h3>
<p>Pie chart that shows where RPC time is spent across methods over the selected range. Quickly surfaces which endpoints dominate total processing time.</p>
<p><img src="developers/l1/img/rpc_total_time_per_method.png" alt="RPC Total Time per Method" /></p>
<h3 id="slowest-rpc-methods"><a class="header" href="#slowest-rpc-methods">Slowest RPC Methods</a></h3>
<p>Table listing the highest average-latency methods over the active dashboard range. Used to prioritise optimisation or caching efforts.</p>
<p><img src="developers/l1/img/slowest_rpc_methods.png" alt="Slowest RPC Methods" /></p>
<h3 id="rpc-request-rate-by-method"><a class="header" href="#rpc-request-rate-by-method">RPC Request Rate by Method</a></h3>
<p>Timeseries showing request throughput broken down by method, averaged across the selected range.</p>
<p><img src="developers/l1/img/rpc_request_rate_by_method.png" alt="RPC Request Rate by Method" /></p>
<h3 id="rpc-latency-by-methods"><a class="header" href="#rpc-latency-by-methods">RPC Latency by Methods</a></h3>
<p>Live timeseries that tries to correlate to the per-block execution time by showing real-time latency per Engine method with an 18 s lookback window.</p>
<p><img src="developers/l1/img/rpc_latency_by_methods.png" alt="RPC Latency by Methods" /></p>
<p><em><strong>Limitations</strong>: The RPC latency views inherit the same windowing caveats as the Engine charts: averages use the dashboard time range while the live chart relies on an 18 s window.</em></p>
<h2 id="engine-and-rpc-error-rates"><a class="header" href="#engine-and-rpc-error-rates">Engine and RPC Error rates</a></h2>
<p>Collapsed row showing error rates for both Engine and RPC APIs side by side and a deagreagated panel by method and kind of error. Each panel repeats per instance to be able to compare behaviour across nodes.</p>
<p><img src="developers/l1/img/engine_and_rpc_error_rates_row.png" alt="Engine and RPC Error rates row" /></p>
<h3 id="engine-successerror-rate"><a class="header" href="#engine-successerror-rate">Engine Success/Error Rate</a></h3>
<p>Shows the rate of successful vs. failed Engine API requests per second.</p>
<p><img src="developers/l1/img/engine_success_error_rate.png" alt="Engine Success/Error Rate" /></p>
<h3 id="rpc-successerror-rate"><a class="header" href="#rpc-successerror-rate">RPC Success/Error Rate</a></h3>
<p>Shows the rate of successful vs. failed RPC API requests per second.</p>
<p><img src="developers/l1/img/rpc_success_error_rate.png" alt="RPC Success/Error Rate" /></p>
<h3 id="engine-and-rpc-errors--by-method-and-kind"><a class="header" href="#engine-and-rpc-errors--by-method-and-kind">Engine and RPC Errors % by Method and Kind</a></h3>
<p>Deaggregated view of error percentages split by method and error kind for both Engine and RPC APIs. The % are calculated against total requests for a particular method, so all different error percentage for a method should sum up to the percentage of errors for that method.</p>
<p><img src="developers/l1/img/engine_and_rpc_errors_by_method_and_kind.png" alt="Engine and RPC Errors % by Method and Kind" /></p>
<h2 id="peer-info"><a class="header" href="#peer-info">Peer Info</a></h2>
<p>Collapsed row providing visibility into the P2P networking layer. Surfaces peer counts, client distribution, and disconnection events to help diagnose connectivity issues and monitor network health. Each panel repeats per instance to compare behaviour across nodes.</p>
<p><img src="developers/l1/img/peer_info_row.png" alt="Peer Info row" /></p>
<h3 id="peer-count"><a class="header" href="#peer-count">Peer Count</a></h3>
<p>Timeseries showing the number of connected peers over time. Useful for detecting connectivity issues or confirming that the node is maintaining a healthy peer set.</p>
<p><img src="developers/l1/img/peer_count.png" alt="Peer Count" /></p>
<h3 id="peer-clients-distribution"><a class="header" href="#peer-clients-distribution">Peer Clients Distribution</a></h3>
<p>Pie chart breaking down connected peers by client type (e.g., Geth, Nethermind, Besu). Helps understand the diversity of the peer set and spot any client-specific connectivity patterns.</p>
<p><img src="developers/l1/img/peer_clients_distribution.png" alt="Peer Clients Distribution" /></p>
<h3 id="peer-clients"><a class="header" href="#peer-clients">Peer Clients</a></h3>
<p>Timeseries view of peer counts by client type over time. Useful for tracking how the peer composition evolves and detecting sudden drops in connections to specific client types.</p>
<p><img src="developers/l1/img/peer_clients.png" alt="Peer Clients" /></p>
<h3 id="peer-disconnection-events"><a class="header" href="#peer-disconnection-events">Peer Disconnection Events</a></h3>
<p>Bar chart showing disconnection events grouped by reason. Helps identify patterns in peer churn and diagnose whether disconnections are due to protocol errors, timeouts, or other causes.</p>
<p><img src="developers/l1/img/peer_disconnection_events.png" alt="Peer Disconnection Events" /></p>
<h3 id="disconnections-details"><a class="header" href="#disconnections-details">Disconnections Details</a></h3>
<p>Table providing a detailed breakdown of disconnections by client type and reason over the selected time range. Useful for investigating which clients are disconnecting most frequently and why.</p>
<p><img src="developers/l1/img/disconnections_details.png" alt="Disconnections Details" /></p>
<h2 id="process-and-server-info"><a class="header" href="#process-and-server-info">Process and server info</a></h2>
<p>Row panels showing process-level and host-level metrics to help you monitor resource usage and spot potential issues.</p>
<p><img src="developers/l1/img/process_and_server_info_row.png" alt="Process &amp; Server info row" /></p>
<h3 id="uptime"><a class="header" href="#uptime">Uptime</a></h3>
<p>Displays time since the Ethrex process started. <em>[need proper instance labels]</em></p>
<p><img src="developers/l1/img/uptime.png" alt="Uptime" /></p>
<h3 id="threads"><a class="header" href="#threads">Threads</a></h3>
<p>Shows the number of tokio process threads in use. <em>[need proper instance labels]</em></p>
<p><img src="developers/l1/img/threads.png" alt="Threads" /></p>
<h3 id="open-fds"><a class="header" href="#open-fds">Open FDs</a></h3>
<p>Reports current file descriptor usage so you can compare against limits. <em>[need proper instance labels]</em></p>
<p><img src="developers/l1/img/open_fds.png" alt="Open FDs" /></p>
<h3 id="open-fds-historic"><a class="header" href="#open-fds-historic">Open FDs Historic</a></h3>
<p>Time-series view of descriptor usage to spot gradual leaks or sudden bursts tied to workload changes.</p>
<p><img src="developers/l1/img/open_fds_historic.png" alt="Open FDs Historic" /></p>
<h3 id="datadir-size"><a class="header" href="#datadir-size">Datadir Size</a></h3>
<p>Tracks database footprint growth, helping you plan disk needs and confirming pruning/compaction behavior.
<img src="developers/l1/img/datadir_size.png" alt="Datadir Size" /></p>
<h3 id="node-cpu-avg-cores-used"><a class="header" href="#node-cpu-avg-cores-used">Node CPU (avg. cores used)</a></h3>
<p>Shows effective CPU cores consumed by each instance, separating sustained computation from short-lived bursts.</p>
<p><img src="developers/l1/img/node_cpu.png" alt="Node CPU" /></p>
<h3 id="node-memory-rss"><a class="header" href="#node-memory-rss">Node Memory (RSS)</a></h3>
<p>Follows the resident memory footprint of the Ethrex process so you can investigate leaks or pressure.</p>
<p><img src="developers/l1/img/node_memory.png" alt="Node Memory" /></p>
<h3 id="host-cpu-utilization-"><a class="header" href="#host-cpu-utilization-">Host CPU Utilization (%)</a></h3>
<p>Uses node exporter metrics to track whole-host CPU load and distinguish client strain from other processes on the server.</p>
<p><img src="developers/l1/img/host_cpu_utilization.png" alt="Host CPU Utilization" /></p>
<h3 id="host-ram-gib---used-vs-total"><a class="header" href="#host-ram-gib---used-vs-total">Host RAM (GiB) - Used vs Total</a></h3>
<p>Compares used versus total RAM to highlight when machines approach memory limits and need attention.</p>
<p><img src="developers/l1/img/host_ram.png" alt="Host RAM" /></p>
<h2 id="block-building-wip"><a class="header" href="#block-building-wip">Block building (WIP)</a></h2>
<p>This collapsed row offers a combined view of the block building base fee, gigagas per second during payload construction, and the time the builder spends assembling blocks. These panels are works in progress, collapsed by default, and may be refined over time.</p>
<p><img src="developers/l1/img/block_building_wip.png" alt="Block building wip" /></p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="storage-backend-api"><a class="header" href="#storage-backend-api">Storage Backend API</a></h1>
<p>We use a thin, minimal interface for storage backends:</p>
<ul>
<li>Thin: Minimal set of operations that databases must provide</li>
<li>Simple: Avoids type-system complexity and focuses on core functionality</li>
</ul>
<p>Rather than implementing business logic in each database backend, this API provides low-level primitives that higher-level code can build upon.
This eliminates code duplication and makes adding new database backends trivial.</p>
<p>The API differentiates between three types of database access:</p>
<ul>
<li>Read views <code>StorageReadView</code>: read-only views of the database, with no atomicity guarantees between operations.</li>
<li>Write batches <code>StorageWriteBatch</code>: write batch functionality, with atomicity guarantees at commit time.</li>
<li>Locked views <code>StorageLockedView</code>: read-only views of a point in time (snapshots), right now it's only used during snap-sync.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="testing"><a class="header" href="#testing">Testing</a></h1>
<p>The ethrex project runs several suites of tests to ensure proper protocol implementation</p>
<h2 id="table-of-contents-2"><a class="header" href="#table-of-contents-2">Table of contents</a></h2>
<ul>
<li><a href="developers/l1/testing/./ef-tests.html">Ethereum Foundation Tests</a></li>
<li><a href="developers/l1/testing/./hive.html">Hive Tests</a></li>
<li><a href="developers/l1/testing/./assertoor.html">Assertoor</a></li>
<li><a href="developers/l1/testing/./rust.html">Rust Unit Tests</a></li>
<li><a href="developers/l1/testing/./load-tests.html">Load Tests</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ethereum-foundation-tests"><a class="header" href="#ethereum-foundation-tests">Ethereum foundation tests</a></h1>
<p>These are the official execution spec tests there two kinds <code>state tests</code> and <code>blockchain tests</code>, you can execute them with:</p>
<h3 id="state-tests"><a class="header" href="#state-tests">State tests</a></h3>
<p>The state tests are individual transactions not related one to each other that test particular behavior of the EVM. Tests are usually run for multiple forks and the result of execution may vary between forks.
See <a href="https://eest.ethereum.org/v4.1.0/consuming_tests/state_test/">docs</a>.</p>
<p>To run the test first:</p>
<pre><code class="language-sh">cd tooling/ef_tests/state
</code></pre>
<p>then download the test vectors:</p>
<pre><code class="language-sh">make download-evm-ef-tests
</code></pre>
<p>then run the tests:</p>
<pre><code class="language-sh">make run-evm-ef-tests
</code></pre>
<h3 id="blockchain-tests"><a class="header" href="#blockchain-tests">Blockchain tests</a></h3>
<p>The blockchain tests test block validation and the consensus rules of the Ethereum blockchain. Tests are usually run for multiple forks.
See <a href="https://eest.ethereum.org/v4.1.0/consuming_tests/blockchain_test">docs</a>.</p>
<p>To run the tests first:</p>
<pre><code class="language-sh">cd tooling/ef_tests/blockchain
</code></pre>
<p>then run the tests:</p>
<pre><code class="language-sh">make test-levm
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="hive-tests"><a class="header" href="#hive-tests">Hive tests</a></h1>
<p>End-to-End tests with hive.
Hive is a system which simply sends RPC commands to our node,
and expects a certain response. You can read more about it <a href="https://github.com/ethereum/hive/blob/master/docs/overview.md">here</a>.</p>
<h4 id="prereqs"><a class="header" href="#prereqs">Prereqs</a></h4>
<p>We need to have go installed for the first time we run hive, an easy way to do this is adding the asdf go plugin:</p>
<pre><code class="language-shell">asdf plugin add golang https://github.com/asdf-community/asdf-golang.git

# If you need to set GOROOT please follow: https://github.com/asdf-community/asdf-golang?tab=readme-ov-file#goroot
</code></pre>
<p>And uncommenting the golang line in the asdf <code>.tool-versions</code> file:</p>
<pre><code class="language-text">rust 1.90.0
golang 1.23.2
</code></pre>
<h4 id="running-simulations"><a class="header" href="#running-simulations">Running Simulations</a></h4>
<p>Hive tests are categorized by "simulations', and test instances can be filtered with a regex:</p>
<pre><code class="language-bash">make run-hive-debug SIMULATION=&lt;simulation&gt; TEST_PATTERN=&lt;test-regex&gt;
</code></pre>
<p>This is an example of a Hive simulation called <code>ethereum/rpc-compat</code>, which will specificaly
run chain id and transaction by hash rpc tests:</p>
<pre><code class="language-bash">make run-hive SIMULATION=ethereum/rpc-compat TEST_PATTERN="/eth_chainId|eth_getTransactionByHash"
</code></pre>
<p>If you want debug output from hive, use the run-hive-debug instead:</p>
<pre><code class="language-bash">make run-hive-debug SIMULATION=ethereum/rpc-compat TEST_PATTERN="*"
</code></pre>
<p>This example runs <strong>every</strong> test under rpc, with debug output</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="assertoor-tests"><a class="header" href="#assertoor-tests">Assertoor tests</a></h1>
<p>We run some assertoor checks on our CI, to execute them locally you can run the following:</p>
<pre><code class="language-bash">make localnet-assertoor-tx
# or
make localnet-assertoor-blob
</code></pre>
<p>Those are two different set of assertoor checks the details are as follows:</p>
<p><em>assertoor-tx</em></p>
<ul>
<li><a href="https://raw.githubusercontent.com/ethpandaops/assertoor/refs/heads/master/playbooks/stable/eoa-transactions-test.yaml">eoa-transaction-test</a></li>
</ul>
<p><em>assertoor-blob</em></p>
<ul>
<li><a href="https://raw.githubusercontent.com/ethpandaops/assertoor/refs/heads/master/playbooks/stable/blob-transactions-test.yaml">blob-transaction-test</a></li>
<li><em>Custom</em> <a href="https://raw.githubusercontent.com/lambdaclass/ethrex/refs/heads/main/.github/config/assertoor/el-stability-check.yaml">el-stability-check</a></li>
</ul>
<p>For reference on each individual check see the <a href="https://github.com/ethpandaops/assertoor/wiki#supported-tasks-in-assertoor">assertoor-wiki</a></p>
<h2 id="run"><a class="header" href="#run">Run</a></h2>
<p>Example run:</p>
<pre><code class="language-bash">cargo run --bin ethrex -- --network fixtures/genesis/kurtosis.json
</code></pre>
<p>The <code>network</code> argument is mandatory, as it defines the parameters of the chain.
For more information about the different cli arguments check out the next section.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="rust-tests"><a class="header" href="#rust-tests">Rust tests</a></h1>
<h2 id="crate-specific-tests"><a class="header" href="#crate-specific-tests">Crate Specific Tests</a></h2>
<p>Rust unit tests that you can run like this:</p>
<pre><code class="language-bash">make test CRATE=&lt;crate&gt;
</code></pre>
<p>For example:</p>
<pre><code class="language-bash">make test CRATE="ethrex-blockchain"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="load-tests"><a class="header" href="#load-tests">Load tests</a></h1>
<p>Before starting, consider increasing the maximum amount of open files for the current shell with the following command:</p>
<pre><code class="language-bash">ulimit -n 65536
</code></pre>
<p>To run a load test, first run the node using a command like the following in the root folder:</p>
<pre><code class="language-bash">cargo run --bin ethrex --release -- --network fixtures/genesis/load-test.json --dev
</code></pre>
<p>There are currently three different load tests you can run:</p>
<p>The first one sends regular transfers between accounts, the second runs an EVM-heavy contract that computes fibonacci numbers, the third a heavy IO contract that writes to 100 storage slots per transaction.</p>
<pre><code class="language-bash"># Eth transfer load test
make load-test

# ERC 20 transfer load test
make load-test-erc20

# Tests a contract that executes fibonacci (high cpu)
make load-test-fibonacci

# Tests a contract that makes heavy access to storage slots
make load-test-io
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="l2-developer-docs"><a class="header" href="#l2-developer-docs">L2 Developer Docs</a></h1>
<p>Welcome to the ethrex L2 developer documentation!</p>
<p>This section provides information about the internals of the L2 side of the project.</p>
<h2 id="table-of-contents-3"><a class="header" href="#table-of-contents-3">Table of contents</a></h2>
<ul>
<li><a href="developers/l2/./dev-mode.html">Dev mode</a></li>
<li><a href="developers/l2/./integration-tests.html">Running integration tests</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ethrex-as-a-local-l2-development-node"><a class="header" href="#ethrex-as-a-local-l2-development-node">Ethrex as a local L2 development node</a></h1>
<h2 id="prerequisites-19"><a class="header" href="#prerequisites-19">Prerequisites</a></h2>
<ul>
<li>This guide assumes you've read the dev <a href="developers/l2/../installing.html">installation guide</a></li>
<li>An Ethereum utility tool like <a href="https://github.com/lambdaclass/rex">rex</a></li>
</ul>
<h2 id="dev-mode-1"><a class="header" href="#dev-mode-1">Dev mode</a></h2>
<p>In dev mode ethrex acts as a local Ethereum development node and a local layer 2 rollup</p>
<pre><code class="language-sh">ethrex l2 --dev
</code></pre>
<p>after running the command the ethrex monitor will open with information about the status of the local L2.</p>
<p>The default port of the L1 JSON-RPC is 8545 you can test it by running</p>
<pre><code class="language-sh">rex block-number http://localhost:8545
</code></pre>
<p>The default port of the L2 JSON-RPC is 1729 you can test it by running</p>
<pre><code class="language-sh">rex block-number http://localhost:1729
</code></pre>
<h2 id="guides"><a class="header" href="#guides">Guides</a></h2>
<p>For more information on how to perform certain operations, go to <a href="developers/l2/">Guides</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="running-integration-tests"><a class="header" href="#running-integration-tests">Running integration tests</a></h1>
<p>In this section, we will explain how to run integration tests for ethrex L2 with the objective of validating the correct functioning of our stack in our releases. For this, we will use ethrex as a local L2 dev node.</p>
<h2 id="prerequisites-20"><a class="header" href="#prerequisites-20">Prerequisites</a></h2>
<ul>
<li>Install the latest ethrex release or pre-release binary following the instructions in the <a href="https://docs.ethrex.xyz/getting-started/installation/binary_distribution.html">Install ethrex (binary distribution)</a> section.</li>
<li>For running the tests, you'll need a fresh clone of <a href="https://github.com/lambdaclass/ethrex/">ethrex</a>.</li>
<li>(Optional for troubleshooting)
<ul>
<li>An Ethereum utility tool like <a href="https://github.com/lambdaclass/rex">rex</a>.</li>
<li><a href="https://jqlang.org/download/"><code>jq</code></a> for JSON processing.</li>
<li><a href="https://curl.se/download.html"><code>curl</code></a> for making HTTP requests.</li>
</ul>
</li>
</ul>
<h2 id="setting-up-the-environment"><a class="header" href="#setting-up-the-environment">Setting up the environment</a></h2>
<p>Our integration tests assume that there is an ethrex L1 node, an ethrex L2 node, and an ethrex L2 prover up and running. So before running them, we need to start the nodes.</p>
<h3 id="running-ethrex-l2-dev-node"><a class="header" href="#running-ethrex-l2-dev-node">Running ethrex L2 dev node</a></h3>
<p>For this, we are using the <code>ethrex l2 --dev</code> command, which does this job for us. In one console, run the following:</p>
<pre><code class="language-shell">./ethrex l2 --dev \
--committer.commit-time 150000 \
--block-producer.block-time 1000 \
--block-producer.base-fee-vault-address 0x000c0d6b7c4516a5b274c51ea331a9410fe69127 \
--block-producer.operator-fee-vault-address 0xd5d2a85751b6F158e5b9B8cD509206A865672362 \
--block-producer.l1-fee-vault-address 0x45681AE1768a8936FB87aB11453B4755e322ceec \
--block-producer.operator-fee-per-gas 1000000000 \
--no-monitor
</code></pre>
<p>Read the note below for explanations about the flags used.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>ethrex's MPT implementation is path-based, and the database commit threshold is set to <code>128</code>. In simple words, the latter implies that the database only stores the state 128 blocks before the current one (e.g., if the current block is block 256, then the database stores the state at block 128), while the state of the blocks within lives in in-memory diff layers (which are lost during node shutdowns).
In ethrex L2, this has a direct impact since if our sequencer seals batches with more than 128 blocks, it won't be able to retrieve the state previous to the first block of the batch being sealed because it was pruned; therefore, it won't be able to create new batches to send to L1.
To solve this, after a batch is sealed, we create a checkpoint of the database at that point to ensure the state needed at the time of commitment is available for the sequencer.
For this test to be valuable, we need to ensure this edge case is covered. To do so, we set up an L2 with batches of approximately 150 blocks. We achieve this by setting the flag <code>--block-producer.block-time</code> to 1 second, which specifies the interval in milliseconds for our builder to build an L2 block. This means the L2 block builder will build blocks every 1 second. We also set the flag <code>--committer.commit-time</code> to 150 seconds (2 minutes and 30 seconds), which specifies the interval in milliseconds in which we want to commit to the L1. This ensures that enough blocks are included in each batch.
The L2's gas pricing mechanism is tested in the integration tests, so we need to set the following flags to ensure the L2 gas pricing mechanism is active:</p>
<ul>
<li><code>--block-producer.base-fee-vault-address</code></li>
<li><code>--block-producer.operator-fee-vault-address</code></li>
<li><code>--block-producer.l1-fee-vault-address</code></li>
<li><code>--block-producer.operator-fee-per-gas</code></li>
</ul>
<p>Read more about ethrex L2 gas pricing mechanism <a href="https://docs.ethrex.xyz/l2/fundamentals/transaction_fees.html">here</a>.
We set the flag <code>--no-monitor</code> to disable the built-in monitoring dashboard since it is not needed for running the integration tests.</p>
</div>
<p>So far, we have an ethrex L1 and an ethrex L2 node up and running. We only miss the ethrex L2 prover, which we are going to spin up in <code>exec</code> mode, meaning that it won't generate ZK proofs.</p>
<h3 id="running-ethrex-l2-prover"><a class="header" href="#running-ethrex-l2-prover">Running ethrex L2 prover</a></h3>
<p>In another terminal, run the following to spin up an ethrex L2 prover in exec mode:</p>
<pre><code class="language-shell">./ethrex l2 prover \
--backend exec \
--proof-coordinators http://localhost:3900
</code></pre>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>The flag <code>--proof-coordinators</code> is used to specify one or more proof coordinator URLs. This is so because the prover is capable of proving ethrex L2 batches from multiple sequencers. We are particularly setting it to <code>localhost:3900</code> because the <code>ethrex l2 --dev</code> command uses the port <code>3900</code> for the proof coordinator by default.<br />
To see more about the proof coordinator, read the <a href="https://docs.ethrex.xyz/l2/architecture/sequencer.html#ethrex-l2-sequencer">ethrex L2 sequencer</a> and <a href="https://docs.ethrex.xyz/l2/architecture/prover.html#ethrex-l2-prover">ethrex L2 prover</a> sections.</p>
</div>
<h2 id="running-the-integration-tests"><a class="header" href="#running-the-integration-tests">Running the integration tests</a></h2>
<p>During the execution of <code>ethrex l2 --dev</code>, a <code>.env</code> file is created and filled with environment variables containing contract addresses. This <code>.env</code> file is always needed for dev environments, so we need it for running the integration tests. Therefore, before running the integration tests, copy the <code>.env</code> file into <code>ethrex/cmd</code>:</p>
<pre><code class="language-shell">cp .env ethrex/cmd
</code></pre>
<p>Finally, in another terminal (should be a third one at this point), change your current directory to <code>ethrex/crates/l2</code> and run:</p>
<pre><code class="language-shell">make test
</code></pre>
<h2 id="faq"><a class="header" href="#faq">FAQ</a></h2>
<h3 id="what-should-i-expect"><a class="header" href="#what-should-i-expect">What should I expect?</a></h3>
<p>Once you run <code>make test</code>, you should see the output of the tests being executed one after another. The tests will interact with the ethrex L2 node and the ethrex L2 prover that you started previously. If everything is set up correctly, all tests should pass successfully.</p>
<h3 id="how-long-do-the-tests-take-to-run"><a class="header" href="#how-long-do-the-tests-take-to-run">How long do the tests take to run?</a></h3>
<p>The current configuration of the L2 node (with a block time of 1 second and a commit time of 150 seconds) means that each batch will contain approximately 150 blocks. Given this setup, the integration tests typically take around 30 to 45 minutes to complete, depending the timing in which you performed the steps.</p>
<h3 id="i-think-my-tests-are-taking-too-long-how-can-i-debug-this"><a class="header" href="#i-think-my-tests-are-taking-too-long-how-can-i-debug-this">I think my tests are taking too long, how can I debug this?</a></h3>
<p>If your tests are taking significantly longer than expected, you are likely watching the <code>Retrying to get message proof for tx ...</code> counter in the tests terminal increase without progressing. Let's unveil what is happening here. This message indicates that the transaction has been included in an L2 block, but that block has not yet been included in a batch. There's no current way to fairly estimate when the block including the transaction will be included in a batch, but we can see how far is the block from being included.</p>
<p>Using the hash of the transaction shown in the log message, you can check the status of the transaction using an Ethereum utility tool like <code>rex</code>. Run the following commands in a new terminal:</p>
<ol>
<li>Get the block number where the transaction was included (replace <code>&lt;TX_HASH&gt;</code> with the actual transaction hash):
<pre><code class="language-shell">rex l2 tx &lt;TX_HASH&gt;
</code></pre>
</li>
<li>As the block is assumed to not be included in a batch yet, we need to check which blocks have been included in the latest batch. <code>rex</code> does not have a command for this yet, so we will use <code>curl</code> to make a JSON-RPC call to the ethrex L2 node. Run the following command:
<pre><code class="language-shell">curl -X POST http://localhost:1729 \
-H "Content-Type: application/json" \
-d '{
"jsonrpc":"2.0",
"method":"ethrex_batchNumber",
"params": [],
"id":1
}' | jq .result
</code></pre>
</li>
<li>Once you have the batch number, you can get the range of blocks included in that batch by running the following command (replace <code>&lt;BATCH_NUMBER&gt;</code> with the actual batch number obtained in the previous step, in hex format, e.g., <code>0x1</code>):
<pre><code class="language-shell">curl -X POST http://localhost:1729 \
-H "Content-Type: application/json" \
-d '{
    "jsonrpc":"2.0",
    "method":"ethrex_getBatchByNumber",
    "params": ["&lt;BATCH_NUMBER&gt;", false],
    "id":1
}' | jq .result.first_block,.result.last_block
</code></pre>
</li>
<li>Compare the block number obtained in step 1 with the range of blocks obtained in step 3 to see how far the block is from being included in a batch. To have a rough estimate, take into account the mean of blocks that are being included into the batches and consider that a batch is sealed approximately every 150 seconds (2 minutes and 30 seconds) based on the current configuration.</li>
</ol>
<h3 id="should-i-worry-about-the-periodic-warning-logs-of-the-l2-prover"><a class="header" href="#should-i-worry-about-the-periodic-warning-logs-of-the-l2-prover">Should I worry about the periodic warning logs of the L2 prover?</a></h3>
<p>Logs are being constantly improved to provide better clarity. However, during the execution of the integration tests, you might notice periodic warning logs from the L2 prover indicating that there are no new batches to prove. These warnings are expected behavior in this testing scenario and can be safely ignored.</p>
<h3 id="the-tests-are-failing-what-should-i-do"><a class="header" href="#the-tests-are-failing-what-should-i-do">The tests are failing, what should I do?</a></h3>
<p>If the tests are failing, first ensure that both the ethrex L2 node and the ethrex L2 prover are running correctly without any errors. Check their logs for any issues. If everything seems fine, try restarting both services and rerun the tests. Ensure that your configuration files (e.g., <code>.env</code>) are correctly set up and that all required environment variables are defined. If the problem persists, consider reaching out to the ethrex community or support channels for further assistance.</p>
<h3 id="how-do-i-run-the-tests-with-ethrex-running-from-docker"><a class="header" href="#how-do-i-run-the-tests-with-ethrex-running-from-docker">How do I run the tests with ethrex running from docker?</a></h3>
<p>To run the integration tests with ethrex running on Docker, pass <code>--net=host</code> to docker run so it binds all ports in <code>localhost</code>:</p>
<pre><code class="language-shell">docker run --net=host &lt;other_docker_flags&gt; ghcr.io/lambdaclass/ethrex:&lt;tag&gt;-l2 &lt;ethrex_flags&gt;
</code></pre>
<p>For <a href="developers/l2/integration-tests.html#running-ethrex-l2-dev-node">"Running ethrex L2 dev node"</a>, with the latest image, the full command would be:</p>
<pre><code class="language-shell">docker run --net=host ghcr.io/lambdaclass/ethrex:latest-l2 l2 --dev \
--committer.commit-time 150000 \
--block-producer.block-time 1000 \
--block-producer.base-fee-vault-address 0x000c0d6b7c4516a5b274c51ea331a9410fe69127 \
--block-producer.operator-fee-vault-address 0xd5d2a85751b6F158e5b9B8cD509206A865672362 \
--block-producer.l1-fee-vault-address 0x45681AE1768a8936FB87aB11453B4755e322ceec \
--block-producer.operator-fee-per-gas 1000000000 \
--no-monitor
</code></pre>
<p>For <a href="developers/l2/integration-tests.html#running-ethrex-l2-prover">"Running ethrex L2 prover"</a>, with the latest image, the full command would be:</p>
<pre><code class="language-shell">docker run --net=host ghcr.io/lambdaclass/ethrex:latest-l2 l2 prover \
--backend exec \
--proof-coordinators http://localhost:3900
</code></pre>
<h2 id="troubleshooting-3"><a class="header" href="#troubleshooting-3">Troubleshooting</a></h2>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>This is a placeholder for future troubleshooting tips.
Please report any issues you encounter while running the integration tests to help us improve this section.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="running-the-prover"><a class="header" href="#running-the-prover">Running the Prover</a></h1>
<p>This guide provides instructions for setting up and running the Ethrex L2 prover for development and testing purposes.</p>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<p>Before you begin, ensure you have the following dependencies installed:</p>
<ul>
<li><a href="https://dev.risczero.com/api/zkvm/install">RISC0</a>
<ol>
<li><code>curl -L https://risczero.com/install | bash</code></li>
<li><code>rzup install</code></li>
</ol>
</li>
<li><a href="https://docs.succinct.xyz/docs/sp1/introduction">SP1</a>
<ol>
<li><code>curl -L https://sp1up.succinct.xyz | bash</code></li>
<li><code>sp1up --version 5.0.8</code></li>
</ol>
</li>
<li><a href="https://docs.soliditylang.org/en/latest/installing-solidity.html">SOLC (v0.8.31)</a></li>
</ul>
<p>After installing the toolchains, a quick test can be performed to check if we have everything installed correctly.</p>
<h3 id="l1-block-proving"><a class="header" href="#l1-block-proving">L1 block proving</a></h3>
<p>ethrex-prover is able to generate execution proofs of Ethereum Mainnet/Testnet blocks. An example binary was created for this purpose in <code>crates/l2/prover/bench</code>. Refer to its README for usage.</p>
<h2 id="dev-mode-2"><a class="header" href="#dev-mode-2">Dev Mode</a></h2>
<p>To run the blockchain (<code>proposer</code>) and prover in conjunction, start the <code>Prover</code>, use the following command:</p>
<pre><code class="language-sh">make init-prover-&lt;sp1|risc0|exec&gt; # optional: GPU=true
</code></pre>
<h3 id="run-the-whole-system-with-the-prover---in-one-machine"><a class="header" href="#run-the-whole-system-with-the-prover---in-one-machine">Run the whole system with the prover - In one Machine</a></h3>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Used for development purposes.</p>
</div>
<ol>
<li><code>cd crates/l2</code></li>
<li><code>make rm-db-l2 &amp;&amp; make down</code>
<ul>
<li>It will remove any old database, if present, stored in your computer. The absolute path of SQL is defined by <a href="https://docs.rs/dirs/latest/dirs/fn.datadir.html">datadir</a>.</li>
</ul>
</li>
<li><code>make init</code>
<ul>
<li>Make sure you have the <code>solc</code> compiler installed in your system.</li>
<li>Init the L1 in a docker container on port <code>8545</code>.</li>
<li>Deploy the needed contracts for the L2 on the L1.</li>
<li>Start the L2 locally on port <code>1729</code>.</li>
</ul>
</li>
<li>In a new terminal → <code>make init-prover-&lt;sp1|risc0|exec&gt; # GPU=true</code>.</li>
</ol>
<p>After this initialization we should have the prover running in <code>dev_mode</code> → No real proofs.</p>
<h2 id="gpu-mode"><a class="header" href="#gpu-mode">GPU mode</a></h2>
<p><strong>Steps for Ubuntu 22.04 with Nvidia A4000:</strong></p>
<ol>
<li>Install <code>docker</code> → using the <a href="https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository">Ubuntu apt repository</a>
<ul>
<li>Add the <code>user</code> you are using to the <code>docker</code> group → command: <code>sudo usermod -aG docker $USER</code>. (needs reboot, doing it after CUDA installation)</li>
<li><code>id -nG</code> after reboot to check if the user is in the group.</li>
</ul>
</li>
<li>Install <a href="https://www.rust-lang.org/tools/install">Rust</a></li>
<li>Install <a href="https://dev.risczero.com/api/zkvm/install">RISC0</a></li>
<li>Install <a href="https://developer.nvidia.com/cuda-downloads?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=Ubuntu&amp;target_version=22.04&amp;target_type=deb_local">CUDA for Ubuntu</a>
<ul>
<li>Install <code>CUDA Toolkit Installer</code> first. Then the <code>nvidia-open</code> drivers.</li>
</ul>
</li>
<li>Reboot</li>
<li>Run the following commands:</li>
</ol>
<pre><code class="language-sh">sudo apt-get install libssl-dev pkg-config libclang-dev clang
echo 'export PATH=/usr/local/cuda/bin:$PATH' &gt;&gt; ~/.bashrc
echo 'export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH' &gt;&gt; ~/.bashrc
</code></pre>
<h3 id="run-the-whole-system-with-a-gpu-prover"><a class="header" href="#run-the-whole-system-with-a-gpu-prover">Run the whole system with a GPU Prover</a></h3>
<p>Two separate machines are recommended for running the <code>Prover</code> and the <code>sequencer</code> to avoid resource contention. However, for development, you can run them in two separate terminals on the same machine.</p>
<ul>
<li><strong>Machine 1 (or Terminal 1)</strong>: For the <code>Prover</code> (GPU is recommended).</li>
<li><strong>Machine 2 (or Terminal 2)</strong>: For the <code>sequencer</code>/L2 node.</li>
</ul>
<ol>
<li>
<p><strong><code>Prover</code>/<code>zkvm</code> Setup</strong></p>
<ol>
<li><code>cd ethrex/crates/l2</code></li>
<li>You can set the following environment variables to configure the prover:
<ul>
<li><code>PROVER_CLIENT_PROVER_SERVER_ENDPOINT</code>: The address of the server where the client will request the proofs from.</li>
<li><code>PROVER_CLIENT_PROVING_TIME_MS</code>: The amount of time to wait before requesting new data to prove.</li>
</ul>
</li>
<li>To start the <code>Prover</code>/<code>zkvm</code>, run:
<pre><code class="language-sh">make init-prover-&lt;sp1|risc0|exec&gt; # optional: GPU=true
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong><code>ProofCoordinator</code>/<code>sequencer</code> Setup</strong></p>
<ol>
<li><code>cd ethrex/crates/l2</code></li>
<li>Create a <code>.env</code> file with the following content:
<pre><code class="language-env"># Should be the same as ETHREX_COMMITTER_L1_PRIVATE_KEY and ETHREX_WATCHER_L2_PROPOSER_PRIVATE_KEY
ETHREX_DEPLOYER_L1_PRIVATE_KEY=&lt;private_key&gt;
# Should be the same as ETHREX_COMMITTER_L1_PRIVATE_KEY and ETHREX_DEPLOYER_L1_PRIVATE_KEY
ETHREX_WATCHER_L2_PROPOSER_PRIVATE_KEY=&lt;private_key&gt;
# Should be the same as ETHREX_WATCHER_L2_PROPOSER_PRIVATE_KEY and ETHREX_DEPLOYER_L1_PRIVATE_KEY
ETHREX_COMMITTER_L1_PRIVATE_KEY=&lt;private_key&gt;
# Should be different from ETHREX_COMMITTER_L1_PRIVATE_KEY and ETHREX_WATCHER_L2_PROPOSER_PRIVATE_KEY
ETHREX_PROOF_COORDINATOR_L1_PRIVATE_KEY=&lt;private_key&gt;
# Used to handle TCP communication with other servers from any network interface.
ETHREX_PROOF_COORDINATOR_LISTEN_ADDRESS=0.0.0.0
# Set to true to randomize the salt.
ETHREX_DEPLOYER_RANDOMIZE_CONTRACT_DEPLOYMENT=true
# Set to true if you want SP1 proofs to be required
ETHREX_L2_SP1=true
# Check the if the verification contract is present on your preferred network. Don't define this if you want it to be deployed automatically.
ETHREX_DEPLOYER_SP1_VERIFIER_ADDRESS=&lt;address&gt;
# Set to true if you want proofs to be required
ETHREX_L2_RISC0=true
# Check the if the contract is present on your preferred network. You shall deploy it manually if not.
ETHREX_DEPLOYER_RISC0_VERIFIER_ADDRESS=&lt;address&gt;
# Set to any L1 endpoint.
ETHREX_ETH_RPC_URL=&lt;url&gt;
</code></pre>
</li>
<li><code>source .env</code></li>
</ol>
</li>
</ol>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Make sure to have funds, if you want to perform a quick test <code>0.2[ether]</code> on each account should be enough.</p>
</div>
<ul>
<li>
<p><code>Finally</code>, to start the <code>proposer</code>/<code>l2 node</code>, run:</p>
<ul>
<li><code>make rm-db-l2 &amp;&amp; make down</code></li>
<li><code>make deploy-l1 &amp;&amp; make init-l2</code> (if running a risc0 prover, see the next step before invoking the L1 contract deployer)</li>
</ul>
</li>
<li>
<p>If running with a local L1 (for development), you will need to manually deploy the risc0 contracts by following the instructions <a href="https://github.com/risc0/risc0-ethereum/tree/main/contracts/script">here</a>.</p>
</li>
<li>
<p>For a local L1 running with ethrex, we do the following:</p>
<ol>
<li>clone the risc0-ethereum repo</li>
<li>edit the <code>risc0-ethereum/contracts/deployment.toml</code> file by adding
<pre><code class="language-toml">[chains.ethrex]
name = "Ethrex local devnet"
id = 9
</code></pre>
</li>
<li>export env. variables (we are using an ethrex's rich L1 account)
<pre><code class="language-bash">export VERIFIER_ESTOP_OWNER="0x4417092b70a3e5f10dc504d0947dd256b965fc62"
export DEPLOYER_PRIVATE_KEY="0x941e103320615d394a55708be13e45994c7d93b932b064dbcb2b511fe3254e2e"
export DEPLOYER_ADDRESS="0x4417092b70a3e5f10dc504d0947dd256b965fc62"
export CHAIN_KEY="ethrex"
export RPC_URL="http://localhost:8545"

export ETHERSCAN_URL="dummy"
export ETHERSCAN_API_KEY="dummy"
</code></pre>
the last two variables need to be defined with some value even if not used, else the deployment script fails.</li>
<li>cd into <code>risc0-ethereum/</code></li>
<li>run the deployment script
<pre><code class="language-bash">bash contracts/script/manage DeployEstopGroth16Verifier --broadcast
</code></pre>
</li>
<li>if the deployment was successful you should see the contract address in the output of the command, you will need to pass this as an argument to the L2 contract deployer, or via the <code>ETHREX_DEPLOYER_RISC0_VERIFIER_ADDRESS=&lt;address&gt;</code> env. variable.
if you get an error like <code>risc0-ethereum/contracts/../lib/forge-std/src/Script.sol": No such file or directory (os error 2)</code>, try to update the git submodules (foundry dependencies) with <code>git submodule update --init --recursive</code>.</li>
</ol>
</li>
</ul>
<h2 id="configuration-5"><a class="header" href="#configuration-5">Configuration</a></h2>
<p>Configuration is done through environment variables or CLI flags.
You can see a list of available flags by passing <code>--help</code> to the CLI, or checkout <a href="developers/l2/../../CLI.html">CLI</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="generate-blobs-for-the-state-reconstruction-test"><a class="header" href="#generate-blobs-for-the-state-reconstruction-test">Generate blobs for the state reconstruction test</a></h1>
<p>The test in <code>crates/l2/tests/state_reconstruct.rs</code> replays a fixed set of blobs to reconstruct. The fixtures need to be regenerated whenever the genesis file changes, because a new genesis alters the hash of the very first block and, by extension, all descendant blocks. Our stored blobs encode parent pointers, so stale hashes make the fixtures unusable. If you ever need to regenerate those blobs, you need to change the files <code>payload_builder.rs</code> and <code>l1_committer.rs</code> and run the sequencer to capture fresh blobs.</p>
<h2 id="summary-4"><a class="header" href="#summary-4">Summary</a></h2>
<ol>
<li>Limit every block to ten transactions to make the batches predictable.</li>
<li>Store each blob locally whenever the committer submits a batch.</li>
<li>Run the dev stack long enough to capture six blobs and move them into <code>fixtures/blobs/</code>.</li>
</ol>
<h2 id="1-cap-block-payloads-at-10-transactions"><a class="header" href="#1-cap-block-payloads-at-10-transactions">1. Cap block payloads at 10 transactions</a></h2>
<p>Edit <code>crates/l2/sequencer/block_producer/payload_builder.rs</code> and, inside the <code>fill_transactions</code> loop, add the early exit that forces every L2 block to contain at most ten transactions:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>if context.payload.body.transactions.len() &gt;= 10 {
    println!("Reached max transactions per block limit");
    break;
}
<span class="boring">}</span></code></pre></pre>
<p>That guarantees we have transactions in each block for at least 6 batches.</p>
<h2 id="2-persist-every-blob-locally-when-the-committer-sends-a-batch"><a class="header" href="#2-persist-every-blob-locally-when-the-committer-sends-a-batch">2. Persist every blob locally when the committer sends a batch</a></h2>
<p>Still in the sequencer, open <code>crates/l2/sequencer/l1_committer.rs</code>:</p>
<ul>
<li>
<p>Add this helper function:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn store_blobs(blobs: Vec&lt;Blob&gt;, current_blob: u64) {
    let blob = blobs.first().unwrap();
    fs::write(format!("{current_blob}-1.blob"), blob).unwrap();
}
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p>At the end of <code>send_commitment</code> (after logging the transaction hash) dump the blob that was just submitted:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Rest of the code ...
info!("Commitment sent: {commit_tx_hash:#x}");
store_blobs(batch.blobs_bundle.blobs.clone(), batch.number);
Ok(commit_tx_hash)  ```

<span class="boring">}</span></code></pre></pre>
</li>
</ul>
<p>Running the node with the deposits of the rich accounts will create <code>N-1.blob</code> files (you can move them into <code>fixtures/blobs/</code> afterwards).</p>
<h2 id="3-run-the-l2-and-capture-six-blobs"><a class="header" href="#3-run-the-l2-and-capture-six-blobs">3. Run the L2 and capture six blobs</a></h2>
<p>Start the local L2 with a 20 seconds per commit so we have at least 6 batches with transactions:</p>
<pre><code class="language-sh">COMPILE_CONTRACTS=true cargo run --release --bin ethrex --features l2,l2-sql -- l2 --dev --no-monitor --committer.commit-time 20000
</code></pre>
<p>In another terminal run:</p>
<pre><code class="language-sh">make init-prover-exec
</code></pre>
<p>Once the sequencer has produced six batches you will see six files named <code>1-1.blob</code> through <code>6-1.blob</code>. Copy them into <code>fixtures/blobs/</code> (overwriting the existing files).</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ethrex-prover-1"><a class="header" href="#ethrex-prover-1">ethrex-prover</a></h1>
<p>The prover leverages ethrex's stateless execution to generate zero-knowledge proofs of a block (or batch of blocks) execution. Stateless execution works by asking a synced node for an execution witness (the minimal state data needed to execute that block or batch) and using the L1 client code to re-execute it. See <a href="prover/prover.html#stateless-execution-and-execution-witness">Stateless execution</a> for more details.</p>
<p>The main interface to try the prover is <a href="prover/../ethrex_replay/ethrex_replay.html">ethrex-replay</a>, we also use it as a component of ethrex's L2 stack, to deploy zk-rollups or zk-validiums (a rollup publishes state information to L1 to reconstruct the L2 state if sequencing were to fail, a validium does not). Because of this the prover also supports some <a href="prover/prover.html#l2-specific-checks">L2 specific checks</a>.</p>
<h2 id="how-do-you-prove-block-execution"><a class="header" href="#how-do-you-prove-block-execution">How do you prove block execution?</a></h2>
<p>Now that general purpose zero-knowledge virtual machines (zkVMs) exist, most people have little trouble with the idea that you can prove execution. Just take the usual EVM code you wrote in Rust, compile to some zkVM target instead and you're mostly done. You can now prove it.</p>
<p>What's usually less clear is how you prove state. Let's say we want to prove a new L2 batch of blocks that were just built. Running the <code>ethrex</code> <code>execute_block</code> function on a Rust zkVM for all the blocks in the batch does the trick, but that only proves that you ran the VM correctly on <strong>some</strong> previous state/batch. How do you know it was the actual previous state of the L2 and not some other, modified one?</p>
<p>In other words, how do you ensure that:</p>
<ul>
<li>Every time the EVM <strong>reads</strong> from some account state or storage slot (think an account balance, some contract's bytecode), the value returned matches the actual value present on the previous state of the chain.</li>
<li>When all <strong>writes</strong> are done to account states or storage slots after execution, the final state matches what the (last executed) block header specified is the state at that block (the header contains the final state MPT root).</li>
</ul>
<h3 id="stateless-execution-and-execution-witness"><a class="header" href="#stateless-execution-and-execution-witness">Stateless execution and execution witness</a></h3>
<p>Ethrex implements a way to execute a block (or a batch of blocks) without having access to the entire blockchain state, but only the necessary subset for that particular execution. This subset is called the <em>execution witness</em>, and running a block this way is called <em>stateless execution</em> (stateless in the sense that you don't need a database with hundreds of gigabytes of the entire state data to execute).</p>
<p>The execution witness is composed of all MPT nodes which are relevant to the execution, so that for each read and write we have all the nodes that form a path from the root to the relevant leaf. This path is a proof that this particular value we read/wrote is part (or not) of the initial or final state MPT.</p>
<p>So, before initiating block execution, we can verify each proof for each state value read from. After execution, we can verify each proof for each state value written to. After these steps we authenticated all state data to two MPT root hashes (initial and final state roots), which later can be compared against reference values to check that the execution started from and arrived to the correct state. If you were to change a single bit, this comparison would fail.</p>
<h3 id="in-a-zkvm-environment"><a class="header" href="#in-a-zkvm-environment">In a zkVM environment</a></h3>
<p>After stateless execution was done, the initial and final state roots can be committed as public values of the zk proof. By verifying the proof we know that blocks were executed from an initial state and arrived into a final state, and we know the root hashes of the MPT of each one. If the initial root is what we expected (equal to the root of the latest validated state), then we trustlessly verified that the chain advanced its state correctly, and we can authenticate the new, valid state using the final state root.</p>
<p>By proving the execution of L2 blocks and verifying the zk proof (alongside with the initial state root) in an Ethereum smart contract validators attest the new state and the L2 inherits the security of Ethereum (assuming no bugs in the whole pipeline). This is the objective of an Ethereum L2.</p>
<p>Validators themselves could verify L1 block execution proofs to attest Ethereum instead of re-executing.</p>
<h2 id="l2-specific-checks"><a class="header" href="#l2-specific-checks">L2 specific checks</a></h2>
<p>Apart from stateless execution, the prover does some extra checks needed for L2 specific features.</p>
<h3 id="data-availability"><a class="header" href="#data-availability">Data availability</a></h3>
<p>Rollups publish state diffs as blob data to the L1 so that users can reconstruct the L2 state and rescue their funds if the sequencing were to fail or censors data. This published data needs to be part of the zk proof the prover generated. For this it calculates the valid state diffs and verifies a KZG proof, whose commitment can later be compared to the one published to the L1 using the <code>BLOBHASH</code> EVM opcode. See <a href="prover/../l2/fundamentals/data_availability.html">data availability</a> for more details.</p>
<h3 id="l1-l2-messaging"><a class="header" href="#l1-l2-messaging">L1&lt;-&gt;L2 messaging</a></h3>
<p>This is a fundamental feature of an L2, used mainly for bridging assets between the L1 and the L2 or between L2s using the ethrex stack. Messages need to be part of the proof to make sure the sequencer included them correctly.</p>
<p>Messages are compressed into a hash or a Merkle tree root which then are stored in an L1 contract together with the rest of the L2 state data. The prover retrieves the transactions or events that the messages produced in the L2, reconstructs the message data and recomputes the hashes or Merkle tree roots, which are then committed as a public input of the zk proof. At verification we can compare these hashes with the ones stored in the L1. This is the same concept used for state data.</p>
<p>For more details checkout <a href="prover/../l2/fundamentals/deposits.html">deposits</a> and <a href="prover/../l2/fundamentals/withdrawals.html">withdrawals</a></p>
<h2 id="see-also"><a class="header" href="#see-also">See also</a></h2>
<p><a href="prover/./guest_program.html">Guest program</a> for the detailed steps of the program that the prover generates a proof of.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ethrex-prover-guest-program"><a class="header" href="#ethrex-prover-guest-program">ethrex-prover guest program</a></h1>
<p>The guest program is the code that is compiled into a zkVM-compatible binary (e.g., RISC-V), to then generate a zero-knowledge proof of its execution.</p>
<h2 id="program-inputs"><a class="header" href="#program-inputs">Program inputs</a></h2>
<p>The inputs for the blocks execution program (also called prover inputs) are:</p>
<ul>
<li><code>blocks</code>: The blocks to be proven (header and body).</li>
<li><code>execution_witness</code>: A structure containing the necessary state data (like account and storage values with their Merkle proofs) required for the execution of the blocks. It includes the parent header of the first block.</li>
<li><code>elasticity_multiplier</code>: A parameter for block validation.</li>
<li><code>fee_configs</code>: L2-specific fee configurations for each block.</li>
<li><code>blob_commitment</code> and <code>blob_proof</code>: L2-specific data for verifying the state diff blob.</li>
</ul>
<p>These inputs are required for proof generation. The public values of the proof (also called program outputs), which are needed for proof verification, are:</p>
<ul>
<li><code>initial_state_hash</code>: The state root from the parent header of the first block.</li>
<li><code>final_state_hash</code>: The state root from the header of the last block.</li>
<li><code>l1messages_merkle_root</code>: The Merkle root of L1 messages (withdrawals) generated during block execution.</li>
<li><code>privileged_transactions_hash</code>: A hash representing all privileged transactions processed in the blocks.</li>
<li><code>blob_versioned_hash</code>: The versioned hash of the state diff blob, derived from its KZG commitment.</li>
<li><code>last_block_hash</code>: The hash of the last block in the batch.</li>
<li><code>chain_id</code>: The chain ID of the network.</li>
<li><code>non_privileged_count</code>: The number of non-privileged transactions in the batch.</li>
</ul>
<h2 id="blocks-execution-program"><a class="header" href="#blocks-execution-program">Blocks execution program</a></h2>
<p>The program leverages <code>ethrex-common</code> primitives and <code>ethrex-vm</code> methods. <code>ethrex-prover</code> implements a program that uses the existing execution logic and generates a proof of its execution using a zkVM. Some L2-specific logic and input validation are added on top of the basic blocks execution.</p>
<p>The following sections outline the steps taken by the execution program.</p>
<h3 id="prelude-1-state-trie-basics"><a class="header" href="#prelude-1-state-trie-basics">Prelude 1: state trie basics</a></h3>
<p>We recommend learning about Merkle Patricia Tries (MPTs) to better understand this section.</p>
<p>Each executed block transitions the Ethereum state from an initial state to a final state. State values are stored in MPTs:</p>
<ol>
<li>Each account has a Storage Trie containing its storage values.</li>
<li>The World State Trie contains all account information, including each account's storage root hash (linking storage tries to the world trie).</li>
</ol>
<p>Hashing the root node of the world state trie generates a unique identifier for a particular Ethereum state, known as the "state hash".</p>
<p>There are two kinds of MPT proofs:</p>
<ol>
<li>Inclusion proofs: Prove that <code>key: value</code> is a valid entry in the MPT with root hash <code>h</code>.</li>
<li>Exclusion proofs: Prove that <code>key</code> does not exist in the MPT with root hash <code>h</code>.
These proofs allow verifying that a value is included (or its key doesn't exist) in a specific state.</li>
</ol>
<h3 id="prelude-2-privileged-transactions-l1-messages-and-state-diffs"><a class="header" href="#prelude-2-privileged-transactions-l1-messages-and-state-diffs">Prelude 2: privileged transactions, L1 messages and state diffs</a></h3>
<p>These three components are specific additions for ethrex's L2 protocol, layered on top of standard Ethereum execution logic. They each require specific validation steps within the program.</p>
<p>For more details, refer to <a href="prover/../l2/architecture/overview.html">Overview</a>, <a href="prover/../l2/fundamentals/withdrawals.html">Withdrawals</a>, and <a href="prover/../l2/fundamentals/state_diffs.html">State diffs</a>.</p>
<h3 id="step-1-initial-state-validation"><a class="header" href="#step-1-initial-state-validation">Step 1: initial state validation</a></h3>
<p>The program validates the initial state by converting the <code>ExecutionWitness</code> into a <code>GuestProgramState</code> and verifying that its trie structure correctly represents the expected state. This involves checking that the calculated state trie root hash matches the initial state hash (obtained from the first block's parent block header).</p>
<p>The validation happens in several steps:</p>
<ol>
<li>The <code>ExecutionWitness</code> (collected during pre-execution) is converted to <code>GuestProgramState</code>.</li>
<li>A <code>GuestProgramStateWrapper</code> is created to provide database functionality.</li>
<li>For each state value in the database (account state and storage slots), the program verifies merkle proofs of the inclusion (or exclusion, in the case of accounts that didn't exist before this batch) of the value in the state trie</li>
<li>The state trie root is compared against the first block's parent state root.</li>
</ol>
<p>This validation ensures that all state values needed for execution are properly linked to the initial state via their MPT proofs. Having the initial state proofs (paths from the root to each relevant leaf) is equivalent to having a relevant subset of the world state trie and storage tries - a set of "pruned tries". This allows operating directly on these pruned tries (adding, removing, modifying values) during execution.</p>
<h3 id="step-2-blocks-execution"><a class="header" href="#step-2-blocks-execution">Step 2: blocks execution</a></h3>
<p>After validating the initial state, the program executes the blocks sequentially. This leverages the existing <code>ethrex-vm</code> execution logic. For each block, it performs validation checks and then executes the transactions within it. State changes from each block are applied before executing the next one.</p>
<h3 id="step-3-final-state-validation"><a class="header" href="#step-3-final-state-validation">Step 3: final state validation</a></h3>
<p>During execution, state values are updated (modified, created, or removed). After executing all blocks, the program calculates the final state by applying all state updates to the initial pruned tries.</p>
<p>Applying the updates results in a new world state root node for the pruned tries. Hashing this node yields the calculated final state hash. The program then verifies that this calculated hash matches the expected final state hash (from the last block header), thus validating the final state.</p>
<h3 id="step-4-privileged-transactions-hash-calculation"><a class="header" href="#step-4-privileged-transactions-hash-calculation">Step 4: privileged transactions hash calculation</a></h3>
<p>After execution and final state validation, the program calculates a hash encompassing all privileged transactions (like L1 to L2 deposits) processed within the blocks. This hash is committed as a public input, required for verification on the L1 bridge contract.</p>
<h3 id="step-5-l1-messages-merkle-root-calculation"><a class="header" href="#step-5-l1-messages-merkle-root-calculation">Step 5: L1 messages Merkle root calculation</a></h3>
<p>Similarly, the program constructs a binary Merkle tree of all L2-&gt;L1 messages (withdrawals) initiated in the blocks and calculates its root hash. This hash is also committed as a public input. Later, L1 accounts can claim their withdrawals by providing a Merkle proof of inclusion that validates against this root hash on the L1 bridge contract.</p>
<h3 id="step-6-state-diff-calculation-and-commitment"><a class="header" href="#step-6-state-diff-calculation-and-commitment">Step 6: state diff calculation and commitment</a></h3>
<p>Finally, the program calculates the state diffs (changes between initial and final state) intended for publication to L1 as blob data. It then verifies the provided <code>blob_commitment</code> and <code>blob_proof</code> against the calculated state diff. The resulting <code>blob_versioned_hash</code> (derived from the KZG commitment) is committed as a public input for verification on the L1 contract.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="rich-accounts"><a class="header" href="#rich-accounts">Rich Accounts</a></h1>
<p>When running ethrex in dev mode (<code>ethrex --dev</code> and <code>ethrex l2 --dev</code>), a bunch of rich accounts are available to make testing of contracts and transactions easy. These are the private keys</p>
<pre><code>0x941e103320615d394a55708be13e45994c7d93b932b064dbcb2b511fe3254e2e (0x4417092B70a3E5f10Dc504d0947DD256B965fc62)
0xbcdf20249abf0ed6d944c0288fad489e33f66b3960d9e6229c1cd214ed3bbe31 (0x8943545177806ED17B9F23F0a21ee5948eCaa776)
0x39725efee3fb28614de3bacaffe4cc4bd8c436257e2c8bb887c4b5c4be45e76d (0xE25583099BA105D9ec0A67f5Ae86D90e50036425)
0x53321db7c1e331d93a11a41d16f004d7ff63972ec8ec7c25db329728ceeb1710 (0x614561D2d143621E126e87831AEF287678B442b8)
0xab63b23eb7941c1251757e24b3d2350d2bc05c3c388d06f8fe6feafefb1e8c70 (0xf93Ee4Cf8c6c40b329b0c0626F28333c132CF241)
0x5d2344259f42259f82d2c140aa66102ba89b57b4883ee441a8b312622bd42491 (0x802dCbE1B1A97554B4F50DB5119E37E8e7336417)
0x27515f805127bebad2fb9b183508bdacb8c763da16f54e0678b16e8f28ef3fff (0xAe95d8DA9244C37CaC0a3e16BA966a8e852Bb6D6)
0x7ff1a4c1d57e5e784d327c4c7651e952350bc271f156afb3d00d20f5ef924856 (0x2c57d1CFC6d5f8E4182a56b4cf75421472eBAEa4)
0x3a91003acaf4c21b3953d94fa4a6db694fa69e5242b2e37be05dd82761058899 (0x741bFE4802cE1C4b5b00F9Df2F5f179A1C89171A)
0xbb1d0f125b4fb2bb173c318cdead45468474ca71474e2247776b2b4c0fa2d3f5 (0xc3913d4D8bAb4914328651C2EAE817C8b78E1f4c)
0x850643a0224065ecce3882673c21f56bcf6eef86274cc21cadff15930b59fc8c (0x65D08a056c17Ae13370565B04cF77D2AfA1cB9FA)
0x94eb3102993b41ec55c241060f47daa0f6372e2e3ad7e91612ae36c364042e44 (0x3e95dFbBaF6B348396E6674C7871546dCC568e56)
0xdaf15504c22a352648a71ef2926334fe040ac1d5005019e09f6c979808024dc7 (0x5918b2e647464d4743601a865753e64C8059Dc4F)
0xeaba42282ad33c8ef2524f07277c03a776d98ae19f581990ce75becb7cfa1c23 (0x589A698b7b7dA0Bec545177D3963A2741105C7C9)
0x3fd98b5187bf6526734efaa644ffbb4e3670d66f5d0268ce0323ec09124bff61 (0x4d1CB4eB7969f8806E2CaAc0cbbB71f88C8ec413)
0x5288e2f440c7f0cb61a9be8afdeb4295f786383f96f5e35eb0c94ef103996b64 (0xF5504cE2BcC52614F121aff9b93b2001d92715CA)
0xf296c7802555da2a5a662be70e078cbd38b44f96f8615ae529da41122ce8db05 (0xF61E98E7D47aB884C244E39E031978E33162ff4b)
0xbf3beef3bd999ba9f2451e06936f0423cd62b815c9233dd3bc90f7e02a1e8673 (0xf1424826861ffbbD25405F5145B5E50d0F1bFc90)
0x6ecadc396415970e91293726c3f5775225440ea0844ae5616135fd10d66b5954 (0xfDCe42116f541fc8f7b0776e2B30832bD5621C85)
0xa492823c3e193d6c595f37a18e3c06650cf4c74558cc818b16130b293716106f (0xD9211042f35968820A3407ac3d80C725f8F75c14)
0xc5114526e042343c6d1899cad05e1c00ba588314de9b96929914ee0df18d46b2 (0xD8F3183DEF51A987222D845be228e0Bbb932C222)
0x04b9f63ecf84210c5366c66d68fa1f5da1fa4f634fad6dfc86178e4d79ff9e59 (0xafF0CA253b97e54440965855cec0A8a2E2399896)
0x00f3c6e26fe106334befc354dcf4a08d2d947625f6968920759ec6630de1c3a3 (0x0002869e27c6FaEe08cCA6b765a726E7a076Ee0F)
0x029227c59d8967cbfec97cffa4bcfb985852afbd96b7b5da7c9a9a42f92e9166 (0x000130badE00212bE1AA2F4aCFe965934635C9cD)
0x031f8b6155ab7f04aa6d5cd424bfc1c3ad65f911ced9e1f863c9bc118eb5228d (0x000a523148845bEe3EE1e9F83df8257a1191C85B)
0x0480559965a26c68396f8d76957d86bcf41d4798d6354a213d67d3c77ab9dd02 (0x0001E8Ff6406a7cd9071F46B8255Db6C16178448)
0x05ec2a3cbcee946efc4a581d508c13bfc1fe2c40410a018b859319ffbb81b741 (0x000f2AbaA7581fAA2ad5C82b604C77ef68c3eAD9)
0x060a9e0d4ee57e31c7b5f8c0496dd9ef7412917d0b430987ff17e7df59348f08 (0x00057714949aD700733C5b8E6cF3e8c6B7D228a2)
0x07794b7d64b91127316f6ffcdaddd797bcd9bd826f64d09e400e1d0a9b63c672 (0x000798832bb08268dB237898b95A8DaE9D58b62c)
0x08372a029a6d3026d62d7a1afc40e487d2a95ac4558d8f5745b8f76ee2aebba1 (0x00002132cE94eEfB06eB15898C1AABd94feb0AC2)
0x08f7bd756bf8bf0aae93401c44ad6f8a059c6ee8b6bbcb8b67f71d437f4bbe0f (0x000b681738e1f8aF387c41b2b1f0A04E0C33e9DB)
0x098622f6492b1986dba92341fd8b1886f5059f45573ee5e7d8deda1e18057f13 (0x000E90875aC71eD46A11dc1b509d2B35E2c9C31F)
0x09f3b5d7a1b8e0c141d47c585170eaeda2deeef8fe8d548946e31e39e6557d97 (0x0005f132597da3152a6Da6beDB7C10bcC9B1B7f5)
0x0ae566c7c3db3611107b876eff2dd4a27e6513642bcd4fab418a7595a14240e4 (0x000D06C23EeD09A7Fa81cADd7eD5C783E8a25635)
0x0f718cb64094032dfa5051446704ae6706744330784fb4dbc1bae22581a2de05 (0x000c877a5D9b9De61e5318B3f4330c56ecdC0865)
0x113771bcca4d3ce8ad9f896a4d07114abf97c68a01b2401f4a0659dcb825a7d6 (0x000fA71E446e1EcFd74d835b5bD6fA848A770d26)
0x1587881856d95ab64fb8470f46fd1d8ee0c3e1a7298de9da82e9d74dd24e9601 (0x000d0576AdEf7083d53F6676bfc7c30d03b6Db1B)
0x174d4a903e9e9fe1bccf4fc56218ca463edce7e26f7a7a1c3d1ac76f28e38a7d (0x000E3388598A0534275104Ad44745620AF31EC7E)
0x175c219128dc61f8b96df198d35f52936343d42f0b71bc8c6eb3b4c00d41eae4 (0x0007514395022786B59ff91408692462C48d872c)
0x179d83566464d67417493a54f6b1a164153be0515adb1a83309d1c255e63ed5b (0x000F76B2Fe7cCC13474de28586A877664EBA16B4)
0x17bb02f6d7d7a00282db9ab76c2384afd7219352c8149f9abc92416d42fe7d4d (0x000F7cFBa0B176Afc2eBadA9d4764d2eA6BBC5a1)
0x180ba7fc7455b07afdf408722b32945e018ed2d5b6865915c185c733ab1f3459 (0x000b59AeD48ADCd6c36Ae5f437AbB9CA730a2c43)
0x19668868eaffec5a2fdeae892e51bffdba2ce033f42181fdb999cfb55483256f (0x00087C666bf7f52758DE186570979C4C79747157)
0x1a48fc41c5bff2f5ab755fad70eafb0d92c7aa4b176752ce36b974c611475c74 (0x000C47c771A8db282eC233b28AD8525dc74D13FE)
0x1bc8b78019f35d4447a774e837d414a3db9e1dea5cfc4e9dc2fc3904969ab51f (0x00044cbfb4Ef6054667994C37c0fe0B6BB639718)
0x1f7918165177ac75620e17524b261329a26d23ae67e6ad4bbe064a25d265dd3f (0x0005E815c1A3F40011Bd70C76062bbcBc51c546B)
0x24805dc4d67e7d1d518227607544b663435b6db0398968024b222ff886884712 (0x0003E72436Ff296B3d39339784499D021b72Aca5)
0x255e46ec0e4051f97108915628d3414f379da711a70741f5c4574e23811ae71a (0x00031dE95353DeE86dc9B1248e825500DE0B39aF)
0x27240f4892ad31223d97c2e40089e0d0069c3b8f40093f6265dce69da2e25105 (0x000511B42328794337D8b6846E5cFFef30c2d77A)
0x274442f0dabd2d7f8ce904e7f2616d9c10807e5856266d160bc6a89ec08150cf (0x000791D3185781e14eBb342E5df3BC9910f62E6F)
0x2875b9d5a0b251168ddae14d3e7491865f0a57c9fa4edc3cc1b2b253f978e9b3 (0x000883A40409Fa2193b698928459CB9E4DD5f8D8)
0x28aab647d7271fc200449ed8f42f4a16d6b23248cb91c02860642cfe95d0a27f (0x000055acf237931902ceBf4B905BF59813180555)
0x2bf2fe73d721086dde4fa564e3452fa8346d9b73badc58b331931c761c1c68d8 (0x000B05E15C62CBC266A4DD1804b017d1f6dB078b)
0x2c4cca9e2f73dc42c0fb35c785e1da6b3731979e5ec651f65d2ce62f12b8174d (0x000cE6740261E297FaD4c975D6D8F89f95C29add)
0x2e2f73b2cca221f5b7995cc0b703aae40598182c13ad83d0ee7ef9030f8f9535 (0x0000E101815A78EbB9FBBa34F4871aD32d5eb6CD)
0x2f409116f384216d02106ec9d73437ab056ce6665747668293a9359101f309c3 (0x000c95f1D83De53B76a0828F1bCdB1DfE12C0ab3)
0x31950b39d586c6d3e37bc37233880ab3266505165be34c628fe5ee6746a3afec (0x0003Ea7fDFCdb89E9ddAb0128ec5C628F8D09D45)
0x31c23065cd63d53ddfc3b0c0816dcfcef4646c72cc8e37315fee069d76c9db8a (0x00031470def99c1d4dfE1fd08DD7A8520Ce21DB7)
0x33e16098bd4020a1c57a980d578e0866785f009125d5c8d99b8cc5e8345e554d (0x000Df55E76cf6dfD9598DD2b54948dE937f50f2B)
0x37243a93a5717e19a933dd465ae911e00b270263903fcf78ecb318465275058c (0x000029bD811D292E7f1CF36c0FA08fd753C45074)
0x3991bd50444f2476e4d71ff594941b622a2492094a8117e519d9dd44314f5f62 (0x0006A070bAC6195b59d4bC7f73741DCBe4e16b5e)
0x3c0924743b33b5f06b056bed8170924ca12b0d52671fb85de1bb391201709aaf (0x000f1EB7F258D4A7683E5D0FC3C01058841DDC6f)
0x3d05b7d615ad30421a0e27e4641260ff48d8e8f5c4a4fa2fbd144f146584303e (0x000784B47aC2843419Df4cAd697d4e7b65CE1F93)
0x3e944a0db91bee398192fcd8e7f1b796416e6a4c329f8f74bb71742040866a86 (0x000541653a96ABAdDba52fAA8D118e570d529543)
0x401fdd734f1803715ba4b07505c7b4e557e5ed39af76e21c9d228ecb5a3837b8 (0x000e1a554572dd96fF3d1F2664832F3E4a66E7b7)
0x41443995d9eb6c6d6df51e55db2b188b12fe0f80d32817e57e11c64acff1feb8 (0x000425E97fC6692891876012824a210451cC06C4)
0x422674ecdc2167979b772269e42b890d46e0ece426718a70d321cf3659e2ad77 (0x0003dDe6f01e3B755e24891a5B0f2463BaD83e15)
0x4366847d055ff7eb7faeb6f818c95015b985d14d6ddfdfb26e494066fcc38519 (0x00094cc0653B52406170105F4eb96C5e2f31Ab74)
0x4458623aa1b3c87043fa01600d29cdc1652148536bb4fc5bffb6e953359cd40d (0x0006E80d584cbF9EB8C41CF2b009C607744a70F6)
0x46d73bc96b8138c33c5d2e5d4c40dc39554cb6da450c3a220fc5738f9b5afd6b (0x000635BCbB109781Cea0Cd53e9f1370Dbac9937f)
0x471c7b13744d5c0637df466a5eda148d97f484f20f907015db4e03159f4d1610 (0x000c2de896E4a92e796d6A9c1E4B01feB3e6Ed61)
0x474cc442ecc2fbc63890b5289382ed9f503bdbd7708b1bf8a5c9d62ba1c84289 (0x0001533C6C5b425815b2BaDdCdd42DFF3be04BCb)
0x4875a27ca99d78b38a5f7b25a512a5dd6474c476eff9c64f641bb39df2741c38 (0x000d35f8cd11bd989216b3669cBaac6fd8c07196)
0x488ed13eb34b7eb99985b8bcfd5f361c059a4b07d62220b50f7ef4f8d2b8f7bf (0x00021C20F3e68F930077Cca109Ca3C044E8B39bD)
0x49313fda2b97355cefc68fd4760672c565040c9a78dfc8dfc973c28d9f56826e (0x0002D79686DeF20a0aB43FEA4a41a1Ad56529621)
0x494ea60e318be249a6e7d6b99f045537089cd91c5271543058828b68446f12cc (0x000e06626Bb8618D9A1867362D46ddb1bF95ad75)
0x49e0796492218e9e971b18ba1612dcbab6bfac6795583f9f326f2e4586cb141f (0x000815A8A659a51A8EF01F02441947Ea99182568)
0x4bd0341e3ae366713a377b033e27c0cc70c21b64e616c8ee478e86c92ed2783a (0x000e65342176C7dac47bc75113F569695d6A113C)
0x4c2b88ba1146b2d18dcb8f2332bb697ff1ba27c47ce243107a6983d278cfe54d (0x0004Aa0442d0d43222431b3017912EC6a099771C)
0x4d636f9a9c60a4329360d48f6fdc4a2cdc40518af238e68bf59df3d31f9cef8a (0x00010AB05661Bfde304A4d884DF99d3011A83C54)
0x4e64d2cc477b31e0597fb4e3489c89777771b168cee98c8a4d2978c36e298ebb (0x000E5DE0a0175866d21F4Ec6c41F0422A05f14D6)
0x547ba217be53dfe01f7d6a4af1452f8e0ba7755ca43ba8bad731d3da77fe1de7 (0x0005C34d7B8b06CE8019C3Bb232dE82B2748A560)
0x553eaa0a8107daf55a8b198065e37d8ee231396a8819483f95da0a762633d8d0 (0x0008Bd31Ee6A758e168844cBEA107Ca4d87251aF)
0x556a4c63c314bf2a1734f34bcc2c45941b41afe3e4827d205092f3cc8d3ab11b (0x0004b0C6de796fD980554cc7ff7B062b3B5079E1)
0x5a10921bc5815991dd35f29b4a11177c10a1f3f0493f9b6baee20cb7a8187f4e (0x0001a2c749FE0Ab1C09f1131BA17530f9D764fBC)
0x5b959cd3e5eb4fdfb46d11d5e5891ecd9c66eae8e00d98f0d17f43657b16a9af (0x000305CD7184aB37fdd3D826B92A640218D09527)
0x5bb463c0e64039550de4f95b873397b36d76b2f1af62454bb02cf6024d1ea703 (0x0009aEFF154De37C8e02E83f93D2FeC5EC96f8a3)
0x5d3564ded68562c6fffe5a92a3ec540b015db1bde8744544012c95462f28b24a (0x0002AfCC1B0B608E86b5a1Dc45dE08184E629796)
0x5f332f1fa6c7c5773bba744dcc9027e07294c1a9a84c27caef8b89296db248fa (0x000882c5FbD315801e4C367BCB04dBD299B9F571)
0x63f6a20cc1d77dd3a602e43f564ca9b4d3b6da8a7227b052827542811c195071 (0x000f17eB09AA3f28132323E6075C672949526d5A)
0x658edfde371c42f7dbdafdb73b9d28b87fff929753f74eb7c9888c2f25b02ea6 (0x00025eea83bA285532F5054b238c938076833d13)
0x6650f803ba48956d66dc723673026b2fa1f932cdb9e2eaafd7fa33a872f1929b (0x00069dC0cc6b9d7B48B5348b12F625E8aB704104)
0x6a781d90721009565792b0429d474b12fdfa31aafbc3faec0d49585174f60dac (0x00032C03f3b02D816128Fb5D2752398E2919a03c)
0x6aeeda1e7eda6d618de89496fce01fb6ec685c38f1c5fccaa129ec339d33ff87 (0x000aC79590dCc656c00c4453f123AcBf10DBb086)
0x6c9c5b48ed5fea8389fd77cc2b83d3c0693eb0ee7ddd19dec8f86f928a33b345 (0x0005e37296348571bd3604f7E56B67a7022801f6)
0x6dbfe7f740aaedf790b92a6b694e1f8885aea1eb2661b349e513c3a3d8ee3487 (0x00030da862690D170F096074e9E8b38db7D6f037)
0x6de4602623b568df6fa9a4e06bb6a1548435633baae11ae286874b7ff6f8c22d (0x000279CB54E00B858774afEA4601034Db41c1A05)
0x6ded84f43b5c521bc7ac18b74c3f405e923a045fa814fa784b35d59cbf297270 (0x000688AA0fBfB3F1e6554A63dF13bE08cB671b3b)
0x6ef568220d33d8181ad89b82cbcfb8bb929949e5699a7e4af28f989e6862f8b5 (0x00075af7E665F3Ca4A4b05520CD6d5c13BbFEAf8)
0x6f6a26a8d3ca35c80bd9c9e48f2d043df9c3a18835ebf622735928e87de6fb91 (0x000E67E4b1A23A3826304099cb24f337c916CF4b)
0x6fbf0095f80c61a80b7908b4696f00336b53be0f2d975d92920d5c02ff595a46 (0x000701F7d594Fb146e4d1c71342012e48A788055)
0x70d20e53ec0f10409564c6a486fa92e905dc87f7dbcab159e367ecf70d94eae9 (0x0009Bf72AF31A4E6B8Ef6FbbFcb017823E4d2aF2)
0x75d7a0ff700a9e8844b7ad81578c4dfbe55c09d1c5dc3f4ab3bf95e8d0cb643c (0x000b4C43cce938dfD3420F975591Ee46D872C136)
0x78ccd4d2698c9967804a23b8e5df6ac980cfc4480c0be9c6d0ab07538f062b7f (0x000a3fC3BFD55b37025E6F4f57B0B6121F54e5bF)
0x7a738a3a8ee9cdbb5ee8dfc1fc5d97847eaba4d31fd94f89e57880f8901fa029 (0x000eA2e72065A2ceCA7f677Bc5E648279c2D843d)
0x7be5365bd828f6d6f686189330f10b7466adca1cd9da226556dfa677f39684b8 (0x000A073dAC5ec2058a0De0e175874D5E297E086E)
0x7d5fa86623f012ce3f1dab8db7ea6516c4105d43e0dc01af9efea9380bf2e92f (0x000e490f26249951F8527779399aa8F281509aC0)
0x7e3d5296f53c67e0c378944f2d909a7234b7ee584d355cd70daf685dbe74b5bf (0x0002d9b2a816717C4d70040D66A714795F9B27a4)
0x814987df97349c4939d5ac6bc7f4f4e245752313f09e5d16047f8fe0984f2d50 (0x000Ebf88AE1BA960B06b0a9bbE576baa3B72E92E)
0x827318914f784ef7fccf70df962ec8e67fc9da68d7490e37b3fc78a42bb916f7 (0x000Aa0154ed6560257d222B5dbE6ce4b66c48979)
0x82ca942cdf86f17c5d3271b4306afc7d5b70d717f12614a1a29f19beb88f6325 (0x000B9Ea41A9dF00b7ae597afc0D10AF42666081F)
0x843a15a6506faad9474eec6822a1bb76db6623522e0e2890731777f2bd78ba20 (0x0005c6BeD054FEad199D72C6f663fC6fBf996153)
0x844ea11663c3f05d6d99896538314a5e5a053fa06db7378f49d99053db2dc5dc (0x000c53b37fA4977B59FD3Efdb473D8069844aDeA)
0x890921816813f30aab7142df0dfda056ddf64e5da309394ec87f8a4666b2a7bc (0x000EBd066B6FEBB9d7f3B767DF06C08e369Dc20F)
0x8929c1621173bddc7dd2fbf6a4321af67b2b818eaf2d6c70080ee1cdb0a28783 (0x0001d0bAE8B1B9fe61d0B788E562A987813cbD98)
0x8a50caa0a1a688918ec563ba04e365c737be607ca339aa4b62a2f921a3ace975 (0x000d72403c18B2516d8ada074E1E7822bF1084DB)
0x8aa2fb5b6d584e759f42861d9fefc3740255044bb2b0e82c6faacd67a74db880 (0x000995137728C7C2a9142F4628f95c98Cac433d7)
0x8cd87153b35b6c40571993a5afcad176c05f6a44d92abdfd47ac377b6cc3b8ec (0x0009e10C0D2F1a7A2b00b61c476aa8b608c60aDc)
0x8cfe380955165dd01f4e33a3c68f4e08881f238fbbea71a2ab407f4a3759705b (0x000a52D537c4150ec274dcE3962a0d179B7E71B0)
0x8f87d3aca3eff8132256f69e17df5ba3c605e1b5f4e2071d56f7e6cd66047cc2 (0x0001c94c108BcE19CDb36b00F867A1798A81DedA)
0x8fd234df35c11c8d32771f9d2f78933b1841af85f2ee25638a513e7353ea22bb (0x000E0ea540095B3853c4cb09E5Cdd197330D3B55)
0x91a2a2b0dca9e807182fc5eecdd361a74d1d0475c3ac406fbdeacea84e0fa31a (0x00054e17Db8C8Db028B19cB0f631888AdEb35E4b)
0x92e52bf06451126362882960e5ff4faa03d5f9d790c5af6a539def14c425923f (0x000A7Bbde38Fc53925D0De9cc1beE3038d36c2d2)
0x93f858b35ed88cf4dce086ab4c61ebcea89769753c8cdf1d5655d18ecdb38edb (0x000c6c1D8F778D981968F9904772B0c455E1C17c)
0x961eb4e04c2129ea9f00b069173cbdf7258948b65cdc038ee638e2b2b987e6fc (0x0003Ffc1f09d39FBFE87eD63E98249039C7b1d9A)
0x97fc4b0fa5f035a29e5c271f189aa2253a4e1959c132b1348881bd2c02102cbe (0x000796370C839773893a2cEFA5fc81f2332936fB)
0x985d0bdcb4d9fb224a69378c301db3b5f683ddb4781f366ed3f275e37d0a95be (0x000AEBc2568796FDB763CAB67B31e0feE58Fe17d)
0x9cdef989f3d75139bc39165c96a23b054f749b317ee625637700e4b7d28faf6d (0x00065fC4337dF331242bEE738031dAf35817Ee9e)
0x9e7a754d717c70645a24ea7bd81e736de854e2611ceccdab741af00a7f46a616 (0x000Ec60762AD0425A04C40c118Db5B9710Aa639e)
0x9ebcc1d015fe749685e5bb5d0063c92101a921d3d92e5ba44092597454227587 (0x00085D9D1a71acf1080cED44CB501B350900627f)
0x9f16862c8609dd08abfed5e19f63b18dd4f804433a9c79ab0440f1d374e6e432 (0x000D268F322F10925cdB5d2AD527E582259Da655)
0xa0110c3eeba2c945e846a286361662f0ce8d948486071cef5f09abada2ddb99c (0x0008D608884cd733642ab17aCa0c8504850B94fA)
0xa6c04c59fafd2a968cc6846a4734aa0264b3879a322494369476ab3e8f0f98a0 (0x000ea86B4A3d7e4AF8CFab052c8b9a040149b507)
0xa7cded2e2b7c46f15c70496e3f39b2411656fa8a6991a97cc1e93bbce5ee1be6 (0x000D66A7706f2DD5F557d5b68e01E07E8FFDfaf5)
0xa836542701576e61c7011fc44db20b9808a22c9783cb5828c9ff93ab364c564d (0x000b1db69627F04688aA47951d847c8BFAB3fFaE)
0xab1853bb4f429804b01d9078f166c073fbe14d7bb4af4e76e197cc16dffb53a2 (0x0004351AD413792131011CC7ed8299dd783C6487)
0xabea088cc1a18dda221851da62d00bdc3724368e47ae0a2516727871554859bd (0x000352E93fe11f9B715fdc61864315970B3DC082)
0xae618ad0dae41d158ef6ce4deec8fb3b7de9dd0a1dd185a2821734ec70bddfb8 (0x000A0191cf913E03bd594bC8817FC3B2895C0a25)
0xb03d7b8f6da932c4e55baaaed1b22f75185a6115210f7a70d7b882326381d749 (0x0001Ebe3a3bA36f57F5989B3F0e5BEEBc710569C)
0xb142300756f21d04354cd336fb01138767825d50c1d91cf751236bdd7cf522ab (0x000cD1537A823Ae7609E3897DA8d95801B557a8a)
0xb370bbc515b99c5c8f7a2bc4306bc4ccc4db49742fc8f173218c0c662dd3b62f (0x0002590DD45738F909115B163F1322A8A24a8B4E)
0xb49cfe28461b3dc8aba0fa8af6087d268360bdfff54e56c742fc6d32179f51de (0x00009074D8fc5Eeb25f1548Df05AD955E21FB08D)
0xb7afc4852985be9d0268236a30c6b90a10891beeac1b5ccaecf074386e5f2904 (0x0006264bf7E3395309F728222641Ff8D0e1ad2C0)
0xb826451d3ab95251746556a3ab193191a63f3848e2461bbc4cfa0de21137ee51 (0x000036e0f87f8Cd3e97f9cfDB2e4E5Ff193c217a)
0xb8a8d6b97b1fffd09b876c51236cc09a89114e75f2882ac5004fb8bc3a1ef4d4 (0x0005b34eB0d99dE72DB14d466f692009c4049D46)
0xb8c8285116055d94644aaf1a6596b25540f4fe0e6aeb803e76aa37e1209fd6db (0x0004ad0D0823e3d31C6ECA2A3495373fA76c43aC)
0xba73c72b16553dbba5a275f541c06e77dcf7773514898dc0f3ddfe13c44f9e11 (0x0006d77295a0260ceAC113c5Aa15CFf0d28d9723)
0xbe2677fadaa3d16debd067c3679a0c1338f420c83f69a4591358d4f2a95933c0 (0x000F74AA6EE08C15076b3576eE33Ed3a80c9A1AD)
0xbfc2079f3da2470011be8f27d2b067ff2a933c7e701237d71b7e6be002b8a31a (0x0008a02d3E8507621f430345b98478058cDca79A)
0xc048f3e8fd5ff23148988025eee03064e6b0c503465b025fe9fea753a3185a17 (0x000ed6E0F4Fdc3615663BF4A601E35e7A8d66E1c)
0xc0f7f797c767e0917a03c115feaab813995ddeeefa4f35a1cd4edac84513cb63 (0x000086Eeea461Ca48e4D319F9789F3Efd134E574)
0xc1354d508b68dc33e1dab6cfbe3ce46302285a245642a0be71a655dd1a925be1 (0x0008a52c83D34f0791D07FfeD04Fb6b14f94E2D4)
0xc339484638efe005997b94978147b5ab6116e0e5def378b6282a875d154cfe88 (0x00029637dA962294449549f804f8184046F5fbB0)
0xc549116c70f6b7ccbadd7b6e195b1a739fb67ff78012f1cbb7bb3105ad66ec12 (0x000dFE27e1b71a49B641ad762aB95558584878D1)
0xc64a7834b476dcc257873670840a10bfbf34f364f001bd7dd55c43815cf63253 (0x000885A4932ebeD6D760EA381e4EdAe51A53db05)
0xc889c7625e6d463c6864a165234d0f29a854c5fbb04a9af4412626b4beda26d7 (0x000EDC52118DadB4B81f013005b6db2665B682ac)
0xcba5cf8ff0d1c75f2125fc4d631922f51584473bec8fc9f05884497e102f9e3d (0x00079f33619F70F1DCE64EB6782E45D3498d807C)
0xce4ead486ce4c05525554cdf6b2278a9d37d2fd4e184af1a9e37345b12158498 (0x00056bde49E3cAA9166C2a4C4951d0Cf067956A0)
0xcfe8dfcd96dcc59dd4a4df47c83437130fb02404a5701fe65fa978981649a92e (0x000C1C05dBFf111c79D5c9E91420DFBEA1c31716)
0xd09dd1b86312497051ca2e8ec38df9c758e47d91e6d2c369403cb95916e40d20 (0x0003B1aB565508e095a543C89531e3fbc4a349DA)
0xd0aaf5554b03c2c6b08edfa2c61272732f99c8f86a18552b9102ff1bad57c1dc (0x0006ed38815a9439c59bD917c12f77a9A7D39BCE)
0xd0f6fc4f6c8fc182c2ebc48329103c15b217453c7383c7315dff723236f9fa0b (0x000212949b4866db43bAF7c4e0975426710ED081)
0xd104400f3401ab2cb8a579d6aa5c5958e7f39d50b3a647e48db4dfd510dd864c (0x0007d272a1f7Dfe862b030adE2922D149f3bDe3B)
0xd288e8ef1fd56420009d02b416946229a074884c68aca08253e4a1b1b2655da4 (0x000A997c1ceCB1DA78C16249e032e77d1865646a)
0xd5c791cbdf1ceb7aea8b112f7598481d1da6ab70ecb3ce486b15fe23635c7a3e (0x0004e4dfCed9d798767A4d7BA2B03495cE80A2b7)
0xd640aab82f34d30047a2ddd34de8f062cd56b875792ed2a792bd4c9958178666 (0x0007316aEDc52EB35c9B5c2E44e9fD712d1DF887)
0xd6d05cc8f2de48565af906295762428f4a52442e920ed36b0b9371ef24869972 (0x00096af89fd96f0d6E1721d9145944e813317d46)
0xd75f886ceee43cc8cb50ce83c6ae9c3062ba4fe74b318a5817d711fc25318084 (0x000A390975F21371F1Cf3C783a4A7C1aF49074Fe)
0xd82f2e030a83e1ee6508b0476495c64fb0f519e3abe4eb83cbae21e85b7d8200 (0x000C1aE5FeCf09595C0C76Db609FEB2a5Af0962E)
0xd9cc048d3b472758b7750698f5cddf671d5faeb12668ee05a3edb4544b4cf9b7 (0x0006cEE23d8E9BC8d99E826cDa50481394aD9bDD)
0xdb2d6a3ec90c30bc7f2e57338979c28e783138ad3da7b6b13e58a2de4a20bfcd (0x000db74a3da16609F183ACE7AF65B43D896349CE)
0xdbbbf42fe6a05bbc0c1d4b99211e2ed72faf45a020843ec154eb9cec821d7e5e (0x0009d862F87F26c638AAd14F2cc48FCa54DBf49d)
0xdc8501a1d8ed67a24ca333e86b02c279fb8aca7610a7d8b07121a28d924d9e3e (0x000C8FC4132881c31f67638c3941dF8D94a92299)
0xdcd4917cd06c0d1be10b97cf6a44a89b978f835f6b8be978e58dba7d1070628b (0x0003135C47c441506b58483Ec6173F767182670B)
0xdf2e10539394549c10eb0a459efcc2eb4b417a7729c0a6e78367d0fc39b45dce (0x00077A336FCA40F933a7A301F4a39C26594F3EB5)
0xe06ad4b90a6d8eab21cef3efe96e0e57db709aa6b4aa778a93520f624ac6ea66 (0x00069DA530A71Dc92D02090d7f5f63e326e9beD0)
0xe188fda09aac7f922732f12865928b506223c8374a75b5dc451b11ef9fbeb133 (0x000b3F6da04b6261B4154C8FaEd119632C49DBd5)
0xe4f7dc8b199fdaac6693c9c412ea68aed9e1584d193e1c3478d30a6f01f26057 (0x0000bd19F707CA481886244bDd20Bd6B8a81bd3e)
0xe556d12479cde2e345ba952bdae2a47f6179f4f03a491ecda414970bab5c8005 (0x000A341763112a5E3452c7AEE45c382a3fb7dc78)
0xe76b962fc2d87e124bba333e6ff90a258760260f24f8a3c4fbceaeac68157f6e (0x000577bDc84B4019F77D9D09BDD8ED6145E0e890)
0xe88d9382e5e4914469a23dcc27271e05aa7715ddeaee66b857a455c1fd51104a (0x0002Bf507275217c9E5EE250bC1B5ca177bb4f74)
0xea016edc3a0dda43660a83cd7dddddfed87f34fe2849ab5c4339e9b8660e9553 (0x0000638374f7dB166990BDc6aBeE884Ee01a8920)
0xeaa700570abf8ad30abc2c4d922f4a76475e0bf37bdc9b434faff602bfe3847b (0x000C5e39879228A1Fc8dF2470822CB8ce2Af8e07)
0xeac93dc1957553f0816bc3a26d62f5ec475ecf2f02ee2a92bf9ff0214fc1fdd9 (0x00097B4463159340Ac83B9bdf657C304cD70c11c)
0xef75cca9bc31f62e7ab5823856dbe3187a6d34ba8a7a9381067b06b2c4d4d447 (0x0006Bd0469166f63D0A1c33F71898D2b2E009b9b)
0xf5c1ce10ff6233f88d700acd5bbd5b4ea00947df74d771bce8951b119bc23dbd (0x000e64e0a2Fd76B4883c800833c82c5F2420b813)
0xf666815790e3f448dc47f90aa0661dc3b0181fa41ff987b893cf1ef46ba52661 (0x00000A8d3f37af8DeF18832962Ee008d8dCa4F7b)
0xfa12d9f4e1eada2bbac5e2b9de0899a18ab07905c833529956a4789d10effa37 (0x0004b230511F921934F33E8B4425E43295232680)
0xfc412094d6bdac3ede9db1979975db0c613da7e4a550a663dacb0074e852eed5 (0x0004C8da21c68dED2F63efD9836De7D43e7cDa10)
0xfc8ae6457da1052f379f9a7eb925e11d10d3fc1dc0b59fe93658704babcfe78c (0x000990B05481b1661bc6211298f6429451B09425)
0xfdb73112480f2b033ff2fe2e6f5bd358fc46307a3fc2aeb70c79e77a8704ad82 (0x000cDF8Dba2393a40857cbCB0FCD9b998a941078)
0xffd790338a2798b648806fc8635ac7bf14af15425fed0c8f25bcc5febaa9b192 (0x000e73282F60E2CdE0D4FA9B323B6D54d860f330)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h3 id="debug-mode"><a class="header" href="#debug-mode">Debug Mode</a></h3>
<p>Debug mode currently enables printing in solidity by using a <code>print()</code> function that does an <code>MSTORE</code> with a specific offset to toggle the "print mode". If the VM is in debug mode it will recognize the offset as the "key" for enabling/disabling print mode. If print mode is enabled, MSTORE opcode stores into a buffer the data that the user wants to print, and when there is no more data left to read it prints it and disables the print mode so that execution continues normally.
You can find the solidity code in the <a href="https://github.com/lambdaclass/ethrex/blob/4e0ed9cc3b4ccb818dbc37afb305726cc01cec55/fixtures/contracts/levm_print/Print.sol">fixtures</a> of this repository. It can be tested with the <code>PrintTest</code> contract and it can be imported into another contracts.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="ethrex-replay"><a class="header" href="#ethrex-replay">ethrex-replay</a></h1>
<p>A tool for executing and proving Ethereum blocks, transactions, and L2 batches — inspired by <a href="https://github.com/lambdaclass/starknet-replay">starknet-replay</a>.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<h3 id="l1"><a class="header" href="#l1">L1</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th>Description</th></tr></thead><tbody>
<tr><td><code>ethrex-replay block</code></td><td>Replay a single block.</td></tr>
<tr><td><code>ethrex-replay blocks</code></td><td>Replay a list of specific block numbers, a range of blocks, or from a specific block to the latest (see <code>ethrex-replay blocks --help</code>)</td></tr>
<tr><td><code>ethrex-replay block-composition</code></td><td></td></tr>
<tr><td><code>ethrex-replay custom</code></td><td>Build your block before to replay it.</td></tr>
<tr><td><code>ethrex-replay transaction</code></td><td>Replay a single transaction of a block.</td></tr>
<tr><td><code>ethrex-replay cache</code></td><td>Generate witness data prior to block replay (see <code>ethrex-replay cache --help</code>)</td></tr>
</tbody></table>
</div>
<h3 id="l2-1"><a class="header" href="#l2-1">L2</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th>Description</th></tr></thead><tbody>
<tr><td><code>ethrex-replay l2 batch</code></td><td></td></tr>
<tr><td><code>ethrex-replay l2 block</code></td><td></td></tr>
<tr><td><code>ethrex-replay l2 custom</code></td><td></td></tr>
<tr><td><code>ethrex-replay l2 transaction</code></td><td></td></tr>
</tbody></table>
</div>
<h2 id="supported-clients"><a class="header" href="#supported-clients">Supported Clients</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Client</th><th><code>ethrex-replay block</code></th><th>notes</th></tr></thead><tbody>
<tr><td>ethrex</td><td>✅</td><td><code>debug_executionWitness</code></td></tr>
<tr><td>reth</td><td>✅</td><td><code>debug_executionWitness</code></td></tr>
<tr><td>geth</td><td>✅</td><td><code>eth_getProof</code></td></tr>
<tr><td>nethermind</td><td>✅</td><td><code>eth_getProof</code></td></tr>
<tr><td>erigon</td><td>❌</td><td>V3 supports <code>eth_getProof</code> only for latest block</td></tr>
<tr><td>besu</td><td>❌</td><td>Doesn't return proof for non-existing accounts</td></tr>
</tbody></table>
</div>
<p>We support any other client that is compliant with <code>eth_getProof</code> or <code>debug_executionWitness</code> endpoints.
You can set the max requests per second to the RPC url with the environment variable <code>REPLAY_RPC_RPS</code>. This is particularly useful when using <code>eth_getProof</code>. Default is 10.</p>
<p>Execution of some particular blocks with the <code>eth_getProof</code> method won't work with zkVMs. But without using these it should work for any block. Read more about this in <a href="ethrex_replay/./faq.html">FAQ</a>. Also, when running against a <strong>full node</strong> using <code>eth_getProof</code> if for some reason information retrieval were to take longer than 25 minutes it would probably fail because the node may have pruned its state (128 blocks * 12 seconds = 25,6 min), normally it doesn't take that much but be wary of that.</p>
<h2 id="supported-zkvm-replays-execution--proving"><a class="header" href="#supported-zkvm-replays-execution--proving">Supported zkVM Replays (execution &amp; proving)</a></h2>
<blockquote>
<p>✅: supported.
⚠️: supported, but flaky.
🔜: to be supported.</p>
</blockquote>
<div class="table-wrapper"><table><thead><tr><th>zkVM</th><th>Hoodi</th><th>Sepolia</th><th>Mainnet</th><th>Public ethrex L2s</th></tr></thead><tbody>
<tr><td>RISC0</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr>
<tr><td>SP1</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr>
<tr><td>OpenVM</td><td>⚠️</td><td>🔜</td><td>🔜</td><td>🔜</td></tr>
<tr><td>ZisK</td><td>🔜</td><td>🔜</td><td>⚠️</td><td>🔜</td></tr>
<tr><td>Jolt</td><td>🔜</td><td>🔜</td><td>🔜</td><td>🔜</td></tr>
<tr><td>Nexus</td><td>🔜</td><td>🔜</td><td>🔜</td><td>🔜</td></tr>
<tr><td>Pico</td><td>🔜</td><td>🔜</td><td>🔜</td><td>🔜</td></tr>
<tr><td>Ziren</td><td>🔜</td><td>🔜</td><td>🔜</td><td>🔜</td></tr>
</tbody></table>
</div>
<h2 id="getting-started-1"><a class="header" href="#getting-started-1">Getting Started</a></h2>
<h3 id="dependencies-1"><a class="header" href="#dependencies-1">Dependencies</a></h3>
<p>These dependencies are optional, install them only if you want to run with the features <code>risc0</code> or <code>sp1</code> respectively.
Make sure to use the correct versions of these.</p>
<h4 id="risc0"><a class="header" href="#risc0"><a href="https://dev.risczero.com/api/zkvm/install">RISC0</a></a></h4>
<pre><code class="language-sh">curl -L https://risczero.com/install | bash
rzup install cargo-risczero 3.0.3
rzup install risc0-groth16
rzup install rust
</code></pre>
<h4 id="sp1"><a class="header" href="#sp1"><a href="https://docs.succinct.xyz/docs/sp1/getting-started/install">SP1</a></a></h4>
<pre><code class="language-sh">curl -L https://sp1up.succinct.xyz | bash
sp1up --version 5.0.8
</code></pre>
<h3 id="installation-1"><a class="header" href="#installation-1">Installation</a></h3>
<h4 id="from-cargo"><a class="header" href="#from-cargo">From Cargo</a></h4>
<pre><code># L1 Replay

## Install without features for vanilla execution (no prover backend)
cargo install --locked --git https://github.com/lambdaclass/ethrex.git ethrex-replay

## Install for CPU execution/proving with SP1
cargo install --locked --git https://github.com/lambdaclass/ethrex.git ethrex-replay --features sp1

## Install for CPU execution/proving with RISC0
cargo install --locked --git https://github.com/lambdaclass/ethrex.git ethrex-replay --features risc0

## Install for GPU execution/proving with SP1
cargo install --locked --git https://github.com/lambdaclass/ethrex.git ethrex-replay --features sp1,gpu

## Install for GPU execution/proving with RISC0
cargo install --locked --git https://github.com/lambdaclass/ethrex.git ethrex-replay --features risc0,gpu

# L2 Replay

## Install without features for vanilla execution (no prover backend)
cargo install --locked --git https://github.com/lambdaclass/ethrex.git ethrex-replay --features l2

## Install for CPU execution/proving with SP1
cargo install --locked --git https://github.com/lambdaclass/ethrex.git ethrex-replay --features l2,sp1

## Install for CPU execution/proving with RISC0
cargo install --locked --git https://github.com/lambdaclass/ethrex.git ethrex-replay --features l2,risc0

## Install for GPU execution/proving with SP1
cargo install --locked --git https://github.com/lambdaclass/ethrex.git ethrex-replay --features l2,sp1,gpu

## Install for GPU execution/proving with RISC0
cargo install --locked --git https://github.com/lambdaclass/ethrex.git ethrex-replay --features l2,risc0,gpu
</code></pre>
<h3 id="run-from-source"><a class="header" href="#run-from-source">Run from Source</a></h3>
<pre><code>git clone git@github.com:lambdaclass/ethrex.git

cd ethrex

# L1 replay

## Vanilla execution (no prover backend)
cargo r -r -p ethrex-replay -- &lt;COMMAND&gt; [ARGS]

## SP1 backend
cargo r -r -p ethrex-replay --features sp1 -- &lt;COMMAND&gt; [ARGS]

## SP1 backend + GPU
cargo r -r -p ethrex-replay --features sp1,gpu -- &lt;COMMAND&gt; [ARGS]

## RISC0 backend
cargo r -r -p ethrex-replay --features risc0 -- &lt;COMMAND&gt; [ARGS]

## RISC0 backend + GPU
cargo r -r -p ethrex-replay --features risc0,gpu -- &lt;COMMAND&gt; [ARGS]

# L2 replay

## Vanilla execution (no prover backend)
cargo r -r -p ethrex-replay --features l2 -- &lt;COMMAND&gt; [ARGS]

## SP1 backend
cargo r -r -p ethrex-replay --features l2,sp1 -- &lt;COMMAND&gt; [ARGS]

## SP1 backend + GPU
SP1_PROVER=cuda cargo r -r -p ethrex-replay --features l2,sp1,gpu -- &lt;COMMAND&gt; [ARGS]

## RISC0 backend
cargo r -r -p ethrex-replay --features l2,risc0 -- &lt;COMMAND&gt; [ARGS]

## RISC0 backend + GPU
cargo r -r -p ethrex-replay --features l2,risc0,gpu -- &lt;COMMAND&gt; [ARGS]
</code></pre>
<h4 id="features-1"><a class="header" href="#features-1">Features</a></h4>
<p>The following table lists the available features for <code>ethrex-replay</code>. To enable a feature, use the <code>--features</code> flag with <code>cargo install</code>, specifying a comma-separated list of features.</p>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th>Description</th></tr></thead><tbody>
<tr><td><code>gpu</code></td><td>Enables GPU support with SP1 or RISC0 backends (must be combined with one of each features, e.g. <code>sp1,gpu</code> or <code>risc0,gpu</code>)</td></tr>
<tr><td><code>risc0</code></td><td>Execution and proving is done with RISC0 backend</td></tr>
<tr><td><code>sp1</code></td><td>Execution and proving is done with SP1 backend</td></tr>
<tr><td><code>l2</code></td><td>Enables L2 batch execution and proving (can be combined with SP1 or RISC0 and GPU features, e.g. <code>sp1,l2,gpu</code>, <code>risc0,l2,gpu</code>, <code>sp1,l2</code>, <code>risc0,l2</code>)</td></tr>
<tr><td><code>jemalloc</code></td><td>Use jemalloc as the global allocator. This is useful to combine with tools like Bytehound and Heaptrack for memory profiling</td></tr>
<tr><td><code>profiling</code></td><td>Useful to run with tools like Samply.</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="running-examples"><a class="header" href="#running-examples">Running Examples</a></h2>
<h3 id="examples-toc"><a class="header" href="#examples-toc">Examples ToC</a></h3>
<ul>
<li><a href="ethrex_replay/ethrex_replay.html#execute-a-single-block-from-a-public-network">Execute a single block from a public network</a></li>
<li><a href="ethrex_replay/ethrex_replay.html#prove-a-single-block">Prove a single block</a></li>
<li><a href="ethrex_replay/ethrex_replay.html#execute-an-l2-batch">Execute an L2 batch</a></li>
<li><a href="ethrex_replay/ethrex_replay.html#prove-an-l2-batch">Prove an L2 batch</a></li>
<li><a href="ethrex_replay/ethrex_replay.html#execute-a-transaction">Execute a transaction</a></li>
<li><a href="ethrex_replay/ethrex_replay.html#plot-block-composition">Plot block composition</a></li>
</ul>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<p>The following instructions assume that you've installed <code>ethrex-replay</code> as described in the <a href="ethrex_replay/ethrex_replay.html#getting-started">Getting Started</a> section.</p>
</div>
<h3 id="execute-a-single-block-from-a-public-network"><a class="header" href="#execute-a-single-block-from-a-public-network">Execute a single block from a public network</a></h3>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<ol>
<li>If <code>BLOCK_NUMBER</code> is not provided, the latest block will be executed.</li>
<li>If <code>ZKVM</code> is not provided, no zkVM will be used for execution.</li>
<li>If <code>RESOURCE</code> is not provided, CPU will be used for execution.</li>
<li>If <code>ACTION</code> is not provided, only execution will be performed.</li>
</ol>
</div>
<pre><code>ethrex-replay block &lt;BLOCK_NUMBER&gt; --zkvm &lt;ZKVM&gt; --resource &lt;RESOURCE&gt; --action &lt;ACTION&gt; --rpc-url &lt;RPC_URL&gt;
</code></pre>
<h3 id="prove-a-single-block"><a class="header" href="#prove-a-single-block">Prove a single block</a></h3>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<ol>
<li>If <code>BLOCK_NUMBER</code> is not provided, the latest block will be executed and proved.</li>
<li>Proving requires a prover backend to be enabled during installation (e.g., <code>sp1</code> or <code>risc0</code>).</li>
<li>Proving with GPU requires the <code>gpu</code> feature to be enabled during installation.</li>
<li>If proving with SP1, add <code>SP1_PROVER=cuda</code> to the command to enable GPU support.</li>
</ol>
</div>
<pre><code>ethrex-replay block &lt;BLOCK_NUMBER&gt; --zkvm &lt;ZKVM&gt; --resource gpu --action prove --rpc-url &lt;RPC_URL&gt;
</code></pre>
<h3 id="execute-an-l2-batch"><a class="header" href="#execute-an-l2-batch">Execute an L2 batch</a></h3>
<pre><code>ethrex-replay l2 batch --batch &lt;BATCH_NUMBER&gt; --execute --rpc-url &lt;RPC_URL&gt;
</code></pre>
<h3 id="prove-an-l2-batch"><a class="header" href="#prove-an-l2-batch">Prove an L2 batch</a></h3>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<ol>
<li>Proving requires a prover backend to be enabled during installation (e.g., <code>sp1</code> or <code>risc0</code>). Proving with GPU requires the <code>gpu</code> feature to be enabled during installation.</li>
<li>If proving with SP1, add <code>SP1_PROVER=cuda</code> to the command to enable GPU support.</li>
<li>Batch replay requires the binary to be run/compiled with the <code>l2</code> feature.</li>
</ol>
</div>
<pre><code>ethrex-replay l2 batch --batch &lt;BATCH_NUMBER&gt; --prove --rpc-url &lt;RPC_URL&gt;
</code></pre>
<h3 id="execute-a-transaction"><a class="header" href="#execute-a-transaction">Execute a transaction</a></h3>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>L2 transaction replay requires the binary to be run/compiled with the <code>l2</code> feature.</p>
</div>
<pre><code>ethrex-replay transaction &lt;TX_HASH&gt; --execute --rpc-url &lt;RPC_URL&gt;

ethrex-replay l2 transaction &lt;TX_HASH&gt; --execute --rpc-url &lt;RPC_URL&gt;
</code></pre>
<h3 id="plot-block-composition"><a class="header" href="#plot-block-composition">Plot block composition</a></h3>
<pre><code>ethrex-replay block-composition --start-block &lt;START_BLOCK&gt; --end-block &lt;END_BLOCK&gt; --rpc-url &lt;RPC_URL&gt; --network &lt;NETWORK&gt;
</code></pre>
<hr />
<h2 id="benchmarking--profiling"><a class="header" href="#benchmarking--profiling">Benchmarking &amp; Profiling</a></h2>
<h3 id="run-samply"><a class="header" href="#run-samply">Run Samply</a></h3>
<p>We recommend building in <code>release-with-debug</code> mode so that the flamegraph is the most accurate.</p>
<pre><code class="language-bash">cargo build -p ethrex-replay --profile release-with-debug --features &lt;FEATURES&gt;
</code></pre>
<h4 id="on-zkvms"><a class="header" href="#on-zkvms">On zkVMs</a></h4>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<ol>
<li>For profiling zkVMs like SP1 the <code>ethrex-replay</code> binary must be built with the <code>profiling</code> feature enabled.</li>
<li>The <code>TRACE_SAMPLE_RATE</code> environment variable controls the sampling rate (in milliseconds). Adjust it according to your needs.</li>
</ol>
</div>
<pre><code>TRACE_FILE=output.json TRACE_SAMPLE_RATE=1000 target/release-with-debug/ethrex-replay &lt;COMMAND&gt; [ARGS]
</code></pre>
<h4 id="execution-without-zkvms"><a class="header" href="#execution-without-zkvms">Execution without zkVMs</a></h4>
<pre><code class="language-bash">samply record target/release-with-debug/ethrex-replay &lt;COMMAND&gt; --no-zkvm [OTHER_ARGS]
</code></pre>
<h3 id="run-bytehound"><a class="header" href="#run-bytehound">Run Bytehound</a></h3>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<ol>
<li>The following requires <a href="https://github.com/jemalloc/jemalloc">Jemalloc</a> and <a href="https://github.com/koute/bytehound">Bytehound</a> to be installed.</li>
<li>The <code>ethrex-replay</code> binary must be built with the <code>jemalloc</code> feature enabled.</li>
</ol>
</div>
<pre><code>export MEMORY_PROFILER_LOG=warn
LD_PRELOAD=/path/to/bytehound/preload/target/release/libbytehound.so:/path/to/libjemalloc.so  ethrex-replay &lt;COMMAND&gt; [ARGS]
</code></pre>
<h3 id="run-heaptrack"><a class="header" href="#run-heaptrack">Run Heaptrack</a></h3>
<div class="mdbook-alerts mdbook-alerts-important">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  important
</p>
<ol>
<li>The following requires <a href="https://github.com/jemalloc/jemalloc">Jemalloc</a> and <a href="https://github.com/KDE/heaptrack">Heaptrack</a> to be installed.</li>
<li>The <code>ethrex-replay</code> binary must be built with the <code>jemalloc</code> feature enabled.</li>
<li>Note that Heaptrack is a <strong>Linux</strong> profiler, so it won't work natively on macOS.</li>
</ol>
</div>
<pre><code>LD_PRELOAD=/path/to/libjemalloc.so heaptrack ethrex-replay &lt;COMMAND&gt; [ARGS]
heaptrack_print heaptrack.&lt;program&gt;.&lt;pid&gt;.gz &gt; heaptrack.stacks
</code></pre>
<hr />
<h2 id="check-all-available-commands"><a class="header" href="#check-all-available-commands">Check All Available Commands</a></h2>
<p>Run:</p>
<pre><code class="language-sh">cargo r -r -p ethrex-replay -- --help
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h2 id="faq-1"><a class="header" href="#faq-1">FAQ</a></h2>
<h3 id="whats-the-difference-between-eth_getproof-and-debug_executionwitness"><a class="header" href="#whats-the-difference-between-eth_getproof-and-debug_executionwitness">What's the difference between <code>eth_getProof</code> and <code>debug_executionWitness</code>?</a></h3>
<p><code>eth_getProof</code> gets the proof for a particular account and the chosen storage slots.
<code>debug_executionWitness</code> gets the whole execution witness necessary to execute a block in a stateless manner.</p>
<p>The former endpoint is implemented by all execution clients and you can even find it in RPC Providers like Alchemy, the latter is only implemented by some execution clients and you can't find it in RPC Providers.</p>
<p>When wanting to execute a historical block we tend to use the <code>eth_getProof</code> method with an RPC Provider because it will be the most reliable, other way is using it against a Hash-Based Archive Node but this would be too heavy to host ourselves (20TB at least). This method is slow because it performs many requests but it's very flexible.</p>
<p>If instead we want to execute a recent block we use it against synced ethrex or reth nodes that expose the <code>debug_executionWitness</code> endpoint, this way retrieval of data will be instant and it will be way faster than the other method, because it won't be doing thousands of RPC requests, just one.</p>
<p>More information regarding the execution witness in <a href="https://github.com/lambdaclass/ethrex/blob/38e0ffc/docs/l2/architecture/prover.md#execution-witness">the prover docs</a>.</p>
<h3 id="why-stateless-execution-of-some-blocks-doesnt-work-with-eth_getproof"><a class="header" href="#why-stateless-execution-of-some-blocks-doesnt-work-with-eth_getproof">Why stateless execution of some blocks doesn't work with <code>eth_getProof</code></a></h3>
<p>With this method of execution we get the proof of all the accounts and storage slots accessed during execution, but the problem arises when we want to delete a node from the Merkle Patricia Trie (MPT) when applying the account updates of the block. This is for a particular case in which a tree restructuring happens and we have a missing node that wasn't accessed but we need to know in order to restructure the trie.</p>
<p>The problem can be explained with a simple example: a Branch node has 2 child nodes and only one was accessed and removed, this branch node should stop existing because they shouldn't have only <strong>one</strong> child. It will be either replaced by a leaf node or by an extension node, this depends on its child.</p>
<p>This problem is wonderfully explained in <a href="https://github.com/kkrt-labs/zk-pig/blob/main/docs/modified-mpt.md">zkpig docs</a>, they also have a very good intro to the MPT.
Here they mention two different solutions that we have to implement in order to fix this. The first one works when the missing node is a Leaf or Extension and the second one works then the missing node is a Branch.</p>
<p>In our code we only applied the first solution by injecting all possible nodes to the execution witness that we build when using <code>eth_getProof</code>, that's why the witness when using this method will be larger than the witness obtained with <code>debug_executionWitness</code>.</p>
<p>We didn't apply the second change because it needs a change to the MPT that we don't want in our code. However we were able to solve it for execution without using a zkVM by injecting some "fake nodes" to the trie just before execution that have the expected hash but their RLP content doesn't match to it. This way we can "trick" the Trie into thinking that it has the branch nodes when in fact, it doesn't.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="cli-commands"><a class="header" href="#cli-commands">CLI Commands</a></h1>
<h2 id="ethrex"><a class="header" href="#ethrex">ethrex</a></h2>
<!-- BEGIN_CLI_HELP -->
<pre><code>ethrex Execution client

Usage: ethrex [OPTIONS] [COMMAND]

Commands:
  removedb            Remove the database
  import              Import blocks to the database
  import-bench        Import blocks to the database for benchmarking
  export              Export blocks in the current chain into a file in rlp encoding
  compute-state-root  Compute the state root from a genesis file
  help                Print this message or the help of the given subcommand(s)

Options:
  -h, --help
          Print help (see a summary with '-h')

  -V, --version
          Print version

Node options:
      --network &lt;GENESIS_FILE_PATH&gt;
          Alternatively, the name of a known network can be provided instead to use its preset genesis file and include its preset bootnodes. The networks currently supported include holesky, sepolia, hoodi and mainnet. If not specified, defaults to mainnet.

          [env: ETHREX_NETWORK=]

      --datadir &lt;DATABASE_DIRECTORY&gt;
          If the datadir is the word `memory`, ethrex will use the `InMemory Engine`.

          [env: ETHREX_DATADIR=]
          [default: /home/runner/.local/share/ethrex]

      --force
          Delete the database without confirmation.

      --metrics.addr &lt;ADDRESS&gt;
          [default: 0.0.0.0]

      --metrics.port &lt;PROMETHEUS_METRICS_PORT&gt;
          [env: ETHREX_METRICS_PORT=]
          [default: 9090]

      --metrics
          Enable metrics collection and exposition

      --dev
          If set it will be considered as `true`. If `--network` is not specified, it will default to a custom local devnet. The Binary has to be built with the `dev` feature enabled.

      --log.level &lt;LOG_LEVEL&gt;
          Possible values: info, debug, trace, warn, error

          [env: ETHREX_LOG_LEVEL=]
          [default: INFO]

      --log.color &lt;LOG_COLOR&gt;
          Possible values: auto, always, never

          [default: auto]

      --log.dir &lt;LOG_DIR&gt;
          Directory to store log files.

      --mempool.maxsize &lt;MEMPOOL_MAX_SIZE&gt;
          Maximum size of the mempool in number of transactions

          [default: 10000]

      --precompute-witnesses
          Once synced, computes execution witnesses upon receiving newPayload messages and stores them in local storage

P2P options:
      --bootnodes &lt;BOOTNODE_LIST&gt;...
          Comma separated enode URLs for P2P discovery bootstrap.

      --syncmode &lt;SYNC_MODE&gt;
          Can be either "full" or "snap" with "snap" as default value.

          [default: snap]

      --p2p.disabled


      --p2p.addr &lt;ADDRESS&gt;
          Listening address for the P2P protocol.

      --p2p.port &lt;PORT&gt;
          TCP port for the P2P protocol.

          [default: 30303]

      --discovery.port &lt;PORT&gt;
          UDP port for P2P discovery.

          [default: 30303]

      --p2p.tx-broadcasting-interval &lt;INTERVAL_MS&gt;
          Transaction Broadcasting Time Interval (ms) for batching transactions before broadcasting them.

          [default: 1000]

      --p2p.target-peers &lt;MAX_PEERS&gt;
          Max amount of connected peers.

          [default: 100]

      --p2p.lookup-interval &lt;INITIAL_LOOKUP_INTERVAL&gt;
          Initial Lookup Time Interval (ms) to trigger each Discovery lookup message and RLPx connection attempt.

          [default: 100]

RPC options:
      --http.addr &lt;ADDRESS&gt;
          Listening address for the http rpc server.

          [env: ETHREX_HTTP_ADDR=]
          [default: 0.0.0.0]

      --http.port &lt;PORT&gt;
          Listening port for the http rpc server.

          [env: ETHREX_HTTP_PORT=]
          [default: 8545]

      --ws.enabled
          Enable websocket rpc server. Disabled by default.

          [env: ETHREX_ENABLE_WS=]

      --ws.addr &lt;ADDRESS&gt;
          Listening address for the websocket rpc server.

          [env: ETHREX_WS_ADDR=]
          [default: 0.0.0.0]

      --ws.port &lt;PORT&gt;
          Listening port for the websocket rpc server.

          [env: ETHREX_WS_PORT=]
          [default: 8546]

      --authrpc.addr &lt;ADDRESS&gt;
          Listening address for the authenticated rpc server.

          [default: 127.0.0.1]

      --authrpc.port &lt;PORT&gt;
          Listening port for the authenticated rpc server.

          [default: 8551]

      --authrpc.jwtsecret &lt;JWTSECRET_PATH&gt;
          Receives the jwt secret used for authenticated rpc requests.

          [default: jwt.hex]

Block building options:
      --builder.extra-data &lt;EXTRA_DATA&gt;
          Block extra data message.

          [default: "ethrex 9.0.0"]

      --builder.gas-limit &lt;GAS_LIMIT&gt;
          Target block gas limit.

          [default: 60000000]

      --builder.max-blobs &lt;MAX_BLOBS&gt;
          EIP-7872: Maximum blobs per block for local building. Minimum of 1. Defaults to protocol max.
</code></pre>
<!-- END_CLI_HELP -->
<h2 id="ethrex-l2-1"><a class="header" href="#ethrex-l2-1">ethrex l2</a></h2>
<pre><code>Usage: ethrex l2 [OPTIONS]
       ethrex l2 &lt;COMMAND&gt;

Commands:
  prover        Initialize an ethrex prover [aliases: p]
  removedb      Remove the database [aliases: rm, clean]
  blobs-saver   Launch a server that listens for Blobs submissions and saves them offline.
  reconstruct   Reconstructs the L2 state from L1 blobs.
  revert-batch  Reverts unverified batches.
  pause         Pause L1 contracts
  unpause       Unpause L1 contracts
  deploy        Deploy in L1 all contracts needed by an L2.
  help          Print this message or the help of the given subcommand(s)

Options:
      --osaka-activation-time &lt;UINT64&gt;
          Block timestamp at which the Osaka fork is activated on L1. If not set, it will assume Osaka is already active.

          [env: ETHREX_OSAKA_ACTIVATION_TIME=]

  -t, --tick-rate &lt;TICK_RATE&gt;
          time in ms between two ticks

          [default: 1000]

      --batch-widget-height &lt;BATCH_WIDGET_HEIGHT&gt;


  -h, --help
          Print help (see a summary with '-h')

Node options:
      --network &lt;GENESIS_FILE_PATH&gt;
          Alternatively, the name of a known network can be provided instead to use its preset genesis file and include its preset bootnodes. The networks currently supported include holesky, sepolia, hoodi and mainnet. If not specified, defaults to mainnet.

          [env: ETHREX_NETWORK=]

      --datadir &lt;DATABASE_DIRECTORY&gt;
          If the datadir is the word `memory`, ethrex will use the `InMemory Engine`.

          [env: ETHREX_DATADIR=]
          [default: "/home/runner/.local/share/ethrex"]

      --force
          Delete the database without confirmation.

      --metrics.addr &lt;ADDRESS&gt;
          [default: 0.0.0.0]

      --metrics.port &lt;PROMETHEUS_METRICS_PORT&gt;
          [env: ETHREX_METRICS_PORT=]
          [default: 9090]

      --metrics
          Enable metrics collection and exposition

      --dev
          If set it will be considered as `true`. If `--network` is not specified, it will default to a custom local devnet. The Binary has to be built with the `dev` feature enabled.

      --log.level &lt;LOG_LEVEL&gt;
          Possible values: info, debug, trace, warn, error
          
          [env: ETHREX_LOG_LEVEL=]
          [default: INFO]

      --log.color &lt;LOG_COLOR&gt;
          Possible values: auto, always, never

          [default: auto]

      --mempool.maxsize &lt;MEMPOOL_MAX_SIZE&gt;
          Maximum size of the mempool in number of transactions

          [default: 10000]

P2P options:
      --bootnodes &lt;BOOTNODE_LIST&gt;...
          Comma separated enode URLs for P2P discovery bootstrap.

      --syncmode &lt;SYNC_MODE&gt;
          Can be either "full" or "snap" with "snap" as default value.

          [default: snap]

      --p2p.disabled


      --p2p.addr &lt;ADDRESS&gt;
          Listening address for the P2P protocol.

      --p2p.port &lt;PORT&gt;
          TCP port for the P2P protocol.

          [default: 30303]

      --discovery.port &lt;PORT&gt;
          UDP port for P2P discovery.

          [default: 30303]

      --p2p.tx-broadcasting-interval &lt;INTERVAL_MS&gt;
          Transaction Broadcasting Time Interval (ms) for batching transactions before broadcasting them.

          [default: 1000]

      --target.peers &lt;MAX_PEERS&gt;
          Max amount of connected peers.

          [default: 100]

RPC options:
      --http.addr &lt;ADDRESS&gt;
          Listening address for the http rpc server.

          [env: ETHREX_HTTP_ADDR=]
          [default: 0.0.0.0]

      --http.port &lt;PORT&gt;
          Listening port for the http rpc server.

          [env: ETHREX_HTTP_PORT=]
          [default: 8545]

      --ws.enabled
          Enable websocket rpc server. Disabled by default.

          [env: ETHREX_ENABLE_WS=]

      --ws.addr &lt;ADDRESS&gt;
          Listening address for the websocket rpc server.

          [env: ETHREX_WS_ADDR=]
          [default: 0.0.0.0]

      --ws.port &lt;PORT&gt;
          Listening port for the websocket rpc server.

          [env: ETHREX_WS_PORT=]
          [default: 8546]

      --authrpc.addr &lt;ADDRESS&gt;
          Listening address for the authenticated rpc server.

          [default: 127.0.0.1]

      --authrpc.port &lt;PORT&gt;
          Listening port for the authenticated rpc server.

          [default: 8551]

      --authrpc.jwtsecret &lt;JWTSECRET_PATH&gt;
          Receives the jwt secret used for authenticated rpc requests.

          [default: jwt.hex]

Block building options:
      --builder.extra-data &lt;EXTRA_DATA&gt;
          Block extra data message.

          [default: "ethrex 9.0.0"]

      --builder.gas-limit &lt;GAS_LIMIT&gt;
          Target block gas limit.

          [default: 60000000]

Eth options:
      --eth.rpc-url &lt;RPC_URL&gt;...
          List of rpc urls to use.

          [env: ETHREX_ETH_RPC_URL=]

      --eth.maximum-allowed-max-fee-per-gas &lt;UINT64&gt;
          [env: ETHREX_MAXIMUM_ALLOWED_MAX_FEE_PER_GAS=]
          [default: 10000000000]

      --eth.maximum-allowed-max-fee-per-blob-gas &lt;UINT64&gt;
          [env: ETHREX_MAXIMUM_ALLOWED_MAX_FEE_PER_BLOB_GAS=]
          [default: 10000000000]

      --eth.max-number-of-retries &lt;UINT64&gt;
          [env: ETHREX_MAX_NUMBER_OF_RETRIES=]
          [default: 10]

      --eth.backoff-factor &lt;UINT64&gt;
          [env: ETHREX_BACKOFF_FACTOR=]
          [default: 2]

      --eth.min-retry-delay &lt;UINT64&gt;
          [env: ETHREX_MIN_RETRY_DELAY=]
          [default: 96]

      --eth.max-retry-delay &lt;UINT64&gt;
          [env: ETHREX_MAX_RETRY_DELAY=]
          [default: 1800]

L1 Watcher options:
      --l1.bridge-address &lt;ADDRESS&gt;
          [env: ETHREX_WATCHER_BRIDGE_ADDRESS=]

      --watcher.watch-interval &lt;UINT64&gt;
          How often the L1 watcher checks for new blocks in milliseconds.

          [env: ETHREX_WATCHER_WATCH_INTERVAL=]
          [default: 12000]

      --watcher.max-block-step &lt;UINT64&gt;
          [env: ETHREX_WATCHER_MAX_BLOCK_STEP=]
          [default: 5000]

      --watcher.block-delay &lt;UINT64&gt;
          Number of blocks the L1 watcher waits before trusting an L1 block.

          [env: ETHREX_WATCHER_BLOCK_DELAY=]
          [default: 10]

Block producer options:
      --watcher.l1-fee-update-interval-ms &lt;ADDRESS&gt;
          [env: ETHREX_WATCHER_L1_FEE_UPDATE_INTERVAL_MS=]
          [default: 60000]

      --block-producer.block-time &lt;UINT64&gt;
          How often does the sequencer produce new blocks to the L1 in milliseconds.

          [env: ETHREX_BLOCK_PRODUCER_BLOCK_TIME=]
          [default: 5000]

      --block-producer.coinbase-address &lt;ADDRESS&gt;
          [env: ETHREX_BLOCK_PRODUCER_COINBASE_ADDRESS=]

      --block-producer.base-fee-vault-address &lt;ADDRESS&gt;
          [env: ETHREX_BLOCK_PRODUCER_BASE_FEE_VAULT_ADDRESS=]

      --block-producer.operator-fee-vault-address &lt;ADDRESS&gt;
          [env: ETHREX_BLOCK_PRODUCER_OPERATOR_FEE_VAULT_ADDRESS=]

      --block-producer.operator-fee-per-gas &lt;UINT64&gt;
          Fee that the operator will receive for each unit of gas consumed in a block.

          [env: ETHREX_BLOCK_PRODUCER_OPERATOR_FEE_PER_GAS=]

      --block-producer.l1-fee-vault-address &lt;ADDRESS&gt;
          [env: ETHREX_BLOCK_PRODUCER_L1_FEE_VAULT_ADDRESS=]

      --block-producer.block-gas-limit &lt;UINT64&gt;
          Maximum gas limit for the L2 blocks.

          [env: ETHREX_BLOCK_PRODUCER_BLOCK_GAS_LIMIT=]
          [default: 30000000]

Proposer options:
      --elasticity-multiplier &lt;UINT64&gt;
          [env: ETHREX_PROPOSER_ELASTICITY_MULTIPLIER=]
          [default: 2]

L1 Committer options:
      --committer.l1-private-key &lt;PRIVATE_KEY&gt;
          Private key of a funded account that the sequencer will use to send commit txs to the L1.

          [env: ETHREX_COMMITTER_L1_PRIVATE_KEY=]

      --committer.remote-signer-url &lt;URL&gt;
          URL of a Web3Signer-compatible server to remote sign instead of a local private key.

          [env: ETHREX_COMMITTER_REMOTE_SIGNER_URL=]

      --committer.remote-signer-public-key &lt;PUBLIC_KEY&gt;
          Public key to request the remote signature from.

          [env: ETHREX_COMMITTER_REMOTE_SIGNER_PUBLIC_KEY=]

      --l1.on-chain-proposer-address &lt;ADDRESS&gt;
          [env: ETHREX_COMMITTER_ON_CHAIN_PROPOSER_ADDRESS=]

      --committer.commit-time &lt;UINT64&gt;
          How often does the sequencer commit new blocks to the L1 in milliseconds.

          [env: ETHREX_COMMITTER_COMMIT_TIME=]
          [default: 60000]

      --committer.batch-gas-limit &lt;UINT64&gt;
          Maximum gas limit for the batch

          [env: ETHREX_COMMITTER_BATCH_GAS_LIMIT=]

      --committer.first-wake-up-time &lt;UINT64&gt;
          Time to wait before the sequencer seals a batch when started. After committing the first batch, `committer.commit-time` will be used.

          [env: ETHREX_COMMITTER_FIRST_WAKE_UP_TIME=]

      --committer.arbitrary-base-blob-gas-price &lt;UINT64&gt;
          [env: ETHREX_COMMITTER_ARBITRARY_BASE_BLOB_GAS_PRICE=]
          [default: 1000000000]

Proof coordinator options:
      --proof-coordinator.l1-private-key &lt;PRIVATE_KEY&gt;
          Private key of of a funded account that the sequencer will use to send verify txs to the L1. Has to be a different account than --committer-l1-private-key.

          [env: ETHREX_PROOF_COORDINATOR_L1_PRIVATE_KEY=]

      --proof-coordinator.tdx-private-key &lt;PRIVATE_KEY&gt;
          Private key of of a funded account that the TDX tool that will use to send the tdx attestation to L1.

          [env: ETHREX_PROOF_COORDINATOR_TDX_PRIVATE_KEY=]

      --proof-coordinator.qpl-tool-path &lt;QPL_TOOL_PATH&gt;
          Path to the QPL tool that will be used to generate TDX quotes.

          [env: ETHREX_PROOF_COORDINATOR_QPL_TOOL_PATH=]
          [default: ./tee/contracts/automata-dcap-qpl/automata-dcap-qpl-tool/target/release/automata-dcap-qpl-tool]

      --proof-coordinator.remote-signer-url &lt;URL&gt;
          URL of a Web3Signer-compatible server to remote sign instead of a local private key.

          [env: ETHREX_PROOF_COORDINATOR_REMOTE_SIGNER_URL=]

      --proof-coordinator.remote-signer-public-key &lt;PUBLIC_KEY&gt;
          Public key to request the remote signature from.

          [env: ETHREX_PROOF_COORDINATOR_REMOTE_SIGNER_PUBLIC_KEY=]

      --proof-coordinator.addr &lt;IP_ADDRESS&gt;
          Set it to 0.0.0.0 to allow connections from other machines.

          [env: ETHREX_PROOF_COORDINATOR_LISTEN_ADDRESS=]
          [default: 127.0.0.1]

      --proof-coordinator.port &lt;UINT16&gt;
          [env: ETHREX_PROOF_COORDINATOR_LISTEN_PORT=]
          [default: 3900]

      --proof-coordinator.send-interval &lt;UINT64&gt;
          How often does the proof coordinator send proofs to the L1 in milliseconds.

          [env: ETHREX_PROOF_COORDINATOR_SEND_INTERVAL=]
          [default: 5000]

Based options:
      --state-updater.sequencer-registry &lt;ADDRESS&gt;
          [env: ETHREX_STATE_UPDATER_SEQUENCER_REGISTRY=]

      --state-updater.check-interval &lt;UINT64&gt;
          [env: ETHREX_STATE_UPDATER_CHECK_INTERVAL=]
          [default: 1000]

      --block-fetcher.fetch_interval_ms &lt;UINT64&gt;
          [env: ETHREX_BLOCK_FETCHER_FETCH_INTERVAL_MS=]
          [default: 5000]

      --fetch-block-step &lt;UINT64&gt;
          [env: ETHREX_BLOCK_FETCHER_FETCH_BLOCK_STEP=]
          [default: 5000]

      --based
          [env: ETHREX_BASED=]

Aligned options:
      --aligned
          [env: ETHREX_ALIGNED_MODE=]

      --aligned-verifier-interval-ms &lt;ETHREX_ALIGNED_VERIFIER_INTERVAL_MS&gt;
          [env: ETHREX_ALIGNED_VERIFIER_INTERVAL_MS=]
          [default: 5000]

      --aligned.beacon-url &lt;BEACON_URL&gt;...
          List of beacon urls to use.

          [env: ETHREX_ALIGNED_BEACON_URL=]

      --aligned-network &lt;ETHREX_ALIGNED_NETWORK&gt;
          L1 network name for Aligned sdk

          [env: ETHREX_ALIGNED_NETWORK=]
          [default: devnet]

      --aligned.fee-estimate &lt;FEE_ESTIMATE&gt;
          Fee estimate for Aligned sdk

          [env: ETHREX_ALIGNED_FEE_ESTIMATE=]
          [default: instant]

Admin server options:
      --admin-server.addr &lt;IP_ADDRESS&gt;
          [env: ETHREX_ADMIN_SERVER_LISTEN_ADDRESS=]
          [default: 127.0.0.1]

      --admin-server.port &lt;UINT16&gt;
          [env: ETHREX_ADMIN_SERVER_LISTEN_PORT=]
          [default: 5555]

L2 options:
      --validium
          If true, L2 will run on validium mode as opposed to the default rollup mode, meaning it will not publish blobs to the L1.

          [env: ETHREX_L2_VALIDIUM=]

      --sponsorable-addresses &lt;SPONSORABLE_ADDRESSES_PATH&gt;
          Path to a file containing addresses of contracts to which ethrex_SendTransaction should sponsor txs

      --sponsor-private-key &lt;SPONSOR_PRIVATE_KEY&gt;
          The private key of ethrex L2 transactions sponsor.

          [env: SPONSOR_PRIVATE_KEY=]
          [default: 0xffd790338a2798b648806fc8635ac7bf14af15425fed0c8f25bcc5febaa9b192]

Monitor options:
      --no-monitor
          [env: ETHREX_NO_MONITOR=]
</code></pre>
<h2 id="ethrex-l2-prover"><a class="header" href="#ethrex-l2-prover">ethrex l2 prover</a></h2>
<pre><code>Initialize an ethrex prover

Usage: ethrex l2 prover [OPTIONS] --proof-coordinators &lt;URL&gt;...

Options:
  -h, --help
          Print help (see a summary with '-h')

Prover client options:
      --backend &lt;BACKEND&gt;
          [env: PROVER_CLIENT_BACKEND=]
          [default: exec]
          [possible values: exec, sp1, risc0]

      --proof-coordinators &lt;URL&gt;...
          URLs of all the sequencers' proof coordinator

          [env: PROVER_CLIENT_PROOF_COORDINATOR_URL=]

      --proving-time &lt;PROVING_TIME&gt;
          Time to wait before requesting new data to prove

          [env: PROVER_CLIENT_PROVING_TIME=]
          [default: 5000]

      --log.level &lt;LOG_LEVEL&gt;
          Possible values: info, debug, trace, warn, error

          [default: INFO]

      --sp1-server &lt;URL&gt;
          Url to the moongate server to use when using sp1 backend

          [env: ETHREX_SP1_SERVER=]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="how-to-release-an-ethrex-version"><a class="header" href="#how-to-release-an-ethrex-version">How to Release an ethrex version</a></h1>
<p>Releases are prepared from dedicated release branches and tagged using versioning.</p>
<h2 id="1st---create-release-branch"><a class="header" href="#1st---create-release-branch">1st - Create release branch</a></h2>
<p>Branch name must follow the format <code>release/vX.Y.Z</code>.</p>
<p>Examples:</p>
<ul>
<li><code>release/v1.2.0</code></li>
<li><code>release/v3.0.0</code></li>
<li><code>release/v3.2.0</code></li>
</ul>
<h2 id="2nd---bump-version"><a class="header" href="#2nd---bump-version">2nd - Bump version</a></h2>
<p>The version must be updated to <code>X.Y.Z</code> in the release branch. There are multiple <code>Cargo.toml</code> and <code>Cargo.lock</code> files that need to be updated.</p>
<p>First, we need to update the version of the workspace package. You can find it in the <code>Cargo.toml</code> file in the root directory, under the <code>[workspace.package]</code> section.</p>
<p>Then, we need to update three more <code>Cargo.toml</code> files that are not part of the workspace but fulfill the role of packages in the monorepo. These are located in the following paths:</p>
<ul>
<li><code>crates/l2/prover/src/guest_program/src/sp1/Cargo.toml</code></li>
<li><code>crates/l2/prover/src/guest_program/src/risc0/Cargo.toml</code></li>
<li><code>crates/l2/prover/src/guest_program/src/zisk/Cargo.toml</code></li>
<li><code>crates/l2/prover/src/guest_program/src/openvm/Cargo.toml</code></li>
<li><code>crates/l2/tee/quote-gen/Cargo.toml</code></li>
</ul>
<p>After updating the version in the <code>Cargo.toml</code> files, we need to update the <code>Cargo.lock</code> files to reflect the new versions. Run <code>make update-cargo-lock</code> from the root directory to update all the <code>Cargo.lock</code> files in the repository. You should see changes in at most the following paths:</p>
<ul>
<li>In the root directory</li>
<li><code>crates/l2/prover/src/guest_program/src/sp1/Cargo.lock</code></li>
<li><code>crates/l2/prover/src/guest_program/src/risc0/Cargo.lock</code></li>
<li><code>crates/l2/prover/src/guest_program/src/zisk/Cargo.lock</code></li>
<li><code>crates/l2/prover/src/guest_program/src/openvm/Cargo.lock</code></li>
<li><code>crates/l2/tee/quote-gen/Cargo.lock</code></li>
</ul>
<p>Then, go to the <code>CLI.md</code> file located in <code>docs/</code> and update the version of the <code>--builder.extra-data</code> flag default value to match the new version (for both ethrex and ethrex l2 sections).</p>
<p>Finally, stage and commit the changes to the release branch.</p>
<p>An example of a PR that bumps the version can be found <a href="https://github.com/lambdaclass/ethrex/pull/4881/files#diff-2e9d962a08321605940b5a657135052fbcef87b5e360662bb527c96d9a615542">here</a>.</p>
<h2 id="3rd---create--push-tag"><a class="header" href="#3rd---create--push-tag">3rd - Create &amp; Push Tag</a></h2>
<p>Create a tag with a format <code>vX.Y.Z-rc.W</code> where <code>X.Y.Z</code> is the semantic version and <code>W</code> is a release candidate version. Other names for subversions are also accepted. Example of valid tags:</p>
<ul>
<li><code>v0.1.3-rc.1</code></li>
<li><code>v0.0.2-alpha</code></li>
</ul>
<pre><code class="language-bash">git tag &lt;release_version&gt;
git push origin &lt;release_version&gt;
</code></pre>
<p>After pushing the tag, a CI job will compile the binaries for different architectures and create a pre-release with the version specified in the tag name. Along with the binaries, a tar file is uploaded with the contracts and the verification keys. The following binaries are built:</p>
<div class="table-wrapper"><table><thead><tr><th>name</th><th>L1</th><th>L2 stack</th><th>Provers</th><th>CUDA support</th></tr></thead><tbody>
<tr><td>ethrex-linux-x86-64</td><td>✅</td><td>❌</td><td>-</td><td>-</td></tr>
<tr><td>ethrex-linux-aarch64</td><td>✅</td><td>❌</td><td>-</td><td>-</td></tr>
<tr><td>ethrex-linux-macos-aarch64</td><td>✅</td><td>❌</td><td>-</td><td>-</td></tr>
<tr><td>ethrex-l2-linux-x86-64</td><td>✅</td><td>✅</td><td>SP1 - RISC0 - Exec</td><td>❌</td></tr>
<tr><td>ethrex-l2-linux-x86-64-gpu</td><td>✅</td><td>✅</td><td>SP1 - RISC0 - Exec</td><td>✅</td></tr>
<tr><td>ethrex-l2-linux-aarch64</td><td>✅</td><td>✅</td><td>SP1 - Exec</td><td>❌</td></tr>
<tr><td>ethrex-l2-linux-aarch64-gpu</td><td>✅</td><td>✅</td><td>SP1 - Exec</td><td>✅</td></tr>
<tr><td>ethrex-l2-macos-aarch64</td><td>✅</td><td>✅</td><td>Exec</td><td>❌</td></tr>
</tbody></table>
</div>
<p>Also, two docker images are built and pushed to the Github Container registry:</p>
<ul>
<li><code>ghcr.io/lambdaclass/ethrex:X.Y.Z-rc.W</code></li>
<li><code>ghcr.io/lambdaclass/ethrex:X.Y.Z-rc.W-l2</code></li>
</ul>
<p>A changelog will be generated based on commit names (using conventional commits) from the last stable tag.</p>
<h2 id="4th---test--publish-release"><a class="header" href="#4th---test--publish-release">4th - Test &amp; Publish Release</a></h2>
<p>Once the pre-release is created and you want to publish the release, go to the <a href="https://github.com/lambdaclass/ethrex/releases">release page</a> and follow the next steps:</p>
<ol>
<li>
<p>Click on the edit button of the last pre-release created</p>
<p><img src="developers/../img/publish_release_step_1.png" alt="edit button" /></p>
</li>
<li>
<p>Manually create the tag <code>vX.Y.Z</code></p>
<p><img src="developers/../img/publish_release_step_2.png" alt="edit tag" /></p>
</li>
<li>
<p>Update the release title</p>
<p><img src="developers/../img/publish_release_step_3.png" alt="edit title" /></p>
</li>
<li>
<p>Set the release as the latest release (you will need to uncheck the pre-release first). And finally, click on <code>Update release</code></p>
<p><img src="developers/../img/publish_release_step_4.png" alt="set latest release" /></p>
</li>
</ol>
<p>Once done, the CI will publish new tags for the already compiled docker images:</p>
<ul>
<li><code>ghcr.io/lambdaclass/ethrex:X.Y.Z</code>, <code>ghcr.io/lambdaclass/ethrex:latest</code></li>
<li><code>ghcr.io/lambdaclass/ethrex:X.Y.Z-l2</code>, <code>ghcr.io/lambdaclass/ethrex:l2</code></li>
</ul>
<h2 id="5th---update-homebrew"><a class="header" href="#5th---update-homebrew">5th - Update Homebrew</a></h2>
<p>Disclaimer: We should automate this</p>
<ol>
<li>Commit a change in https://github.com/lambdaclass/homebrew-tap/ bumping the ethrex version (like <a href="https://github.com/lambdaclass/homebrew-tap/commit/d78a2772ad9c5412e7f84c6210bd85c970fcd0e6">this one</a>).
<ul>
<li>
<p>The first SHA is the hash of the <code>.tar.gz</code> from the release. You can get it by downloading the <code>Source code (tar.gz)</code> from the ethrex release and running</p>
<pre><code class="language-bash">shasum -a 256 ethrex-v3.0.0.tar.gz
</code></pre>
</li>
<li>
<p>For the second one:</p>
<ul>
<li>
<p>First download the <code>ethrex-l2-macos-aarch64</code> binary from the ethrex release</p>
</li>
<li>
<p>Give exec permissions to binary</p>
<pre><code class="language-bash">chmod +x ethrex-l2-macos-aarch64
</code></pre>
</li>
<li>
<p>Create a dir <code>ethrex/3.0.0/bin</code> (replace the version as needed)</p>
</li>
<li>
<p>Move (and rename) the binary to <code>ethrex/3.0.0/bin/ethrex</code> (the last <code>ethrex</code> is the binary)</p>
</li>
<li>
<p>Remove quarantine flags (in this case, <code>ethrex</code> is the root dir mentioned before):</p>
<pre><code class="language-bash">xattr -dr com.apple.metadata:kMDItemWhereFroms ethrex
xattr -dr com.apple.quarantine ethrex
</code></pre>
</li>
<li>
<p>Tar the dir with the following name (again, <code>ethrex</code> is the root dir):</p>
<pre><code class="language-bash">tar -czf ethrex-3.0.0.arm64_sonoma.bottle.tar.gz ethrex
</code></pre>
</li>
<li>
<p>Get the checksum:</p>
<pre><code class="language-bash">shasum -a 256 ethrex-3.0.0.arm64_sonoma.bottle.tar.gz
</code></pre>
</li>
<li>
<p>Use this as the second hash (the one in the <code>bottle</code> section)</p>
</li>
</ul>
</li>
</ul>
</li>
<li>Push the commit</li>
<li>Create a new release with tag <code>v3.0.0</code>. <strong>IMPORTANT</strong>: attach the <code>ethrex-3.0.0.arm64_sonoma.bottle.tar.gz</code> to the release</li>
</ol>
<h2 id="6th---merge-the-release-branch-via-pr"><a class="header" href="#6th---merge-the-release-branch-via-pr">6th - Merge the release branch via PR</a></h2>
<p>Once the release is verified, <strong>merge the branch via PR</strong>.</p>
<h2 id="dealing-with-hotfixes"><a class="header" href="#dealing-with-hotfixes">Dealing with hotfixes</a></h2>
<p>If hotfixes are needed before the final release, commit them to <code>release/vX.Y.Z</code>, push, and create a new pre-release tag. The final tag <code>vX.Y.Z</code> should always point to the exact commit you will merge via PR.</p>
<h2 id="troubleshooting-4"><a class="header" href="#troubleshooting-4">Troubleshooting</a></h2>
<h3 id="failure-on-latest-release-workflow"><a class="header" href="#failure-on-latest-release-workflow">Failure on "latest release" workflow</a></h3>
<p>If the CI fails when setting a release as latest (step 4), Docker tags <code>latest</code> and <code>l2</code> may not be updated. To manually push that changes, follow these steps:</p>
<ul>
<li>Create a new Github Personal Access Token (PAT) from the <a href="https://github.com/settings/tokens/new">settings</a>.</li>
<li>Check <code>write:packages</code> permission (this will auto-check <code>repo</code> permissions too), give a name and a short expiration time.</li>
<li>Save the token securely.</li>
<li>Click on <code>Configure SSO</code> button and authorize LambdaClass organization.</li>
<li>Log in to Github Container Registry: <code>docker login ghcr.io</code>. Put your Github's username and use the token as your password.</li>
<li>Pull RC images:</li>
</ul>
<pre><code class="language-bash">docker pull --platform linux/amd64 ghcr.io/lambdaclass/ethrex:X.Y.Z-rc.W
docker pull --platform linux/amd64 ghcr.io/lambdaclass/ethrex:X.Y.Z-rc.W-l2
</code></pre>
<ul>
<li>Retag them:</li>
</ul>
<pre><code class="language-bash">docker tag ghcr.io/lambdaclass/ethrex:X.Y.Z-rc.W ghcr.io/lambdaclass/ethrex:X.Y.Z
docker tag ghcr.io/lambdaclass/ethrex:X.Y.Z-rc.W-l2 ghcr.io/lambdaclass/ethrex:X.Y.Z-l2
docker tag ghcr.io/lambdaclass/ethrex:X.Y.Z-rc.W ghcr.io/lambdaclass/ethrex:latest
docker tag ghcr.io/lambdaclass/ethrex:X.Y.Z-rc.W-l2 ghcr.io/lambdaclass/ethrex:l2
</code></pre>
<ul>
<li>Push them:</li>
</ul>
<pre><code class="language-bash">docker push ghcr.io/lambdaclass/ethrex:X.Y.Z
docker push ghcr.io/lambdaclass/ethrex:X.Y.Z-l2
docker push ghcr.io/lambdaclass/ethrex:latest
docker push ghcr.io/lambdaclass/ethrex:l2
</code></pre>
<ul>
<li>Delete the PAT for security (<a href="https://github.com/settings/tokens">here</a>)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="short-to-mid-term-roadmap"><a class="header" href="#short-to-mid-term-roadmap">Short– to Mid-Term Roadmap</a></h1>
<p>This document represents the <strong>short- to mid-term roadmap</strong>.
Items listed here are actionable, concrete, and intended to be worked on in the coming weeks.
Long-term research directions and second-order ideas are intentionally out of scope.</p>
<p><strong>Priority reflects relative urgency, not effort.</strong></p>
<p>This is a WIP document and it requires better descriptions; it's supposed to be used internally.</p>
<hr />
<h2 id="priority-legend"><a class="header" href="#priority-legend">Priority Legend</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Priority</th><th>Meaning</th></tr></thead><tbody>
<tr><td style="text-align: right">0</td><td>Highest priority, low effort with potential win</td></tr>
<tr><td style="text-align: right">1</td><td>High. Should be addressed soon</td></tr>
<tr><td style="text-align: right">2</td><td>Medium. Important but not blocking</td></tr>
<tr><td style="text-align: right">3</td><td>Low. Useful improvement</td></tr>
<tr><td style="text-align: right">4</td><td>Very low. Nice to have</td></tr>
<tr><td style="text-align: right">5</td><td>Deprioritized for now</td></tr>
<tr><td style="text-align: right">6</td><td>Long tail / hygiene</td></tr>
<tr><td style="text-align: right">—</td><td>Not yet prioritized</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="execution"><a class="header" href="#execution">Execution</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Item</th><th>Priority</th><th>Status</th><th>Description</th></tr></thead><tbody>
<tr><td>Replace BTreeMap with FxHashMap</td><td>0</td><td>In Progress</td><td>Replace BTreeMap/BTreeSet with FxHashMap/FxHashSet</td></tr>
<tr><td>Skip Zero-Initialization in Memory Resize</td><td>0</td><td>Pending</td><td>Use unsafe set_len (EVM spec says expanded memory is zero)</td></tr>
<tr><td>Remove RefCell from Memory</td><td>0</td><td>Pending</td><td>Consider using UnsafeCell with manual safety guarantees, or restructure to avoid shared ownership.</td></tr>
<tr><td>Try out PEVM</td><td>0</td><td>In Progress</td><td>Benchmark again against pevm</td></tr>
<tr><td>Inline Hot Opcodes</td><td>0</td><td>In Progress</td><td>Opcodes call a function in a jump table when some of the most used ones could perform better being inlined instead</td></tr>
<tr><td>Test ECPairing libraries</td><td>0</td><td>Pending</td><td>Benchmark arkworks pairing in levm</td></tr>
<tr><td>PGO/BOLT</td><td>0</td><td>Pending</td><td>Try out both <a href="https://doc.rust-lang.org/beta/rustc/profile-guided-optimization.html">PGO</a> and <a href="https://github.com/llvm/llvm-project/tree/main/bolt">BOLT</a> to see if we can improve perf</td></tr>
<tr><td>Use an arena allocator for substate tracking</td><td>0</td><td>Pending</td><td>Substates are currently a linked list allocated through boxing. Consider using an arena allocator (e.g. bumpalo) for them</td></tr>
<tr><td>ruint</td><td>0</td><td>Pending</td><td>Try out <a href="https://github.com/recmo/uint">ruint</a> as the <code>U256</code> library to see if it improves performance. Part of SIMD initiative</td></tr>
<tr><td>Nibbles</td><td>1</td><td>Pending</td><td>Nibbles are currently stored as a byte (<code>u8</code>), when they could be stored compactly as actual nibbles in memory and reduce by half their representation size</td></tr>
<tr><td>RLP Duplication</td><td>1</td><td>Pending</td><td>Check whether we are encoding/decoding something twice (clearly unnecessary)</td></tr>
<tr><td>Object pooling</td><td>2</td><td>Pending</td><td>Reuse EVM stack frames to reduce allocations and improve performance</td></tr>
<tr><td>Avoid clones in hot path</td><td>2</td><td>Pending</td><td>Avoid Clone on Account Load and check rest of the hot path</td></tr>
<tr><td>SIMD Everywhere</td><td>2</td><td>Pending</td><td>There are some libraries that can be replaced by others that use SIMD instructions for better performance</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="io"><a class="header" href="#io">IO</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Item</th><th>Priority</th><th>Status</th><th>Description</th></tr></thead><tbody>
<tr><td>Add Block Cache (RocksDB)</td><td>0</td><td>Pending</td><td>Currently there is no explicit block cache, relying on OS page cache. Also try row cache</td></tr>
<tr><td>Use Two-Level Index (RocksDB)</td><td>0</td><td>Pending</td><td>Use Two-Level Index with Partitioned Filters</td></tr>
<tr><td>Enable unordered writes for State (RocksDB)</td><td>0</td><td>Pending</td><td>For <code>ACCOUNT_TRIE_NODES, STORAGE_TRIE_NODES cf_opts.set_unordered_write(true);</code> Faster writes when we don't need strict ordering</td></tr>
<tr><td>Increase Bloom Filter (RocksDB)</td><td>0</td><td>Pending</td><td>Change and benchmark higher bits per key for state tables</td></tr>
<tr><td>Consider LZ4 for State Tables (RocksDB)</td><td>0</td><td>Pending</td><td>Trades CPU for smaller DB and potentially better cache utilization</td></tr>
<tr><td>Add Read-Ahead for Sequential Scans (RocksDB)</td><td>0</td><td>Pending</td><td>Use for trie iteration, sync operations</td></tr>
<tr><td>Optimize for Point Lookups (RocksDB)</td><td>0</td><td>Pending</td><td>Adds hash index inside FlatKeyValue for faster point lookups</td></tr>
<tr><td>Modify block size (RocksDB)</td><td>0</td><td>Pending</td><td>Benchmark different block size configurations</td></tr>
<tr><td>Memory-Mapped Reads (RocksDB)</td><td>0</td><td>Pending</td><td>Can be an improvement on high-RAM systems</td></tr>
<tr><td>Increase layers commit threshold</td><td>0</td><td>Pending</td><td>For read-heavy workloads with plenty of RAM</td></tr>
<tr><td>Remove locks</td><td>1</td><td>Pending</td><td>Check if there are still some unnecessary locks, e.g. in the VM we have one</td></tr>
<tr><td>Benchmark bloom filter</td><td>1</td><td>Pending</td><td>Review trie layer's bloom filter, remove it or test other libraries/configurations</td></tr>
<tr><td>Use multiget on trie traversal</td><td>1</td><td>Pending</td><td>Using multiget on trie traversal might reduce read time</td></tr>
<tr><td>Spawned</td><td>3</td><td>Pending</td><td><a href="https://github.com/lambdaclass/spawned"><em>Spawnify</em></a> io intensive components/flows. Mempool and Snapsync are top priorities</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="zk--l2"><a class="header" href="#zk--l2">ZK + L2</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Item</th><th>Priority</th><th>Status</th><th>Description</th></tr></thead><tbody>
<tr><td>ZK API</td><td>1</td><td>Pending</td><td>Improve prover API to unify multiple backends</td></tr>
<tr><td>Native Rollups</td><td>2</td><td>Pending</td><td>Add EXEC Precompile POC</td></tr>
<tr><td>Based Rollups</td><td>2</td><td>Pending</td><td><a href="https://docs.ethrex.xyz/l2/roadmap.html">Based Rollups Roadmap</a></td></tr>
<tr><td>Zisk</td><td>2</td><td>In Progress</td><td>Integrate full Zisk Proving on the L2</td></tr>
<tr><td>zkVMs</td><td>2</td><td>In Progress</td><td>Make GuestProgramState more strict when information is missing</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="snapsync"><a class="header" href="#snapsync">SnapSync</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Item</th><th>Priority</th><th>Status</th><th>Description</th></tr></thead><tbody>
<tr><td>Download receipts and blocks</td><td>1</td><td>Pending</td><td>After snap sync is finished and the node is executing blocks, it should download all historical blocks and receipts in the background</td></tr>
<tr><td>Download headers in background (no rewrite)</td><td>1</td><td>Pending</td><td>Download headers in background</td></tr>
<tr><td>Avoid copying trie leaves when inserting (no rewrite)</td><td>1</td><td>Pending</td><td>Avoid copying trie leaves when inserting</td></tr>
<tr><td>Rewrite snapsync</td><td>4</td><td>Pending</td><td>Use Spawned for snapsync</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="ux--dx"><a class="header" href="#ux--dx">UX / DX</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Item</th><th>Priority</th><th>Status</th><th>Description</th></tr></thead><tbody>
<tr><td>Improve internal documentation</td><td>0</td><td>In Progress</td><td>Improve internal docs for developers, add architecture</td></tr>
<tr><td>geth db migration tooling</td><td>0</td><td>In Progress</td><td>As we don't support pre-merge blocks we need a tool to migrate other client's DB to ours at a specific block</td></tr>
<tr><td>Add MIT License</td><td>0</td><td>Pending</td><td>Add dual license</td></tr>
<tr><td>Add Tests</td><td>1</td><td>In Progress</td><td>Improve coverage</td></tr>
<tr><td>Add Fuzzing</td><td>1</td><td>In Progress</td><td>Add basic fuzzing scenarios</td></tr>
<tr><td>Add Prop test</td><td>1</td><td>In Progress</td><td>Add basic property testing scenarios</td></tr>
<tr><td>Add security runs to CI</td><td>1</td><td>In Progress</td><td>Add fuzzing and every security tool we have to the CI</td></tr>
<tr><td>CLI Documentation</td><td>1</td><td>Pending</td><td>Review CLI docs and flags</td></tr>
<tr><td>API Documentation</td><td>1</td><td>Pending</td><td>Add API documentation to docs. Add compliance matrix</td></tr>
<tr><td>IPv6 support</td><td>1</td><td>Pending</td><td>IPv6 is not fully supported</td></tr>
<tr><td>P2P leechers</td><td>1</td><td>Pending</td><td>Improve scoring heuristic and kick leechers</td></tr>
<tr><td>Custom Deterministic Benchmark</td><td>1</td><td>In Progress</td><td>We have a tool to run certain mainnet blocks, integrate that tool into our pipeline for benchmarking (not easy with DB changes)</td></tr>
<tr><td>Benchmark contract call &amp; simple transfers</td><td>1</td><td>Pending</td><td>Create a new benchmark with contract call &amp; simple transfers</td></tr>
<tr><td>Improve Error handling</td><td>1</td><td>In Progress</td><td>Avoid panic, unwrap and expect</td></tr>
<tr><td>Websocket subscriptions</td><td>2</td><td>Pending</td><td>Add subscription support for websocket</td></tr>
<tr><td>Not allow empty blocks in dev mode</td><td>2</td><td>Pending</td><td>For L2 development it's useful not to have empty blocks</td></tr>
<tr><td>P2P rate limiting</td><td>3</td><td>Pending</td><td>Improve scoring heuristic and DDoS protection</td></tr>
<tr><td>Migrations</td><td>4</td><td>Pending</td><td>Add DB Migration mechanism for ethrex upgrades</td></tr>
<tr><td>No STD</td><td>5</td><td>Pending</td><td>Support WASM target for some crates related to proving and execution. Useful for dApp builders and light clients</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="new-features"><a class="header" href="#new-features">New Features</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Item</th><th>Priority</th><th>Status</th><th>Description</th></tr></thead><tbody>
<tr><td>Block-Level Access Lists</td><td>2</td><td>In Progress</td><td>Implement <a href="https://eips.ethereum.org/EIPS/eip-7928">EIP-7928</a></td></tr>
<tr><td>Disc V5</td><td>2</td><td>In Progress</td><td>Add discV5 Support</td></tr>
<tr><td>Sparse Blobpool</td><td>—</td><td>Pending</td><td>Implement <a href="https://eips.ethereum.org/EIPS/eip-8070">EIP-8070</a></td></tr>
<tr><td>Pre merge blocks</td><td>—</td><td>Pending</td><td>Be able to process pre merge blocks</td></tr>
<tr><td>Archive node</td><td>—</td><td>Pending</td><td>Allow archive node mode</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="contributing-to-the-documentation"><a class="header" href="#contributing-to-the-documentation">Contributing to the Documentation</a></h1>
<p>We welcome contributions to the documentation! If you want to help improve or expand the docs, please follow these guidelines:</p>
<h2 id="how-to-edit-the-docs"><a class="header" href="#how-to-edit-the-docs">How to Edit the Docs</a></h2>
<ul>
<li>
<p>All documentation lives in this <code>docs/</code> directory and its subfolders.</p>
</li>
<li>
<p>The documentation is written in Markdown and rendered using <a href="https://rust-lang.github.io/mdBook/">mdBook</a>.</p>
</li>
<li>
<p>To preview your changes locally, <a href="CONTRIBUTING_DOCS.html#documentation-dependencies">install the dependencies</a> and run:</p>
<pre><code class="language-sh">make docs-serve
</code></pre>
<p>This will start a local server and open the docs in your browser.</p>
</li>
</ul>
<h2 id="adding-or-editing-content"><a class="header" href="#adding-or-editing-content">Adding or Editing Content</a></h2>
<ul>
<li>To add a new page, create a new <code>.md</code> file in the appropriate subdirectory and add a link to it in <code>SUMMARY.md</code>.</li>
<li>To edit an existing page, simply modify the relevant <code>.md</code> file.</li>
<li>For style and formatting, try to keep a consistent tone and structure with the rest of the documentation.</li>
</ul>
<h2 id="documentation-dependencies"><a class="header" href="#documentation-dependencies">Documentation dependencies</a></h2>
<p>We use some mdBook preprocessors and backends for extra features:</p>
<ul>
<li><a href="https://github.com/lambdalisue/rs-mdbook-alerts"><code>mdbook-alerts</code></a> for custom markdown syntax.</li>
<li><a href="https://github.com/badboy/mdbook-mermaid"><code>mdbook-mermaid</code></a> for diagrams.</li>
<li><a href="https://github.com/Michael-F-Bryan/mdbook-linkcheck"><code>mdbook-linkcheck</code></a> for checking broken links (optional).</li>
</ul>
<p>You can install mdBook and all dependencies with:</p>
<pre><code class="language-sh">make docs-deps
</code></pre>
<h2 id="submitting-changes"><a class="header" href="#submitting-changes">Submitting Changes</a></h2>
<ul>
<li>Please open a Pull Request with your proposed changes.</li>
<li>If you are adding new content, update <code>SUMMARY.md</code> so it appears in the navigation.</li>
<li>If you have questions, open an issue or ask in the community chat.</li>
</ul>
<p>Thank you for helping improve the documentation!</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="recommended-lectures"><a class="header" href="#recommended-lectures">Recommended lectures</a></h1>
<blockquote>
<p><strong>Disclaimer</strong>: This section is under development. We’ll continue to expand it with more up-to-date materials over time.</p>
</blockquote>
<p>For those interested in deepening their understanding of Ethereum internals, execution clients, and related zero-knowledge and distributed systems topics, we recommend the following materials:</p>
<ul>
<li>
<p><a href="https://x.com/megaeth_labs/status/1978854478943256986?s=12">ENDGAME: How MegaETH bridges throughput and decentralization</a></p>
</li>
<li>
<p><a href="https://x.com/megaeth_labs/status/1962902246573879530?s=12">ENDGAME: How SALT breaks the bottleneck that's been strangling blockchains</a></p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
